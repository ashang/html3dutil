/*
 CC0-1.0
*/
(function(C,w){"object"===typeof exports&&"undefined"!==typeof module?w(exports):"function"===typeof define&&define.amd?define(["exports"],w):w(C.H3DU={})})(this,function(C){function w(a,b){this.curve=a;this.curveParam=b}function ga(a,b,c,d,e){for(var f=.5*(c-b),g=b+f,h=0,k=0,l=0;l<ea.length;l+=3){var p=ea[l+2],H=ea[l+1],v=ea[l],m=a(f*v+g),h=h+p*m,k=k+H*m;0<v&&(m=a(-f*v+g),h+=p*m,k+=H*m)}h=h*f*d;k=k*f*d;return 1E-6>Math.abs(h-k)?k+(k-h)/8191:10<=e?k+(k-h)/8191:ga(a,b,g,d,e+1)+ga(a,g,c,d,e+1)}function ja(a){return 1===
a.length?{x:a[0]}:2===a.length?{x:a[0],y:a[1]}:3===a.length?{x:a[0],y:a[1],z:a[2]}:4===a.length?{x:a[0],y:a[1],z:a[2],w:a[3]}:{}}function u(a,b,c){if(0>=a.length)throw Error();if(!b)throw Error();this.bits=c||0;this.controlPoints=a;a=b.length-this.controlPoints.length;if(1>a||a>this.controlPoints.length)throw Error();u._checkKnots(b,a-1);c=this.controlPoints[0].length;var d=1;0!==(this.bits&u.DIVIDE_BIT)&&(d=2);if(c<d)throw Error();this.fastBezier=!1;if(a===this.controlPoints.length&&4>=a){this.fastBezier=
!0;for(c=0;c<a;c++)if(0!==b[c]){this.fastBezier=!1;break}for(c=a;this.fastBezier&&c<b.length;c++)if(1!==b[c]){this.fastBezier=!1;break}}this.knots=b;this.buffer=[]}function K(a,b,c,d){this.bits=d||0;d=a.length;if(0>=d)throw Error();var e=a[0].length;if(0>=e)throw Error();var f=a[0][0].length,g=1;0!==(this.bits&u.DIVIDE_BIT)&&(g=2);if(f<g)throw Error();if(!b||!c)throw Error();this.degreeU=b.length-e-1;this.degreeV=c.length-d-1;this.vcplen=d;this.ucplen=e;if(1>this.degreeU||this.degreeU+1>e)throw Error();
if(1>this.degreeV||this.degreeV+1>d)throw Error();u._checkKnots(b,this.degreeU);u._checkKnots(c,this.degreeV);this.knotsU=b;this.knotsV=c;this.bufferU=[];this.bufferV=[];this.controlPoints=a}function U(a,b,c,d){this.x1=a;this.x2=c;this.y1=b;this.y2=d}function aa(a,b,c,d,e,f,g,h,k,l,p){this.x1=a;this.x2=c;this.y1=b;this.y2=d;this.rx=e;this.ry=f;a=Math.cos(g);g=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(g);this.cr=a;this.sr=g;this.cx=h;this.cy=k;this.theta=
l;this.delta=p}function Y(a,b,c){var d;d=(a[0]-c[0])*(b[1]-c[1]);b=(a[1]-c[1])*(b[0]-c[0]);a=d-b;if(0<d){if(0>=b)return 0>a?-1:0===a?0:1;d+=b}else if(0>d){if(0<=b)return 0>a?-1:0===a?0:1;d=-d-b}else return 0>a?-1:0===a?0:1;d*=3.3306690738754716E-16;return a>=d||-a>=d?0>a?-1:0===a?0:1:0}function ha(){this.openPolygons=new fa;this.closedPolygons=new fa;this.clear=function(){this.openPolygons.clear();this.closedPolygons.clear()};this.size=function(){return this.closedPolygons.size()}}function ba(a,b,
c){for(var d=[],e=0;e<c-1;e++)for(var f=0;f<b-1;f++){var g=e*b+f,h=g+b,k=g+1,l=h+1;d.push(g,h,k);d.push(k,h,l)}return Z(a,d)}if("undefined"!==typeof window&&null!==window&&("undefined"===typeof window.Promise||null===window.Promise)){var L=function(a){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];a&&this._invokeResolver(a)};L.resolve=function(a){return new this(function(b){b(a)})};L.reject=function(a){return new this(function(b,c){c(a)})};L.all=
L.when=function(a){return new this(function(b,c){var d=0,e=[];a.forEach(function(a,g){d++;a.then(function(a){e[g]=a;d--;d||b(e)},function(a){d=1/0;c(a)})})})};L.race=function(a){return new this(function(b,c){a.forEach(function(a){a.then(b,c)})})};L.prototype.then=function(a,b){this._cb.fulfilled.push(a);this._cb.rejected.push(b);var c=new L(null);this._thenPromises.push(c);0<this._state&&this._schedule();return c};L.prototype.fulfill=function(a){if(0!==this._state)return this;this._state=1;this._value=
a;this._thenPromises.length&&this._schedule();return this};L.prototype.reject=function(a){if(0!==this._state)return this;this._state=2;this._value=a;this._thenPromises.length&&this._schedule();return this};L.prototype.resolve=function(a){if(a===this)this.reject(new TypeError("Promise resolved by its own instance"));else if(a instanceof this.constructor)a.chain(this);else{var b;if("undefined"===typeof a||null===a||"object"!==typeof a&&"function"!==typeof a)this.fulfill(a);else{try{b=a.then}catch(f){this.reject(f);
return}if("function"===typeof b){var c=!1,d=function(a){c||(c=!0,this.resolve(a))},e=function(a){c||(c=!0,this.reject(a))};try{b.call(a,d.bind(this),e.bind(this))}catch(f){c||this.reject(f)}}else this.fulfill(a)}}};L.prototype.chain=function(a){return this.then(function(b){a.resolve(b)},function(b){a.reject(b)})};L.prototype["catch"]=function(a){return this.then(null,a)};L.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};L.prototype._processQueue=
function(){for(this._timeout=null;this._thenPromises.length;){var a=this._cb.fulfilled.shift(),b=this._cb.rejected.shift();this._executeCallback(1===this._state?a:b)}};L.prototype._executeCallback=function(a){var b=this._thenPromises.shift();if("function"!==typeof a)1===this._state?b.fulfill(this._value):b.reject(this._value);else try{var c=a(this._value);b.resolve(c);return c}catch(d){b.reject(d)}};L.prototype._invokeResolver=function(a){try{a(this.resolve.bind(this),this.reject.bind(this))}catch(b){this.reject(b)}};
"undefined"!==typeof window&&null!==window&&(window.Promise=L)}if("undefined"===typeof Object.keys||null===Object.keys)Object.keys=function(a){var b=[],c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[b.length]=c);return b};var ka=function(a,b,c){function d(a,b,c){return function(d){a&&a(d);b.successes[c]=d;return!0}}function e(a,b,c){return function(d){a&&a(d);b.failures[c]=d;return!0}}if(!a||0===a.length)return Promise.resolve({successes:[],failures:[],results:[]});for(var f={successes:[],
failures:[],results:[]},g=[],h=0;h<a.length;h++){var k=h;g.push(a[h].then(d(b,f,k),e(c,f,k)))}return Promise.all(g).then(function(a){for(var b=0;b<f.successes.length;b++)"undefined"===typeof f.successes[b]&&(f.successes.splice(b,1),--b);for(b=0;b<f.failures.length;b++)"undefined"===typeof f.failures[b]&&(f.failures.splice(b,1),--b);f.results=a;return Promise.resolve(f)})},la=function(){throw Error();};(function(a){a.skipWhite=function(a,c,d){for(;c<d;){var b=a.charCodeAt(c);if(32===b||13===b||12===
b||9===b||10===b)++c;else break}return c};a.parseComma=function(b,c,d){var e=c;c=a.skipWhite(b,c,d);return c<d&&44===b.charCodeAt(c)?a.skipWhite(b,c+1,d):e};a.parseEndparen=function(b,c,d){var e=c;c=a.skipWhite(b,c,d);return c<d&&41===b.charCodeAt(c)?c+1:e};a.hsl=function(b,c,d,e){var f,g;f=c;if((g=a.parseHue(b,c,d,e,0))===c)return f;c=g;if((g=a.sepPct(b,c,d,e,1))===c)return f;c=g;if((g=a.sepPct(b,c,d,e,2))===c)return f;c=g;g=a.parseEndparen(b,c,d);if(g===c)return f;c=g;b=a.hlsToRgb(e[0],e[2],e[1]);
e[0]=b[0];e[1]=b[1];e[2]=b[2];e[3]=255;return c};a.pct=function(b,c,d,e,f){var g=a.parseNumber(b,c,d);if(g!==c){if(g>=d||37!==b.charAt(g))return c;e[f]=255*a.stringToPercent(b,c,g)/100;return g+1}return g};a.parseByte=function(b,c,d,e,f){d=a.parseInteger(b,c,d,!0);d!==c&&(e[f]=a.stringToByte(b,c,d));return d};a.parseHue=function(b,c,d,e,f){var g=c;c=a.skipWhite(b,c,d);d=a.parseNumber(b,c,d);return d!==c?(e[f]=a.stringToHue(b,c,d),d):g};a.sepByte=function(b,c,d,e,f){var g=a.parseComma(b,c,d);return g!==
c?a.parseByte(b,g,d,e,f):g};a.sepPct=function(b,c,d,e,f){var g=a.parseComma(b,c,d);return g!==c?a.pct(b,g,d,e,f):g};a.sepAlpha=function(b,c,d,e,f){var g=a.parseComma(b,c,d);g!==c&&(c=g,g=a.parseNumber(b,c,d),g!==c&&(e[f]=a.stringToAlpha(b,c,g)));return g};a.hsla=function(b,c,d,e){var f,g;f=c;if((g=a.parseHue(b,c,d,e,0))===c)return f;c=g;if((g=a.sepPct(b,c,d,e,1))===c)return f;c=g;if((g=a.sepPct(b,c,d,e,2))===c)return f;c=g;if((g=a.sepAlpha(b,c,d,e,3))===c)return f;c=g;g=a.hlsToRgb(e[0],e[2],e[1]);
e[0]=g[0];e[1]=g[1];e[2]=g[2];g=a.parseEndparen(b,c,d);return g===c?f:g};a.rgba=function(b,c,d,e){var f,g;f=c;var h=c=a.skipWhite(b,c,d),k=!0;(g=a.pct(b,c,d,e,0))===c?k=!1:c=g;k&&(g=a.sepPct(b,c,d,e,1))===c?k=!1:c=g;k&&(g=a.sepPct(b,c,d,e,2))===c?k=!1:c=g;k&&(g=a.sepAlpha(b,c,d,e,3))===c?k=!1:c=g;k||(c=h,k=!0,(g=a.parseByte(b,c,d,e,0))===c?k=!1:c=g,k&&(g=a.sepByte(b,c,d,e,1))===c?k=!1:c=g,k&&(g=a.sepByte(b,c,d,e,2))===c?k=!1:c=g,k&&(g=a.sepAlpha(b,c,d,e,3))===c?k=!1:c=g);if(!k)return f;g=a.parseEndparen(b,
c,d);return g===c?f:g};a.rgb=function(b,c,d,e){var f,g;f=c;var h=c=a.skipWhite(b,c,d),k=!0;(g=a.pct(b,c,d,e,0))===c?k=!1:c=g;k&&(g=a.sepPct(b,c,d,e,1))===c?k=!1:c=g;k&&(g=a.sepPct(b,c,d,e,2))===c?k=!1:c=g;k||(c=h,k=!0,(g=a.parseByte(b,c,d,e,0))===c?k=!1:c=g,k&&(g=a.sepByte(b,c,d,e,1))===c?k=!1:c=g,k&&(g=a.sepByte(b,c,d,e,2))===c?k=!1:c=g);if(!k)return f;e[3]=255;g=a.parseEndparen(b,c,d);return g===c?f:g};a.stringToNumber=function(a,c,d){a=a.substring(c,c+(d-c));return parseFloat(a)};a.stringToPercent=
function(b,c,d){b=a.stringToNumber(b,c,d);return Number.isNaN(b)?-1:0>b?0:100<b?100:b};a.stringToAlpha=function(b,c,d){b=a.stringToNumber(b,c,d);return 0>b?0:1<b?255:255*b};a.stringToHue=function(b,c,d){b=a.stringToNumber(b,c,d);return Number.isNaN(b)||b===Number.POSITIVE_INFINITY||b===Number.NEGATIVE_INFINITY?0:(b%360+360)%360};a.stringToByte=function(b,c,d){b=a.stringToNumber(b,c,d);return 0>b?0:255<b?255:b};a.parseInteger=function(a,c,d,e){var b=!1,g=c;for(e&&c<d&&(43===a.charCodeAt(c)||45===a.charCodeAt(c))&&
++c;c<d&&48<=a.charCodeAt(c)&&57>=a.charCodeAt(c);)++c,b=!0;return b?c:g};a.parseNumber=function(b,c,d){var e=c,f,g=0;if((f=a.parseInteger(b,c,d,!0))!==e)return c=f,c<d&&46===b.charCodeAt(c)?(++c,(f=a.parseInteger(b,c,d,!1))!==c?c<d&&(69===b.charCodeAt(c)||101===b.charCodeAt(c))&&(g=a.parseInteger(b,c+1,d,!0))!==c+1?g:f:c-1):c;c<d&&(43===b.charCodeAt(c)||45===b.charCodeAt(c))&&++c;return c<d&&46===b.charCodeAt(c)&&(++c,(f=a.parseInteger(b,c,d,!1))!==c)?c<d&&(69===b.charCodeAt(c)||101===b.charCodeAt(c))&&
(g=a.parseInteger(b,c+1,d,!0))!==c+1?g:f:e};a.hlsToRgb=a.HlsToRgb=function(a,c,d){c=0>c?0:255<c?255:c;d=0>d?0:255<d?255:d;if(0===d)return[c,c,c];d=127.5>=c?c*(255+d)/255:c+d-c*d/255;var b=2*c-d,f;if(0>a||360<=a)a=(a%360+360)%360;var g=a+120;360<=g&&(g-=360);c=60>g?b+(d-b)*g/60:180>g?d:240>g?b+(d-b)*(240-g)/60:b;g=a;f=60>g?b+(d-b)*g/60:180>g?d:240>g?b+(d-b)*(240-g)/60:b;g=a-120;0>g&&(g+=360);a=60>g?b+(d-b)*g/60:180>g?d:240>g?b+(d-b)*(240-g)/60:b;return[0>c?0:255<c?255:c,0>f?0:255<f?255:f,0>a?0:255<
a?255:a]};a.dehexchar=function(a){return 48<=a&&57>=a?a-48:65<=a&&70>=a?a+10-65:97<=a&&102>=a?a+10-97:-1};a.rgbHex=function(b,c,d){if("undefined"===typeof b||null===b||0===b.length)return!1;var e=b.length,f=[0,0,0,0,0,0,0,0],g=0,h=0;if("#"===b.charAt(0))--e,++g;else if(d)return!1;if(3!==e&&4!==e&&6!==e&&8!==e)return!1;for(d=g;d<b.length;++d){g=a.dehexchar(b.charCodeAt(d));if(0>g)return!1;f[h++]=g}c[3]=4===e?f[3]|f[3]<<4:8===e?f[7]|f[6]<<4:255;3===e||4===e?(c[0]=f[0]|f[0]<<4,c[1]=f[1]|f[1]<<4,c[2]=
f[2]|f[2]<<4):6<=e&&(c[0]=f[1]|f[0]<<4,c[1]=f[3]|f[2]<<4,c[2]=f[5]|f[4]<<4);return!0};a.colorToRgba=a.colorToRgba=function(b){if("undefined"===typeof b||null===b||0===b.length)return null;b=b.replace(/^[\r\n\t \u000c]+|[\r\n\t \u000c]+$/g,"");b=b.toLowerCase();if("transparent"===b)return[0,0,0,0];if("undefined"===typeof b||null===b||0===b.length)return null;var c=[0,0,0,0];if("#"===b.charAt(0)&&a.rgbHex(b,c,!0))return c;if(4<b.length&&"rgb("===b.substring(0,4))return a.rgb(b,4,b.length,c)===b.length?
c:null;if(5<b.length&&"rgba("===b.substring(0,5))return a.rgba(b,5,b.length,c)===b.length?c:null;if(4<b.length&&"hsl("===b.substring(0,4))return a.hsl(b,4,b.length,c)===b.length?c:null;if(5<b.length&&"hsla("===b.substring(0,5))return a.hsla(b,5,b.length,c)===b.length?c:null;var d=a.colorToRgbaSetUpNamedColors();return"undefined"!==typeof d[b]&&null!==d[b]?(a.rgbHex(d[b],c,!1),c):null};a.namedColorMap=a.namedColorMap=null;a.nc="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
a.colorToRgbaSetUpNamedColors=function(){if("undefined"===typeof a.namedColorMap||null===a.namedColorMap){for(var b={},c=0;c<a.nc.length;c+=2)b[a.nc[c]]=a.nc[c+1];for(var d="grey gray darkgrey darkgray darkslategrey darkslategray dimgrey dimgray lightgrey lightgray lightslategrey lightslategray slategrey slategray".split(" "),c=0;c<d.length;c+=2)b[d[c]]=b[d[c+1]];a.namedColorMap=b}return a.namedColorMap}})(la);var ia=function(a){a[0]=0>a[0]?0:Math.min(a[0],1);a[1]=0>a[1]?0:Math.min(a[1],1);a[2]=0>
a[2]?0:Math.min(a[2],1);a[3]=0>a[3]?0:Math.min(a[3],1);return a},n={_frustumPoints:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=[],k=d[1]*f[2],l=d[2]*f[1],p=k-l,H=d[2]*f[0],m=d[0]*f[2],F=H-m,n=d[0]*f[1],D=d[1]*f[0],q=n-D,y=b[2]*d[0],ua=b[0]*d[2],r=b[0]*d[1],u=b[1]*d[0],w=f[2]*b[0],A=f[0]*b[2],E=f[0]*b[1],B=f[1]*b[0],na=1/(b[0]*p+b[1]*F+b[2]*q),C=f[1]*b[2],x=f[2]*b[1],G=b[1]*d[2],I=b[2]*d[1],S=-b[3],J=-d[3],z=-f[3];h[0]=(p*S+(C-x)*J+(G-I)*z)*na;h[1]=(F*S+(w-A)*J+(y-ua)*z)*na;h[2]=(q*
S+(E-B)*J+(r-u)*z)*na;var L=e[1]*f[2],M=e[2]*f[1],N=L-M,K=e[2]*f[0],O=e[0]*f[2],P=K-O,Q=e[0]*f[1],R=e[1]*f[0],T=Q-R,U=b[2]*e[0],Y=b[0]*e[2],aa=b[0]*e[1],ba=b[1]*e[0],Z=1/(b[0]*N+b[1]*P+b[2]*T),ca=b[1]*e[2],da=b[2]*e[1],V=-e[3];h[3]=(N*S+(C-x)*V+(ca-da)*z)*Z;h[4]=(P*S+(w-A)*V+(U-Y)*z)*Z;h[5]=(T*S+(E-B)*V+(aa-ba)*z)*Z;var ea=k-l,fa=H-m,ga=n-D,ha=c[2]*d[0],ia=c[0]*d[2],ja=c[0]*d[1],ka=c[1]*d[0],la=f[2]*c[0],ma=f[0]*c[2],va=f[0]*c[1],wa=f[1]*c[0],oa=1/(c[0]*ea+c[1]*fa+c[2]*ga),xa=f[1]*c[2],ya=f[2]*c[1],
za=c[1]*d[2],Aa=c[2]*d[1],W=-c[3];h[6]=(ea*W+(xa-ya)*J+(za-Aa)*z)*oa;h[7]=(fa*W+(la-ma)*J+(ha-ia)*z)*oa;h[8]=(ga*W+(va-wa)*J+(ja-ka)*z)*oa;var Ba=L-M,Ca=K-O,Da=Q-R,Ea=c[2]*e[0],Fa=c[0]*e[2],Ga=c[0]*e[1],Ha=c[1]*e[0],pa=1/(c[0]*Ba+c[1]*Ca+c[2]*Da),Ia=c[1]*e[2],Ja=c[2]*e[1];h[9]=(Ba*W+(xa-ya)*V+(Ia-Ja)*z)*pa;h[10]=(Ca*W+(la-ma)*V+(Ea-Fa)*z)*pa;h[11]=(Da*W+(va-wa)*V+(Ga-Ha)*z)*pa;var Ka=d[1]*g[2],La=d[2]*g[1],Ma=Ka-La,Na=d[2]*g[0],Oa=d[0]*g[2],Pa=Na-Oa,Qa=d[0]*g[1],Ra=d[1]*g[0],Sa=Qa-Ra,Ta=g[2]*b[0],
Ua=g[0]*b[2],Va=g[0]*b[1],Wa=g[1]*b[0],qa=1/(b[0]*Ma+b[1]*Pa+b[2]*Sa),Xa=g[1]*b[2],Ya=g[2]*b[1],X=-g[3];h[12]=(Ma*S+(Xa-Ya)*J+(G-I)*X)*qa;h[13]=(Pa*S+(Ta-Ua)*J+(y-ua)*X)*qa;h[14]=(Sa*S+(Va-Wa)*J+(r-u)*X)*qa;var Za=e[1]*g[2],$a=e[2]*g[1],ab=Za-$a,bb=e[2]*g[0],cb=e[0]*g[2],db=bb-cb,eb=e[0]*g[1],fb=e[1]*g[0],gb=eb-fb,ra=1/(b[0]*ab+b[1]*db+b[2]*gb);h[15]=(ab*S+(Xa-Ya)*V+(ca-da)*X)*ra;h[16]=(db*S+(Ta-Ua)*V+(U-Y)*X)*ra;h[17]=(gb*S+(Va-Wa)*V+(aa-ba)*X)*ra;var hb=Ka-La,ib=Na-Oa,jb=Qa-Ra,kb=g[2]*c[0],lb=g[0]*
c[2],mb=g[0]*c[1],nb=g[1]*c[0],sa=1/(c[0]*hb+c[1]*ib+c[2]*jb),ob=g[1]*c[2],pb=g[2]*c[1];h[18]=(hb*W+(ob-pb)*J+(za-Aa)*X)*sa;h[19]=(ib*W+(kb-lb)*J+(ha-ia)*X)*sa;h[20]=(jb*W+(mb-nb)*J+(ja-ka)*X)*sa;var qb=Za-$a,rb=bb-cb,sb=eb-fb,ta=1/(c[0]*qb+c[1]*rb+c[2]*sb);h[21]=(qb*W+(ob-pb)*V+(Ia-Ja)*X)*ta;h[22]=(rb*W+(kb-lb)*V+(Ea-Fa)*X)*ta;h[23]=(sb*W+(mb-nb)*V+(Ga-Ha)*X)*ta;return h},boxCenter:function(a){return[a[0]+.5*(a[3]-a[0]),a[1]+.5*(a[4]-a[1]),a[2]+.5*(a[5]-a[2])]},boxDimensions:function(a){return[a[3]-
a[0],a[4]-a[1],a[5]-a[2]]},boxIsEmpty:function(a){return a[0]>a[3]||a[1]>a[4]||a[2]>a[5]},colorToLinear:function(a){return[.04045>=a[0]?a[0]/12.92:Math.pow((.055+a[0])/1.055,2.4),.04045>=a[1]?a[1]/12.92:Math.pow((.055+a[1])/1.055,2.4),.04045>=a[2]?a[2]/12.92:Math.pow((.055+a[2])/1.055,2.4),3>=a.length?1:a[3]]},colorTosRGB:function(a){return[.0031308>=a[0]?12.92*a[0]:1.055*Math.pow(a[0],1/2.4)-.055,.0031308>=a[1]?12.92*a[1]:1.055*Math.pow(a[1],1/2.4)-.055,.0031308>=a[2]?12.92*a[2]:1.055*Math.pow(a[2],
1/2.4)-.055,3>=a.length?1:a[3]]},frustumHasBox:function(a,b){if(n.boxIsEmpty(b))return!1;for(var c=0;6>c;c++){var d=a[c],e=d[3],f=d[0]*b[0],g=d[2]*b[2],h=d[1]*b[1];if(0>=f+h+g+e&&0>=d[0]*b[3]+d[1]*b[4]+d[2]*b[5]+e&&0>=f+d[1]*b[4]+g+e&&0>=f+d[1]*b[4]+d[2]*b[5]+e&&0>=f+h+d[2]*b[5]+e&&0>=d[0]*b[3]+d[1]*b[4]+g+e&&0>=d[0]*b[3]+h+g+e&&0>=d[0]*b[3]+h+d[2]*b[5]+e)return!1}d=n._frustumPoints(a);for(c=0;3>c;c++){e=b[c];if(d[c]<e&&d[3+c]<e&&d[6+c]<e&&d[9+c]<e&&d[12+c]<e&&d[15+c]<e&&d[18+c]<e&&d[21+c]<e)return!1;
e=b[c+3];if(d[c]>e&&d[3+c]>e&&d[6+c]>e&&d[9+c]>e&&d[12+c]>e&&d[15+c]>e&&d[18+c]>e&&d[21+c]>e)return!1}return!0},frustumHasPoint:function(a,b,c,d){for(var e=0;6>e;e++)if(0>=a[e][0]*b+a[e][1]*c+a[e][2]*d+a[e][3])return!1;return!0},frustumHasSphere:function(a,b,c,d,e){if(0>e)throw Error("radius is negative");for(var f=0;6>f;f++){var g=a[f];if(g[3]+g[0]*b+g[1]*c+g[2]*d<-e)return!1}return!0},mat3copy:function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]]},mat3identity:function(){return[1,0,0,
0,1,0,0,0,1]},mat3invert:function(a){var b=[],c=a[4]*a[8]-a[5]*a[7],d=a[5]*a[6]-a[3]*a[8],e=a[3]*a[7]-a[4]*a[6],f=1/(a[0]*c+a[1]*d+a[2]*e);if(0===f)return n.mat3identity();b[0]=c*f;b[1]=(a[2]*a[7]-a[1]*a[8])*f;b[2]=(a[1]*a[5]-a[2]*a[4])*f;b[3]=d*f;b[4]=(a[0]*a[8]-a[2]*a[6])*f;b[5]=(a[2]*a[3]-a[0]*a[5])*f;b[6]=e*f;b[7]=(a[1]*a[6]-a[0]*a[7])*f;b[8]=(a[0]*a[4]-a[1]*a[3])*f;return b},mat3multiply:function(a,b){var c=[];c[0]=b[0]*a[0]+b[1]*a[3]+b[2]*a[6];c[1]=b[0]*a[1]+b[1]*a[4]+b[2]*a[7];c[2]=b[0]*a[2]+
b[1]*a[5]+b[2]*a[8];c[3]=b[3]*a[0]+b[4]*a[3]+b[5]*a[6];c[4]=b[3]*a[1]+b[4]*a[4]+b[5]*a[7];c[5]=b[3]*a[2]+b[4]*a[5]+b[5]*a[8];c[6]=b[6]*a[0]+b[7]*a[3]+b[8]*a[6];c[7]=b[6]*a[1]+b[7]*a[4]+b[8]*a[7];c[8]=b[6]*a[2]+b[7]*a[5]+b[8]*a[8];return c},mat3transform:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[3]+b*a[6],e*a[1]+c*a[4]+b*a[7],e*a[2]+c*a[5]+b*a[8]]},mat3transpose:function(a){return n.mat3transposeInPlace(n.mat3copy(a))},
mat3transposeInPlace:function(a){var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return a},mat4copy:function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]},mat4frustum:function(a,b,c,d,e,f){var g=2*e,h=1/(b-a),k=1/(d-c),l=1/(f-e);return[g*h,0,0,0,0,g*k,0,0,(a+b)*h,(d+c)*k,-(f+e)*l,-1,0,0,-(g*f)*l,0]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},mat4inverseTranspose3:function(a){if(0===a[1]&&0===a[2]&&
0===a[4]&&0===a[6]&&0===a[8]&&0===a[9])return 1===a[0]&&1===a[5]&&1===a[10]?[1,0,0,0,1,0,0,0,1]:0!==a[0]*a[5]*a[10]?[1/a[0],0,0,0,1/a[5],0,0,0,1/a[10]]:[1,0,0,0,1,0,0,0,1];a=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];var b=a[0]*a[4]*a[8]+a[3]*a[7]*a[2]+a[6]*a[1]*a[5]-a[6]*a[4]*a[2]-a[3]*a[1]*a[8]-a[0]*a[7]*a[5];if(0===b)return[1,0,0,0,1,0,0,0,1];b=1/b;return[(-a[5]*a[7]+a[4]*a[8])*b,(a[5]*a[6]-a[3]*a[8])*b,(-a[4]*a[6]+a[3]*a[7])*b,(a[2]*a[7]-a[1]*a[8])*b,(-a[2]*a[6]+a[0]*a[8])*b,(a[1]*a[6]-a[0]*
a[7])*b,(-a[2]*a[4]+a[1]*a[5])*b,(a[2]*a[3]-a[0]*a[5])*b,(-a[1]*a[3]+a[0]*a[4])*b]},mat4invert:function(a){var b=a[0]*a[10],c=a[0]*a[11],d=a[0]*a[5],e=a[0]*a[6],f=a[0]*a[7],g=a[0]*a[9],h=a[10]*a[12],k=a[10]*a[13],l=a[10]*a[15],p=a[11]*a[12],H=a[11]*a[13],m=a[11]*a[14],F=a[1]*a[4],t=a[1]*a[6],D=a[1]*a[7],q=a[1]*a[8],y=a[2]*a[4],r=a[2]*a[5],u=a[2]*a[7],w=a[2]*a[8],E=a[2]*a[9],A=a[3]*a[4],B=a[3]*a[5],J=a[3]*a[6],z=a[3]*a[8],C=a[3]*a[9],x=a[4]*a[9],G=a[5]*a[8],I=a[6]*a[8],S=a[6]*a[9],L=a[7]*a[8],M=a[7]*
a[9],N=F-d,K=t-r,O=D-B,P=y-e,d=d-F,t=r-t,r=u-J,F=A-f,D=B-D,u=J-u,e=e-y,y=f-A,f=a[9]*a[12]*u+h*O+p*t+a[8]*a[13]*r+k*F+H*e+a[8]*a[14]*D+a[9]*a[14]*y+m*N+a[8]*a[15]*K+a[9]*a[15]*P+l*d;if(0===f)return n.mat4identity();f=1/f;A=[];A[0]=a[6]*H-a[7]*k+M*a[14]-a[5]*m-S*a[15]+a[5]*l;A[1]=a[3]*k-a[2]*H-C*a[14]+a[1]*m+E*a[15]-a[1]*l;A[2]=a[13]*r+a[14]*D+a[15]*K;A[3]=a[9]*u+a[10]*O+a[11]*t;A[4]=a[7]*h-a[6]*p-L*a[14]+a[4]*m+I*a[15]-a[4]*l;A[5]=a[2]*p-a[3]*h+a[14]*(z-c)+a[15]*(b-w);A[6]=a[12]*u+a[14]*y+a[15]*P;
A[7]=a[8]*r+a[10]*F+a[11]*e;A[8]=a[5]*p-M*a[12]+L*a[13]-a[4]*H+a[15]*(x-G);A[9]=C*a[12]-a[1]*p+a[13]*(c-z)+a[15]*(q-g);A[10]=a[12]*O+a[13]*F+a[15]*d;A[11]=a[8]*D+a[9]*y+a[11]*N;A[12]=S*a[12]-a[5]*h-I*a[13]+a[4]*k+a[14]*(G-x);A[13]=a[1]*h-E*a[12]+a[13]*(w-b)+a[14]*(g-q);A[14]=a[12]*t+a[13]*e+a[14]*N;A[15]=a[8]*K+a[9]*P+a[10]*d;for(a=0;16>a;a++)A[a]*=f;return A},mat4isIdentity:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===
a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mat4lookat:function(a,b,c){if("undefined"===typeof c||null===c)c=[0,1,0];if("undefined"===typeof b||null===b)b=[0,0,0];b=n.vec3sub(b,a);var d=n.vec3length(b);if(1E-6>d)return n.mat4identity();n.vec3scaleInPlace(b,1/d);c=n.vec3normalize(c);c=n.vec3cross(b,c);n.vec3normalizeInPlace(c);d=n.vec3cross(c,b);n.vec3normalizeInPlace(d);n.vec3negateInPlace(b);return[c[0],d[0],b[0],0,c[1],d[1],b[1],0,c[2],d[2],b[2],0,-n.vec3dot(a,c),-n.vec3dot(a,
d),-n.vec3dot(a,b),1]},mat4multiply:function(a,b){for(var c=[],d=0;16>d;d+=4)for(var e=0;4>e;e++)c[d+e]=b[d]*a[e]+b[d+1]*a[e+4]+b[d+2]*a[e+8]+b[d+3]*a[e+12];return c},mat4oblique:function(a,b){var c=(0<=a&&360>a?a:a%360+(0>a?360:0))*n.PiDividedBy180,d=(0<=b&&360>b?b:b%360+(0>b?360:0))*n.PiDividedBy180,e=Math.cos(c),f=Math.cos(d),c=e/(0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-e*e):-Math.sqrt(1-e*e):Math.sin(c));return[1,0,0,0,0,1,0,0,-f*c,-(0<=d&&6.283185307179586>d?3.141592653589793>=
d?Math.sqrt(1-f*f):-Math.sqrt(1-f*f):Math.sin(d))*c,1,0,0,0,0,1]},mat4ortho:function(a,b,c,d,e,f){var g=1/(b-a),h=1/(d-c),k=1/(f-e);return[2*g,0,0,0,0,2*h,0,0,0,0,-2*k,0,-(a+b)*g,-(d+c)*h,-(e+f)*k,1]},mat4ortho2d:function(a,b,c,d){return n.mat4ortho(a,b,c,d,-1,1)},mat4ortho2dAspect:function(a,b,c,d,e){return n.mat4orthoAspect(a,b,c,d,-1,1,e)},mat4orthoAspect:function(a,b,c,d,e,f,g){g/=Math.abs((b-a)/(d-c));var h=Math.abs(b-a),k=Math.abs(d-c);1>g?(g=k/g,d>c?(c-=.5*(g-k),d+=.5*(g-k)):(d-=.5*(g-k),c+=
.5*(g-k))):(g*=h,b>a?(a-=.5*(g-h),b+=.5*(g-h)):(b-=.5*(g-h),a+=.5*(g-h)));return n.mat4ortho(a,b,c,d,e,f)},mat4perspective:function(a,b,c,d){a=1/Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*n.PiDividedBy360);var e;e=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,e*(c+d),-1,0,0,e*c*d*2,0]},mat4perspectiveHorizontal:function(a,b,c,d){return n.mat4perspective(n.Num360DividedByPi*Math.atan2(Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*n.PiDividedBy360),b),b,c,d)},mat4projectVec3:function(a,b,c,d){var e;"undefined"!==
typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);d=1/(e*a[3]+c*a[7]+b*a[11]+a[15]);return[(e*a[0]+c*a[4]+b*a[8]+a[12])*d,(e*a[1]+c*a[5]+b*a[9]+a[13])*d,(e*a[2]+c*a[6]+b*a[10]+a[14])*d]},mat4rotate:function(a,b,c,d,e){var f,g;"undefined"!==typeof d&&"undefined"!==typeof e?(f=c,g=d,c=e,e=b):"undefined"===typeof c?(f=b[0],g=b[1],c=b[2],e=b[3]):(f=c[0],g=c[1],c=c[2],e=b);e=(0<=e&&360>e?e:e%360+(0>e?360:0))*n.PiDividedBy180;b=Math.cos(e);var h=3.141592653589793>=e?Math.sqrt(1-b*b):-Math.sqrt(1-
b*b);if(1===f&&0===g&&0===c)return[a[0],a[1],a[2],a[3],b*a[4]+a[8]*h,b*a[5]+a[9]*h,b*a[6]+a[10]*h,b*a[7]+a[11]*h,b*a[8]-h*a[4],b*a[9]-h*a[5],b*a[10]-h*a[6],b*a[11]-h*a[7],a[12],a[13],a[14],a[15]];if(0===f&&1===g&&0===c)return[b*a[0]-h*a[8],b*a[1]-h*a[9],b*a[2]-h*a[10],b*a[3]-h*a[11],a[4],a[5],a[6],a[7],b*a[8]+a[0]*h,b*a[9]+a[1]*h,b*a[10]+a[2]*h,b*a[11]+a[3]*h,a[12],a[13],a[14],a[15]];if(0===f&&0===g&&1===c)return[b*a[0]+a[4]*h,b*a[1]+a[5]*h,b*a[2]+a[6]*h,b*a[3]+a[7]*h,b*a[4]-h*a[0],b*a[5]-h*a[1],
b*a[6]-h*a[2],b*a[7]-h*a[3],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]];if(0===f&&0===g&&0===c)return n.mat4copy(a);e=1/Math.sqrt(f*f+g*g+c*c);f*=e;g*=e;c*=e;var k=g*g;d=1-b;var l=f*g,p=g*c;e=f*h;g*=h;var H=c*h,h=d*p,m=d*l,F=d*f*c;f=b+d*f*f;l=m+H;p=F-g;k=b+d*k;H=m-H;m=h+e;c=b+d*c*c;b=F+g;e=h-e;return[a[0]*f+a[4]*l+a[8]*p,a[1]*f+a[5]*l+a[9]*p,a[10]*p+a[2]*f+a[6]*l,a[11]*p+a[3]*f+a[7]*l,a[0]*H+a[4]*k+a[8]*m,a[1]*H+a[5]*k+a[9]*m,a[10]*m+a[2]*H+a[6]*k,a[11]*m+a[3]*H+a[7]*k,a[0]*b+a[4]*e+a[8]*c,a[1]*
b+a[5]*e+a[9]*c,a[10]*c+a[2]*b+a[6]*e,a[11]*c+a[3]*b+a[7]*e,a[12],a[13],a[14],a[15]]},mat4rotated:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d,d=a):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2],d=a[3]):(e=b[0],c=b[1],b=b[2],d=a);d=(0<=d&&360>d?d:d%360+(0>d?360:0))*n.PiDividedBy180;if(90===d||-270===d)return d=1/Math.sqrt(e*e+c*c+b*b),e*=d,c*=d,b*=d,[e*e,e*c+b,e*b-c,0,c*e-b,c*c,c*b+e,0,b*e+c,b*c-e,b*b,0,0,0,0,1];if(-90===d||270===d)return d=1/Math.sqrt(e*e+c*c+b*b),
e*=d,c*=d,b*=d,[e*e,e*c-b,e*b+c,0,c*e+b,c*c,c*b-e,0,b*e-c,b*c+e,b*b,0,0,0,0,1];if(180===d||-180===d)return d=1/Math.sqrt(e*e+c*c+b*b),e*=d,c*=d,b*=d,[e*e*2-1,e*c*2,e*b*2,0,c*e*2,c*c*2-1,c*b*2,0,b*e*2,b*c*2,b*b*2-1,0,0,0,0,1];a=Math.cos(d);var f=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);if(1===e&&0===c&&0===b)return[1,0,0,0,0,a,f,0,0,-f,a,0,0,0,0,1];if(0===e&&1===c&&0===b)return[a,0,-f,0,0,1,0,0,f,0,a,0,0,0,0,1];if(0===e&&0===c&&1===b)return[a,f,
0,0,-f,a,0,0,0,0,1,0,0,0,0,1];if(0===e&&0===c&&0===b)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];d=1/Math.sqrt(e*e+c*c+b*b);e*=d;c*=d;b*=d;d=e*e;var g=c*c,h=b*b,k=e*b,l=c*b,p=e*f,H=c*f,f=b*f,m=1-a;e=m*e*c;c=m*k;b=m*l;return[a+m*d,e+f,c-H,0,e-f,a+m*g,b+p,0,c+H,b-p,a+m*h,0,0,0,0,1]},mat4scale:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0]*e,a[1]*e,a[2]*e,a[3]*e,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],
a[15]]},mat4scaleInPlace:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);a[0]*=e;a[1]*=e;a[2]*=e;a[3]*=e;a[4]*=c;a[5]*=c;a[6]*=c;a[7]*=c;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a},mat4scaled:function(a,b,c){return"undefined"!==typeof b&&"undefined"!==typeof c?[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]:[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},mat4toFrustumPlanes:function(a){var b=[[],[],[],[],[],[]];b[0]=n.planeNormalizeInPlace([a[3]+a[0],a[7]+a[4],
a[11]+a[8],a[15]+a[12]]);b[1]=n.planeNormalizeInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);b[2]=n.planeNormalizeInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);b[3]=n.planeNormalizeInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]);b[4]=n.planeNormalizeInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);b[5]=n.planeNormalizeInPlace([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);return b},mat4toMat3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},mat4transform:function(a,
b,c,d,e){var f;"undefined"!==typeof c&&"undefined"!==typeof d&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],d=b[2],b=b[3]);return[f*a[0]+c*a[4]+d*a[8]+b*a[12],f*a[1]+c*a[5]+d*a[9]+b*a[13],f*a[2]+c*a[6]+d*a[10]+b*a[14],f*a[3]+c*a[7]+d*a[11]+b*a[15]]},mat4transformVec3:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[4]+b*a[8]+a[12],e*a[1]+c*a[5]+b*a[9]+a[13],e*a[2]+c*a[6]+b*a[10]+a[14]]},mat4translate:function(a,b,c,d){var e;
"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*e+a[4]*c+a[8]*b+a[12],a[1]*e+a[5]*c+a[9]*b+a[13],a[2]*e+a[6]*c+a[10]*b+a[14],a[3]*e+a[7]*c+a[11]*b+a[15]]},mat4translated:function(a,b,c){var d;"undefined"!==typeof b&&"undefined"!==typeof c?(d=a,a=c):(d=a[0],b=a[1],a=a[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,d,b,a,1]},mat4transpose:function(a){return n.mat4transposeInPlace(n.mat4copy(a))},mat4transposeInPlace:function(a){var b=
a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return a},planeFromNormalAndPoint:function(a,b){return[a[0],a[1],a[2],-(a[0]*b[0]+a[1]*b[1]+a[2]*b[2])]},planeNormalize:function(a){return n.planeNormalizeInPlace(n.vec4copy(a))},planeNormalizeInPlace:function(a){var b=a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},quatConjugate:function(a){return[-a[0],
-a[1],-a[2],a[3]]},quatFromAxisAngle:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2]):(e=b[0],c=b[1],b=b[2]);d=(0<=a&&360>a?a:a%360+(0>a?360:0))*n.PiDividedBy360;a=Math.cos(d);d=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);e=n.vec3normalizeInPlace([e,c,b]);e=[e[0],e[1],e[2],a];e[0]*=d;e[1]*=d;e[2]*=d;return e},quatFromMat4:function(a){var b=[],c=a[1],d=a[2],e=a[4],f=a[6],
g=a[8],h=a[9],k=a[0]+a[5]+a[10];0<=k?(a=.5*Math.sqrt(k+1),k=.25/a,b[0]=(f-h)*k,b[1]=(g-d)*k,b[2]=(c-e)*k,b[3]=a):a[0]>a[5]&&a[0]>a[10]?(a=.5*Math.sqrt(1+a[0]-a[5]-a[10]),k=.25/a,b[0]=a,b[1]=(e+c)*k,b[2]=(d+g)*k,b[3]=(f-h)*k):a[5]>a[10]?(a=.5*Math.sqrt(1+a[5]-a[0]-a[10]),k=.25/a,b[0]=(e+c)*k,b[1]=a,b[2]=(h+f)*k,b[3]=(g-d)*k):(a=.5*Math.sqrt(1+a[10]-a[0]-a[5]),k=.25/a,b[0]=(g+d)*k,b[1]=(h+f)*k,b[2]=a,b[3]=(c-e)*k);return b},quatFromTaitBryan:function(a,b,c,d){var e,f;if("undefined"===typeof d||null===
d)d=n.GlobalRollPitchYaw;if(0>d||6<=d)throw Error("invalid mode");a.constructor===Array?(c=(0<=a[2]&&360>a[2]?a[2]:a[2]%360+(0>a[2]?360:0))*n.PiDividedBy360,e=(0<=a[0]&&360>a[0]?a[0]:a[0]%360+(0>a[0]?360:0))*n.PiDividedBy360,f=(0<=a[1]&&360>a[1]?a[1]:a[1]%360+(0>a[1]?360:0))*n.PiDividedBy360):(c=(0<=c&&360>c?c:c%360+(0>c?360:0))*n.PiDividedBy360,e=(0<=a&&360>a?a:a%360+(0>a?360:0))*n.PiDividedBy360,f=(0<=b&&360>b?b:b%360+(0>b?360:0))*n.PiDividedBy360);a=Math.cos(e);e=0<=e&&6.283185307179586>e?3.141592653589793>=
e?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(e);b=Math.cos(f);f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(f);var g=Math.cos(c);c=0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-g*g):-Math.sqrt(1-g*g):Math.sin(c);var h;d===n.GlobalPitchYawRoll||d===n.GlobalPitchRollYaw?(h=[c*f,g*f,c*b,g*b],d===n.GlobalPitchYawRoll&&(h[0]=-h[0]),d=[h[3]*e+h[0]*a,h[1]*a+h[2]*e,h[2]*a-h[1]*e,h[3]*a-h[0]*e]):d===n.GlobalYawPitchRoll||d===n.GlobalYawRollPitch?
(h=[g*e,c*e,c*a,g*a],d===n.GlobalYawRollPitch&&(h[1]=-h[1]),d=[h[0]*b-h[2]*f,h[3]*f+h[1]*b,h[2]*b+h[0]*f,h[3]*b-h[1]*f]):(h=[b*e,f*a,f*e,b*a],d===n.GlobalRollPitchYaw&&(h[2]=-h[2]),d=[h[0]*g+h[1]*c,h[1]*g-h[0]*c,h[3]*c+h[2]*g,h[3]*g-h[2]*c]);return d},quatFromVectors:function(a,b){var c=n.vec3cross(a,b);if(1E-9>n.vec3dot(c,c)){if(0<n.vec3dot(a,b))return[0,0,0,1];c=n.vec3perp(a);c[3]=0}else{var d=n.vec3length(a)*n.vec3length(b);0===d&&(d=1);c[3]=d+n.vec3dot(a,b)}return n.quatNormalizeInPlace(c)},quatIdentity:function(){return[0,
0,0,1]},quatInvert:function(a){var b=1/n.quatDot(a,a);return n.vec4scaleInPlace(n.quatConjugate(a),b)},quatIsIdentity:function(a){return 0===a[0]&&0===a[1]&&0===a[2]&&1===a[3]},quatMultiply:function(a,b){return[a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]+a[1]*b[3]+a[2]*b[0]-a[0]*b[2],a[3]*b[2]+a[2]*b[3]+a[0]*b[1]-a[1]*b[0],a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]]},quatNlerp:function(a,b,c){var d=1-c,e=a[0]*d,f=a[1]*d,g=a[2]*d,d=a[3]*d,h=b[0]*c,k=b[1]*c,l=b[2]*c;c*=b[3];return 0>a[0]*b[0]+a[1]*
b[1]+a[2]*b[2]+a[3]*b[3]?n.quatNormalizeInPlace([e-h,f-k,g-l,d-c]):n.quatNormalizeInPlace([e+h,f+k,g+l,d+c])},quatRotate:function(a,b,c,d,e){return n.quatMultiply(a,n.quatFromAxisAngle(b,c,d,e))},quatSlerp:function(a,b,c){var d=n.quatDot(a,b),e=b;0>d&&(e=[-b[0],-b[1],-b[2],-b[3]],d=n.quatDot(a,e));if(-1<d)if(1>d){if(d=Math.acos(d),0===d)return n.quatNlerp(a,b,c)}else return n.quatNlerp(a,b,c);else d=Math.PI;var f=1/Math.sin(d);b=Math.sin((1-c)*d)*f;c=Math.sin(c*d)*f;return[a[0]*b+e[0]*c,a[1]*b+e[1]*
c,a[2]*b+e[2]*c,a[3]*b+e[3]*c]},quatToAxisAngle:function(a){var b=a[3],c=1-b*b;return 0<c?(c=1/Math.sqrt(c),[a[0]*c,a[1]*c,a[2]*c,Math.acos(Math.min(1,Math.max(0,b)))*n.Num360DividedByPi]):[0,1,0,0]},quatToMat4:function(a){var b,c,d,e,f,g,h,k,l;b=2*a[0];c=2*a[1];d=2*a[2];e=b*a[0];f=b*a[1];g=b*a[2];h=c*a[1];k=d*a[1];l=d*a[2];b*=a[3];c*=a[3];a=d*a[3];return[1-(h+l),f+a,g-c,0,f-a,1-(e+l),k+b,0,g+c,k-b,1-(e+h),0,0,0,0,1]},quatToTaitBryan:function(a,b){var c=a[3],d,e,f,g=1;if("undefined"===typeof b||null===
b)b=n.GlobalRollPitchYaw;if(0>b||6<=b)throw Error("invalid mode");b===n.GlobalRollPitchYaw?(d=a[1],e=a[0],f=a[2],g=-1):b===n.GlobalPitchYawRoll?(d=a[2],e=a[1],f=a[0],g=-1):b===n.GlobalPitchRollYaw?(d=a[1],e=a[2],f=a[0]):b===n.GlobalYawPitchRoll?(d=a[2],e=a[0],f=a[1]):b===n.GlobalYawRollPitch?(d=a[0],e=a[2],f=a[1],g=-1):(d=a[0],e=a[1],f=a[2]);var h=e*e,k=Math.atan2(2*(c*d-g*e*f),1-2*(d*d+h)),l=2*(c*e+g*d*f);1<l&&(l=1);-1>l&&(l=-1);l=Math.asin(l);e=Math.atan2(2*(c*f-g*d*e),1-2*(h+f*f));k*=n.Num180DividedByPi;
l*=n.Num180DividedByPi;e*=n.Num180DividedByPi;if(1E-6>Math.abs(l-90)||1E-6>Math.abs(l+90))e=0,k=Math.atan2(d,c)*n.Num180DividedByPi,isNaN(k)&&(k=0);c=[];b===n.GlobalRollPitchYaw?(c[0]=l,c[1]=k,c[2]=e):b===n.GlobalPitchYawRoll?(c[0]=e,c[1]=l,c[2]=k):b===n.GlobalPitchRollYaw?(c[0]=e,c[1]=k,c[2]=l):b===n.GlobalYawPitchRoll?(c[0]=l,c[1]=e,c[2]=k):b===n.GlobalYawRollPitch?(c[0]=k,c[1]=e,c[2]=l):(c[0]=k,c[1]=l,c[2]=e);return c},quatTransform:function(a,b){var c=a[1]*b[2]-a[2]*b[1]+b[0]*a[3],d=a[2]*b[0]-
a[0]*b[2]+b[1]*a[3],e=a[0]*b[1]-a[1]*b[0]+b[2]*a[3],f=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];return 3===b.length?[c*a[3]-(d*a[2]-e*a[1])+a[0]*f,d*a[3]-(e*a[0]-c*a[2])+a[1]*f,e*a[3]-(c*a[1]-d*a[0])+a[2]*f]:[c*a[3]-(d*a[2]-e*a[1])+a[0]*f,d*a[3]-(e*a[0]-c*a[2])+a[1]*f,e*a[3]-(c*a[1]-d*a[0])+a[2]*f,1]},vec2abs:function(a){return[Math.abs(a[0]),Math.abs(a[1])]},vec2absInPlace:function(a){a[0]=Math.abs(a[0]);a[1]=Math.abs(a[1]);return a},vec2add:function(a,b){return[a[0]+b[0],a[1]+b[1]]},vec2addInPlace:function(a,
b){var c=b[1];a[0]+=b[0];a[1]+=c;return a},vec2assign:function(a,b){a[0]=b[0];a[1]=b[1];return a},vec2clamp:function(a,b,c){return n.vec2clampInPlace(n.vec2copy(a),b,c)},vec2clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;return a},vec2copy:function(a){return[a[0],a[1]]},vec2dist:function(a,b){return n.vec2length(n.vec2sub(a,b))},vec2dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},vec2length:function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+
a*a)},vec2lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c]},vec2mul:function(a,b){return[a[0]*b[0],a[1]*b[1]]},vec2mulInPlace:function(a,b){var c=b[1];a[0]*=b[0];a[1]*=c;return a},vec2negate:function(a){return[-a[0],-a[1]]},vec2negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];return a},vec2normalize:function(a){return n.vec2normalizeInPlace([a[0],a[1]])},vec2normalizeInPlace:function(a){var b=a[0],c=a[1],b=Math.sqrt(b*b+c*c);0!==b&&(b=1/b,a[0]*=b,a[1]*=b);return a},vec2perp:function(a){return[-a[1],
a[0]]},vec2proj:function(a,b){var c=n.vec2dot(b,b);return 0===c?[0,0]:n.vec2scale(b,n.vec2dot(a,b)/c)},vec2reflect:function(a,b){return n.vec2sub(a,n.vec2scale(b,2*n.vec2dot(b,a)))},vec2scale:function(a,b){return n.vec2scaleInPlace([a[0],a[1]],b)},vec2scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;return a},vec2sub:function(a,b){return[a[0]-b[0],a[1]-b[1]]},vec2subInPlace:function(a,b){var c=b[1];a[0]-=b[0];a[1]-=c;return a},vec3abs:function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])]},vec3absInPlace:function(a){a[0]=
Math.abs(a[0]);a[1]=Math.abs(a[1]);a[2]=Math.abs(a[2]);return a},vec3add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},vec3addInPlace:function(a,b){var c=b[1],d=b[2];a[0]+=b[0];a[1]+=c;a[2]+=d;return a},vec3assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},vec3clamp:function(a,b,c){return n.vec3clampInPlace(n.vec3copy(a),b,c)},vec3clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1])),e=Math.min(c,Math.max(b,a[2]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;a[2]=e;return a},
vec3copy:function(a){return[a[0],a[1],a[2]]},vec3cross:function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},vec3dist:function(a,b){return n.vec3length(n.vec3sub(a,b))},vec3dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3fromWindowPoint:function(a,b,c,d){var e=.5*c[2],f=.5*c[3],g=0,h=0,k=2*a[2]-1;0!==e&&0!==f&&(g=(a[0]-c[0]-e)/e,h=(a[1]-c[1]-f)/f);h=d?h:-h;a=n.mat4invert(b);return n.mat4projectVec3(a,[g,h,k])},vec3length:function(a){var b=a[0],c=a[1];a=a[2];
return Math.sqrt(b*b+c*c+a*a)},vec3lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c]},vec3mul:function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]},vec3mulInPlace:function(a,b){var c=b[1],d=b[2];a[0]*=b[0];a[1]*=c;a[2]*=d;return a},vec3negate:function(a){return[-a[0],-a[1],-a[2]]},vec3negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},vec3normalize:function(a){return n.vec3normalizeInPlace([a[0],a[1],a[2]])},vec3normalizeInPlace:function(a){var b=
a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b);return a},vec3perp:function(a){var b=Math.abs(a[0]),c=Math.abs(a[1]),d=Math.max(b,c,Math.abs(a[2])),e=[0,0,0];d===b?(e[0]=a[1],e[1]=-a[0],e[2]=0):d===c?(e[0]=0,e[1]=a[2],e[2]=-a[1]):(e[0]=-a[2],e[1]=0,e[2]=a[0]);return e},vec3proj:function(a,b){var c=n.vec3dot(b,b);return 0===c?[0,0,0]:n.vec3scale(b,n.vec3dot(a,b)/c)},vec3reflect:function(a,b){return n.vec3sub(a,n.vec3scale(b,2*n.vec3dot(b,a)))},vec3scale:function(a,
b){return n.vec3scaleInPlace([a[0],a[1],a[2]],b)},vec3scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},vec3sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},vec3subInPlace:function(a,b){var c=b[1],d=b[2];a[0]-=b[0];a[1]-=c;a[2]-=d;return a},vec3toWindowPoint:function(a,b,c,d){if(0>c[2]||0>c[3])throw Error();a=n.mat4projectVec3(b,a);b=.5*c[2];var e=.5*c[3];return[a[0]*b+b+c[0],(d?a[1]:-a[1])*e+e+c[1],.5*(a[2]+1)]},vec3triple:function(a,b,c){return n.vec3dot(a,n.vec3cross(b,c))},
vec4abs:function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2]),Math.abs(a[3])]},vec4absInPlace:function(a){a[0]=Math.abs(a[0]);a[1]=Math.abs(a[1]);a[2]=Math.abs(a[2]);a[3]=Math.abs(a[3]);return a},vec4add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},vec4addInPlace:function(a,b){var c=b[1],d=b[2],e=b[3];a[0]+=b[0];a[1]+=c;a[2]+=d;a[3]+=e;return a},vec4assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},vec4clamp:function(a,b,c){return n.vec4clampInPlace(n.vec4copy(a),
b,c)},vec4clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1])),e=Math.min(c,Math.max(b,a[2])),f=Math.min(c,Math.max(b,a[3]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;a[2]=e;a[3]=f;return a},vec4copy:function(a){return[a[0],a[1],a[2],a[3]]},vec4dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},vec4length:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},vec4lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c,a[3]+
(b[3]-a[3])*c]},vec4negate:function(a){return[-a[0],-a[1],-a[2],-a[3]]},vec4negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},vec4normalize:function(a){return n.vec4normalizeInPlace([a[0],a[1],a[2],a[3]])},vec4normalizeInPlace:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],b=Math.sqrt(b*b+c*c+d*d+e*e);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},vec4proj:function(a,b){var c=n.vec4dot(b,b);return 0===c?[0,0,0]:n.vec4scale(b,n.vec4dot(a,b)/c)},vec4scale:function(a,
b){return[a[0]*b,a[1]*b,a[2]*b,a[3]*b]},vec4scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},vec4sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},vec4subInPlace:function(a,b){var c=b[1],d=b[2],e=b[3];a[0]-=b[0];a[1]-=c;a[2]-=d;a[3]-=e;return a},interpCubicBezier:function(a,b,c,d,e){if(0>=e)return 0;if(1<=e)return 1;for(var f=e,g=0;10>g;g++){var h=f*(3*a*(f*(f-2)+1)-3*c*f*(f-1)+f*f)-e;if(1E-9>Math.abs(h))break;f-=h/(3*(((3*f-4)*f+1)*a+(-3*f+2)*f*c+f*f))}return f*
(3*b*(f*(f-2)+1)-3*d*f*(f-1)+f*f)}};n.quatDot=n.vec4dot;n.quatNormalizeInPlace=n.vec4normalizeInPlace;n.quatNormalize=n.vec4normalize;n.quatLength=n.vec4length;n.quatScaleInPlace=n.vec4scaleInPlace;n.quatScale=n.vec4scale;n.quatCopy=n.vec4copy;n.PiTimes2=6.283185307179586;n.HalfPi=1.5707963267948966;n.PiDividedBy180=.017453292519943295;n.ToRadians=n.PiDividedBy180;n.PiDividedBy360=.008726646259971648;n.Num360DividedByPi=114.59155902616465;n.Num180DividedByPi=57.29577951308232;n.ToDegrees=n.Num180DividedByPi;
n.GlobalPitchYawRoll=0;n.GlobalPitchRollYaw=1;n.GlobalYawPitchRoll=2;n.GlobalYawRollPitch=3;n.GlobalRollPitchYaw=4;n.GlobalRollYawPitch=5;n.LocalPitchYawRoll=n.GlobalRollYawPitch;n.LocalPitchRollYaw=n.GlobalYawRollPitch;n.LocalYawPitchRoll=n.GlobalRollPitchYaw;n.LocalYawRollPitch=n.GlobalPitchRollYaw;n.LocalRollPitchYaw=n.GlobalYawPitchRoll;n.LocalRollYawPitch=n.GlobalPitchYawRoll;n.PitchYawRoll=0;n.PitchRollYaw=1;n.YawPitchRoll=2;n.YawRollPitch=3;n.RollPitchYaw=4;n.RollYawPitch=5;n.quatInverse=n.quatInvert;
n.vec3norm=n.vec3normalize;n.vec4norm=n.vec4normalize;n.quatNorm=n.quatNormalize;n.vec3normInPlace=n.vec3normalizeInPlace;n.vec4normInPlace=n.vec4normalizeInPlace;n.quatNormInPlace=n.quatNormalizeInPlace;n.planeNormInPlace=n.planeNormalizeInPlace;n.planeNorm=n.planeNormalize;var I={vecZeros:function(a){for(var b=[],c=0;c<a;c++)b[c]=0;return b},vecSub:function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]-b[d];return c},vecSubInPlace:function(a,b){for(var c=0;c<a.length;c++)a[c]-=b[c];return a},vecScale:function(a,
b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]*b;return c},vecSubScaleInPlace:function(a,b,c){for(var d=0;d<a.length;d++)a[d]=(a[d]-b[d])*c;return a},vecNormalizeInPlace:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];b=Math.sqrt(b);if(0!==b)for(b=1/b,c=0;c<a.length;c++)a[c]*=b;return a},vecLength:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return Math.sqrt(b)}};w.prototype.endPoints=function(){return"undefined"!==typeof this.curveParam&&null!==this.curveParam?this.curveParam.endPoints():
"undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.endPoints&&null!==this.curve.endPoints?this.curve.endPoints():[0,1]};w.prototype._getCoord=function(a){return"undefined"!==typeof this.curveParam&&null!==this.curveParam?this.curveParam.getCoordinate(a):a};w._EPSILON=1E-5;w.prototype.evaluate=function(a){return"undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.evaluate&&null!==this.curve.evaluate?
this.curve.evaluate(this._getCoord(a)):[0,0,0]};w.prototype.velocity=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.velocity&&null!==this.curve.velocity)return this.curve.velocity(this._getCoord(a));var b=w._EPSILON,c=this.evaluate(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.evaluate(a+b));return I.vecSubScaleInPlace(c,this.evaluate(a),1/b)};w.prototype.accel=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&
this.curve!==this&&"undefined"!==typeof this.curve.accel&&null!==this.curve.accel)return this.curve.accel(this._getCoord(a));var b=w._EPSILON,c=this.velocity(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.velocity(a+b));return I.vecSubScaleInPlace(c,this.velocity(a),1/b)};w.prototype.jerk=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.jerk&&null!==this.curve.jerk)return this.curve.jerk(this._getCoord(a));var b=w._EPSILON,c=this.accel(a+
b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.accel(a+b));return I.vecSubScaleInPlace(c,this.accel(a),1/b)};w.prototype.normal=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.normal&&null!==this.curve.normal)return this.curve.normal(this._getCoord(a));var b=w._EPSILON,c=this.tangent(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(c=this.tangent(a+-b));c=I.vecSubInPlace(c,this.tangent(a));return I.vecNormalizeInPlace(c)};w.prototype.tangent=
function(a){return I.vecNormalizeInPlace(this.velocity(a))};w.prototype.getLength=function(){var a=this.endPoints();return this.arcLength(a[1])};var ea=[.9969339225295955,.00825771143316837,0,.9815606342467192,.02303608403898155,.04717533638651112,.9505377959431213,.03891523046929952,0,.9041172563704749,.05369701760775668,.10693932599531891,.8435581241611533,.06725090705083998,0,.7699026741943047,.07992027533360173,.16007832854334625,.6840598954700559,.09154946829504924,0,.5873179542866175,.10164973227906016,
.20316742672306579,.4813394504781571,.11002260497764407,0,.3678314989981802,.11671205350175679,.23349253653835478,.24850574832046932,.12162630352394839,0,.1252334085114689,.12458416453615606,.24914704581340283,0,.12555689390547423,0];w.prototype.arcLength=function(a){if("undefined"!==typeof this.curveParam&&null!==this.curveParam&&this.curveParam instanceof w._ArcLengthParam)return a;if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.arcLength&&
null!==this.curve.arcLength)return this.curve.arcLength(this._getCoord(a));var b=this.endPoints();if(a===b[0])return 0;var c=this;return ga(function(a){return I.vecLength(c.velocity(a))},Math.min(a,b[0]),Math.max(a,b[0]),a>=b[0]?1:-1,0)};w.prototype.getPoints=function(a){if(0===a)return[];if(0>a)throw Error();for(var b=this.endPoints(),c=[this.evaluate(b[0])],d=1;d<a;d++){var e=this.evaluate(b[0]+d/(a-1)*(b[1]-b[0]));c.push(e)}return c};w.prototype.getPointsAsObjects=function(a){if(0===a)return[];
if(0>a)throw Error();for(var b=this.endPoints(),c=[ja(this.evaluate(b[0]))],d=1;d<a;d++){var e=this.evaluate(b[0]+d/(a-1)*(b[1]-b[0]));c.push(ja(e))}return c};w._ChangeEnds=function(a,b){this.u1=a;this.u2=b;this.getCoordinate=function(a){return a};this.endPoints=function(){return[this.u1,this.u2]}};w._FitRange=function(a,b,c){this.newEp1=b;this.newEp2=c;this.invNewEpDelta=1/(c-b);a=a.endPoints();this.origEp1=a[0];this.origEp2=a[1];this.getCoordinate=function(a){return this.origEp1+(this.origEp2-this.origEp1)*
(a-this.newEp1)*this.invNewEpDelta};this.endPoints=function(){return[b,c]}};w._ArcLengthParam=function(a){this.curve=a;this.ep=this.curve.endPoints();this.segments=[];a=this.ep[0];for(var b=0,c=this.curve.getLength(),c=Math.min(Math.max(10,Math.ceil(18*c)),50),d=1;d<=c;d++){var e=this.ep[0]+d/c*(this.ep[1]-this.ep[0]),f=this.curve.arcLength(e);this.segments.push([b,f,a,e]);a=e;b=f}this.length=0===this.segments.length?0:this.segments[this.segments.length-1][1];this._vecLength=function(a){for(var b=
0,c=0;c<a.length;c++)b+=a[c]*a[c];return Math.sqrt(b)};this._solveArcLength=function(a,b,c,d){for(var e=0;10>e;e++){var f=this.curve.arcLength(b)-a;if(1E-10>Math.abs(f)&&b>=c&&b<d)break;var g=this._vecLength(this.curve.velocity(b));if(0===g)break;var g=f/g,h=b-g;if(0===g)break;c!==Number.NEGATIVE_INFINITY&&d!==Number.POSITIVE_INFINITY?0>f?(c=Math.max(c,b),b=h,h>=d&&(b=c+.5*(d-c))):0<f&&(d=Math.min(d,b),b=h,h<=c&&(b=c+.5*(d-c))):b=h}return b}};w._ArcLengthParam.prototype.getCoordinate=function(a){var b,
c;if(a>this.length)return b=this.curve.endPoints(),c=b[0]+a/this.length*(b[1]-b[0]),this._solveArcLength(a,c,b[0],Number.POSITIVE_INFINITY);if(0>a)return b=this.curve.endPoints(),c=b[0]+a/this.length*(b[1]-b[0]),this._solveArcLength(a,c,Number.NEGATIVE_INFINITY,0);if(a===this.length)return b=this.curve.endPoints(),b[1];if(0===a)return b=this.curve.endPoints(),b[0];c=0;for(var d=this.segments.length,e=0;c<d;){e+=1;if(20<e)throw Error();var f=c+((d-c)/2|0);b=this.segments[f];if(a===b[0])return b[2];
if(a===b[1])return b[3];if(a>b[0]&&a<b[1])return c=b[2]+(a-b[0])/(b[1]-b[0])*(b[3]-b[2]),1E-10<=b[1]-b[0]?this._solveArcLength(a,c,b[2],b[3]):c;a<b[0]?d=f:c=f+1}throw Error("Internal error");};w._ArcLengthParam.prototype.endPoints=function(){return[0,this.length]};w.prototype.changeEnds=function(a,b){return new w(this,new w._ChangeEnds(a,b))};w.prototype.fitRange=function(a,b){return new w(this,new w._FitRange(this,a,b))};w.prototype.toArcLengthParam=function(){return new w(this,new w._ArcLengthParam(this))};
var R=function(a){this.surface="undefined"===typeof a?null:a};R._EPSILON=1E-5;R.prototype.tangent=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.tangent&&null!==this.surface.tangent)return this.surface.tangent(a,b);var c=R._EPSILON,d=this.evaluate(a+c,b);0===d[0]&&0===d[1]&&0===d[2]&&(c=-c,d=this.evaluate(a+c,b));return I.vecSubScaleInPlace(d,this.evaluate(a,b),1/c)};R.prototype.bitangent=function(a,b){if("undefined"!==typeof this.surface&&
null!==this.surface&&"undefined"!==typeof this.surface.bitangent&&null!==this.surface.bitangent)return this.surface.bitangent(a,b);var c=R._EPSILON,d=this.evaluate(a,b+c);0===d[0]&&0===d[1]&&0===d[2]&&(c=-c,d=this.evaluate(a,b+c));return I.vecSubScaleInPlace(d,this.evaluate(a,b),1/c)};R.prototype.normal=function(a,b){return I.vecNormalizeInPlace(this.gradient(a,b))};R.prototype.gradient=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.gradient&&
null!==this.surface.gradient)return this.surface.gradient(a,b);var c=this.tangent(a,b),d=this.bitangent(a,b);if(0===I.vecLength(d))return c;if(0!==I.vecLength(c)){if(3!==c.length||3!==d.length){var e=c.length,f=I.vecZeros(e),c=[c[0]||0,c[1]||0,c[2]||0],d=[d[0]||0,d[1]||0,d[2]||0],c=H3DU.Math.vec3cross(c,d);f[0]=c[0];f[1]=c[1];f[2]=c[2];return f.slice(0,e)}return H3DU.Math.vec3cross(c,d)}return d};R.prototype.evaluate=function(a,b){return"undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==
typeof this.surface.evaluate&&null!==this.surface.evaluate?this.surface.evaluate(a,b):[0,0,0]};R.prototype.endPoints=function(){return"undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.endPoints&&null!==this.surface.endPoints?this.surface.endPoints():[0,1,0,1]};var x=function(a,b,c,d){if("undefined"===typeof d||null===d)d=b;if("undefined"===typeof c||null===c)c=0;if(0>c||0>=b||0>=d)throw Error();this.buffer=a;this.offset=c;this.countPerValue=b;this.stride=d};
x.prototype.count=function(){var a=this.buffer.length-this.offset;return Math.floor(a/this.stride)+(a%this.stride>=this.countPerValue?1:0)};x.prototype.get=function(a){return this.buffer[this.offset+a*this.stride]};x.prototype.set=function(a,b){this.buffer[this.offset+a*this.stride]=b;return this};x.prototype.getVec=function(a,b){for(var c=this.offset+a*this.stride,d=this.buffer,e=0;e<this.countPerValue;e++)b[e]=d[c+e];return b};x.prototype.setVec=function(a,b){for(var c=this.offset+a*this.stride,
d=this.buffer,e=Math.min(b.length,this.countPerValue),f=0;f<e;f++)d[c+f]=b[f];return this};x.prototype.copy=function(){for(var a=this.count(),b=x.makeBlank(a,this.countPerValue),c=[],d=0;d<a;d++)this.getVec(d,c),b.setVec(d,c);return b};x.makeBlank=function(a,b){return new x(new Float32Array(new ArrayBuffer(a*b*4)),b)};x.makeIndices=function(a){var b;b=65536>a?new Uint16Array(new ArrayBuffer(2*a)):new Uint32Array(new ArrayBuffer(4*a));for(var c=0;c<a;c++)b[c]=c;return b};x.merge=function(a,b,c,d){var e;
e=Math.max("undefined"===typeof a||null===a?0:a.countPerValue,"undefined"===typeof c||null===c?0:c.countPerValue);var f=x.makeBlank(b.length+d.length,e),g=I.vecZeros(e);if("undefined"!==typeof a&&null!==a)for(e=0;e<b.length;e++)a&&a.getVec(b[e],g),f.setVec(e,g);if("undefined"!==typeof c&&null!==c)for(e=0;e<d.length;e++)c&&c.getVec(d[e],g),f.setVec(b.length+e,g);return f};var r=function(){this.format=H3DU.MeshBuffer.TRIANGLES;this.attributes=[];this.indices=this._bounds=null};r.prototype.getIndices=
function(){return this.indices};r.prototype.setIndices=function(a){if(a instanceof Array){for(var b=0,c=a.length-1;0<=c&&!(b=Math.max(b,a[c]),65536<=b);c--);this.indices=65536<=b?new Uint32Array(a):new Uint16Array(a)}else this.indices=a.slice(0,a.length);return this};r.prototype.setPrimitiveType=function(a){this.format=a;return this};r.prototype.setAttribute=function(a,b,c,d,e){return this.setAttributeEx(a,0,b,c,d,e)};r.prototype.setAttributeEx=function(a,b,c,d,e,f){var g;if(c instanceof x){if(c.buffer instanceof
x)throw Error();return this.setAttributeEx(a,b,c.buffer,c.countPerValue,c.offset,c.stride)}if("undefined"===typeof d||null===d)throw Error();g=c instanceof Array?new Float32Array(c):c;f="undefined"===typeof f||null===f?d:f;e="undefined"===typeof e||null===e?0:e;if(0>=d||0>=f||0>e)throw Error();b=r._resolveSemantic(a,b);if("undefined"===typeof b||null===b)return console.warn("Unsupported attribute semantic: "+a),this;a=b[0];b=b[1];var h=this.getAttribute(a,b);h?(h[2].buffer=c,h[2].offset=e,h[2].countPerValue=
d,h[2].stride=f):this.attributes.push([a,b,new x(g,d,e,f)]);this._bounds=null;return this};r.prototype._getAttributes=function(){return this.attributes};r.prototype.getAttribute=function(a,b){var c=r._resolveSemantic(a,b);if("undefined"===typeof c||null===c)return console.warn("Unsupported attribute semantic: "+a),null;for(var d=0;d<this.attributes.length;d++)if(this.attributes[d][0]===c[0]&&this.attributes[d][1]===c[1])return this.attributes[d][2];return null};r.prototype.vertexIndices=function(a,
b){var c=3,d=this.primitiveType();d===H3DU.MeshBuffer.LINES&&(c=2);d===H3DU.MeshBuffer.POINTS&&(c=1);if("undefined"===typeof this.indices||null===this.indices){d=a*c;if(d+c>this.vertexCount())throw Error();b[0]=d;2<=c&&(b[1]=d+1);3<=c&&(b[2]=d+2)}else d=a*c,b[0]=this.indices[d],2<=c&&(b[1]=this.indices[d+1]),3<=c&&(b[2]=this.indices[d+2]);return b};r.fromPositions=function(a){a=new Float32Array(a);return(new r).setAttribute("POSITION",a,3,0)};r.fromPositionsNormals=function(a){a=new Float32Array(a);
return(new r).setAttribute("POSITION",a,3,0,6).setAttribute("NORMAL",a,3,3,6)};r.fromPositionsNormalsUV=function(a){a=new Float32Array(a);return(new r).setAttribute("POSITION",a,3,0,8).setAttribute("NORMAL",a,3,3,8).setAttribute("TEXCOORD",a,2,6,8)};r.prototype.primitiveCount=function(){return this.format===H3DU.MeshBuffer.LINES?Math.floor(this.vertexCount()/2):this.format===H3DU.MeshBuffer.POINTS?this.vertexCount():Math.floor(this.vertexCount()/3)};r.prototype.getPositions=function(){var a=this.getAttribute(H3DU.Semantic.POSITION,
0);if(!a)return[];for(var b=[],c=[],d=this.primitiveCount(),e=0;e<d;e++){this.vertexIndices(e,c);for(var f=[],g=0;g<c.length;g++)f.push(a.getVec(c[g],[0,0,0]));b.push(f)}return b};r.prototype.normalizeNormals=function(){for(var a=0;a<this.attributes.length;a++){var b=this.attributes[a];if(b[0]===H3DU.Semantic.NORMAL)for(var c=[],d=b[2].count(),e=0;e<d;e++)b[2].getVec(e,c),I.vecNormalizeInPlace(c),b[2].setVec(e,c)}return this};r.prototype.reverseNormals=function(){for(var a=0;a<this.attributes.length;a++){var b=
this.attributes[a];if(b[0]===H3DU.Semantic.NORMAL)for(var c=[],d=b[2].count(),e=0;e<d;e++){b[2].getVec(e,c);for(var f=0;f<c.length;f++)c[f]=-c[f];b[2].setVec(e,c)}}return this};r.prototype.setColor3=function(a){return 3===arguments.length?this.setColor([arguments[0],arguments[1],arguments[2]]):this.setColor(a)};r.prototype.setColor=function(a){a=H3DU.toGLColor(a);for(var b=!1,c=0;c<this.attributes.length;c++){var d=this.attributes[c],e=d[2].count();if(d[0]===H3DU.Semantic.COLOR)for(var b=!0,f=0;f<
e;f++)d[2].setVec(f,a)}return b?this:(this._ensureAttribute(H3DU.Semantic.COLOR,0,3),this.setColor(a))};r.prototype.reverseWinding=function(){if(this.primitiveType()===H3DU.MeshBuffer.TRIANGLES){this._ensureIndices();for(var a=0;a+2<this.indices.length;a+=3){var b=this.indices[a+1];this.indices[a+1]=this.indices[a+2];this.indices[a+2]=b}}return this};r._recalcNormals=function(a,b,c,d,e){var f=e?-1:1;e={};var g=[],h,k=b.count(),l=Math.min(a.count(),k),p=[0,0,0],m=[0,0,0],v=[0,0,0],F=[0,0,0];for(h=
0;h<l;h++)if(b.setVec(h,p),!d){var n=a.getVec(h,[]);e[n]?e[n].push(h):e[n]=[h]}for(h=0;h<c.length;h+=3)p=a.getVec(c[h],p),m=a.getVec(c[h+1],m),v=a.getVec(c[h+2],v),l=H3DU.Math.vec3sub(p,v),n=H3DU.Math.vec3sub(m,v),l=H3DU.Math.vec3cross(l,n),H3DU.Math.vec3normalizeInPlace(l),H3DU.Math.vec3scaleInPlace(l,f),b.getVec(c[h],p),b.getVec(c[h+1],m),b.getVec(c[h+2],v),H3DU.Math.vec3addInPlace(p,l),H3DU.Math.vec3addInPlace(m,l),H3DU.Math.vec3addInPlace(v,l),b.setVec(c[h],p),b.setVec(c[h+1],m),b.setVec(c[h+
2],v);if(!d)for(var D in e)if(Object.prototype.hasOwnProperty.call(e,D)&&(d=e[D])&&d.constructor===Array&&2<=d.length){b.getVec(d[0],F);f=[F[0],F[1],F[2]];g[0]=F[0];g[1]=F[1];g[2]=F[2];c=3;for(h=1;h<d.length;h++){p=!1;a.getVec(d[h],F);m=F[0];v=F[1];l=F[2];for(n=0;n<c;n+=3)if(m===g[n]&&v===g[n+1]&&l===g[n+2]){p=!0;break}p||(g[c++]=m,g[c++]=v,g[c++]=l,H3DU.Math.vec3addInPlace(f,F))}for(h=0;h<d.length;h++)b.setVec(d[h],f)}for(h=0;h<k;h++)b.getVec(h,F),H3DU.Math.vec3normalize(F),b.setVec(h,F)};r._recalcTangentsInternal=
function(a,b,c,d,e,f){for(var g=[0,0,0],h=[0,0,0],k=[0,0,0],l=0;l<f.length;l+=3){var g=a.getVec(f[l],g),h=a.getVec(f[l+1],h),k=a.getVec(f[l+2],k),p;p=h[0]-g[0];var m=h[1]-g[1],v=h[2]-g[2],n=k[0]-g[0],t=k[1]-g[1],D=k[2]-g[2],g=c.getVec(f[l],g),h=c.getVec(f[l+1],h),k=c.getVec(f[l+2],k),q=h[0]-g[0],y=h[1]-g[1],r=k[0]-g[0],u=k[1]-g[1],w=q*u-y*r;0===w?p=[0,0,0,0,0,0]:(w=1/w,y=-y,r=-r,p=[(u*p+y*n)*w,(u*m+y*t)*w,(u*v+y*D)*w,(r*p+q*n)*w,(r*m+q*t)*w,(r*v+q*D)*w]);for(m=0;3>m;m++)v=p,g=b.getVec(f[l+m],g),n=
g[0],t=g[1],D=g[2],q=v[0]*n+v[1]*t+v[2]*D,q=H3DU.Math.vec3normalizeInPlace([v[0]-q*n,v[1]-q*t,v[2]-q*D]),u=v[3]*n+v[4]*t+v[5]*D,w=v[3]*q[0]+v[4]*q[1]+v[5]*q[2],v=H3DU.Math.vec3normalizeInPlace([v[3]-u*n-w*q[0],v[4]-u*t-w*q[1],v[5]-u*D-w*q[2]]),d.setVec(f[l+m],q),e.setVec(f[l+m],v)}};r.prototype._ensureIndices=function(){if("undefined"===typeof this.indices||null===this.indices)this.indices=x.makeIndices(this.vertexCount())};r.prototype._makeRedundant=function(){this._ensureIndices();for(var a=[],
b=0;b<this.attributes.length;b++){var c=this.attributes[b];a.push([c[0],c[1],x.merge(c[2],this.indices,null,[])])}this.attributes=a;this.setIndices(x.makeIndices(this.indices.length))};r.prototype._ensureAttribute=function(a,b,c){var d=this.getAttribute(a,b),e=0===this.attributes.length?0:this.attributes[0][2].count(),f="undefined"!==typeof d&&null!==d?d.countPerValue:0;if(d&&f>=c)return d;var g=x.makeBlank(e,c);if(0<f)for(c=I.vecZeros(c),f=0;f<e;f++)d.getVec(f,c),g.setVec(f,c);this.attributes.push([a,
b,g]);return g};r.prototype._countPerValue=function(a){a=this.getAttribute(a);return"undefined"!==typeof a&&null!==a?a.countPerValue:0};r.prototype.recalcNormals=function(a,b){if(this.primitiveType()===H3DU.MeshBuffer.TRIANGLES){if(3>this._countPerValue(H3DU.Semantic.POSITION))return this;this._makeRedundant();var c=this.getAttribute(H3DU.Semantic.POSITION),d=this._ensureAttribute(H3DU.Semantic.NORMAL,0,3);r._recalcNormals(c,d,this.indices,a,b)}return this};r.prototype._recalcTangents=function(){if(this.primitiveType()===
H3DU.MeshBuffer.TRIANGLES){if(3>this._countPerValue(H3DU.Semantic.POSITION)||3>this._countPerValue(H3DU.Semantic.NORMAL)||2>this._countPerValue(H3DU.Semantic.TEXCOORD))return this;this._makeRedundant();var a=this.getAttribute(H3DU.Semantic.POSITION),b=this.getAttribute(H3DU.Semantic.NORMAL),c=this.getAttribute(H3DU.Semantic.TEXCOORD),d=this._ensureAttribute(H3DU.Semantic.TANGENT,0,3),e=this._ensureAttribute(H3DU.Semantic.BITANGENT,0,3);r._recalcTangentsInternal(a,b,c,d,e,this.indices)}return this};
r.prototype.merge=function(a){var b=[],c;if(!a)throw Error();if(0===a.indices.length)return this;if(this.indices&&0===this.indices.length){for(var d=!0,e=0;e<this.attributes.length;e++)c=this.attributes[e][2],d=d&&("undefined"===typeof c||null===c||0===c.count());if(d){for(e=0;e<a.attributes.length;e++)c=a.attributes[e],b.push([c[0],c[1],c[2].copy()]);this._bounds=null;this.format=a.format;this.attributes=b;"undefined"===typeof a.indices||null===a.indices?(this.indices=null,this._ensureIndices()):
this.setIndices(a.indices.slice(0,a.indices.length));return this}}if(this.format!==a.format)throw Error();this._ensureIndices();a._ensureIndices();for(e=0;e<this.attributes.length;e++){var f=null;c=this.attributes[e];for(var d=c[0],g=c[1],h=0;h<a.attributes.length;h++){var k=a.attributes[h];if(k[0]===d&&k[1]===g){f=k[2];break}}c=x.merge(c[2],this.indices,f,a.indices);if(!c)throw Error();b.push([d,g,c])}for(e=0;e<a.attributes.length;e++){f=null;k=a.attributes[e];for(h=0;h<this.attributes.length;h++)if(c=
this.attributes[h],k[0]===c[0]&&k[1]===c[1]){f=c;break}if("undefined"===typeof f||null===f){c=x.merge(null,this.indices,k[2],a.indices);if(!c)throw Error();b.push([k[0],k[1],c])}}a=x.makeIndices(this.indices.length+a.indices.length);this._bounds=null;this.attributes=b;this.setIndices(a);return this};r.prototype.transform=function(a){var b=this.getAttribute(H3DU.Semantic.POSITION);if(!b)return this;var c=this.getAttribute(H3DU.Semantic.NORMAL),d=!(1===a[0]&&0===a[1]&&0===a[2]&&0===a[4]&&1===a[5]&&
0===a[6]&&0===a[8]&&0===a[9]&&1===a[10]),e=null;"undefined"!==typeof c&&null!==c&&d&&(e=H3DU.Math.mat4inverseTranspose3(a));var f=b.count();c&&(f=Math.min(f,c.count()));for(var g=[0,0,0],h=[0,0,0],k=0;k<f;k++){b.getVec(k,g);var l=H3DU.Math.mat4projectVec3(a,g[0],g[1],g[2]);b.setVec(k,l);c&&d&&"undefined"!==typeof e&&null!==e&&(c.getVec(k,h),l=H3DU.Math.mat3transform(e,h[0],h[1],h[2]),H3DU.Math.vec3normalizeInPlace(l),c.setVec(k,l))}this._bounds=null;return this};r._addLine=function(a,b,c,d){if(c<
d){var e=c;c=d;d=e}(e=b[c])?0>e.indexOf(d)&&(e.push(d),a.push(c,d)):(b[c]=[d],a.push(c,d))};r.prototype.toWireFrame=function(){return(new r).merge(this).wireFrame()};r.prototype.wireFrame=function(){if(this.primitiveType()!==H3DU.MeshBuffer.TRIANGLES)return this;for(var a=[],b={},c=[],d=this.primitiveCount(),e=0;e<d;e++){this.vertexIndices(e,c);var f=c[0],g=c[1],h=c[2];r._addLine(a,b,f,g);r._addLine(a,b,g,h);r._addLine(a,b,h,f)}return this.setIndices(a).setPrimitiveType(H3DU.MeshBuffer.LINES)};r.prototype.getBounds=
function(){if(!this._bounds){var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this.getAttribute(H3DU.Semantic.POSITION,0);if(!c)return b;for(var d=[],e=[0,0,0],f=this.primitiveCount(),g=0;g<f;g++){this.vertexIndices(g,d);for(var h=0;h<d.length;h++){var k=c.getVec(d[h],e);a?(a=!1,b[0]=b[3]=k[0],b[1]=b[4]=k[1],b[2]=b[5]=k[2]):(b[0]=Math.min(b[0],k[0]),b[3]=Math.max(b[3],k[0]),b[1]=Math.min(b[1],k[1]),b[4]=Math.max(b[4],k[1]),b[2]=Math.min(b[2],k[2]),b[5]=Math.max(b[5],k[2]))}b.push([])}this._bounds=
b.slice(0,6);return b}return this._bounds.slice(0,6)};r.prototype.primitiveType=function(){return this.format};r.prototype.vertexCount=function(){if("undefined"===typeof this.indices||null===this.indices){for(var a=0,b=0;b<this.attributes.length;b++){var c=this.attributes[b];if(0===b||c.count()<a)a=c.count()}return a}return this.indices.length};r._resolveSemantic=function(a,b){if("number"===typeof a)return[a,b|0];var c=r._wellKnownAttributes[a];if("undefined"===typeof c||null===c){var d=a.indexOf("_");
if(0>d)return null;c=r._wellKnownAttributes[a.substr(0,d)];if("undefined"===typeof c||null===c)return null;d=a.substr(d+1);return 5>=d.length&&/^\d$/.test(d)?[c,parseInt(d,10)]:null}return[c,0]};r.LINES=1;r.TRIANGLES=4;r.POINTS=0;r._wellKnownAttributes={POSITION:0,TEXCOORD:2,TEXCOORD_0:2,NORMAL:1,COLOR:3,JOINT:4,WEIGHT:5,JOINTS:4,WEIGHTS:5,TANGENT:6,BITANGENT:7};var T={POSITION:0,NORMAL:1,TEXCOORD:2,COLOR:3,JOINT:4,WEIGHT:5,TANGENT:6,BITANGENT:7,CUSTOM:8,MODEL:101,VIEW:102,PROJECTION:103,MODELVIEW:104,
MODELVIEWPROJECTION:105,MODELVIEWINVERSETRANSPOSE:106,VIEWINVERSE:107,JOINTMATRIX:108},B=function(){this.attributes=[];this.vertexCount=0;this.indices=[];this.mode=r.TRIANGLES},O=function(){this.attributes=[];this.vertexCount=0;this.indices=[];this.mode=r.TRIANGLES};B._toMeshBuffer=function(a,b,c){for(var d=0,e=b.length-1;0<=e&&!(d=Math.max(d,b[e]),65536<=d);e--);var f=new r,e=65536>d?new Uint16Array(b):new Uint32Array(b);f.setPrimitiveType(c);f.setIndices(e);for(e=0;e<a.length;e++)c=a[e],f.setAttributeEx(c[0],
c[1],c[3],c[2]);return f};B._blank=function(a){for(var b=[],c=0;c<a;c++)b.push(0);return b};B._resize=function(a,b){if(a[2]!==b){for(var c=a[3].length/a[2],d=Math.min(a[2],b),e=B._blank(c*b),f=0,g=0,h=0;h<c;h++){for(var k=0;k<d;k++)e[g+k]=a[3][f+k];f+=a[2];g+=b}a[2]=b;a[3]=e}};B._addValue=function(a,b){for(var c=Math.min(b.length,a[2]),d=0;d<c;d++)a[3].push(b[d]);for(d=c;d<a[2];d++)a[3].push(0)};B._defaultEndPointsCurve=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(c[0]===T.POSITION&&0===
c[1]){a=c[4];if("undefined"!==typeof a.endPoints&&null!==a.endPoints)return c[4].endPoints();break}}return[0,1]};B._defaultEndPointsSurface=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(c[0]===T.POSITION&&0===c[1]){a=c[4];if("undefined"!==typeof a&&null!==a&&"undefined"!==typeof a.endPoints&&null!==a.endPoints)return c[4].endPoints();break}}return[0,1,0,1]};B._setAttribute=function(a,b,c,d,e,f){var g="undefined"===typeof f||null===f?3:f,h="undefined"!==typeof c&&null!==c;if(0>=f)throw Error("Invalid attribute size");
d=r._resolveSemantic(d,"undefined"===typeof e||null===e?0:e);if("undefined"===typeof d||null===d)throw Error();for(e=0;e<a.length;e++)if(f=a[e],f[0]===d[0]&&f[1]===d[1]){h?(f[4]=c,B._resize(f,g)):a.splice(e,1);return}h&&(b=[d[0],d[1],g,B._blank(g*b),c],a.push(b))};B._NormalSurface=function(a){this.surface=new R(a);this.endPoints=function(){return this.surface.endPoints()};this.evaluate=function(a,c){return this.surface.normal(a,c)}};B.prototype.clearVertices=function(){this.vertexCount=0;this.indices=
[];for(var a=0;a<this.attributes.length;a++)this.attributes[a][3]=[];return this};B.prototype.toMeshBuffer=function(){return B._toMeshBuffer(this.attributes,this.indices,this.mode)};B.prototype.position=function(a,b){return this.attribute(a,T.POSITION,0,b)};B.prototype.attribute=function(a,b,c,d){B._setAttribute(this.attributes,this.vertexCount,a,b,c,d);return this};B.prototype.constantAttribute=function(a,b,c,d){return"number"===typeof a?this.attribute({evaluate:function(){return[a]}},b,c,1):this.attribute({evaluate:function(){return a}},
b,c,a.length)};B.curveToBuffer=function(a,b,c,d,e){return(new B).position(a,3).evalCurve(b,c,d,e).toMeshBuffer()};O.prototype.clearVertices=function(){this.vertexCount=0;this.indices=[];for(var a=0;a<this.attributes.length;a++)this.attributes[a][3]=[];return this};O.prototype.toMeshBuffer=function(){return B._toMeshBuffer(this.attributes,this.indices,this.mode)};O.prototype.position=function(a,b){return this.attribute(a,T.POSITION,0,b)};O.prototype.texCoord=function(a,b){return this.attribute(a,T.TEXCOORD,
0,"undefined"===typeof b||null===b?2:b)};O.prototype.positionNormal=function(a,b){var c="undefined"!==typeof a&&null!==a?new B._NormalSurface(a):null;return this.attribute(a,T.POSITION,0,b).attribute(c,T.NORMAL,0,b)};O._TexCoord=function(a){a=(new R(a)).endPoints();this.u1=a[0];this.v1=a[2];this.uinv=a[0]===a[1]?0:1/(a[1]-a[0]);this.vinv=a[2]===a[3]?0:1/(a[3]-a[2]);this.evaluate=function(a,c){return[(a-this.u1)*this.uinv,(c-this.v1)*this.vinv]}};O.prototype.positionTexCoord=function(a,b){var c="undefined"!==
typeof a&&null!==a?new O._TexCoord(a):null;return this.attribute(a,T.POSITION,0,b).attribute(c,T.TEXCOORD,0,2)};O.prototype.positionNormalTexCoord=function(a,b){return this.positionNormal(a,b).positionTexCoord(a,b)};O.prototype.attribute=function(a,b,c,d){B._setAttribute(this.attributes,this.vertexCount,a,b,c,d);return this};O.prototype.constantAttribute=function(a,b,c){return"number"===typeof a?this.attribute({evaluate:function(){return[a]}},b,c,1):this.attribute({evaluate:function(){return a}},
b,c,a.length)};O.surfaceToBuffer=function(a,b,c,d,e,f,g,h){return(new O).positionNormalTexCoord(a,3).evalSurface(b,c,d,e,f,d,h).toMeshBuffer()};B.prototype.evalCurve=function(a,b,c,d){b="undefined"===typeof b||null===b?24:Math.ceil(b);if(0===b)return this;if(0>b)throw Error();if("undefined"===typeof a||null===a)a=r.LINES;if("undefined"===typeof c||null===c||"undefined"===typeof d||null===d)d=B._defaultEndPointsCurve(this.attributes),c=d[0],d=d[1];var e=(d-c)/b,f=this.vertexCount;if(a===r.LINES||"undefined"===
typeof a||null===a){for(d=0;d<b;d++)this.indices.push(f+d,f+d+1);this.vertexCount+=b+1}else if(a===r.POINTS){for(d=0;d<b;d++)this.indices.push(f+d);this.vertexCount+=b+1}else return this;this.mode=a;for(d=0;d<=b;d++)for(a=c+d*e,f=0;f<this.attributes.length;f++){var g=this.attributes[f],h="undefined"!==typeof g[4]&&null!==g[4]?g[4].evaluate(a):[];B._addValue(g,h)}return this};O.prototype.evalSurface=function(a,b,c,d,e,f,g){b="undefined"===typeof b||null===b?24:Math.ceil(b);c="undefined"===typeof c||
null===c?24:Math.ceil(c);if(0===b||0===c)return this;if(0>=b)throw Error();if(0>=c)throw Error();if("undefined"===typeof a||null===a)a=r.TRIANGLES;if("undefined"===typeof d||null===d||"undefined"===typeof e||null===e||"undefined"===typeof f||null===f||"undefined"===typeof g||null===g)g=B._defaultEndPointsSurface(this.attributes),d=g[0],e=g[1],f=g[2],g=g[3];if(a!==r.TRIANGLES&&a!==r.LINES&&a!==r.POINTS)return this;var h,k,l,p=(e-d)/b,m=(g-f)/c;e=this.vertexCount;this.vertexCount+=(c+1)*(b+1);for(g=
0;g<=c;g++)for(l=0;l<=b;l++){h=l*p+d;k=g*m+f;for(var v=0;v<this.attributes.length;v++){var n=this.attributes[v],t="undefined"!==typeof n[4]&&null!==n[4]?n[4].evaluate(h,k):[];B._addValue(n,t)}}this.mode=a;if(a===r.TRIANGLES)for(a=b+1,g=0;g<c;g++)for(l=0;l<b;l++)p=g*a+l+e,d=p+a,f=p+1,h=d+1,this.indices.push(p,d,f),this.indices.push(f,d,h);else if(a===r.POINTS)for(b=this.vertexCount,g=e;g<b;g++)this.indices.push(g);else if(a===r.LINES)for(a=b+1,g=0;g<=b;g++)for(l=0;l<=c;l++)d=l*a+g+e,l<c&&(f=d+a,this.indices.push(d,
f)),g<b&&(f=d+1,this.indices.push(f,d));return this};u.prototype=Object.create(w.prototype);u.prototype.constructor=u;u.DIVIDE_BIT=2;u._checkKnots=function(a,b){for(var c=1;c<a.length;c++)if(a[c]<a[c-1])throw Error();for(c=1;c<a.length-2-b;c++)if(a[c+b]<=a[c])throw Error();if(a[0]===a[a.length-1]||a[0]>=a[b+1])throw Error();if(a[a.length-2-b]>=a[a.length-1])throw Error();if(b+1>=a.length)throw Error();};u._nfunc=function(a,b,c,d){if(0===b)return d[a]<=c&&c<d[a+1]?1:0;if(d[a]>c||d[a]===d[a+b]&&d[a+
b+1]===d[a+1]||d[a+b+1]<c)return 0;var e=d[a]===d[a+b]?0:u._nfunc(a,b-1,c,d),f=d[a+b+1]===d[a+1]?0:u._nfunc(a+1,b-1,c,d);if(0===e+f)return 0;var g=0;if(0!==e)var h=d[a+b]-d[a],g=g+(c-d[a])*e*(0===h?1:1/h);0!==f&&(h=d[a+b+1]-d[a+1],g+=(d[a+b+1]-c)*f*(0===h?1:1/h));return g};u._getFactors=function(a,b,c,d,e){for(var f=1,g=1,h=0;h<d;h++)e[h]=0;for(h=1;h<a.length;h++)if(a[h]===a[0])f+=1;else break;for(h=a.length-2;0<=h;h--)if(a[h]===a[a.length-1])g+=1;else break;if(b>=a[a.length-1-c]&&a[a.length-1-c]===
a[a.length-1])e[d-1]=1;else if(f!==c+1||g!==c+1)for(h=0;h<d;h++)e[h]=u._nfunc(h,c,b,a);else if(b<=a[c])e[0]=1;else if(b>=a[a.length-1-c])e[d-1]=1;else{d=-1;for(h=0;h<=a.length;h++)if(a[h]<=b&&b<a[h+1]){d=h;break}if(!(0>d))for(var f=a[d+1]-b,g=a[d],k=b-g,l=e[d]=1;l<=c;l++){e[d-l]=e[d-l+1]*f/(a[d+1]-a[d-l+1]);for(h=d-l+1;h<d;h++){var p=a[h];e[h]*=(b-p)/(a[h+l]-p);e[h]+=e[h+1]*(a[h+l+1]-b)/(a[h+l+1]-a[h+1])}e[d]*=k/(a[d+l]-g)}}};u.prototype.evaluate=function(a){var b=[];if(this.fastBezier){var c=this.controlPoints;
switch(c.length){case 1:b=c[0].slice(0,c[0].length);break;case 2:for(var d=c[0].length,b=[],e=c[0],c=c[1],f=0;f<d;f++){var g=e[f];b[f]=g+(c[f]-g)*a}break;case 3:d=c[0].length;b=[];e=c[0];f=c[1];c=c[2];for(g=0;g<d;g++)b[g]=((a-2)*a+1)*e[g]+(-2*a+2)*a*f[g]+a*a*c[g];break;case 4:for(var d=c[0].length,b=[],e=c[0],f=c[1],g=c[2],c=c[3],h=0;h<d;h++)b[h]=(((3-a)*a-3)*a+1)*e[h]+((3*a-6)*a+3)*a*f[h]+(-3*a+3)*a*a*g[h]+a*a*a*c[h]}}else if(e=this.controlPoints.length,c=this.knots.length-e-1,d=this.controlPoints[0].length,
b=null,a<=this.knots[c]?this.knots[c]===this.knots[0]?b=this.controlPoints[0].slice(0,d):a=this.knots[c]:a>=this.knots[this.knots.length-1-c]&&(this.knots[this.knots.length-1-c]===this.knots[this.knots.length-1]?b=this.controlPoints[e-1].slice(0,d):a=this.knots[this.knots.length-1-c]),"undefined"===typeof b||null===b){h=0;b=-1;for(e=0;e<this.knots.length;e++)if(f=this.knots[e],(g=a===f)&&h++,f<this.knots[e+1])if(g){b=e;break}else if(f<a&&a<this.knots[e+1]){b=e;break}if(0>b)throw Error();if(h>c)throw Error();
if(h===c)b=this.controlPoints[b-c].slice(0,d);else{f=c-h;g=[];for(e=b-c;e<=b-h;e++)g.push(this.controlPoints[e]);for(h=1;h<=f;h++)for(var k=g[h-1],e=h;e<g.length;e++){for(var l=b-c+e,p=this.knots[l],l=(a-p)/(this.knots[l+c-h+1]-p),p=g[e],m=[],v=0;v<d;v++)m[v]=k[v]*(1-l)+p[v]*l;g[e]=m;k=p}b=g[g.length-1].slice(0,d)}}0!==(this.bits&u.DIVIDE_BIT)&&(b=u._fromHomogen(b));return b};u._splitKnots=function(a,b,c){for(var d=-1,e=-1,f=[],g=[],h=0;h<a.length;h++)if(a[h]>c){e=h;break}else a[h]<c&&(d=h);if(0>
d||0>e)throw Error();for(h=0;h<=d;h++)f.push(a[h]);for(h=0;h<b+1;h++)f.push(c),g.push(c);for(h=e;h<a.length;h++)g.push(a[h]);return[f,g]};u.prototype.split=function(a){var b=this.controlPoints.length,c=this.knots.length-b-1,d=this.controlPoints[0].length,e;if(a<=this.knots[c])return[null,this];if(a>=this.knots[this.knots.length-1-c])return[this,null];var f=0,g=-1;for(e=0;e<this.knots.length;e++){var h=this.knots[e],k=a===h;k&&f++;if(h<this.knots[e+1])if(k){g=e;break}else if(h<a&&a<this.knots[e+1]){g=
e;break}}if(0>g)throw Error();if(f>c)throw Error();var h=u._splitKnots(this.knots,c,a),l,k=[];if(f===c)l=this.controlPoints.slice(0,g-c+1),k=this.controlPoints.slice(g-c,this.controlPoints.length);else{var p=c-f,m=[];for(e=g-c;e<=g-f;e++)m.push(this.controlPoints[e]);l=[];for(e=0;e<=g-c;e++)l.push(this.controlPoints[e]);for(var v=[],n=1;n<=p;n++){var t=m[n-1];for(e=n;e<m.length;e++){for(var D=g-c+e,q=this.knots[D],D=(a-q)/(this.knots[D+c-n+1]-q),q=m[e],y=[],r=0;r<d;r++)y[r]=t[r]*(1-D)+q[r]*D;m[e]=
y;t=q;e===n?l.push(y):e+1===m.length&&v.push(y)}}k.push(l[l.length-1]);for(e=v.length-1;0<=e;e--)k.push(v[e]);for(e=g-f;e<b;e++)k.push(this.controlPoints[e])}a=new u(l,h[0],this.bits);b=new u(k,h[1],this.bits);return[a,b]};u.prototype.endPoints=function(){var a=this.knots.length-this.controlPoints.length-1;return[this.knots[a],this.knots[this.knots.length-1-a]]};u.prototype.getControlPoints=function(){return this.controlPoints};u.prototype.getKnots=function(){return this.knots};u.prototype.velocity=
function(a){var b=[];if(this.fastBezier){var c=this.controlPoints;switch(c.length){case 1:b=I.vecZeros(c[0].length);break;case 2:b=I.vecSub(c[1],c[0]);break;case 3:for(var b=c[0].length,d=[],e=c[0],f=c[1],c=c[2],g=0;g<b;g++)d[g]=(2*a-2)*e[g]+(-4*a+2)*f[g]+2*a*c[g];b=d;break;case 4:for(var b=c[0].length,d=[],e=c[0],f=c[1],g=c[2],c=c[3],h=0;h<b;h++)d[h]=((-3*a+6)*a-3)*e[h]+((9*a-12)*a+3)*f[h]+(-9*a+6)*a*g[h]+3*a*a*c[h];b=d}}else{c=this.controlPoints.length;e=this.knots.length-c-1;d=this.controlPoints[0].length;
u._getFactors(this.knots,a,e-1,c,this.buffer);f=[];for(g=0;g<c;g++)f[g]=0;for(a=0;a<c-1;a++)g=e*this.buffer[a+1]/(this.knots[a+e+1]-this.knots[a+1]),f[a+1]+=g,f[a]-=g;for(g=0;g<d;g++){for(a=e=0;a<c;a++)e+=f[a]*this.controlPoints[a][g];b[g]=e}}0!==(this.bits&u.DIVIDE_BIT)&&(b=u._fromHomogen(b));return b};u._fromHomogen=function(a){for(var b=a.length,c=1/a[b-1],d=0;d<b-1;d++)a[d]*=c;return a=a.slice(0,b-1)};K.prototype=Object.create(R.prototype);K.prototype.constructor=K;u.clamped=function(a,b,c){return new u(a,
u.clampedKnots(a.length,b),c)};u.fromBezierCurve=function(a,b){return u.clamped(a,a.length-1,b)};u.uniform=function(a,b,c){return new u(a,u.uniformKnots(a.length,b),c)};K.clamped=function(a,b,c,d){return new K(a,u.clampedKnots(a[0].length,b),u.clampedKnots(a.length,c),d)};K.uniform=function(a,b,c,d){return new K(a,u.uniformKnots(a[0].length,b),u.uniformKnots(a.length,c),d)};u.uniformKnots=function(a,b){"object"===typeof a&&(a=a.length);var c="undefined"===typeof b||null===b?3:b;if(a<c+1)throw Error("too few control points for degree "+
c+" curve");for(var c=c+1,d=[],e=1/(a+c-1),f=0;f<a+c;f++)d.push(f*e);return d};u.clampedKnots=function(a,b){"object"===typeof a&&(a=a.length);var c="undefined"===typeof b||null===b?3:b;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var c=c+1,d=a-c,e=[],f=0;f<c;f++)e.push(0);for(f=0;f<d;f++)e.push(1*(f+1)/(d+1));for(f=0;f<c;f++)e.push(1);return e};K.prototype.evaluate=function(a,b){var c=this.controlPoints[0][0].length,d=this.bufferU,e=this.bufferV,f,g,h,k;u._getFactors(this.knotsU,
a,this.degreeU,this.ucplen,this.bufferU);u._getFactors(this.knotsV,b,this.degreeV,this.vcplen,this.bufferV);var l=[];for(h=0;h<c;h++){for(f=k=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)k+=this.controlPoints[g][f][h]*d[f]*e[g];l[h]=k}0!==(this.bits&u.DIVIDE_BIT)&&(l=u._fromHomogen(l));return l};K.prototype.getControlPoints=function(){return this.controlPoints};K.prototype.getKnots=function(){return this.knots};K.prototype.tangent=function(a,b){var c=this.controlPoints[0][0].length,d=this.bufferV,
e,f,g,h;u._getFactors(this.knotsU,a,this.degreeU-1,this.ucplen,this.bufferU);u._getFactors(this.knotsV,b,this.degreeV,this.vcplen,this.bufferV);var k=[],l=[];for(g=0;g<this.ucplen;g++)l[g]=0;for(e=0;e<this.ucplen-1;e++)f=this.degreeU*this.bufferU[e+1]/(this.knotsU[e+this.degreeU+1]-this.knotsU[e+1]),l[e+1]+=f,l[e]-=f;for(g=0;g<c;g++){for(e=h=0;e<this.ucplen;e++)for(f=0;f<this.vcplen;f++)h+=this.controlPoints[f][e][g]*l[e]*d[f];k[g]=h}0!==(this.bits&u.DIVIDE_BIT)&&(k=u._fromHomogen(k));return k};K.prototype.bitangent=
function(a,b){var c=this.controlPoints[0][0].length,d=this.bufferU,e,f,g,h;u._getFactors(this.knotsU,a,this.degreeU,this.ucplen,this.bufferU);u._getFactors(this.knotsV,b,this.degreeV-1,this.vcplen,this.bufferV);var k=[],l=[];for(g=0;g<this.vcplen;g++)l[g]=0;for(e=0;e<this.vcplen-1;e++)f=this.degreeV*this.bufferV[e+1]/(this.knotsV[e+this.degreeV+1]-this.knotsV[e+1]),l[e+1]+=f,l[e]-=f;for(g=0;g<c;g++){for(e=h=0;e<this.ucplen;e++)for(f=0;f<this.vcplen;f++)h+=this.controlPoints[f][e][g]*d[e]*l[f];k[g]=
h}0!==(this.bits&u.DIVIDE_BIT)&&(k=u._fromHomogen(k));return k};K.fromBezierSurface=function(a,b){return K.clamped(a,a[0].length-1,a.length-1,b)};var J=function(a){this.curves=[];this.curvesEp=[];this.runningCurveStart=[];for(var b=0;b<a.length;b++)this.curves[b]=a[b]instanceof w?a[b]:new w(a[b]),this.curvesEp[b]=this.curves[b].endPoints(),this.runningCurveStart[b]=0===b?0:Number.NaN};J.prototype=Object.create(w.prototype);J.prototype.constructor=J;J.prototype.endPoints=function(){return[0,this.curves.length]};
J.prototype.getCurves=function(){return this.curves};J.prototype._getRunningCurveStart=function(a){if(0===a)return 0;if(isNaN(this.runningCurveStart[a]))for(var b=1;b<=a;b++)isNaN(this.runningCurveStart[b])&&(this.runningCurveStart[b]=this.runningCurveStart[b-1]+this.curves[b-1].arcLength(this.curvesEp[b-1][1]));return this.runningCurveStart[a]};J.prototype._getCurveAndPoint=function(a){var b;0>a?a=b=0:a>=this.curves.length?(b=this.curves.length-1,a=1):(b=Math.floor(a),a-=b);var c=this.curvesEp[b];
return[b,c[0]+(c[1]-c[0])*a]};J.prototype.arcLength=function(a){if(0>=a)return 0;a=this._getCurveAndPoint(a);return this._getRunningCurveStart(a[0])+this.curves[a[0]].arcLength(a[1])};J.prototype.evaluate=function(a){a=this._getCurveAndPoint(a);return this.curves[a[0]].evaluate(a[1])};J.prototype.velocity=function(a){a=this._getCurveAndPoint(a);return this.curves[a[0]].velocity(a[1])};J.fromTCBSpline=function(a,b,c,d,e,f){var g=a[0].length;if(2>a.length)throw Error();b="undefined"===typeof b||null===
b?0:b;c="undefined"===typeof c||null===c?0:c;d="undefined"===typeof d||null===d?0:d;e="undefined"===typeof e||null===e?!1:e;f="undefined"===typeof f||null===f?!1:f;for(var h=1/3,k=[],l=a.length-1,p=e?l+1:l,m=0;m<p;m++){var v=[[],[],[],[]],n=m>l?a[0]:a[m],t,D,q;e?0===m?(D=a[l],t=a[m+1],q=2===a.length?a[0]:a[m+2]):m===l-1?(D=a[m-1],t=a[m+1],q=a[0]):m===l?(D=a[m-1],t=a[0],q=a[1]):(D=a[m-1],t=a[m+1],q=a[m+2]):(t=a[m+1],D=0===m?null:a[m-1],q=m>=l?null:a[m+2]);for(var y=1-c,r=1+c,w=1-d,E=1+d,B=1-b,A=0;A<
g;A++){var z=n[A],C=t[A],x=t[A]-n[A],G=.5*B*r*E*("undefined"===typeof D||null===D?0:n[A]-D[A])+.5*B*y*w*x,x=.5*B*y*E*x+.5*B*r*w*("undefined"===typeof q||null===q?0:q[A]-t[A]);if(!f){if("undefined"===typeof D||null===D)G=0;if("undefined"===typeof q||null===q)x=0}G=z+G*h;x=C-x*h;v[0][A]=z;v[1][A]=G;v[2][A]=x;v[3][A]=C}k.push(u.clamped(v,3))}return new J(k)};J.fromHermiteSpline=function(a){var b=a[0].length;if(4>a.length||0!==a.length%2)throw Error();for(var c=1/3,d=[],e=0;e<a.length-2;e+=2){for(var f=
[[],[],[],[]],g=a[e],h=a[e+1],k=a[e+2],l=a[e+3],p=0;p<b;p++){var m=g[p],v=k[p],n=m+h[p]*c,t=v-l[p]*c;f[0][p]=m;f[1][p]=n;f[2][p]=t;f[3][p]=v}d.push(u.clamped(f,3))}return new J(d)};J.fromCatmullRomSpline=function(a,b,c){var d=a[0].length;if(2>a.length)throw Error();b="undefined"===typeof b||null===b?.5:b;c="undefined"===typeof c||null===c?!1:c;for(var e=[],f=a.length-1,g=c?f+1:f,h=0;h<g;h++){var k=[[],[],[],[]],l=0===h?a[0]:a[h-1],p=a[h],m=a[h+1],v=h+2>f?a[f]:a[h+2];if(!c&&h+2>f){for(var n=[],t=0;t<
d;t++)n[t]=l[t]+(p[t]-m[t]);v=n}if(!c&&0===h){n=[];for(t=0;t<d;t++)n[t]=v[t]+(m[t]-p[t]);l=n}c&&(0===h?(l=a[f],v=2===a.length?a[0]:a[h+2]):h===f-1?v=a[0]:h===f&&(m=a[0],v=a[1]));for(var q=n=0,r=0,t=0;t<d;t++)var y=l[t]-p[t],n=n+y*y,y=p[t]-m[t],q=q+y*y,y=m[t]-v[t],r=r+y*y;n=Math.sqrt(n);q=Math.sqrt(q);r=Math.sqrt(r);for(t=0;t<d;t++){var y=l[t],w=p[t],B=m[t],E=v[t],x=1,A=1,z=1;0!==b&&(x=Math.pow(n,b),A=Math.pow(q,b),z=Math.pow(r,b));var C,G=w,I=B;C=3*x*(x+A);0!==C&&(G=(x*x*B-A*A*y+w*(2*x*x+3*x*A+A*
A))/C);C=3*z*(z+A);0!==C&&(I=(z*z*w-A*A*E+B*(2*z*z+3*z*A+A*A))/C);k[0][t]=w;k[1][t]=G;k[2][t]=I;k[3][t]=B}e.push(u.clamped(k,3))}return new J(e)};J.fromEllipseArc=function(a,b,c,d,e,f){if("undefined"===typeof e||null===e)e=0;if("undefined"===typeof f||null===f)f=0;var g=f;f=0>f?-1:1;for(var h=g>.5*Math.PI&&g<=2*Math.PI?.25*g:.5*Math.PI,k=[];0<g;){var l=Math.min(h,g),p=e+l*f,m = Math.cos(e),v = (e>=0 && e<6.283185307179586) ? (e<=3.141592653589793 ? Math.sqrt(1.0-m*m) : -Math.sqrt(1.0-m*m)) : Math.sin(e),n = Math.cos(p),p = (p>=0 && p<6.283185307179586) ? (p<=3.141592653589793 ? Math.sqrt(1.0-n*n) : -Math.sqrt(1.0-n*n)) : Math.sin(p),g=g-l;e+=l*f;var m=[m,v,1],n=[n,p,1],l=Math.sin(.5*(Math.PI-l)),v=m[0]+
.5*(n[0]-m[0]),p=m[1]+.5*(n[1]-m[1]),t=1/Math.sqrt(v*v+p*p),q=1/l,v=[v*t*q,p*t*q,l];m[0]=a+m[0]*c;m[1]=b+m[1]*d;n[0]=a+n[0]*c;n[1]=b+n[1]*d;v[0]=(a+v[0]*c)*l;v[1]=(b+v[1]*d)*l;k.push(H3DU.BSplineCurve.fromBezierCurve([m,v,n],H3DU.BSplineCurve.DIVIDE_BIT))}return new H3DU.PiecewiseCurve(k)};var ca=function(a){this.data=a;this.next=this.prev=null},fa=function(){this._last=this.root=null;this.size=function(){for(var a=this.root,b=0;a;)b++,a=a.next;return b};this.first=function(){return this.root};this.last=
function(){return this._last};this.front=function(){return this.root?this.root.data:null};this.back=function(){return this._last?this._last.data:null};this.clear=function(){this.root=this._last=null};this.spliceToBegin=function(a){a.root&&(this.root.prev=a._last,a._last.next=this.root,this.root=a.root,a.clear())};this.spliceToEnd=function(a){a.root&&(this._last.next=a.root,a.root.prev=this._last,this._last=a._last,a.clear())};this.spliceOneToEnd=function(a,b){a.erase(b);return this.push(b.data)};
this.erase=function(a){if(!a)return this;a===this.root&&(this.root=a.next);a===this._last&&(this._last=a.prev);a.prev&&(a.prev.next=a.next);a.next&&(a.next.prev=a.prev);return this};this.insertAfter=function(a,b){var c=new ca(a);b===this._last&&(this._last=c);var d=b.next;b.next=c;c.prev=b;if(c.next=d)d.prev=c;return c};this.push=function(a){this.root?(a=new ca(a),this._last.next=a,a.prev=this._last,this._last=a):this.root=this._last=new ca(a);return this};this.reverse=function(){var a=this.root,
b=this._last;if(a){for(var c=a;a;){var d=a.next,e=a.prev;a.prev=d;a.next=e;a=d}this.root=b;this._last=c;return this}};this.unshift=function(a){this.root?(a=new ca(a),this.root.prev=a,a.next=this.root,this.root=a):this.root=this._last=new ca(a);return this};this.pop=function(){this._last&&(this._last.prev&&(this._last.prev.next=null),this._last=this._last.prev);return this};this.shift=function(){this.root&&(this.root.next&&(this.root.next.prev=null),this.root=this.root.next);return this}};U.prototype=
Object.create(H3DU.Curve.prototype);U.prototype.constructor=U;U.prototype.evaluate=function(a){return[this.x1+(this.x2-this.x1)*a,this.y1+(this.y2-this.y1)*a,0]};U.prototype.velocity=function(){return[this.x2-this.x1,this.y2-this.y1,0]};U.prototype.arcLength=function(a){var b=this.x1+(this.x2-this.x1)*a-this.x1,c=this.y1+(this.y2-this.y1)*a-this.y1,b=Math.sqrt(b*b+c*c);0>a&&(b=-b);return b};aa.prototype=Object.create(H3DU.Curve.prototype);aa.prototype.constructor=aa;aa.prototype.evaluate=function(a){if(0===
a)return[this.x1,this.y1,0];if(1===a)return[this.x2,this.y2,0];var b=this.theta+this.delta*a;a=Math.cos(b);b=0<=b&&6.283185307179586>b?3.141592653589793>=b?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(b);return[this.cr*a*this.rx-this.sr*b*this.rx+this.cx,this.sr*a*this.rx+this.cr*b*this.ry+this.cy,0]};aa.prototype.velocity=function(a){var b=this.theta+this.delta*a;a=Math.cos(b);b=-(0<=b&&6.283185307179586>b?3.141592653589793>=b?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(b))*this.delta;a*=this.delta;
return[this.cr*b*this.rx-this.sr*a*this.rx,this.sr*b*this.rx+this.cr*a*this.ry,0]};var m=function(){this.segments=[];this.incomplete=!1;this.startPos=[0,0];this.endPos=[0,0]},P={};m.CLOSE=0;m.LINE=1;m.QUAD=2;m.CUBIC=3;m.ARC=4;m.prototype.isIncomplete=function(){return this.incomplete};m._startPoint=function(a){return a[0]===m.CLOSE?[0,0]:[a[1],a[2]]};m._endPoint=function(a){return a[0]===m.CLOSE?[0,0]:a[0]===m.ARC?[a[8],a[9]]:[a[a.length-2],a[a.length-1]]};m._point=function(a,b){var c,d,e;if(a[0]===
m.CLOSE)return[0,0];if(a[0]===m.LINE)return[a[1]+(a[3]-a[1])*b,a[2]+(a[4]-a[2])*b];if(a[0]===m.QUAD){e=1-b;var f=e*e,g=e+e;c=a[1]*f;d=a[3]*g;e=c+b*(d+b*a[5]);c=a[2]*f;d=a[4]*g;c+=b*(d+b*a[6]);return[e,c]}if(a[0]===m.CUBIC)return c=3*(a[3]-a[1]),d=3*(a[5]-a[3])-c,f=a[7]-c-d-a[1],e=a[1]+b*(c+b*(d+b*f)),c=3*(a[4]-a[2]),d=3*(a[6]-a[4])-c,f=a[8]-c-d-a[2],c=a[2]+b*(c+b*(d+b*f)),[e,c];if(a[0]===m.ARC){if(0===b)return[a[1],a[2]];if(1===b)return[a[8],a[9]];e=a[3];c=a[4];g=a[5];f=a[12]+(a[13]-a[12])*b;d=Math.cos(g);
var g=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-d*d):-Math.sqrt(1-d*d):Math.sin(g),h=Math.cos(f),f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-h*h):-Math.sqrt(1-h*h):Math.sin(f);return[d*h*e-g*f*c+a[10],g*h*e+d*f*c+a[11]]}return[0,0]};m._segToCurve=function(a,b){if(a[0]===m.LINE)return new U(a[1],a[2],a[3],a[4]);if(a[0]===m.QUAD)return u.fromBezierCurve([[a[1],a[2],0],[a[3],a[4],0],[a[5],a[6],0]]);if(a[0]===m.CUBIC)return u.fromBezierCurve([[a[1],a[2],0],[a[3],a[4],
0],[a[5],a[6],0],[a[7],a[8],0]]);if(a[0]===m.ARC)return 0===b?[a[1],a[2]]:1===b?[a[8],a[9]]:new aa(a[1],a[2],a[8],a[9],a[3],a[4],a[5],a[10],a[11],a[12],a[13]-a[12]);throw Error();};m._subdivide2=function(a,b,c,d,e,f,g,h,k,l,p,n,v,q,t){var H=a+(c-a)*p,F=c+(e-c)*p;c=H+(F-H)*p;e+=(g-e)*p;var F=F+(e-F)*p,r=c+(F-c)*p,u=b+(d-b)*p,w=d+(f-d)*p;d=u+(w-u)*p;f+=(h-f)*p;var w=w+(f-w)*p,x=d+(w-d)*p;p=k+(l-k)*p;m._flattenCubic(a,b,H,u,c,d,r,x,k,p,n,v,q,t+1);m._flattenCubic(r,x,F,w,e,f,g,h,p,l,n,v,q,t+1)};m._subdivide3=
function(a,b,c,d,e,f,g,h,k,l,p,n,v,q,t,D){var H=a+(c-a)*p,F=c+(e-c)*p;c=H+(F-H)*p;e+=(g-e)*p;var F=F+(e-F)*p,r=c+(F-c)*p,u=b+(d-b)*p,w=d+(f-d)*p;d=u+(w-u)*p;f+=(h-f)*p;var w=w+(f-w)*p,x=d+(w-d)*p;p=k+(l-k)*p;n=(n-p)/(l-p);m._flattenCubic(a,b,H,u,c,d,r,x,k,p,v,q,t,D+1);m._subdivide2(r,x,F,w,e,f,g,h,p,l,n,v,q,t,D+1)};m._flattenCubic=function(a,b,c,d,e,f,g,h,k,l,p,n,v,q){if("undefined"===typeof q||null===q)q=0;20<=q||Math.abs(a-c-c+e)+Math.abs(c-e-e+g)+Math.abs(b-d-d+f)+Math.abs(d-f-f+h)<=n?0===v?p.push([a,
b,g,h]):(a=g-a,b=h-b,p.push(k,l,Math.sqrt(a*a+b*b))):m._subdivide2(a,b,c,d,e,f,g,h,k,l,.5,p,n,v,q)};m._flattenQuad=function(a,b,c,d,e,f,g,h,k,l,p,n){if("undefined"===typeof n||null===n)n=0;if(20<=n||Math.abs(a-c-c+e)+Math.abs(b-d-d+f)<=l)0===p?k.push([a,b,e,f]):(a=e-a,b=f-b,k.push(g,h,Math.sqrt(a*a+b*b)));else{var v=.5*(a+c);c=.5*(c+e);var H=.5*(v+c),t=.5*(b+d);d=.5*(d+f);var q=.5*(t+d),r=.5*(g+h);m._flattenQuad(a,b,v,t,H,q,g,r,k,l,p,n+1);m._flattenQuad(H,q,c,d,e,f,r,h,k,l,p,n+1)}};m._flattenArc=
function(a,b,c,d,e,f,g){var h=a[5],k=Math.cos(h);m._flattenArcInternal([a[3],a[4],a[10],a[11],k,0<=h&&6.283185307179586>h?3.141592653589793>=h?Math.sqrt(1-k*k):-Math.sqrt(1-k*k):Math.sin(h)],a[1],a[2],a[8],a[9],a[12],a[13],b,c,d,e,f,g)};m._flattenArcInternal=function(a,b,c,d,e,f,g,h,k,l,p,n,v){if("undefined"===typeof v||null===v)v=0;var H=.5*(f+g),t=.5*(h+k),q=Math.cos(H),r=0<=H&&6.283185307179586>H?3.141592653589793>=H?Math.sqrt(1-q*q):-Math.sqrt(1-q*q):Math.sin(H),u=a[4]*q*a[0]-a[5]*r*a[1]+a[2],
q=a[5]*q*a[0]+a[4]*r*a[1]+a[3];20<=v||Math.abs(b-u-u+d)+Math.abs(c-q-q+e)<=p?0===n?(l.push([b,c,u,q]),l.push([u,q,d,e])):(a=u-b,c=q-c,c=Math.sqrt(a*a+c*c),l.push(h,t,c),a=d-u,c=e-q,c=Math.sqrt(a*a+c*c),l.push(t,k,c)):(m._flattenArcInternal(a,b,c,u,q,f,H,h,t,l,p,n,v+1),m._flattenArcInternal(a,u,q,d,e,H,g,t,k,l,p,n,v+1))};m.prototype._start=function(){for(var a=0;a<this.segments.length;a++){var b=this.segments[a];if(b[0]!==m.CLOSE)return m._startPoint(b)}return[0,0]};m.prototype._end=function(){for(var a=
this.segments.length-1;0<=a;a--){var b=this.segments[a];if(b[0]!==m.CLOSE)return m._endPoint(b)}return[0,0]};m.prototype.merge=function(a){var b=null;if(!a)return this;for(var c=a.segments.length,d=0;d<c;d++){var e=a.segments[d];if(e[0]===m.CLOSE)this.closePath();else{var f=m._startPoint(e);b&&b[0]===f[0]&&b[1]===f[1]||this.moveTo(f[0],f[1]);b=m._endPoint(e);e[0]===m.LINE&&this.lineTo(e[3],e[4]);e[0]===m.QUAD&&this.quadraticCurveTo(e[3],e[4],e[5],e[6]);e[0]===m.CUBIC&&this.bezierCurveTo(e[3],e[4],
e[5],e[6],e[7],e[8]);e[0]===m.ARC&&(f=e[13]-e[12],this.arcSvgTo(e[3],e[4],e[5]*m._toDegrees,Math.abs(f)>Math.PI,0<f,e[8],e[9]))}}return this};m.prototype.toString=function(){for(var a=null,b="",c=0;c<this.segments.length;c++){var d=this.segments[c];if(d[0]===m.CLOSE)b+="Z";else{var e=m._startPoint(d);a&&a[0]===e[0]&&a[1]===e[1]||(b+="M"+e[0]+","+e[1]);a=m._endPoint(d);d[0]===m.LINE&&(b+="L"+d[3]+","+d[4]);d[0]===m.QUAD&&(b+="Q"+d[3]+","+d[4]+","+d[5]+","+d[6]);d[0]===m.CUBIC&&(b+="C"+d[3]+","+d[4]+
","+d[5]+","+d[6]+","+d[7]+","+d[8]);d[0]===m.ARC&&(e=d[13]-d[12],b+="A"+d[3]+","+d[4]+","+180*d[5]/Math.PI+","+(Math.abs(e)>Math.PI?"1":"0")+(0<e?"1":"0")+d[8]+","+d[9])}}return b};m.prototype.pathLength=function(a){if(0===this.segments.length)return 0;"undefined"!==typeof a&&null!==a&&console.warn("Unused parameter flatness is defined");return this.getCurves().getLength()};m.prototype.getLines=function(a){var b=[];if("undefined"===typeof a||null===a)a=1;for(var c=0;c<this.segments.length;c++){var d=
this.segments[c];d[0]===m.QUAD?m._flattenQuad(d[1],d[2],d[3],d[4],d[5],d[6],0,1,b,2*a,0):d[0]===m.CUBIC?m._flattenCubic(d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],0,1,b,2*a,0):d[0]===m.ARC?m._flattenArc(d,0,1,b,2*a,0):d[0]!==m.CLOSE&&b.push([d[1],d[2],d[3],d[4]])}return b};m.prototype.toLinePath=function(a){var b=[],c=new m,d=null;if("undefined"===typeof a||null===a)a=1;for(var e=0;e<this.segments.length;e++){var f=this.segments[e];if(f[0]===m.CLOSE)c.closePath();else{var g=m._endPoint(f),h=m._startPoint(f);
d&&d[0]===h[0]&&d[1]===h[1]||c.moveTo(h[0],h[1]);d=g;b.splice(0,b.length);if(f[0]===m.QUAD)for(m._flattenQuad(f[1],f[2],f[3],f[4],f[5],f[6],0,1,b,2*a,0),f=0;f<b.length;f++)c.lineTo(b[f][2],b[f][3]);else if(f[0]===m.CUBIC)for(m._flattenCubic(f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8],0,1,b,2*a,0),f=0;f<b.length;f++)c.lineTo(b[f][2],b[f][3]);else if(f[0]===m.ARC)for(m._flattenArc(f,0,1,b,2*a,0),f=0;f<b.length;f++)c.lineTo(b[f][2],b[f][3]);else f[0]!==m.CLOSE?c.lineTo(f[3],f[4]):c.closePath()}}return c};
m.prototype.toCurvePath=function(){for(var a=new m,b=null,c=0;c<this.segments.length;c++){var d=this.segments[c];if(d[0]===m.CLOSE)a.closePath();else{var e=m._endPoint(d),f=m._startPoint(d);b&&b[0]===f[0]&&b[1]===f[1]||a.moveTo(f[0],f[1]);b=e;if(d[0]===m.QUAD)a.quadraticCurveTo(d[3],d[4],d[5],d[6]);else if(d[0]===m.CUBIC)a.bezierCurveTo(d[3],d[4],d[5],d[6],d[7],d[8]);else if(d[0]===m.ARC)for(e=m._arcToBezierCurves(d[10],d[11],d[3],d[4],d[5],d[12],d[13]),d=0;d<e.length;d++)a.bezierCurveTo(e[d][2],
e[d][3],e[d][4],e[d][5],e[d][6],e[d][7]);else d[0]===m.LINE&&a.lineTo(d[3],d[4])}}return a};m._accBounds=function(a,b,c){0<=c&&1>=c&&(b=m._point(b,c),a[0]=Math.min(b[0],a[0]),a[1]=Math.min(b[1],a[1]),a[2]=Math.max(b[0],a[2]),a[3]=Math.max(b[1],a[3]))};m._accBoundsPoint=function(a,b,c){a[0]=Math.min(b,a[0]);a[1]=Math.min(c,a[1]);a[2]=Math.max(b,a[2]);a[3]=Math.max(c,a[3])};m._accBoundsArc=function(a,b,c,d,e,f,g,h){var k=Math.cos(h);h=0<=h&&6.283185307179586>h?3.141592653589793>=h?Math.sqrt(1-k*k):
-Math.sqrt(1-k*k):Math.sin(h);f=d*k*b-e*h*c+f;b=e*k*b+d*h*c+g;a[0]=Math.min(f,a[0]);a[1]=Math.min(b,a[1]);a[2]=Math.max(f,a[2]);a[3]=Math.max(b,a[3])};m._normAngleRadians=function(a){var b=2*Math.PI;return 0<=a?a<b?a:a%b:a%b+b};m._angleInRange=function(a,b,c){if(Math.abs(c-b)>=2*Math.PI)return!0;a=m._normAngleRadians(a);var d=m._normAngleRadians(b),e=m._normAngleRadians(c);return b===c?a===d:b<c?d<e?a>=d&&a<=e:a>=d||a<=e:e<d?a>=e&&a<=d:a>=e||a<=d};m.prototype.getBounds=function(){for(var a=Number.POSITIVE_INFINITY,
a=[a,a,-a,a],b=!0,c=0;c<this.segments.length;c++){var d=this.segments[c],e,f;if(d[0]!==m.CLOSE){var g=m._endPoint(d),h=d[1],k=d[2],l=g[0],p=g[1];b?(a[0]=Math.min(h,l),a[1]=Math.min(k,p),a[2]=Math.max(h,l),a[3]=Math.max(k,p)):(a[0]=Math.min(h,l,a[0]),a[1]=Math.min(k,p,a[1]),a[2]=Math.max(h,l,a[2]),a[3]=Math.max(k,p,a[3]));b=!1;if(d[0]===m.QUAD)l=d[5],p=d[6],e=h-2*d[3]+l,f=k-2*d[4]+p,0!==e&&m._accBounds(a,d,(h-d[3])/e),0!==f&&m._accBounds(a,d,(k-d[4])/f);else if(d[0]===m.CUBIC){var l=d[7],p=d[8],g=
h-3*d[3]+3*d[5]-l,n=k-3*d[4]+3*d[6]-p;if(0!==g||0!==n)e=h-2*d[3]+d[5],f=k-2*d[4]+d[6],h=d[3]*d[3]+d[5]*d[5]-d[5]*(h+d[3])+l*(h-d[3]),l=d[4]*d[4]+d[6]*d[6]-d[6]*(k+d[4])+p*(k-d[4]),0<=h&&0!==g&&(h=Math.sqrt(h),m._accBounds(a,d,(e-h)/g),m._accBounds(a,d,(e+h)/g)),0<=l&&0!==n&&(l=Math.sqrt(l),m._accBounds(a,d,(f-l)/n),m._accBounds(a,d,(f+l)/n))}else if(d[0]===m.ARC)if(f=d[3],n=d[4],k=d[10],g=d[11],e=d[12],h=d[13],l=d[5],Math.abs(h-e)>=2*Math.PI)f===n?(d=f,e=n):(d=Math.cos(l),l=0<=l&&6.283185307179586>
l?3.141592653589793>=l?Math.sqrt(1-d*d):-Math.sqrt(1-d*d):Math.sin(l),e=d*f,f*=l,h=-l*n,l=d*n,d=Math.sqrt(e*e+h*h),e=Math.sqrt(f*f+l*l)),m._accBoundsPoint(a,k+d,g+e),m._accBoundsPoint(a,k+d,g-e),m._accBoundsPoint(a,k-d,g+e),m._accBoundsPoint(a,k-d,g-e);else if(h!==e){var d=Math.cos(l),l=0<=l&&6.283185307179586>l?3.141592653589793>=l?Math.sqrt(1-d*d):-Math.sqrt(1-d*d):Math.sin(l),p=[],v;0!==d&&0!==l?(v=Math.atan2(-n*l/d,f),p.push(v,v+Math.PI),v=Math.atan2(n*d/l,f),p.push(v,v+Math.PI)):p.push(0,Math.PI,
.5*Math.PI,1.5*Math.PI);for(v=0;v<p.length;v++)m._angleInRange(p[v],e,h)&&m._accBoundsArc(a,f,n,d,l,k,g,p[v])}}}return a};m.prototype.reverse=function(){for(var a=0,b=0,c=!1,d=0,e=0,f=new m,g=this.segments.length-1;0<=g;g--){var h=this.segments[g],k=m._startPoint(h),l=m._endPoint(h);if(h[0]!==m.CLOSE){if(g===this.segments.length-1)f.moveTo(l[0],l[1]);else if(a!==l[0]||b!==l[1])c&&f.closePath(),c=!1,f.moveTo(l[0],l[1]);a=k[0];b=k[1]}if(h[0]===m.CLOSE){c&&f.closePath();for(var c=!0,h=!1,p=g-1;0<=p&&
this.segments[p][0]!==m.CLOSE;p--){k=m._startPoint(this.segments[p]);l=m._endPoint(this.segments[p]);if(h&&(d!==l[0]||e!==l[1]))break;d=k[0];e=k[1];h=!0}h&&(f.moveTo(d,e),l=m._endPoint(this.segments[g-1]),d===l[0]&&e===l[1]||f.lineTo(l[0],l[1]),a=l[0],b=l[1])}else h[0]===m.QUAD?f.quadraticCurveTo(h[3],h[4],h[1],h[2]):h[0]===m.CUBIC?f.bezierCurveTo(h[5],h[6],h[3],h[4],h[1],h[2]):h[0]===m.ARC?(k=h[13]-h[12],f.arcSvgTo(h[3],h[4],h[5]*m._toDegrees,Math.abs(k)>Math.PI,0>k,h[1],h[2])):h[0]===m.LINE&&f.lineTo(h[1],
h[2])}c&&f.closePath();return f};m._pushXY=function(a,b,c,d){d?0===a.length?a.push(b,c):a[a.length-1]===c&&a[a.length-2]===b||a.push(b,c):a.push(b,c)};m.prototype._getSubpaths=function(a,b){var c=[],d=[],e;if("undefined"===typeof a||null===a)a=1;for(var f=0,g=0,h=!0,k=null,l=0;l<this.segments.length;l++){e=this.segments[l];var p=m._startPoint(e),n=m._endPoint(e);c.splice(0,c.length);if(e[0]!==m.CLOSE){if(h||f!==p[0]||g!==p[1])k=p,d.push(k),h=!1;f=n[0];g=n[1]}if(e[0]===m.QUAD)for(m._flattenQuad(e[1],
e[2],e[3],e[4],e[5],e[6],0,1,c,2*a,0),e=0;e<c.length;e++)m._pushXY(k,c[e][2],c[e][3],b);else if(e[0]===m.CUBIC)for(m._flattenCubic(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],0,1,c,2*a,0),e=0;e<c.length;e++)m._pushXY(k,c[e][2],c[e][3],b);else if(e[0]===m.ARC)for(m._flattenArc(e,0,1,c,2*a,0),e=0;e<c.length;e++)m._pushXY(k,c[e][2],c[e][3],b);else e[0]!==m.CLOSE&&m._pushXY(k,e[3],e[4],b)}return d};m._CurveList=function(a){H3DU.Curve.apply(this,[(new H3DU.PiecewiseCurve(a)).toArcLengthParam().fitRange(0,
1)]);this.curves=a};m._CurveList.prototype=Object.create(H3DU.Curve.prototype);m._CurveList.prototype.constructor=m._CurveList;m._CurveList.prototype.getCurves=function(){return this.curves};m.prototype.interpolate=function(a,b){if(!a||a.segments.length!==this.segments.length)return null;for(var c=[],d=[],e=[],f,g=new m,h,k=0;k<this.segments.length;k++){var l=this.segments[k],p=a.segments[k],n=!1;l[0]!==m.CLOSE&&(f=m._startPoint(l),h&&h[0]===f[0]&&h[1]===f[1]||(n=!0),h=m._endPoint(l));if(l[0]===m.QUAD){c[0]=
m.CUBIC;c[1]=l[1];c[2]=l[2];f=2*l[3];var v=2*l[4];c[3]=(l[1]+f)/3;c[4]=(l[2]+v)/3;c[5]=(l[5]+f)/3;c[6]=(l[6]+v)/3;c[7]=l[5];c[8]=l[6];l=c}p[0]===m.QUAD&&(d[0]=m.CUBIC,d[1]=p[1],d[2]=p[2],f=2*p[3],v=2*p[4],d[3]=(p[1]+f)/3,d[4]=(p[2]+v)/3,d[5]=(p[5]+f)/3,d[6]=(p[6]+v)/3,d[7]=p[5],d[8]=p[6],p=d);if(l[0]!==p[0])return null;switch(l[0]){case m.CLOSE:g.closePath();h=null;break;case m.LINE:case m.QUAD:case m.CUBIC:for(f=1;f<l.length;f++)e[f]=l[f]+(p[f]-l[f])*b;n&&g.moveTo(e[1],e[2]);l[0]===m.LINE?g.lineTo(e[3],
e[4]):l[0]===m.QUAD?g.quadraticCurveTo(e[3],e[4],e[5],e[6]):l[0]===m.CUBIC&&g.bezierCurveTo(e[3],e[4],e[5],e[6],e[7],e[8]);break;case m.ARC:v=l[13]-l[12];f=Math.abs(v)>Math.PI;var q=p[13]-p[12],t=Math.abs(q)>Math.PI;f=.5>b?f:t;var v=.5>b?0<v:0<q,q=l[1]+(p[1]-l[1])*b,t=l[2]+(p[2]-l[2])*b,D=l[3]+(p[3]-l[3])*b,r=l[4]+(p[4]-l[4])*b,u=l[5]+(p[5]-l[5])*b,w=l[8]+(p[8]-l[8])*b,l=l[9]+(p[9]-l[9])*b;n&&g.moveTo(q,t);g.arcSvgTo(D,r,u*m._toDegrees,f,v,w,l);break;default:return console.log("unknown kind"),null}}return g};
m._addSegment=function(a,b){0<a.length&&b instanceof U&&b.x1===b.x2&&b.y1===b.y2||a.push(b)};m.prototype.getCurves=function(){for(var a=[],b=[],c=0,d=0,e=0,f=0,g=!0,h=null,k=0;k<this.segments.length;k++){var l=this.segments[k],p=m._startPoint(l),n=m._endPoint(l);if(l[0]!==m.CLOSE){if(g||c!==p[0]||d!==p[1])h=[],a.push(h),e=p[0],f=p[1],g=!1;c=n[0];d=n[1];m._addSegment(h,m._segToCurve(l))}else m._addSegment(h,new U(c,d,e,f)),c=e,d=f}for(k=0;k<a.length;k++)b.push((new H3DU.PiecewiseCurve(a[k])).toArcLengthParam().fitRange(0,
1));return new m._CurveList(b)};m.prototype.getLinePoints=function(a){a=this.getLines(a);for(var b=[],c=0,d=0,e=0;e<a.length;e++){var f=a[e];0!==e&&c===f[0]&&d===f[1]||b.push([f[0],f[1]]);b.push([f[2],f[3]]);c=f[2];d=f[3]}return b};m.prototype.getLinePointsAsObjects=function(a){a=this.getLines(a);for(var b=[],c=0,d=0,e=0;e<a.length;e++){var f=a[e];0!==e&&c===f[0]&&d===f[1]||b.push({x:f[0],y:f[1]});b.push({x:f[2],y:f[3]});c=f[2];d=f[3]}return b};m.prototype.getPoints=function(a){if(1>a||0===this.segments.length)return[];
if(1===a)return[this._start()];if(2===a)return[this._start(),this._end()];for(var b=this.getCurves(),c=[],d=0;d<a;d++){var e=b.evaluate(d/(a-1));c.push([e[0],e[1]])}return c};m.prototype.getPointsAsObjects=function(a){if(1>a||0===this.segments.length)return[];if(1===a)return a=this._start(),[{x:a[0],y:a[1]}];if(2===a){a=this._start();var b=this._end();return[{x:a[0],y:a[1]},{x:b[0],y:b[1]}]}for(var b=this.getCurves(),c=[],d=0;d<a;d++){var e=b.evaluate(d/(a-1));c.push({x:e[0],y:e[1]})}return c};m.prototype.closePath=
function(){this.startPos[0]===this.endPos[0]&&this.startPos[1]===this.endPos[1]||this.lineTo(this.startPos[0],this.startPos[1]);0<this.segments.length&&this.segments.push([m.CLOSE]);this.incomplete=!1;return this};m.prototype.moveTo=function(a,b){this.startPos[0]=a;this.startPos[1]=b;this.endPos[0]=a;this.endPos[1]=b;this.incomplete=!1;return this};m.prototype.lineTo=function(a,b){this.segments.push([m.LINE,this.endPos[0],this.endPos[1],a,b]);this.endPos[0]=a;this.endPos[1]=b;this.incomplete=!1;return this};
m.prototype.getCurrentPoint=function(){return[this.endPos[0],this.endPos[1]]};m._areCollinear=function(a,b,c,d,e,f){c-=a;d-=b;var g=[e-a,f-b],h=c*c+d*d;if(0===h)return!0;g=(c*g[0]+d*g[1])/h;a=[a+g*c,b+g*d];e=[e-a[0],f-a[1]];return 0===e[0]*e[0]+e[1]*e[1]};m.prototype.arcTo=function(a,b,c,d,e){if(0>e)throw Error("IndexSizeError");var f=this.endPos[0],g=this.endPos[1];if(0===e||f===a&&g===b||a===c&&b===d||m._areCollinear(f,g,a,b,c,d))return this.lineTo(a,b);f=[f-a,g-b];g=1/Math.sqrt(f[0]*f[0]+f[1]*
f[1]);f=[f[0]*g,f[1]*g];c=[c-a,d-b];d=1/Math.sqrt(c[0]*c[0]+c[1]*c[1]);d=[c[0]*d,c[1]*d];c=f[0]*d[1]-f[1]*d[0];g=(1+(f[0]*d[0]+f[1]*d[1]))*e/Math.abs(c);f=[f[0]*g,f[1]*g];d=[d[0]*g,d[1]*g];f=[a+f[0],b+f[1]];a=[a+d[0],b+d[1]];this.lineTo(f[0],f[1]);return this.arcSvgTo(e,e,0,!1,0>c,a[0],a[1])};m.prototype.arc=function(a,b,c,d,e,f){return this._arcInternal(a,b,c,d,e,f,!0)};m.prototype._arcInternal=function(a,b,c,d,e,f,g){if(0>c)throw Error("IndexSizeError");var h=m._normAngleRadians(d),k=m._normAngleRadians(e),
l=2*Math.PI,p=Math.cos(h),n=Math.cos(k),v=a+c*p,p=b+c*(3.141592653589793>=h?Math.sqrt(1-p*p):-Math.sqrt(1-p*p)),q=a+c*n,n=b+c*(3.141592653589793>=k?Math.sqrt(1-n*n):-Math.sqrt(1-n*n));g&&this.lineTo(v,p);if(v===q&&p===n&&d===e||0===c)return this.lineTo(q,n);if(!f&&e-d>=l||f&&d-e>=l)return this._arcInternal(a,b,c,d,d+Math.PI,f,!1)._arcInternal(a,b,c,d+Math.PI,d+2*Math.PI,f,!1)._arcInternal(a,b,c,h,k,f,!1);g=e-d;if(g>=l||0>g){l=g%l;if(0===l&&0!==g)return this._arcInternal(a,b,c,d,d+Math.PI,f,!1)._arcInternal(a,
b,c,d+Math.PI,d+2*Math.PI,f,!1)._arcInternal(a,b,c,h,k,f,!1);g=l}a=Math.abs(g)>Math.PI^f^d>e;d=0<g^f^d>e;return this.lineTo(v,p).arcSvgTo(c,c,0,a,d,q,n)};m.prototype.quadraticCurveTo=function(a,b,c,d){this.segments.push([m.QUAD,this.endPos[0],this.endPos[1],a,b,c,d]);this.endPos[0]=c;this.endPos[1]=d;this.incomplete=!1;return this};m.prototype.bezierCurveTo=function(a,b,c,d,e,f){this.segments.push([m.CUBIC,this.endPos[0],this.endPos[1],a,b,c,d,e,f]);this.endPos[0]=e;this.endPos[1]=f;this.incomplete=
!1;return this};m._vecangle=function(a,b,c,d){var e;e=(a*c+b*d)/(Math.sqrt(a*a+b*b)*Math.sqrt(c*c+d*d));-1>e?e=-1:1<e&&(e=1);e=Math.acos(e);0>a*d-b*c&&(e=-e);return e};m._arcSvgToCenterParam=function(a){var b=a[1],c=a[2],d=a[8],e=a[9],f=a[3],g=a[4],h=a[5],k=.5*(b-d),l=.5*(c-e),p=Math.cos(h),n=0<=h&&6.283185307179586>h?3.141592653589793>=h?Math.sqrt(1-p*p):-Math.sqrt(1-p*p):Math.sin(h),h=p*k+n*l,k=p*l-n*k,l=f*f,v=g*g,q=l*k*k+v*h*h,v=Math.sqrt(Math.max(0,(l*v-q)/q)),l=f*k*v/g,v=g*h*v/f;a[6]===a[7]?
l=-l:v=-v;b=p*l-n*v+.5*(b+d);c=n*l+p*v+.5*(c+e);e=(h-l)/f;p=(k-v)/g;d=e/Math.sqrt(e*e+p*p);-1>d?d=-1:1<d&&(d=1);d=Math.acos(d);0>p&&(d=-d);f=m._vecangle(e,p,(-h-l)/f,(-k-v)/g);f=0>f?2*Math.PI+f:f;!a[7]&&0<f?f-=2*Math.PI:a[7]&&0>f&&(f+=2*Math.PI);return[b,c,d,f+d]};m._toRadians=Math.PI/180;m._toDegrees=180/Math.PI;m._arcToBezierCurves=function(a,b,c,d,e,f,g){var h=Math.cos(e);e=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-h*h):-Math.sqrt(1-h*h):Math.sin(e);var k=Math.abs(g-f),l=16;k<
Math.PI/8?l=2:k<Math.PI/4?l=4:k<Math.PI/2?l=6:k<Math.PI&&(l=10);var p=(g-f)/l;g=[];var k=Math.tan(.5*p),k=1/3*Math.sin(p)*(Math.sqrt(3*k*k+4)-1),p=2*Math.PI/l,m=Math.cos(p),p=0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(p),n=Math.cos(f),q=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(f);for(f=0;f<l;f++){var t=m*q+p*n,D=m*n-p*q,r=t,u=D,w=[a+c*h*n-d*e*q,b+c*e*n+d*h*q],x=[a+c*h*u-d*e*r,b+c*e*u+d*h*r],n=[-c*h*q-
d*e*n,-c*e*q+d*h*n],r=[-c*h*r-d*e*u,-c*e*r+d*h*u],n=[w[0]+n[0]*k,w[1]+n[1]*k],r=[x[0]-r[0]*k,x[1]-r[1]*k];g.push([w[0],w[1],n[0],n[1],r[0],r[1],x[0],x[1]]);n=D;q=t}return g};m.prototype.arcSvgTo=function(a,b,c,d,e,f,g){if(0===a||0===b)return this.lineTo(f,g);var h=this.endPos[0],k=this.endPos[1];if(h===f&&k===g)return this;c=(0<=c&&360>c?c:c%360+(0>c?360:0))*m._toRadians;a=Math.abs(a);b=Math.abs(b);var l=.5*(h-f),p=.5*(k-g),n=Math.cos(c),v=0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-
n*n):-Math.sqrt(1-n*n):Math.sin(c),q=n*l+v*p,l=n*p-v*l,q=q*q/(a*a)+l*l/(b*b);1<q&&(q=Math.sqrt(q),a*=q,b*=q);a=[m.ARC,h,k,a,b,c,!!d,!!e,f,g];b=m._arcSvgToCenterParam(a);a[6]=null;a[7]=null;a[10]=b[0];a[11]=b[1];a[12]=b[2];a[13]=b[3];this.segments.push(a);this.endPos[0]=f;this.endPos[1]=g;this.incomplete=!1;return this};m._nextAfterWs=function(a,b){for(;b[0]<a.length;){var c=a.charCodeAt(b[0]);b[0]++;if(32!==c&&13!==c&&9!==c&&10!==c)return c}return-1};m._nextAfterSepReq=function(a,b){for(var c=!1,
d=!1;b[0]<a.length;){var e=a.charCodeAt(b[0]);b[0]++;if(32===e||13===e||9===e||10===e)d=!0;else{if(c||44!==e)return d?e:-1;c=d=!0}}return-1};m._nextAfterSep=function(a,b){for(var c=!1;b[0]<a.length;){var d=a.charCodeAt(b[0]);b[0]++;if(32!==d&&13!==d&&9!==d&&10!==d){if(c||44!==d)return d;c=!0}}return-1};m._peekNextNumber=function(a,b){var c=b[0],d=null!==m._nextNumber(a,b,!0);b[0]=c;return d};m._nextNumber=function(a,b,c){var d=b[0];c=c?m._nextAfterSep(a,b):m._nextAfterWs(a,b);var e=b[0]-1,f=!1,g=
!1,h=!1;if(46===c)f=!0;else if(48<=c&&57>=c)g=!0;else if(45!==c&&43!==c)return b[0]=d,null;for(;b[0]<a.length;)if(c=a.charCodeAt(b[0]),b[0]++,46===c){if(f)return b[0]=d,null;f=!0}else if(48<=c&&57>=c)g=!0;else if(69===c||101===c){if(!g)return b[0]=d,null;h=!0;break}else{if(!g)return b[0]=d,null;b[0]--;a=parseFloat(a.substr(e,b[0]-e));return Number.isNaN(a)?(b[0]=a,null):a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY?0:a}if(h){c=a.charCodeAt(b[0]);if(0>c)return b[0]=d,null;b[0]++;g=!1;
if(48<=c&&57>=c)g=!0;else if(45!==c&&43!==c)return b[0]=d,null;for(;b[0]<a.length;)if(c=a.charCodeAt(b[0]),b[0]++,48<=c&&57>=c)g=!0;else{if(!g)return b[0]=d,null;b[0]--;a=parseFloat(a.substr(e,b[0]-e));return Number.isNaN(a)?(b[0]=d,null):a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY?0:a}}if(!g)return b[0]=d,null;a=parseFloat(a.substr(e,a.length-e));return Number.isNaN(a)?(b[0]=d,null):a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY?0:a};m.prototype.transform=function(a){var b=
new m,c=a[0],d=a[1],e=a[2],f=a[3],g=a[4];a=a[5];var h,k,l,p,n=[0],v=null;for(l=0;l<this.segments.length;l++){h=this.segments[l];var q=!1;h[0]!==m.CLOSE&&(p=m._startPoint(h),v&&v[0]===p[0]&&v[1]===p[1]||(q=!0),v=m._endPoint(h));switch(h[0]){case m.CLOSE:b.closePath();v=null;break;case m.LINE:case m.QUAD:case m.CUBIC:for(p=1;p<h.length;p+=2)n[p]=c*h[p]+e*h[p+1]+g,n[p+1]=d*h[p]+f*h[p+1]+a;q&&b.moveTo(n[1],n[2]);h[0]===m.LINE?b.lineTo(n[3],n[4]):h[0]===m.QUAD?b.quadraticCurveTo(n[3],n[4],n[5],n[6]):h[0]===
m.CUBIC&&b.bezierCurveTo(n[3],n[4],n[5],n[6],n[7],n[8]);break;case m.ARC:if(1===c&&0===d&&0===e&&1===f){p=h[13]-h[12];var t=Math.abs(p)>Math.PI;q&&b.moveTo(h[1]+g,h[2]+a);b.arcSvgTo(h[3],h[4],h[5]*m._toDegrees,t,0<p,h[8]+g,h[9]+a)}else if(0===d&&0===e&&0===h[5])p=h[13]-h[12],t=Math.abs(p)>Math.PI,q&&b.moveTo(c*h[1]+g,f*h[2]+a),b.arcSvgTo(c*h[3],f*h[4],0,t,0<p,c*h[8]+g,f*h[9]+a);else for(t=m._arcToBezierCurves(h[10],h[11],h[3],h[4],h[5],h[12],h[13]),t[0][0]=h[1],t[0][1]=h[2],t[t.length-1][6]=h[8],
t[t.length-1][7]=h[9],p=0;p<t.length;p++){for(var r=t[p],u=0;8>u;u+=2)h=c*r[u]+e*r[u+1]+g,k=d*r[u]+f*r[u+1]+a,r[u]=h,r[u+1]=k;q&&0===p&&b.moveTo(r[0],r[1]);b.bezierCurveTo(r[2],r[3],r[4],r[5],r[6],r[7])}}}return b};m.prototype.rect=function(a,b,c,d){return 0>c||0>d?this:this.moveTo(a,b).lineTo(a+c,b).lineTo(a+c,b+d).lineTo(a,b+d).closePath()};m.prototype.line=function(a,b,c,d){return this.moveTo(a,b).lineTo(c,d)};m.prototype.polyline=function(a,b){var c="undefined"!==typeof b&&null!==b?b:!1;if(0===
a.length)return this;if(0!==a.length%2)throw Error();this.moveTo(a[0],a[1]);for(var d=2;d<a.length;d+=2)this.lineTo(a[d],a[d+1]);c&&this.closePath();return this};m.prototype.roundRect=function(a,b,c,d,e,f){if(0>c||0>d)return this;e=Math.min(c,Math.max(0,e));f=Math.min(d,Math.max(0,f));var g=.5*e,h=.5*f;a+=g;this.moveTo(a,b);a+=c-e;this.lineTo(a,b);a+=g;b+=h;this.arcSvgTo(g,h,0,!1,!0,a,b);b+=d-f;this.lineTo(a,b);a-=g;b+=h;this.arcSvgTo(g,h,0,!1,!0,a,b);a-=c-e;this.lineTo(a,b);a-=g;b-=h;this.arcSvgTo(g,
h,0,!1,!0,a,b);b-=d-f;this.lineTo(a,b);this.arcSvgTo(g,h,0,!1,!0,a+g,b-h);this.closePath();return this};m.prototype.bevelRect=function(a,b,c,d,e,f){if(0>c||0>d)return this;e=Math.min(c,Math.max(0,e));f=Math.min(d,Math.max(0,f));var g=.5*e,h=.5*f;a+=g;this.moveTo(a,b);a+=c-e;this.lineTo(a,b);a+=g;b+=h;this.lineTo(a,b);b+=d-f;this.lineTo(a,b);a-=g;b+=h;this.lineTo(a,b);a-=c-e;this.lineTo(a,b);a-=g;b-=h;this.lineTo(a,b);b-=d-f;this.lineTo(a,b);this.lineTo(a+g,b-h);this.closePath();return this};m.prototype.ellipse=
function(a,b,c,d){if(0>c||0>d)return this;var e=.5*c;d*=.5;a+=e;return this.moveTo(a,b).arcSvgTo(e,d,0,!1,!0,a-c,b).arcSvgTo(e,d,0,!1,!0,a,b).closePath()};m.prototype.ellipseForBox=function(a,b,c,d){return this.ellipse(a+.5*c,b+.5*d,c,d)};m.prototype.arcShape=function(a,b,c,d,e,f,g){if(0>c||0>d)return this;var h=Math.PI/180,k=e+f;c*=.5;d*=.5;var l=(0<=k&&360>k?k:k%360+(0>k?360:0))*h,p=(0<=e&&360>e?e:e%360+(0>e?360:0))*h,m=Math.cos(l),l=3.141592653589793>=l?Math.sqrt(1-m*m):-Math.sqrt(1-m*m),n=Math.cos(p);
this.moveTo(a+n*c,b+(3.141592653589793>=p?Math.sqrt(1-n*n):-Math.sqrt(1-n*n))*d);0<f?(p=e+180,e=180,f=!0):(p=e-180,e=-180,f=!1);for(;f?p<k:p>k;p+=e){var n=(0<=p&&360>p?p:p%360+(0>p?360:0))*h,q=Math.cos(n);this.arcSvgTo(c,d,0,!1,f,a+q*c,b+(3.141592653589793>=n?Math.sqrt(1-q*q):-Math.sqrt(1-q*q))*d)}this.arcSvgTo(c,d,0,!1,f,a+m*c,b+l*d);2===g?this.lineTo(a,b).closePath():1===g&&this.closePath();return this};m.prototype.arcShapeForBox=function(a,b,c,d,e,f,g){return this.arcShape(a+.5*c,b+.5*d,c,d,e,
f,g)};m.prototype.arrow=function(a,b,c,d,e,f,g){var h=c-a,k=d-b,l=Math.sqrt(h*h+k*k);if(0===l)return this;g*=.5;e*=.5;var p=1/l,h=h*p,k=k*p;f=Math.min(f,l);f=l-f;this.moveTo(a,b);this.lineTo(g*k+a,-g*h+b);this.lineTo(f*h+g*k+a,f*k-g*h+b);this.lineTo(f*h+e*k+a,f*k-e*h+b).lineTo(c,d);this.lineTo(f*h-e*k+a,f*k+e*h+b);this.lineTo(f*h-g*k+a,f*k+g*h+b);this.lineTo(-g*k+a,g*h+b);this.closePath();return this};m.prototype.regularPolygon=function(a,b,c,d,e){if(2>=c)return this;var f=e||0,f=(0<=f&&360>f?f:f%
360+(0>f?360:0))*n.ToRadians,g=n.PiTimes2/c;e=Math.cos(g);for(var g=3.141592653589793>=g?Math.sqrt(1-e*e):-Math.sqrt(1-e*e),h=Math.cos(f),f=3.141592653589793>=f?Math.sqrt(1-h*h):-Math.sqrt(1-h*h),k=0;k<c;k++){var l=a+h*d,p=b+f*d;0===k?this.moveTo(l,p):this.lineTo(l,p);l=e*h-g*f;f=e*f+g*h;h=l}return this.closePath()};m.prototype.regularStar=function(a,b,c,d,e,f){if(0>=c)return this;var g=f||0,g=(0<=g&&360>g?g:g%360+(0>g?360:0))*n.ToRadians;c*=2;var h=n.PiTimes2/c;f=Math.cos(h);for(var h=3.141592653589793>=
h?Math.sqrt(1-f*f):-Math.sqrt(1-f*f),k=Math.cos(g),g=3.141592653589793>=g?Math.sqrt(1-k*k):-Math.sqrt(1-k*k),l=0;l<c;l++){var p=0===(l&1)?d:e,m=a+k*p,p=b+g*p;0===l?this.moveTo(m,p):this.lineTo(m,p);m=f*k-h*g;g=f*g+h*k;k=m}return this.closePath()};m.fromString=function(a){for(var b=[0],c=!1,d=new m,e=!1,f,g,h,k,l,p,n,q,r,t;!e&&b[0]<a.length;){var u=m._nextAfterWs(a,b);if(!c&&77!==u&&109!==u){e=!0;break}switch(u){case 90:case 122:d.closePath();break;case 77:case 109:for(h=!1;;){k=109===u?d.endPos[0]:
0;l=109===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}n=m._nextNumber(a,b,!0);if("undefined"===typeof n||null===n){e=!0;break}h?d.lineTo(k+p,l+n):d.moveTo(k+p,l+n);h=!0}c=!0;break;case 76:case 108:for(h=!1;;){k=108===u?d.endPos[0]:0;l=108===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}n=m._nextNumber(a,b,!0);if("undefined"===typeof n||null===n){e=!0;break}d.lineTo(k+p,l+n);h=!0}break;case 72:case 104:for(h=
!1;;){k=104===u?d.endPos[0]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}d.lineTo(k+p,d.endPos[1]);h=!0}break;case 86:case 118:for(h=!1;;){k=118===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}d.lineTo(d.endPos[0],k+p);h=!0}break;case 67:case 99:for(h=!1;;){k=99===u?d.endPos[0]:0;l=99===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}f=[];for(n=0;5>n;n++)if(f[n]=m._nextNumber(a,
b,!0),"undefined"===typeof f[n]||null===f[n]){e=!0;break}if(e)break;n=f[0];h=f[1];q=f[2];d.bezierCurveTo(k+p,l+n,k+h,l+q,k+f[3],l+f[4]);h=!0}break;case 81:case 113:for(h=!1;;){k=113===u?d.endPos[0]:0;l=113===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}n=m._nextNumber(a,b,!0);if("undefined"===typeof n||null===n){e=!0;break}h=m._nextNumber(a,b,!0);if("undefined"===typeof h||null===h){e=!0;break}q=m._nextNumber(a,b,!0);if("undefined"===typeof q||null===
q){e=!0;break}d.quadraticCurveTo(k+p,l+n,k+h,l+q);h=!0}break;case 65:case 97:for(h=!1;;){k=97===u?d.endPos[0]:0;l=97===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}n=m._nextNumber(a,b,!0);if("undefined"===typeof n||null===n){e=!0;break}f=m._nextNumber(a,b,!0);if("undefined"===typeof f||null===f){e=!0;break}g=m._nextAfterSepReq(a,b);r=m._nextAfterSep(a,b);if(-1===g||-1===r){e=!0;break}h=m._nextNumber(a,b,!0);if("undefined"===typeof h||null===h){e=!0;break}q=
m._nextNumber(a,b,!0);if("undefined"===typeof q||null===q){e=!0;break}d.arcSvgTo(p+k,n+l,f,48!==g,48!==r,h+k,q+l);h=!0}break;case 83:case 115:for(h=!1;;){k=115===u?d.endPos[0]:0;l=115===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}n=m._nextNumber(a,b,!0);if("undefined"===typeof n||null===n){e=!0;break}h=m._nextNumber(a,b,!0);if("undefined"===typeof h||null===h){e=!0;break}q=m._nextNumber(a,b,!0);if("undefined"===typeof q||null===q){e=!0;break}r=d.endPos[0];
t=d.endPos[1];f=d.endPos[0];g=d.endPos[1];0<d.segments.length&&d.segments[d.segments.length-1][0]===m.CUBIC&&(r=d.segments[d.segments.length-1][5],t=d.segments[d.segments.length-1][6]);d.bezierCurveTo(2*f-r,2*g-t,p+k,n+l,h+k,q+l);h=!0}break;case 84:case 116:for(h=!1;;){k=116===u?d.endPos[0]:0;l=116===u?d.endPos[1]:0;p=m._nextNumber(a,b,h);if("undefined"===typeof p||null===p){h||(e=!0);break}n=m._nextNumber(a,b,!0);if("undefined"===typeof n||null===n){e=!0;break}r=d.endPos[0];t=d.endPos[1];f=d.endPos[0];
g=d.endPos[1];0<d.segments.length&&d.segments[d.segments.length-1][0]===m.QUAD&&(r=d.segments[d.segments.length-1][3],t=d.segments[d.segments.length-1][4]);d.quadraticCurveTo(2*f-r,2*g-t,p+k,n+l);h=!0}break;default:return d.incomplete=!0,d}}e&&(d.incomplete=!0);return d};P._CONVEX=1;P._EAR=2;P._REFLEX=3;P._pointInTri=function(a,b,c,d){if(d[0]===a[0]&&d[1]===a[1]||d[0]===b[0]&&d[1]===b[1]||d[0]===c[0]&&d[1]===c[1])return!1;var e=b[0]-c[0],f=b[1]-c[1],g=b[0]-a[0],h=b[1]-a[1],k=g*e+h*f;return 1E-9<Math.sqrt(Math.abs(g*
g+h*h-k*k/(e*e+f*f)))?(e=Y(b,c,d),f=Y(b,c,a),g=0===e||0===f||e===f,e=Y(a,c,d),f=Y(a,c,b),g=g&&(0===e||0===f||e===f),e=Y(a,b,d),f=Y(a,b,c),g&&(0===e||0===f||e===f)):!1};P._Contour=function(a){this.vertexList=new fa;var b=a.length;4<=b&&a[0]===a[b-2]&&a[1]===a[b-1]&&(b-=2);var c=-1,d=-1,e=null,f=-1,g=Number.POSITIVE_INFINITY,g=[g,g,-g,-g],h=!0;this.vertexCount=0;var k;for(k=0;k<b;k+=2){var l=a[k],p=a[k+1];if(!(0<k&&l===c&&p===d)){c=l;d=p;this.vertexList.push([l,p]);if(!e||l>f)f=l,e=this.vertexList.last();
h?(g[0]=g[2]=l,g[1]=g[3]=p,h=!1):(g[0]=Math.min(g[0],l),g[1]=Math.min(g[1],p),g[2]=Math.max(g[2],l),g[3]=Math.max(g[3],p));this.vertexCount++}}this.maxXNode=e;this.bounds=g;a=0;b=!0;c=-2;d=this.vertexList.first();e=this.vertexList.last().data;for(f=d.data;d;)g=d.next?d.next.data:f,h=d.prev?d.prev.data:e,b&&(h=Y(h,d.data,g),-2!==c&&h!==c&&(b=!1),c=h),a+=d.data[0]*g[1]-d.data[1]*g[0],d=d.next;this.convex=b;this.winding=0===a?0:0>a?-1:1};P._Contour.prototype.findVisiblePoint=function(a,b){var c=this.vertexList.first();
if("undefined"===typeof c||null===c)return null;var d=this.bounds;if(a<d[0]||b<d[1]||a>d[2]||b>d[2])return null;for(var d=this.vertexList.last(),e=c,f=[];c;){var g=c.next?c.next:e,h=c.data[0],k=g.data[0],l=c.data[1],p=g.data[1],m=Math.min(h,k),n=Math.min(l,p),q=Math.max(l,p);if(h===a&&l===b)return c;if(k===a&&p===b)return g;a<=Math.max(h,k)&&b>=n&&b<=q&&(l===p?f.push([m,m===c.data[0]?c:g,!0]):(l=a+(b-l)/(p-l)*(k-h),l>=a&&(l===h?f.push([l,c,!0]):l===k?f.push([l,g,!0]):f.push([l,c,!1]))));c=c.next}if(0===
f.length)return null;1<f.length&&(f=f.sort(function(a,b){return a[0]===b[0]?0:a[0]<b[0]?-1:1}));if(f[0][2])return f[0][1];c=f[0][1];c=c.next?c.next:e;g=[a,b];f=[f[0][0],b];h=e;for(k=[];h;)h!==c&&(l=Y((h.prev?h.prev:d).data,h.data,(h.next?h.next:e).data),0!==l&&l!==this.vertexList.winding&&P._pointInTri(g,f,c.data,h.data)&&(l=h.data[0]-g[0],p=h.data[1]-g[1],p=Math.sqrt(l*l+p*p),l/=p,-1>l&&(l=-1),1<l&&(l=1),k.push([Math.acos(l),p,h]))),h=h.next;if(0===k.length)return c;1<k.length&&(k=k.sort(function(a,
b){return a[0]===b[0]?a[1]===b[1]?0:a[1]<b[1]?-1:1:a[0]<b[0]?-1:1}));return k[0][2]};m.prototype.getTriangles=function(a){if("undefined"===typeof a||null===a)a=1;var b=this._getSubpaths(a,!0),c=[],d=[],e=0;a=[];var f;for(f=0;f<b.length;f++){var g=new P._Contour(b[f]);0<g.winding?(0===e&&(e=1),c.push(g)):0>g.winding&&(0===e&&(e=-1),d.push(g))}if(0===d.length||0===c.length)for(b=0===d.length?c:d,f=0;f<b.length;f++)P._triangulate(b[f],a);else{b=0<e?c:d;d=0<e?d:c;for(f=0;f<d.length;f++)if(d[f])for(c=
0;c<b.length;c++)if(b[c]&&(e=d[f].maxXNode,g=b[c].findVisiblePoint(e.data[0],e.data[1]))){b[c].vertexCount+=P._connectContours(d[f].vertexList,b[c].vertexList,e,g);d[f]=null;break}for(f=0;f<b.length;f++)P._triangulate(b[f],a);for(f=0;f<d.length;f++)P._triangulate(d[f],a)}return a};m.prototype.toMeshBuffer=function(a,b){if("undefined"===typeof a||null===a)a=0;for(var c=this.getTriangles(b),d=[],e=0;e<c.length;e++){var f=c[e];d.push(f[0],f[1],a,0,0,1,f[0],f[1],f[2],f[3],a,0,0,1,f[2],f[3],f[4],f[5],
a,0,0,1,f[4],f[5])}return H3DU.MeshBuffer.fromPositionsNormalsUV(d)};P._connectContours=function(a,b,c,d){for(var e=d,f=c,g=0;f;)e=b.insertAfter(f.data,e),f=f.next,g++;for(f=a.first();f!==c&&"undefined"!==typeof f&&null!==f;)e=b.insertAfter(f.data,e),f=f.next,g++;e=b.insertAfter(c.data,e);b.insertAfter(d.data,e);b.convex=!1;return g+2};P._triangulate=function(a,b){var c,d;if(a&&!(3>a.vertexCount)&&0!==a.winding)if(3===a.vertexCount){c=a.vertexList.first();for(d=[];c;)d.push(c.data[0],c.data[1]),c=
c.next;b.push(d)}else{d=[];for(c=a.vertexList.first();c;)d.push([c.data[0],c.data[1]]),c=c.next;c=[];a.convex?c.push(d):3>d.length||(console.warn("not implemented"),c.push(d));if(0<d.length&&0===c.length)throw Error();for(d=0;d<c.length;d++)for(var e=c[d],f=0;f<e.length-2;f++)b.push([e[0][0],e[0][1],e[f+1][0],e[f+1][1],e[f+2][0],e[f+2][1]])}};var tb=function(a){this.comparer=a;this.nodes=[];this._size=0;this.size=function(){return this._size};this._compare=function(a,c){return this.comparer?this.comparer(a,
c):a===c?0:a<c?-1:1};this.push=function(a){for(var b=this._size;0<b;){var d=(b-1)/2|0;if(0<this.comparer(a,this.nodes[d]))this.nodes[b]=this.nodes[d],b=d;else break}this.nodes[b]=a;this._size+=1;return this};this.pop=function(){var a=null;if(0<this._size){var c=0,a=this.nodes[c];this._size--;for(var d=this.nodes[this._size];;){var e=1+2*c,f=2*(c+1);if(e<this._size)if(e=f>=this._size||0<this.comparer(this.nodes[e],this.nodes[f])?e:f,0>this.comparer(d,this.nodes[e]))this.nodes[c]=this.nodes[e],c=e;
else break;else break}this.nodes[c]=d}return a}},da=function(a){this.right=this.left=null;this.red=!0;this.p=null;this.data=a;this.link=function(a){return a?this.right:this.left};this.copy=function(){var a=new da(this.data);a.left=this.left;a.right=this.right;a.red=this.red;a.p=this.p;a.data=this.data;return a};this.setLink=function(a,c){a?this.right=c:this.left=c;"undefined"!==typeof c&&null!==c&&(c.p=this)};this.prev=function(){if("undefined"!==typeof this.left&&null!==this.left){for(var a=this.left;"undefined"!==
typeof a.right&&null!==a.right;)a=a.right;return a}for(var a=this.p,c=this;"undefined"!==typeof a&&null!==a&&c===a.left;)c=a,a=a.p;return a};this.next=function(){if("undefined"!==typeof this.right&&null!==this.right){for(var a=this.right;"undefined"!==typeof a.left&&null!==a.left;)a=a.left;return a}for(var a=this.p,c=this;"undefined"!==typeof a&&null!==a&&c===a.right;)c=a,a=a.p;return a}},E=function(a){this.comparer=a?a:E._defaultCompare;this.root=null;this._size=0;this.size=function(){return this._size}};
E._defaultCompare=function(a,b){return a===b?0:a<b?-1:1};E.prototype.first=function(){var a=this.root;if("undefined"===typeof a||null===a)return null;for(;"undefined"!==typeof a.left&&null!==a.left;)a=a.left;return a};E.prototype.last=function(){var a=this.root;if("undefined"===typeof a||null===a)return null;for(;"undefined"!==typeof a.right&&null!==a.right;)a=a.right;return a};E.prototype.find=function(a){for(var b=this.root;"undefined"!==typeof b&&null!==b;){var c=this.cmp(b.data,a);if(0===c)break;
b=0>c?b.right:b.left}return"undefined"===typeof b||null===b?null:b.data};E._red=function(a){return"undefined"!==typeof a&&null!==a&&1===a.red};E._single=function(a,b){var c=a.link(!b);a.setLink(!b,c.link(b));c.setLink(b,a);a.red=!0;c.red=!1;return c};E._double=function(a,b){a.setLink(!b,E._single(a.link(!b),!b));return E._single(a,b)};E.prototype.erase=function(a){if("undefined"!==typeof this.root&&null!==this.root){var b=new da(null),c,d,e,f=null,g=!0;c=b;d=null;for(c.setLink(!0,this.root);null!==
c.link(g);){var h=g;e=d;d=c;c=c.link(g);var k=this.comparer(c.data,a),g=0>k;0===k&&(f=c);if(!E._red(c)&&!E._red(c.link(g)))if(E._red(c.link(!g)))d.setLink(h,d=E._single(c,g));else if(!E._red(c.link(!g))&&(k=d.link(!h),"undefined"!==typeof k&&null!==k))if(E._red(k.link(!h))||E._red(k.link(h))){var l=e.right===d;E._red(k.link(h))?e.setLink(l,E._double(d,h)):E._red(k.link(!h))&&e.setLink(l,E._single(d,h));c.red=e.link(l).red=!1;e.link(l).left.red=!0;e.link(l).right.red=!0}else d.red=!1,k.red=!0,c.red=
!0}"undefined"!==typeof f&&null!==f&&(f.data=c.data,d.setLink(d.right===c,c.link("undefined"===typeof c.left||null===c.left)));this.root=b.right;"undefined"!==typeof this.root&&null!==this.root&&(this.root.p=null,this.root.red=!1);--this._size}};E.prototype.insert=function(a){if(!a)throw Error();if("undefined"===typeof this.root||null===this.root)a=this.root=new da(a);else{var b=new da(null),c,d,e,f,g=!1,h=!1;d=b;c=e=null;f=this.root;for(d.setLink(!0,f);;){"undefined"===typeof f||null===f?e.setLink(g,
f=new da(a)):E._red(f.left)&&E._red(f.right)&&(f.red=!0,f.left.red=!1,f.right.red=!1);if(E._red(f)&&E._red(e)){var k=d.right===c;f===e.link(h)?d.setLink(k,E._single(c,!h)):d.setLink(k,E._double(c,!h))}k=this.comparer(f.data,a);if(0===k){a=f;break}h=g;g=0>k;"undefined"!==typeof c&&null!==c&&(d=c);c=e;e=f;f=f.link(g)}this.root=b.right;"undefined"!==typeof this.root&&null!==this.root&&(this.root.p=null)}this.root.red=!1;++this._size;return a};var M=function(a,b){this.subpaths=[];this.contours=[];if("undefined"!==
typeof a&&null!==a){this.subpaths=a._getSubpaths(b,!0);for(var c=0;c<this.subpaths.length;c++)this.contours[c]=new M._Contour(this.subpaths[c])}this.path=a;this.getBounds=function(){return this.path.getBounds()};this.ncontours=function(){return this.subpaths.length};this.contour=function(a){return this.contours[a]};this.push=function(a){this.contours.push(a)};this.toPath=function(){for(var a=new m,b=0;b<this.contours.length;b++){for(var c=this.contours[b].vertices,g=0;g<c.length;g+=2)0===g?a.moveTo(c[g],
c[g+1]):a.lineTo(c[g],c[g+1]);a.closePath()}return a}};M._Contour=function(a){this.vertices=a;this.nvertices=function(){return this.vertices.length/2};this.segment=function(a){return a===this.nvertices()-1?[[this.vertices[2*a],this.vertices[2*a+1]],[this.vertices[0],this.vertices[1]]]:[[this.vertices[2*a],this.vertices[2*a+1]],[this.vertices[2*a+2],this.vertices[2*a+3]]]}};var q=function(a,b){this.eq=new tb(q.sweepEventCompNum);this.eventHolder=[];this.subject=a;this.clipping=b;this.nint=0};M.PointChain=
function(){this.l=new fa;this._closed=!1;this.closed=function(){return this._closed};this.clear=function(){this.l.clear()};this.first=function(){return this.l.first()};this.size=function(){return this.l.length};this.init=function(a){this.l.push(a[0]).push(a[1])};this.linkSegment=function(a){return q._ptEq(a[0],this.l.front())?(q._ptEq(a[1],this.l.back())?this._closed=!0:this.l.unshift(a[1]),!0):q._ptEq(a[1],this.l.back())?(q._ptEq(a[0],this.l.front())?this._closed=!0:this.l.push(a[0]),!0):q._ptEq(a[1],
this.l.front())?(q._ptEq(a[0],this.l.back())?this._closed=!0:this.l.unshift(a[0]),!0):q._ptEq(a[0],this.l.back())?(q._ptEq(a[1],this.l.front())?this._closed=!0:this.l.push(a[1]),!0):!1}};M.PointChain.prototype.linkPointChain=function(a){return q._ptEq(a.l.front(),this.l.back())?(a.l.shift(),this.l.spliceToEnd(a.l),!0):q._ptEq(a.l.back(),this.l.front())?(this.l.shift(),this.l.spliceToBegin(a.l),!0):q._ptEq(a.l.front(),this.l.front())?(this.l.shift(),a.l.reverse(),this.l.spliceToBegin(a.l),!0):q._ptEq(a.l.back(),
this.l.back())?(this.l.pop(),a.l.reverse(),this.l.spliceToEnd(a.l),!0):!1};ha.prototype.add=function(a){for(var b=this.openPolygons.first();b;){if(b.data.linkSegment(a)){if(b.data.closed())this.closedPolygons.spliceOneToEnd(this.openPolygons,b);else for(a=b.next;a;){if(b.data.linkPointChain(a.data)){this.openPolygons.erase(a);break}a=a.next}return}b=b.next}b=new M.PointChain;b.init(a);this.openPolygons.push(b)};ha.prototype.toPolygon=function(){for(var a=new M(null),b=this.closedPolygons.first();b;){for(var c=
new M._Contour([]),d=b.data.first();d;)c.vertices.push(d.data[0],d.data[1]),d=d.next;a.contours.push(c);b=b.next}return a};q.NORMAL=0;q.SUBJECT=0;q.CLIPPING=1;q.INTERSECTION=0;q.UNION=1;q.DIFFERENCE=2;q.XOR=3;q.NON_CONTRIBUTING=1;q.SAME_TRANSITION=2;q.DIFFERENT_TRANSITION=3;q.SweepEvent=function(a,b,c,d,e){this.p=a;this.id=-1;this.left=b;this.pl=c;this.other=d;this.type="undefined"===typeof e||null===e?q.NORMAL:e;this.poss=null;this.inside=this.inOut=!1;this.segment=function(){return[this.p,this.other.p]};
this.below=function(a){return this.left?0<q.signedArea(this.p,this.other.p,a):0<q.signedArea(this.other.p,this.p,a)};this.above=function(a){return!this.below(a)}};q.signedArea=function(a,b,c){return.5*((a[0]-c[0])*(b[1]-c[1])-(b[0]-c[0])*(a[1]-c[1]))};q._ptEq=function(a,b){return a[0]===b[0]&&a[1]===b[1]};q.sweepEventComp=function(a,b){return a.p[0]>b.p[0]?!0:b.p[0]>a.p[0]?!1:q._ptEq(a.p,b.p)?a.left!==b.left?a.left:a.above(b.other.p):a.p[1]>b.p[1]};q.sweepEventCompNum=function(a,b){return a===b?0:
q.sweepEventComp(a,b)?-1:1};q.segmentComp=function(a,b){return a===b?!1:0!==q.signedArea(a.p,a.other.p,b.p)||0!==q.signedArea(a.p,a.other.p,b.other.p)?q._ptEq(a.p,b.p)?a.below(b.other.p):q.sweepEventComp(a,b)?b.above(a.p):a.below(b.p):q._ptEq(a.p,b.p)?a.id<b.id:q.sweepEventComp(a,b)};q.segmentCompNum=function(a,b){return a===b?0:q.segmentComp(a,b)?-1:1};q.prototype.storeSweepEvent=function(a){a.id=this.eventHolder.length;this.eventHolder.push(a);return a};q.prototype.compute=function(a){if(0===this.subject.ncontours()*
this.clipping.ncontours())return a===q.DIFFERENCE?this.subject:a===q.UNION?0===this.subject.ncontours()?this.clipping:this.subject:new M;var b,c,d=new M,e=this.subject.getBounds();c=this.clipping.getBounds();b=[e[0],e[1]];var e=[e[2],e[3]],f=[c[0],c[1]],g=[c[2],c[3]];if(b[0]>g[0]||f[0]>e[0]||b[1]>g[1]||f[1]>e[1]){if(a===q.DIFFERENCE)return this.subject;if(a===q.UNION)for(d=this.subject,b=0;b<this.clipping.ncontours();b++)d.push(this.clipping.contour(b));return d}for(b=0;b<this.subject.ncontours();b++)for(c=
0;c<this.subject.contour(b).nvertices();c++)this.processSegment(this.subject.contour(b).segment(c),q.SUBJECT);for(b=0;b<this.clipping.ncontours();b++)for(c=0;c<this.clipping.contour(b).nvertices();c++)this.processSegment(this.clipping.contour(b).segment(c),q.CLIPPING);b=new E(q.segmentCompNum);var h,k,l;c=new ha;for(f=Math.min(e[0],g[0]);0<this.eq.size();){g=this.eq.pop();if(a===q.INTERSECTION&&g.p[0]>f||a===q.DIFFERENCE&&g.p[0]>e[0])break;if(a===q.UNION&&g.p[0]>f){for(g.left||c.add(g.segment());0<
this.eq.size();)g=this.eq.pop(),g.left||c.add(g.segment());break}if(g.left){h=b.insert(g);g.poss=h;if(!h)throw Error();if((l=k=h)&&!l.data)throw Error();k=k!==b.first()?k.prev():null;"undefined"===typeof k||null===k?g.inside=g.inOut=!1:k.data.type!==q.NORMAL?k===b.first()?(g.inside=!0,g.inOut=!1):(h=k,h=h.prev(),k.data.pl===g.pl?(g.inOut=!k.data.inOut,g.inside=!h.data.inOut):(g.inOut=!h.data.inOut,g.inside=!k.data.inOut)):g.pl===k.data.pl?(g.inside=k.data.inside,g.inOut=!k.data.inOut):(g.inside=!k.data.inOut,
g.inOut=k.data.inside);l=l.next();"undefined"!==typeof l&&null!==l&&this.possibleIntersection(g,l.data);"undefined"!==typeof k&&null!==k&&this.possibleIntersection(k.data,g)}else{l=k=h=g.other.poss;l=l.next();k=k!==b.first()?k.prev():null;switch(g.type){default:throw Error();case q.NORMAL:switch(a){default:throw Error();case q.INTERSECTION:g.other.inside&&c.add(g.segment());break;case q.UNION:g.other.inside||c.add(g.segment());break;case q.DIFFERENCE:(g.pl===q.SUBJECT&&!g.other.inside||g.pl===q.CLIPPING&&
g.other.inside)&&c.add(g.segment());break;case q.XOR:c.add(g.segment())}break;case q.SAME_TRANSITION:a!==q.INTERSECTION&&a!==q.UNION||c.add(g.segment());break;case q.DIFFERENT_TRANSITION:a===q.DIFFERENCE&&c.add(g.segment())}b.erase(h.data);"undefined"!==typeof l&&null!==l&&"undefined"!==typeof k&&null!==k&&this.possibleIntersection(k.data,l.data)}}return c.toPolygon(d)};q.prototype.processSegment=function(a,b){if(!q._ptEq(a[0],a[1])){var c=this.storeSweepEvent(new q.SweepEvent(a[0],!0,b,null)),d=
this.storeSweepEvent(new q.SweepEvent(a[1],!0,b,c));c.other=d;c.p[0]<d.p[0]?d.left=!1:c.p[0]>d.p[0]?c.left=!1:c.p[1]<d.p[1]?d.left=!1:c.left=!1;this.eq.push(c);this.eq.push(d)}};q.findIntersection=function(a,b,c,d){a=q._findIntersectionInternal(a[0][0],a[0][1],a[1][0],a[1][1],b[0][0],b[0][1],b[1][0],b[1][1]);0<a.length&&(c[0]=a[0][0],c[1]=a[0][1]);1<a.length&&(d[0]=a[1][0],d[1]=a[1][1]);return a.length};q._findIntersectionInternal=function(a,b,c,d,e,f,g,h){var k,l=c-a,p=d-b,m=g-e;k=h-f;var n=l*l+
p*p,q=m*m+k*k,t=[];if(0===n)return 0===q?a===e&&b===f&&t.push([a,b]):(l=((a-e)*m+(b-f)*k)/q,0<=l&&1>=l&&(p=[e+m*l,f+k*l],l=a-p[0],p=b-p[1],1E-9>=Math.sqrt(l*l+p*p)&&t.push([a,b]))),t;if(0===q)return c=((e-a)*l+(f-b)*p)/n,0<=c&&1>=c&&(b=[a+l*c,b+p*c],a=e-b[0],b=f-b[1],1E-9>=Math.sqrt(a*a+b*b)&&t.push([e,f])),t;var n=l*k-m*p,q=e-a,r=f-b,m=q*k-m*r;k=q*p-l*r;if(0===n){if(0===m&&0===k){t=(l*(e-a)+p*(f-b))/(l*l+p*p);f=(l*(g-a)+p*(h-b))/(l*l+p*p);if(0>=t&&1<=f||1<=t&&0>=f)return[[a,b],[c,d]];if(0>t&&0>f||
1<t&&1<f)return[];if(0>=t&&0>=f)return[[a,b]];if(1<=t&&1<=f)return[[c,d]];if(0>t||0>f)return t=Math.max(t,f),[[a,b],[a+l*t,b+p*t]];if(1<t||1<f)return e=Math.min(t,f),[[a+l*e,b+p*e],[c,d]];e=Math.min(t,f);t=Math.max(t,f);return[[a+l*e,b+p*e],[a+l*t,b+p*t]]}}else e=m/n,f=k/n,0<=e&&1>=e&&0<=f&&1>=f&&t.push([a+l*e,b+p*e]);return t};q.prototype.possibleIntersection=function(a,b){var c=[],d;if(d=q.findIntersection(a.segment(),b.segment(),c,[]))if(1!==d||!q._ptEq(a.p,b.p)&&!q._ptEq(a.other.p,b.other.p))if(2!==
d||a.pl!==b.pl)1===d?(q._ptEq(a.p,c)||q._ptEq(a.other.p,c)||this._divideSegment(a,c),q._ptEq(b.p,c)||q._ptEq(b.other.p,c)||this._divideSegment(b,c)):(c=[],q._ptEq(a.p,b.p)?c.push(null):q.sweepEventComp(a,b)?(c.push(b),c.push(a)):(c.push(a),c.push(b)),q._ptEq(a.other.p,b.other.p)?c.push(null):q.sweepEventComp(a.other,b.other)?(c.push(b.other),c.push(a.other)):(c.push(a.other),c.push(b.other)),2===c.length?(a.type=a.other.type=q.NON_CONTRIBUTING,b.type=b.other.type=a.inOut===b.inOut?q.SAME_TRANSITION:
q.DIFFERENT_TRANSITION):3===c.length?(c[1].type=c[1].other.type=q.NON_CONTRIBUTING,c[0]?c[0].other.type=a.inOut===b.inOut?q.SAME_TRANSITION:q.DIFFERENT_TRANSITION:c[2].other.type=a.inOut===b.inOut?q.SAME_TRANSITION:q.DIFFERENT_TRANSITION,this._divideSegment(c[0]?c[0]:c[2].other,c[1].p)):c[0]!==c[3].other?(c[1].type=q.NON_CONTRIBUTING,c[2].type=a.inOut===b.inOut?q.SAME_TRANSITION:q.DIFFERENT_TRANSITION,this._divideSegment(c[0],c[1].p),this._divideSegment(c[1],c[2].p)):(c[1].type=c[1].other.type=q.NON_CONTRIBUTING,
this._divideSegment(c[0],c[1].p),c[3].other.type=a.inOut===b.inOut?q.SAME_TRANSITION:q.DIFFERENT_TRANSITION,this._divideSegment(c[3].other,c[2].p)))};q.prototype._divideSegment=function(a,b){var c=this.storeSweepEvent(new q.SweepEvent(b,!1,a.pl,a,a.type)),d=this.storeSweepEvent(new q.SweepEvent(b,!0,a.pl,a.other,a.other.type));q.sweepEventComp(d,a.other)&&(a.other.left=!0,d.left=!1);q.sweepEventComp(a,c);a.other.other=d;a.other=c;this.eq.push(d);this.eq.push(c)};m.prototype.union=function(a,b){if("undefined"===
typeof a||null===a)return this;var c=new M(this,b),d=new M(a,b);return(new q(c,d)).compute(q.UNION).toPath()};m.prototype.difference=function(a,b){if("undefined"===typeof a||null===a)return this;var c=new M(this,b),d=new M(a,b);return(new q(c,d)).compute(q.DIFFERENCE).toPath()};m.prototype.intersection=function(a,b){if("undefined"===typeof a||null===a)return this;var c=new M(this,b),d=new M(a,b);return(new q(c,d)).compute(q.INTERSECTION).toPath()};m.prototype.xor=function(a,b){if("undefined"===typeof a||
null===a)return this;var c=new M(this,b),d=new M(a,b);return(new q(c,d)).compute(q.XOR).toPath()};var N=function(a){if("undefined"===typeof a||null===a)throw Error("mesh is null");this.meshBuffer=a;this.transform=new H3DU.Transform;this.parent=null;this.visible=!0};N.prototype.getMeshBuffer=function(){return this.meshBuffer};N._meshBufferWarning=!1;N.prototype.vertexCount=function(){return this.meshBuffer?this.meshBuffer.vertexCount():0};N.prototype.primitiveCount=function(){return this.meshBuffer?
this.meshBuffer.primitiveCount():0};N.prototype.setVisible=function(a){this.visible=!!a;return this};N.prototype.getVisible=function(){return this.visible};N.prototype.copy=function(){var a=new H3DU.Shape(this.meshBuffer);a.visible=this.visible;a.parent=null;a.transform=this.getTransform().copy();return a};N.prototype.getTransform=function(){return this.transform};N.prototype.getBounds=function(){if(!this.meshBuffer){var a=Number.POSITIVE_INFINITY;return[a,a,a,-a,-a,-a]}var b=this.meshBuffer.getBounds();
if(H3DU.Math.boxIsEmpty(b))return b;var c=this.getMatrix();if(H3DU.Math.mat4isIdentity(c))return b.slice(0,6);if(0===c[1]&&0===c[2]&&0===c[3]&&0===c[4]&&0===c[6]&&0===c[7]&&0===c[8]&&0===c[9]&&0===c[11]&&1===c[15]){var a=[],d=c[0],e=c[12];a[0]=d*b[0]+e;var f=c[5],g=c[13];a[1]=f*b[1]+g;var h=c[10],c=c[14];a[2]=h*b[2]+c;b=[d*b[3]+e,f*b[4]+g,h*b[5]+c];return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2]),Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2])]}a=[H3DU.Math.mat4projectVec3(c,
b[0],b[1],b[2]),H3DU.Math.mat4projectVec3(c,b[0],b[1],b[5]),H3DU.Math.mat4projectVec3(c,b[0],b[4],b[2]),H3DU.Math.mat4projectVec3(c,b[0],b[4],b[5]),H3DU.Math.mat4projectVec3(c,b[3],b[1],b[2]),H3DU.Math.mat4projectVec3(c,b[3],b[1],b[5]),H3DU.Math.mat4projectVec3(c,b[3],b[4],b[2]),H3DU.Math.mat4projectVec3(c,b[3],b[4],b[5])];b=a[0];d=[b[0],b[1],b[2],b[0],b[1],b[2]];for(e=1;8>e;e++)b=a[e],d[0]=Math.min(d[0],b[0]),d[1]=Math.min(d[1],b[1]),d[2]=Math.min(d[2],b[2]),d[3]=Math.max(d[3],b[0]),d[4]=Math.max(d[4],
b[1]),d[5]=Math.max(d[5],b[2]);return d};N.prototype.isCulled=function(a){return this.meshBuffer&&this.visible?!H3DU.Math.frustumHasBox(a,this.getBounds()):!0};N.prototype.setTransform=function(a){this.transform=a.copy();return this};N.prototype.setScale=function(a,b,c){this.getTransform().setScale(a,b,c);return this};N.prototype.setPosition=function(a,b,c){this.getTransform().setPosition(a,b,c);return this};N.prototype.setQuaternion=function(a){this.getTransform().setQuaternion(a);return this};N.prototype.getMatrix=
function(){var a=this.getTransform(),b=a.isIdentity();if("undefined"===typeof this.parent||null===this.parent)a=a.getMatrix();else var c=this.parent.getMatrix(),a=b?c:H3DU.Math.mat4isIdentity(c)?a.getMatrix():H3DU.Math.mat4multiply(c,a.getMatrix());return a};var G=function(){this._init()};G.prototype._init=function(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new H3DU.Transform};G.prototype.shapeCount=function(){return this.shapes.length};G.prototype.getShape=function(a){return"undefined"===
typeof this.shapes[a]?null:this.shapes[a]};G.prototype.setShape=function(a,b){this.shapes[a]=b;return this};G.prototype.copy=function(){var a=new H3DU.ShapeGroup;a.visible=this.visible;a.transform=this.transform.copy();for(var b=0;b<this.shapes.length;b++)a.addShape(this.shapes[b].copy());return a};G.prototype.addShape=function(a){if(!a)throw Error();a.parent=this;this.shapes.push(a);return this};G.prototype.setVisible=function(a){this.visible=!!a;return this};G.prototype.getVisible=function(){return this.visible};
G.prototype.getTransform=function(){return this.transform};G.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if("undefined"!==typeof this.parent&&null!==this.parent)var c=this.parent.getMatrix(),a=b?H3DU.Math.mat4multiply(c,a.getMatrix()):H3DU.Math.mat4isIdentity(c)?a.getMatrix():c;else a=a.getMatrix();return a};G.prototype.setTransform=function(a){this.transform=a.copy();return this};G.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===
a&&(this.shapes.splice(b,1),b--);return this};G.prototype.getBounds=function(){for(var a=Number.POSITIVE_INFINITY,a=[a,a,a,-a,-a,-a],b=!0,c=0;c<this.shapes.length;c++){var d=this.shapes[c].getBounds();H3DU.Math.boxIsEmpty(d)||(b?(a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=d[3],a[4]=d[4],a[5]=d[5],b=!1):(a[0]=Math.min(d[0],a[0]),a[1]=Math.min(d[1],a[1]),a[2]=Math.min(d[2],a[2]),a[3]=Math.max(d[3],a[3]),a[4]=Math.max(d[4],a[4]),a[5]=Math.max(d[5],a[5])))}return a};G.prototype.vertexCount=function(){for(var a=
0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};G.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};G.prototype.setPosition=function(a,b,c){this.transform.setPosition(a,b,c);return this};G.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};G.prototype.setScale=function(a,b,c){this.transform.setScale(a,b,c);return this};var z=function(){this.scale=[1,1,1];this.position=[0,
0,0];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=H3DU.Math.mat4identity()};z.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],this.matrix[10]]:this.scale.slice(0,3)};z.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};z.prototype.getQuaternion=function(){return this.complexMatrix?H3DU.Math.quatNormalizeInPlace(H3DU.Math.quatFromMat4(this.matrix)):
this.rotation.slice(0,4)};z.prototype.reset=function(){this.matrix=H3DU.Math.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;return this};z.prototype.setMatrix=function(a){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=H3DU.Math.quatFromMat4(this.matrix);this.rotation=H3DU.Math.quatNormalizeInPlace(this.rotation);
this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15];return this};z.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&H3DU.Math.quatIsIdentity(this.rotation);
return this._isIdentity};z.prototype.setScale=function(a,b,c){if(this.complexMatrix)return this;this.scale="undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};z.prototype.setPosition=function(a,b,c){if(this.complexMatrix)return this;this.position="undefined"===typeof a||null===
a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};z.prototype.movePosition=function(a,b,c){if(this.complexMatrix)return this;"undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?(this.position[0]+=a,this.position[1]+=b,this.position[2]+=c):"number"!==
typeof a?(this.position[0]+=a[0],this.position[1]+=a[1],this.position[2]+=a[2]):(this.position[0]+=a,this.position[1]+=a,this.position[2]+=a);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};z.prototype.setQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=a.slice(0,4);H3DU.Math.quatNormalizeInPlace(this.rotation);this._matrixDirty=!0;return this};z.prototype.setRotation=function(a,b,c,d){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,
b,c,d))};z.prototype.setOrientation=function(a,b,c,d){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};z.prototype.multQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=H3DU.Math.quatNormalizeInPlace(H3DU.Math.quatMultiply(this.rotation,a));this._matrixDirty=!0;return this};z.prototype.multRotation=function(a,b,c,d){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};z.prototype.multOrientation=function(a,b,c,d){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,
b,c,d))};z.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,H3DU.Math.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=
H3DU.Math.mat4multiply(this.matrix,H3DU.Math.quatToMat4(this.rotation));H3DU.Math.mat4scaleInPlace(this.matrix,this.scale);var a=this.matrix;this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]}else if(this._isIdentity)return H3DU.Math.mat4identity();return this.matrix.slice(0,16)};z.prototype.copy=function(){var a=new H3DU.Transform;a.scale=this.scale.slice(0,this.scale.length);
a.position=this.position.slice(0,this.scale.length);a.complexMatrix=this.complexMatrix;a._matrixDirty=this._matrixDirty;a.matrix=this.matrix.slice(0,this.matrix.length);return a};var Q={},ma=function(a){this.indices=a;this.last=this.start=-1;this.addIndex=function(a){0>this.start?this.start=a:(0>this.last||(this.indices.push(this.start),this.indices.push(this.last),this.indices.push(a)),this.last=a)}},Z=function(a,b){var c=new Float32Array(a);return(new H3DU.MeshBuffer).setIndices(b).setAttribute(H3DU.Semantic.POSITION,
c,3,0,8).setAttribute(H3DU.Semantic.NORMAL,c,3,3,8).setAttribute(H3DU.Semantic.TEXCOORD,c,2,6,8)};Q.createBox=function(a,b,c,d){a*=.5;b*=.5;c*=.5;a=[-a,-b,c,-1,0,0,1,0,-a,b,c,-1,0,0,1,1,-a,b,-c,-1,0,0,0,1,-a,-b,-c,-1,0,0,0,0,a,-b,-c,1,0,0,1,0,a,b,-c,1,0,0,1,1,a,b,c,1,0,0,0,1,a,-b,c,1,0,0,0,0,a,-b,-c,0,-1,0,1,0,a,-b,c,0,-1,0,1,1,-a,-b,c,0,-1,0,0,1,-a,-b,-c,0,-1,0,0,0,a,b,c,0,1,0,1,0,a,b,-c,0,1,0,1,1,-a,b,-c,0,1,0,0,1,-a,b,c,0,1,0,0,0,-a,-b,-c,0,0,-1,1,0,-a,b,-c,0,0,-1,1,1,a,b,-c,0,0,-1,0,1,a,-b,-c,
0,0,-1,0,0,a,-b,c,0,0,1,1,0,a,b,c,0,0,1,1,1,-a,b,c,0,0,1,0,1,-a,-b,c,0,0,1,0,0];if(d)for(d=0;d<a.length;d+=8)a[d+3]=-a[d+3],a[d+4]=-a[d+4],a[d+5]=-a[d+5];return Z(a,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23])};Q.createCylinder=function(a,b,c,d,e,f,g){if("undefined"===typeof d||null===d)d=32;if("undefined"===typeof e||null===e)e=1;if(2>=d)throw Error("too few slices");if(1>e)throw Error("too few stacks");if(0>c)throw Error("negative height");if(0>=
a&&0>=b||0===c)return new H3DU.MeshBuffer;for(var h=g?-1:1,k=[],l=[],p=H3DU.Math.PiTimes2/d,m=Math.cos(p),n=3.141592653589793>=p?Math.sqrt(1-m*m):-Math.sqrt(1-m*m),q=1,t=0,p=0;p<d;p++){var r=1*p/d;k.push(q,t);l.push(r);r=m*q+n*t;t=m*t-n*q;q=r}k.push(k[0],k[1]);l.push(1);if(0<c){a===b?(n=0,m=h):(p=a-b,m=c,n=Math.sqrt(m*m+p*p),0!==n&&(n=1/n,p*=n,m*=n),m*=h,n=p*h);h=1/e;q=[];for(p=0;p<=e;p++)for(var t=p===e?1:p*h,r=c*t,u=a+(b-a)*t,w=0;w<=d;w++){var x,z;x=k[2*w];z=k[2*w+1];q.push(x*u,z*u,r,x*m,z*m,n,
1-l[w],t)}a=ba(q,d+1,e+1);return f?a.recalcNormals(f,g):a}return Z([],[])};Q.createLathe=function(a,b,c,d){if(4>a.length)throw Error("too few points");if("undefined"===typeof b||null===b)b=32;if(2>=b)throw Error("too few slices");if(0!==a.length%1)throw Error("points array length is not an even number");var e;for(e=0;e<a.length;e+=2)if(0>a[e<<1])throw Error("point's x is less than 0");var f=[],g=[];e=H3DU.Math.PiTimes2/b;var h=Math.cos(e),k=3.141592653589793>=e?Math.sqrt(1-h*h):-Math.sqrt(1-h*h),
l=1,m=0;for(e=0;e<b;e++){var n=1*e/b;f.push(l,m);g.push(n);n=h*l+k*m;m=h*m-k*l;l=n}f.push(f[0],f[1]);g.push(1);h=a.length/2-1;k=1/h;l=[];for(e=0;e<=h;e++)for(var m=e===h?1:e*k,q=e<<1,n=a[q+1],q=a[q],r=0;r<=b;r++)l.push(f[2*r]*q,f[2*r+1]*q,n,0,0,0,1-g[r],m);return ba(l,b+1,h+1).recalcNormals(c,d)};Q.createClosedCylinder=function(a,b,c,d,e,f,g){e=H3DU.Meshes.createCylinder(a,b,c,d,e,f,g);a=H3DU.Meshes.createDisk(0,a,d,2,!g).reverseWinding();b=H3DU.Meshes.createDisk(0,b,d,2,g);b.transform(H3DU.Math.mat4translated(0,
0,c));return e.merge(a).merge(b)};Q.createDisk=function(a,b,c,d,e){return H3DU.Meshes.createPartialDisk(a,b,c,d,0,360,e)};Q.createPartialDisk=function(a,b,c,d,e,f,g){if("undefined"===typeof c||null===c)c=32;if("undefined"===typeof d||null===d)d=1;if("undefined"===typeof e||null===e)e=0;if("undefined"===typeof f||null===f)f=360;if(2>=c)throw Error("too few slices");if(1>d)throw Error("too few loops");if(a>b)throw Error("inner greater than outer");0>a&&(a=0);0>b&&(b=0);if(0===b||0===f)return new H3DU.MeshBuffer;
var h=360===f&&0===e,k=0>f?-1:1;0>f&&(f=-f);f%=360;0===f&&(f=360);var l=[],m=[],n=H3DU.Math.PiTimes2,q=360===f?n:f*H3DU.Math.PiDividedBy180;e*=H3DU.Math.PiDividedBy180;0>k&&(q=-q);var r=q/c,k=Math.cos(r),r=0<=r&&6.283185307179586>r?3.141592653589793>=r?Math.sqrt(1-k*k):-Math.sqrt(1-k*k):Math.sin(r),t=Math.cos(e),u=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(e),w=t,y=u;for(e=0;e<=c;e++){e===c&&q===n?l.push(y,w):l.push(u,t);m.push(1*e/c);var x=k*u+r*t,
t=k*t-r*u,u=x}h&&(l[0]=0,l[1]=1,l[l.length-1]=1,l[l.length-2]=0,m[0]=0,m[m.length-1]=1);h=g?-1:1;g=360===f?c:c+1;if(0===a&&1===d&&360===f){k=[];a=[];f=new ma(a);r=e/d*b;t=r/b;for(q=0;q<c;q++)m=l[q],n=l[q+1],k.push(m*r,n*r,0,0,0,h,.5*(1+m*t),.5*(1+n*t)),f.addIndex(q);f.addIndex(0);return Z(k,a)}c=b-a;k=[];for(e=0;e<=d;e++)for(r=a+e/d*c,t=r/b,q=0;q<g;q++)m=l[q],n=l[q+1],k.push(m*r,n*r,0,0,0,h,.5*(1+m*t),.5*(1+n*t));if(360===f){b=k;d+=1;l=[];for(c=0;c<d-1;c++)for(a=0;a<g;a++)f=c*g+a,e=f+g,h=a===g-1?
c*g:f+1,m=a===g-1?(c+1)*g:e+1,l.push(f,e,h),l.push(h,e,m);d=Z(b,l)}else d=ba(k,g,d+1);return d};Q.createTorus=function(a,b,c,d,e,f){if("undefined"===typeof d||null===d)d=16;if("undefined"===typeof c||null===c)c=16;if(3>d)throw Error("crosswise is less than 3");if(3>c)throw Error("lengthwise is less than 3");if(0>a||0>b)throw Error("inner or outer is less than 0");if(0===b||0===a)return new H3DU.MeshBuffer;var g=[],h=[],k,l,m,n=H3DU.Math.PiTimes2/d;m=Math.cos(n);var q=0<=n&&6.283185307179586>n?3.141592653589793>=
n?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(n);l=0;k=1;for(n=0;n<d;n++){g.push(l,k);var r=m*l+q*k;k=m*k-q*l;l=r}g.push(g[0]);g.push(g[1]);n=H3DU.Math.PiTimes2/c;m=Math.cos(n);q=0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(n);l=0;k=1;for(n=0;n<c;n++)h.push(l,k),r=m*l+q*k,k=m*k-q*l,l=r;h.push(h[0]);h.push(h[1]);q=[];for(r=0;r<=c;r++){k=r/c;l=h[2*r];for(var t=h[2*r+1],n=0;n<=d;n++){m=n/d;var u=g[2*n],w=g[2*n+1];q.push(w*(b+t*a),u*(b+t*a),l*a,t*w,t*u,l,
m,k)}}a=ba(q,d+1,c+1);return e?a.recalcNormals(e,f):a};Q.createPlane=function(a,b,c,d,e){if("undefined"===typeof a||null===a)a=1;if("undefined"===typeof b||null===b)b=1;if("undefined"===typeof c||null===c)c=1;if("undefined"===typeof d||null===d)d=1;if(0>a||0>b)throw Error("width or height is less than 0");if(0>=d||0>=c)throw Error("widthDiv or heightDiv is 0 or less");if(0===a||0===b)return new H3DU.MeshBuffer;var f=.5*-a,g=.5*-b;e=e?-1:1;for(var h=[],k=0;k<=d;k++)for(var l=k/d,m=g+b*l,n=0;n<=c;n++){var q=
n/c;h.push(f+a*q,m,0,0,0,e,q,l)}return ba(h,c+1,d+1)};Q.createSphere=function(a,b,c,d,e){return H3DU.Meshes._createCapsule(a,0,b,c,1,d,e)};Q.createCapsule=function(a,b,c,d,e,f,g){if("undefined"===typeof d||null===d)d=8;if(1>d)throw Error("too few stacks");return H3DU.Meshes._createCapsule(a,b,c,2*d,e,f,g)};Q._createCapsule=function(a,b,c,d,e,f,g){if("undefined"===typeof c||null===c)c=16;if("undefined"===typeof d||null===d)d=16;if("undefined"===typeof e||null===e)e=1;if("undefined"===typeof a||null===
a)a=1;if("undefined"===typeof b||null===b)b=1;if(2>d)throw Error("too few stacks");if(2>=c)throw Error("too few slices");if(1>e&&0<b)throw Error("too few middle stacks");if(0>b)throw Error("negative length");if(0>a)throw Error("negative radius");if(0===a)return new H3DU.MeshBuffer;var h,k,l=.5*b,m=d/2,n=g?-1:1,q=[],r=[],t=[],u=[],w,y=H3DU.Math.PiTimes2/c,x=Math.cos(y),z=0<=y&&6.283185307179586>y?3.141592653589793>=y?Math.sqrt(1-x*x):-Math.sqrt(1-x*x):Math.sin(y);k=1;for(y=h=0;y<c;y++){var B=1*y/c;
q.push(k,h);u.push(B);var C=x*k+z*h;h=x*h-z*k;k=C}q.push(q[0],q[1]);u.push(1);var B=2*a,B=B/(B+b),A=[];A.push(-1);r.push(0);t.push(0);y=Math.PI/d;x=Math.cos(y);k=z=0<=y&&6.283185307179586>y?3.141592653589793>=y?Math.sqrt(1-x*x):-Math.sqrt(1-x*x):Math.sin(y);h=x;for(y=0;y<d;y++)C=1*(y+1)/d,r.push(k),A.push(-h),t.push(C),C=x*k+z*h,h=x*h-z*k,k=C;x=[];for(y=C=0;y<=d;y++){var E=t[y],J=a*A[y];w=y<m?-l:l;var G=a*r[y];C++;for(var I=0;I<=c;I++)k=u[I],z=q[2*I],h=q[2*I+1],x.push(z*G,h*G,J+w,z*G*n,h*G*n,J*n,
1-k,E);if(y+1===m&&0<b)for(var L=.5*B,M=2*l,N=1-B,K=0;K<=e;K++)for(w=-l+(0===K?0:M*K/e),E=L+(0===K?0:N*K/e),C++,I=0;I<=c;I++)k=u[I],z=q[2*I],h=q[2*I+1],x.push(z*G,h*G,J+w,z*G*n,h*G*n,J*n,1-k,E)}a=ba(x,c+1,C);return f?a.recalcNormals(f,g):a.normalizeNormals()};Q.createPointedStar=function(a,b,c,d){if(2>a||0>b||0>c||0>=b&&0>=c)return new H3DU.MeshBuffer;if(b===c)return Q.createDisk(b,b,a,1,d);var e=[],f=[],g=new ma(f),h=0,k=1/Math.max(b,c);d=d?-1:1;e.push(0,0,0,0,0,d,.5,.5);g.addIndex(h++);for(var l=
H3DU.Math.PiTimes2/(2*a),m=Math.cos(l),l=3.141592653589793>=l?Math.sqrt(1-m*m):-Math.sqrt(1-m*m),n=0,q=1,r=0;r<2*a;r++){var t=0===(r&1)?b:c,u=-n*t,t=q*t;e.push(u,t,0,0,0,d,.5*(1+u*k),.5*(1+t*k));g.addIndex(h);u=m*q-l*n;n=m*n+l*q;q=u}g.addIndex(1);return Z(e,f)};C.Math=n;C.Curve=w;C.Surface=R;C.CurveBuilder=B;C.SurfaceBuilder=O;C.PiecewiseCurve=J;C.BSplineCurve=u;C.BSplineSurface=K;C.GraphicsPath=m;C.Shape=N;C.ShapeGroup=G;C.Transform=z;C.Meshes=Q;C.BufferAccessor=x;C.MeshBuffer=r;C.Semantic=T;C.getPromiseResults=
ka;C.getPromiseResultsAll=function(a,b,c){return ka(a,b,c).then(function(a){return 0<a.failures.length?Promise.reject(a):Promise.resolve(a.successes)})};C.loadFileFromUrl=function(a,b){var c=b||"text";return new Promise(function(b,e){var d=new XMLHttpRequest;d.onreadystatechange=function(d){d=d.target;4===d.readyState&&(200<=d.status&&300>d.status?(d="xml"===c?d.responseXML:"json"===c?"response"in d?d.response:JSON.parse(d.responseText):"arraybuffer"===c?d.response:d.responseText+"",b({url:a,data:d})):
e({url:a}))};d.onerror=function(b){e({url:a,error:b})};d.open("get",a,!0);d.responseType=c;d.send()})};C.getTimePosition=function(a,b,c){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)a.lastTime=b;return 1*(b-a.time)%c/c};C.newFrames=function(a,b){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)return a.lastTime=b,0;var c=b-a.lastTime;
a.lastTime=b;return 60*c/1E3};C.toGLColor=function(a,b,c,d){return"undefined"===typeof a||null===a?[0,0,0,0]:"string"===typeof a?(a=la.colorToRgba(a)||[0,0,0,0],b=1/255,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,ia(a)):"number"===typeof a&&"number"===typeof b&&"number"===typeof c?[a,b,c,"number"!==typeof d?1:d]:a.constructor===Array?ia([a[0]||0,a[1]||0,a[2]||0,"number"!==typeof a[3]?1:a[3]]):ia(a||[0,0,0,0])};Object.defineProperty(C,"__esModule",{value:!0})});
