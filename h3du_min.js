/*
 CC0-1.0
*/
(function(y,w){"object"===typeof exports&&"undefined"!==typeof module?w(exports):"function"===typeof define&&define.amd?define(["exports"],w):w(y.H3DU={})})(this,function(y){function w(a,b){this.curve=a;this.curveParam=b}function Z(a,b,c,d,e){for(var f=.5*(c-b),g=b+f,h=0,m=0,t=0;t<aa.length;t+=3){var k=aa[t+2],l=aa[t+1],n=aa[t],q=a(f*n+g),h=h+k*q,m=m+l*q;0<n&&(q=a(-f*n+g),h+=k*q,m+=l*q)}h=h*f*d;m=m*f*d;return 1E-6>Math.abs(h-m)?m+(m-h)/8191:10<=e?m+(m-h)/8191:Z(a,b,g,d,e+1)+Z(a,g,c,d,e+1)}function p(a,
b,c){if(0>=a.length)throw Error();if(!b)throw Error();this.bits=c||0;this.controlPoints=a;0!==(this.bits&p.WEIGHTED_BIT)&&0===(this.bits&p.HOMOGENEOUS_BIT)&&(this.controlPoints=p._convertToHomogen(this.controlPoints));a=b.length-this.controlPoints.length;if(1>a||a>this.controlPoints.length)throw Error();p._checkKnots(b,a-1);c=this.controlPoints[0].length;var d=1;0!==(this.bits&p.DIVIDE_BIT)&&(d=2);if(c<d)throw Error();this.fastBezier=!1;if(a===this.controlPoints.length&&4>=a){this.fastBezier=!0;for(c=
0;c<a;c++)if(0!==b[c]){this.fastBezier=!1;break}for(c=a;this.fastBezier&&c<b.length;c++)if(1!==b[c]){this.fastBezier=!1;break}}this.knots=b;this.buffer=[]}function H(a,b,c,d){this.bits=d||0;0!==(this.bits&p.WEIGHTED_BIT)&&0===(this.bits&p.HOMOGENEOUS_BIT)&&(a=H._convertToHomogen(a));d=a.length;if(0>=d)throw Error();var e=a[0].length;if(0>=e)throw Error();var f=a[0][0].length,g=1;0!==(this.bits&p.DIVIDE_BIT)&&(g=2);if(f<g)throw Error();if(!b||!c)throw Error();this.degreeU=b.length-e-1;this.degreeV=
c.length-d-1;this.vcplen=d;this.ucplen=e;if(1>this.degreeU||this.degreeU+1>e)throw Error();if(1>this.degreeV||this.degreeV+1>d)throw Error();p._checkKnots(b,this.degreeU);p._checkKnots(c,this.degreeV);this.knotsU=b;this.knotsV=c;this.bufferU=[];this.bufferV=[];this.controlPoints=a}function U(a,b,c){("undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c)&&console.warn("Unused parameters u1 and/or u2 given");this.curve=p.clamped(a,a.length-1,0)}function V(a,b,c,d,e){"undefined"!==typeof b&&
null!==b&&console.warn("Unused parameter u1 is defined");"undefined"!==typeof c&&null!==c&&console.warn("Unused parameter u2 is defined");"undefined"!==typeof d&&null!==d&&console.warn("Unused parameter v1 is defined");"undefined"!==typeof e&&null!==e&&console.warn("Unused parameter v2 is defined");this.surface=H.clamped(a,a[0].length-1,a.length-1,0)}if("undefined"!==typeof window&&null!==window&&("undefined"===typeof window.Promise||null===window.Promise)){var L=function(a){this._state=0;this._timeout=
this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];a&&this._invokeResolver(a)};L.resolve=function(a){return new this(function(b){b(a)})};L.reject=function(a){return new this(function(b,c){c(a)})};L.all=L.when=function(a){return new this(function(b,c){var d=0,e=[];a.forEach(function(a,g){d++;a.then(function(a){e[g]=a;d--;d||b(e)},function(a){d=1/0;c(a)})})})};L.race=function(a){return new this(function(b,c){a.forEach(function(a){a.then(b,c)})})};L.prototype.then=function(a,
b){this._cb.fulfilled.push(a);this._cb.rejected.push(b);var c=new L(null);this._thenPromises.push(c);0<this._state&&this._schedule();return c};L.prototype.fulfill=function(a){if(0!==this._state)return this;this._state=1;this._value=a;this._thenPromises.length&&this._schedule();return this};L.prototype.reject=function(a){if(0!==this._state)return this;this._state=2;this._value=a;this._thenPromises.length&&this._schedule();return this};L.prototype.resolve=function(a){if(a===this)this.reject(new TypeError("Promise resolved by its own instance"));
else if(a instanceof this.constructor)a.chain(this);else{var b;if("undefined"===typeof a||null===a||"object"!==typeof a&&"function"!==typeof a)this.fulfill(a);else{try{b=a.then}catch(f){this.reject(f);return}if("function"===typeof b){var c=!1,d=function(a){c||(c=!0,this.resolve(a))},e=function(a){c||(c=!0,this.reject(a))};try{b.call(a,d.bind(this),e.bind(this))}catch(f){c||this.reject(f)}}else this.fulfill(a)}}};L.prototype.chain=function(a){return this.then(function(b){a.resolve(b)},function(b){a.reject(b)})};
L.prototype["catch"]=function(a){return this.then(null,a)};L.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};L.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var a=this._cb.fulfilled.shift(),b=this._cb.rejected.shift();this._executeCallback(1===this._state?a:b)}};L.prototype._executeCallback=function(a){var b=this._thenPromises.shift();if("function"!==typeof a)1===this._state?b.fulfill(this._value):b.reject(this._value);
else try{var c=a(this._value);b.resolve(c);return c}catch(d){b.reject(d)}};L.prototype._invokeResolver=function(a){try{a(this.resolve.bind(this),this.reject.bind(this))}catch(b){this.reject(b)}};"undefined"!==typeof window&&null!==window&&(window.Promise=L)}if("undefined"===typeof Object.keys||null===Object.keys)Object.keys=function(a){var b=[],c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[b.length]=c);return b};var ca=function(a,b,c){function d(a,b,c){return function(d){a&&a(d);b.successes[c]=
d;return!0}}function e(a,b,c){return function(d){a&&a(d);b.failures[c]=d;return!0}}if(!a||0===a.length)return Promise.resolve({successes:[],failures:[],results:[]});for(var f={successes:[],failures:[],results:[]},g=[],h=0;h<a.length;h++){var m=h;g.push(a[h].then(d(b,f,m),e(c,f,m)))}return Promise.all(g).then(function(a){for(var b=0;b<f.successes.length;b++)"undefined"===typeof f.successes[b]&&(f.successes.splice(b,1),--b);for(b=0;b<f.failures.length;b++)"undefined"===typeof f.failures[b]&&(f.failures.splice(b,
1),--b);f.results=a;return Promise.resolve(f)})},da=function(){throw Error();};(function(a){a.skipWhite=function(a,c,d){for(;c<d;){var b=a.charCodeAt(c);if(32===b||13===b||12===b||9===b||10===b)++c;else break}return c};a.parseComma=function(b,c,d){var e=c;c=a.skipWhite(b,c,d);return c<d&&44===b.charCodeAt(c)?a.skipWhite(b,c+1,d):e};a.parseEndparen=function(b,c,d){var e=c;c=a.skipWhite(b,c,d);return c<d&&41===b.charCodeAt(c)?c+1:e};a.hsl=function(b,c,d,e){var f,g;f=c;if((g=a.parseHue(b,c,d,e,0))===
c)return f;c=g;if((g=a.sepPct(b,c,d,e,1))===c)return f;c=g;if((g=a.sepPct(b,c,d,e,2))===c)return f;c=g;g=a.parseEndparen(b,c,d);if(g===c)return f;c=g;b=a.hlsToRgb(e[0],e[2],e[1]);e[0]=b[0];e[1]=b[1];e[2]=b[2];e[3]=255;return c};a.pct=function(b,c,d,e,f){var g=a.parseNumber(b,c,d);if(g!==c){if(g>=d||37!==b.charAt(g))return c;e[f]=255*a.stringToPercent(b,c,g)/100;return g+1}return g};a.parseByte=function(b,c,d,e,f){d=a.parseInteger(b,c,d,!0);d!==c&&(e[f]=a.stringToByte(b,c,d));return d};a.parseHue=
function(b,c,d,e,f){var g=c;c=a.skipWhite(b,c,d);d=a.parseNumber(b,c,d);return d!==c?(e[f]=a.stringToHue(b,c,d),d):g};a.sepByte=function(b,c,d,e,f){var g=a.parseComma(b,c,d);return g!==c?a.parseByte(b,g,d,e,f):g};a.sepPct=function(b,c,d,e,f){var g=a.parseComma(b,c,d);return g!==c?a.pct(b,g,d,e,f):g};a.sepAlpha=function(b,c,d,e,f){var g=a.parseComma(b,c,d);g!==c&&(c=g,g=a.parseNumber(b,c,d),g!==c&&(e[f]=a.stringToAlpha(b,c,g)));return g};a.hsla=function(b,c,d,e){var f,g;f=c;if((g=a.parseHue(b,c,d,
e,0))===c)return f;c=g;if((g=a.sepPct(b,c,d,e,1))===c)return f;c=g;if((g=a.sepPct(b,c,d,e,2))===c)return f;c=g;if((g=a.sepAlpha(b,c,d,e,3))===c)return f;c=g;g=a.hlsToRgb(e[0],e[2],e[1]);e[0]=g[0];e[1]=g[1];e[2]=g[2];g=a.parseEndparen(b,c,d);return g===c?f:g};a.rgba=function(b,c,d,e){var f,g;f=c;var h=c=a.skipWhite(b,c,d),m=!0;(g=a.pct(b,c,d,e,0))===c?m=!1:c=g;m&&(g=a.sepPct(b,c,d,e,1))===c?m=!1:c=g;m&&(g=a.sepPct(b,c,d,e,2))===c?m=!1:c=g;m&&(g=a.sepAlpha(b,c,d,e,3))===c?m=!1:c=g;m||(c=h,m=!0,(g=a.parseByte(b,
c,d,e,0))===c?m=!1:c=g,m&&(g=a.sepByte(b,c,d,e,1))===c?m=!1:c=g,m&&(g=a.sepByte(b,c,d,e,2))===c?m=!1:c=g,m&&(g=a.sepAlpha(b,c,d,e,3))===c?m=!1:c=g);if(!m)return f;g=a.parseEndparen(b,c,d);return g===c?f:g};a.rgb=function(b,c,d,e){var f,g;f=c;var h=c=a.skipWhite(b,c,d),m=!0;(g=a.pct(b,c,d,e,0))===c?m=!1:c=g;m&&(g=a.sepPct(b,c,d,e,1))===c?m=!1:c=g;m&&(g=a.sepPct(b,c,d,e,2))===c?m=!1:c=g;m||(c=h,m=!0,(g=a.parseByte(b,c,d,e,0))===c?m=!1:c=g,m&&(g=a.sepByte(b,c,d,e,1))===c?m=!1:c=g,m&&(g=a.sepByte(b,c,
d,e,2))===c?m=!1:c=g);if(!m)return f;e[3]=255;g=a.parseEndparen(b,c,d);return g===c?f:g};a.stringToNumber=function(a,c,d){a=a.substring(c,c+(d-c));return parseFloat(a)};a.stringToPercent=function(b,c,d){b=a.stringToNumber(b,c,d);return Number.isNaN(b)?-1:0>b?0:100<b?100:b};a.stringToAlpha=function(b,c,d){b=a.stringToNumber(b,c,d);return 0>b?0:1<b?255:255*b};a.stringToHue=function(b,c,d){b=a.stringToNumber(b,c,d);return Number.isNaN(b)||b===Number.POSITIVE_INFINITY||b===Number.NEGATIVE_INFINITY?0:
(b%360+360)%360};a.stringToByte=function(b,c,d){b=a.stringToNumber(b,c,d);return 0>b?0:255<b?255:b};a.parseInteger=function(a,c,d,e){var b=!1,g=c;for(e&&c<d&&(43===a.charCodeAt(c)||45===a.charCodeAt(c))&&++c;c<d&&48<=a.charCodeAt(c)&&57>=a.charCodeAt(c);)++c,b=!0;return b?c:g};a.parseNumber=function(b,c,d){var e=c,f,g=0;if((f=a.parseInteger(b,c,d,!0))!==e)return c=f,c<d&&46===b.charCodeAt(c)?(++c,(f=a.parseInteger(b,c,d,!1))!==c?c<d&&(69===b.charCodeAt(c)||101===b.charCodeAt(c))&&(g=a.parseInteger(b,
c+1,d,!0))!==c+1?g:f:c-1):c;c<d&&(43===b.charCodeAt(c)||45===b.charCodeAt(c))&&++c;return c<d&&46===b.charCodeAt(c)&&(++c,(f=a.parseInteger(b,c,d,!1))!==c)?c<d&&(69===b.charCodeAt(c)||101===b.charCodeAt(c))&&(g=a.parseInteger(b,c+1,d,!0))!==c+1?g:f:e};a.hlsToRgb=a.HlsToRgb=function(a,c,d){c=0>c?0:255<c?255:c;d=0>d?0:255<d?255:d;if(0===d)return[c,c,c];d=127.5>=c?c*(255+d)/255:c+d-c*d/255;var b=2*c-d,f;if(0>a||360<=a)a=(a%360+360)%360;var g=a+120;360<=g&&(g-=360);c=60>g?b+(d-b)*g/60:180>g?d:240>g?b+
(d-b)*(240-g)/60:b;g=a;f=60>g?b+(d-b)*g/60:180>g?d:240>g?b+(d-b)*(240-g)/60:b;g=a-120;0>g&&(g+=360);a=60>g?b+(d-b)*g/60:180>g?d:240>g?b+(d-b)*(240-g)/60:b;return[0>c?0:255<c?255:c,0>f?0:255<f?255:f,0>a?0:255<a?255:a]};a.dehexchar=function(a){return 48<=a&&57>=a?a-48:65<=a&&70>=a?a+10-65:97<=a&&102>=a?a+10-97:-1};a.rgbHex=function(b,c,d){if("undefined"===typeof b||null===b||0===b.length)return!1;var e=b.length,f=[0,0,0,0,0,0,0,0],g=0,h=0;if("#"===b.charAt(0))--e,++g;else if(d)return!1;if(3!==e&&4!==
e&&6!==e&&8!==e)return!1;for(d=g;d<b.length;++d){g=a.dehexchar(b.charCodeAt(d));if(0>g)return!1;f[h++]=g}c[3]=4===e?f[3]|f[3]<<4:8===e?f[7]|f[6]<<4:255;3===e||4===e?(c[0]=f[0]|f[0]<<4,c[1]=f[1]|f[1]<<4,c[2]=f[2]|f[2]<<4):6<=e&&(c[0]=f[1]|f[0]<<4,c[1]=f[3]|f[2]<<4,c[2]=f[5]|f[4]<<4);return!0};a.colorToRgba=a.colorToRgba=function(b){if("undefined"===typeof b||null===b||0===b.length)return null;b=b.replace(/^[\r\n\t \u000c]+|[\r\n\t \u000c]+$/g,"");b=b.toLowerCase();if("transparent"===b)return[0,0,0,
0];if("undefined"===typeof b||null===b||0===b.length)return null;var c=[0,0,0,0];if("#"===b.charAt(0)&&a.rgbHex(b,c,!0))return c;if(4<b.length&&"rgb("===b.substring(0,4))return a.rgb(b,4,b.length,c)===b.length?c:null;if(5<b.length&&"rgba("===b.substring(0,5))return a.rgba(b,5,b.length,c)===b.length?c:null;if(4<b.length&&"hsl("===b.substring(0,4))return a.hsl(b,4,b.length,c)===b.length?c:null;if(5<b.length&&"hsla("===b.substring(0,5))return a.hsla(b,5,b.length,c)===b.length?c:null;var d=a.colorToRgbaSetUpNamedColors();
return"undefined"!==typeof d[b]&&null!==d[b]?(a.rgbHex(d[b],c,!1),c):null};a.namedColorMap=a.namedColorMap=null;a.nc="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
a.colorToRgbaSetUpNamedColors=function(){if("undefined"===typeof a.namedColorMap||null===a.namedColorMap){for(var b={},c=0;c<a.nc.length;c+=2)b[a.nc[c]]=a.nc[c+1];for(var d="grey gray darkgrey darkgray darkslategrey darkslategray dimgrey dimgray lightgrey lightgray lightslategrey lightslategray slategrey slategray".split(" "),c=0;c<d.length;c+=2)b[d[c]]=b[d[c+1]];a.namedColorMap=b}return a.namedColorMap}})(da);var ba=function(a){a[0]=0>a[0]?0:Math.min(a[0],1);a[1]=0>a[1]?0:Math.min(a[1],1);a[2]=0>
a[2]?0:Math.min(a[2],1);a[3]=0>a[3]?0:Math.min(a[3],1);return a},k={_frustumPoints:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=[],m=d[1]*f[2],t=d[2]*f[1],k=m-t,l=d[2]*f[0],n=d[0]*f[2],q=l-n,u=d[0]*f[1],C=d[1]*f[0],p=u-C,v=b[2]*d[0],T=b[0]*d[2],x=b[0]*d[1],D=b[1]*d[0],w=f[2]*b[0],E=f[0]*b[2],z=f[0]*b[1],y=f[1]*b[0],B=1/(b[0]*k+b[1]*q+b[2]*p),ka=f[1]*b[2],la=f[2]*b[1],A=b[1]*d[2],G=b[2]*d[1],K=-b[3],O=-d[3],P=-f[3];h[0]=(k*K+(ka-la)*O+(A-G)*P)*B;h[1]=(q*K+(w-E)*O+(v-T)*P)*B;h[2]=(p*
K+(z-y)*O+(x-D)*P)*B;var J=e[1]*f[2],I=e[2]*f[1],S=J-I,R=e[2]*f[0],H=e[0]*f[2],F=R-H,L=e[0]*f[1],M=e[1]*f[0],Q=L-M,N=b[2]*e[0],U=b[0]*e[2],V=b[0]*e[1],aa=b[1]*e[0],Z=1/(b[0]*S+b[1]*F+b[2]*Q),ba=b[1]*e[2],ca=b[2]*e[1],W=-e[3];h[3]=(S*K+(ka-la)*W+(ba-ca)*P)*Z;h[4]=(F*K+(w-E)*W+(N-U)*P)*Z;h[5]=(Q*K+(z-y)*W+(V-aa)*P)*Z;var da=m-t,ma=l-n,na=u-C,oa=c[2]*d[0],pa=c[0]*d[2],qa=c[0]*d[1],ra=c[1]*d[0],sa=f[2]*c[0],ta=f[0]*c[2],ua=f[0]*c[1],va=f[1]*c[0],ea=1/(c[0]*da+c[1]*ma+c[2]*na),wa=f[1]*c[2],xa=f[2]*c[1],
ya=c[1]*d[2],za=c[2]*d[1],X=-c[3];h[6]=(da*X+(wa-xa)*O+(ya-za)*P)*ea;h[7]=(ma*X+(sa-ta)*O+(oa-pa)*P)*ea;h[8]=(na*X+(ua-va)*O+(qa-ra)*P)*ea;var Aa=J-I,Ba=R-H,Ca=L-M,Da=c[2]*e[0],Ea=c[0]*e[2],Fa=c[0]*e[1],Ga=c[1]*e[0],fa=1/(c[0]*Aa+c[1]*Ba+c[2]*Ca),Ha=c[1]*e[2],Ia=c[2]*e[1];h[9]=(Aa*X+(wa-xa)*W+(Ha-Ia)*P)*fa;h[10]=(Ba*X+(sa-ta)*W+(Da-Ea)*P)*fa;h[11]=(Ca*X+(ua-va)*W+(Fa-Ga)*P)*fa;var Ja=d[1]*g[2],Ka=d[2]*g[1],La=Ja-Ka,Ma=d[2]*g[0],Na=d[0]*g[2],Oa=Ma-Na,Pa=d[0]*g[1],Qa=d[1]*g[0],Ra=Pa-Qa,Sa=g[2]*b[0],
Ta=g[0]*b[2],Ua=g[0]*b[1],Va=g[1]*b[0],ga=1/(b[0]*La+b[1]*Oa+b[2]*Ra),Wa=g[1]*b[2],Xa=g[2]*b[1],Y=-g[3];h[12]=(La*K+(Wa-Xa)*O+(A-G)*Y)*ga;h[13]=(Oa*K+(Sa-Ta)*O+(v-T)*Y)*ga;h[14]=(Ra*K+(Ua-Va)*O+(x-D)*Y)*ga;var Ya=e[1]*g[2],Za=e[2]*g[1],$a=Ya-Za,ab=e[2]*g[0],bb=e[0]*g[2],cb=ab-bb,db=e[0]*g[1],eb=e[1]*g[0],fb=db-eb,ha=1/(b[0]*$a+b[1]*cb+b[2]*fb);h[15]=($a*K+(Wa-Xa)*W+(ba-ca)*Y)*ha;h[16]=(cb*K+(Sa-Ta)*W+(N-U)*Y)*ha;h[17]=(fb*K+(Ua-Va)*W+(V-aa)*Y)*ha;var gb=Ja-Ka,hb=Ma-Na,ib=Pa-Qa,jb=g[2]*c[0],kb=g[0]*
c[2],lb=g[0]*c[1],mb=g[1]*c[0],ia=1/(c[0]*gb+c[1]*hb+c[2]*ib),nb=g[1]*c[2],ob=g[2]*c[1];h[18]=(gb*X+(nb-ob)*O+(ya-za)*Y)*ia;h[19]=(hb*X+(jb-kb)*O+(oa-pa)*Y)*ia;h[20]=(ib*X+(lb-mb)*O+(qa-ra)*Y)*ia;var pb=Ya-Za,qb=ab-bb,rb=db-eb,ja=1/(c[0]*pb+c[1]*qb+c[2]*rb);h[21]=(pb*X+(nb-ob)*W+(Ha-Ia)*Y)*ja;h[22]=(qb*X+(jb-kb)*W+(Da-Ea)*Y)*ja;h[23]=(rb*X+(lb-mb)*W+(Fa-Ga)*Y)*ja;return h},boxCenter:function(a){return[a[0]+.5*(a[3]-a[0]),a[1]+.5*(a[4]-a[1]),a[2]+.5*(a[5]-a[2])]},boxDimensions:function(a){return[a[3]-
a[0],a[4]-a[1],a[5]-a[2]]},boxIsEmpty:function(a){return a[0]>a[3]||a[1]>a[4]||a[2]>a[5]},colorToLinear:function(a){return[.04045>=a[0]?a[0]/12.92:Math.pow((.055+a[0])/1.055,2.4),.04045>=a[1]?a[1]/12.92:Math.pow((.055+a[1])/1.055,2.4),.04045>=a[2]?a[2]/12.92:Math.pow((.055+a[2])/1.055,2.4),3>=a.length?1:a[3]]},colorTosRGB:function(a){return[.0031308>=a[0]?12.92*a[0]:1.055*Math.pow(a[0],1/2.4)-.055,.0031308>=a[1]?12.92*a[1]:1.055*Math.pow(a[1],1/2.4)-.055,.0031308>=a[2]?12.92*a[2]:1.055*Math.pow(a[2],
1/2.4)-.055,3>=a.length?1:a[3]]},frustumHasBox:function(a,b){if(k.boxIsEmpty(b))return!1;for(var c=0;6>c;c++){var d=a[c],e=d[3],f=d[0]*b[0],g=d[2]*b[2],h=d[1]*b[1];if(0>=f+h+g+e&&0>=d[0]*b[3]+d[1]*b[4]+d[2]*b[5]+e&&0>=f+d[1]*b[4]+g+e&&0>=f+d[1]*b[4]+d[2]*b[5]+e&&0>=f+h+d[2]*b[5]+e&&0>=d[0]*b[3]+d[1]*b[4]+g+e&&0>=d[0]*b[3]+h+g+e&&0>=d[0]*b[3]+h+d[2]*b[5]+e)return!1}d=k._frustumPoints(a);for(c=0;3>c;c++){e=b[c];if(d[c]<e&&d[3+c]<e&&d[6+c]<e&&d[9+c]<e&&d[12+c]<e&&d[15+c]<e&&d[18+c]<e&&d[21+c]<e)return!1;
e=b[c+3];if(d[c]>e&&d[3+c]>e&&d[6+c]>e&&d[9+c]>e&&d[12+c]>e&&d[15+c]>e&&d[18+c]>e&&d[21+c]>e)return!1}return!0},frustumHasPoint:function(a,b,c,d){for(var e=0;6>e;e++)if(0>=a[e][0]*b+a[e][1]*c+a[e][2]*d+a[e][3])return!1;return!0},frustumHasSphere:function(a,b,c,d,e){if(0>e)throw Error("radius is negative");for(var f=0;6>f;f++){var g=a[f];if(g[3]+g[0]*b+g[1]*c+g[2]*d<-e)return!1}return!0},mat3copy:function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]]},mat3identity:function(){return[1,0,0,
0,1,0,0,0,1]},mat3invert:function(a){var b=[],c=a[4]*a[8]-a[5]*a[7],d=a[5]*a[6]-a[3]*a[8],e=a[3]*a[7]-a[4]*a[6],f=1/(a[0]*c+a[1]*d+a[2]*e);if(0===f)return k.mat3identity();b[0]=c*f;b[1]=(a[2]*a[7]-a[1]*a[8])*f;b[2]=(a[1]*a[5]-a[2]*a[4])*f;b[3]=d*f;b[4]=(a[0]*a[8]-a[2]*a[6])*f;b[5]=(a[2]*a[3]-a[0]*a[5])*f;b[6]=e*f;b[7]=(a[1]*a[6]-a[0]*a[7])*f;b[8]=(a[0]*a[4]-a[1]*a[3])*f;return b},mat3multiply:function(a,b){var c=[];c[0]=b[0]*a[0]+b[1]*a[3]+b[2]*a[6];c[1]=b[0]*a[1]+b[1]*a[4]+b[2]*a[7];c[2]=b[0]*a[2]+
b[1]*a[5]+b[2]*a[8];c[3]=b[3]*a[0]+b[4]*a[3]+b[5]*a[6];c[4]=b[3]*a[1]+b[4]*a[4]+b[5]*a[7];c[5]=b[3]*a[2]+b[4]*a[5]+b[5]*a[8];c[6]=b[6]*a[0]+b[7]*a[3]+b[8]*a[6];c[7]=b[6]*a[1]+b[7]*a[4]+b[8]*a[7];c[8]=b[6]*a[2]+b[7]*a[5]+b[8]*a[8];return c},mat3transform:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[3]+b*a[6],e*a[1]+c*a[4]+b*a[7],e*a[2]+c*a[5]+b*a[8]]},mat3transpose:function(a){return k.mat3transposeInPlace(k.mat3copy(a))},
mat3transposeInPlace:function(a){var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return a},mat4copy:function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]},mat4frustum:function(a,b,c,d,e,f){var g=2*e,h=1/(b-a),m=1/(d-c),t=1/(f-e);return[g*h,0,0,0,0,g*m,0,0,(a+b)*h,(d+c)*m,-(f+e)*t,-1,0,0,-(g*f)*t,0]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},mat4inverseTranspose3:function(a){if(0===a[1]&&0===a[2]&&
0===a[4]&&0===a[6]&&0===a[8]&&0===a[9])return 1===a[0]&&1===a[5]&&1===a[10]?[1,0,0,0,1,0,0,0,1]:0!==a[0]*a[5]*a[10]?[1/a[0],0,0,0,1/a[5],0,0,0,1/a[10]]:[1,0,0,0,1,0,0,0,1];a=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];var b=a[0]*a[4]*a[8]+a[3]*a[7]*a[2]+a[6]*a[1]*a[5]-a[6]*a[4]*a[2]-a[3]*a[1]*a[8]-a[0]*a[7]*a[5];if(0===b)return[1,0,0,0,1,0,0,0,1];b=1/b;return[(-a[5]*a[7]+a[4]*a[8])*b,(a[5]*a[6]-a[3]*a[8])*b,(-a[4]*a[6]+a[3]*a[7])*b,(a[2]*a[7]-a[1]*a[8])*b,(-a[2]*a[6]+a[0]*a[8])*b,(a[1]*a[6]-a[0]*
a[7])*b,(-a[2]*a[4]+a[1]*a[5])*b,(a[2]*a[3]-a[0]*a[5])*b,(-a[1]*a[3]+a[0]*a[4])*b]},mat4invert:function(a){var b=a[0]*a[10],c=a[0]*a[11],d=a[0]*a[5],e=a[0]*a[6],f=a[0]*a[7],g=a[0]*a[9],h=a[10]*a[12],m=a[10]*a[13],t=a[10]*a[15],l=a[11]*a[12],r=a[11]*a[13],n=a[11]*a[14],q=a[1]*a[4],u=a[1]*a[6],C=a[1]*a[7],p=a[1]*a[8],v=a[2]*a[4],T=a[2]*a[5],x=a[2]*a[7],D=a[2]*a[8],w=a[2]*a[9],E=a[3]*a[4],z=a[3]*a[5],y=a[3]*a[6],B=a[3]*a[8],A=a[3]*a[9],G=a[4]*a[9],J=a[5]*a[8],I=a[6]*a[8],K=a[6]*a[9],O=a[7]*a[8],P=a[7]*
a[9],H=q-d,F=u-T,S=C-z,R=v-e,d=d-q,u=T-u,T=x-y,q=E-f,C=z-C,x=y-x,e=e-v,v=f-E,f=a[9]*a[12]*x+h*S+l*u+a[8]*a[13]*T+m*q+r*e+a[8]*a[14]*C+a[9]*a[14]*v+n*H+a[8]*a[15]*F+a[9]*a[15]*R+t*d;if(0===f)return k.mat4identity();f=1/f;E=[];E[0]=a[6]*r-a[7]*m+P*a[14]-a[5]*n-K*a[15]+a[5]*t;E[1]=a[3]*m-a[2]*r-A*a[14]+a[1]*n+w*a[15]-a[1]*t;E[2]=a[13]*T+a[14]*C+a[15]*F;E[3]=a[9]*x+a[10]*S+a[11]*u;E[4]=a[7]*h-a[6]*l-O*a[14]+a[4]*n+I*a[15]-a[4]*t;E[5]=a[2]*l-a[3]*h+a[14]*(B-c)+a[15]*(b-D);E[6]=a[12]*x+a[14]*v+a[15]*R;
E[7]=a[8]*T+a[10]*q+a[11]*e;E[8]=a[5]*l-P*a[12]+O*a[13]-a[4]*r+a[15]*(G-J);E[9]=A*a[12]-a[1]*l+a[13]*(c-B)+a[15]*(p-g);E[10]=a[12]*S+a[13]*q+a[15]*d;E[11]=a[8]*C+a[9]*v+a[11]*H;E[12]=K*a[12]-a[5]*h-I*a[13]+a[4]*m+a[14]*(J-G);E[13]=a[1]*h-w*a[12]+a[13]*(D-b)+a[14]*(g-p);E[14]=a[12]*u+a[13]*e+a[14]*H;E[15]=a[8]*F+a[9]*R+a[10]*d;for(a=0;16>a;a++)E[a]*=f;return E},mat4isIdentity:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===
a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mat4lookat:function(a,b,c){if("undefined"===typeof c||null===c)c=[0,1,0];if("undefined"===typeof b||null===b)b=[0,0,0];b=k.vec3sub(b,a);var d=k.vec3length(b);if(1E-6>d)return k.mat4identity();k.vec3scaleInPlace(b,1/d);c=k.vec3normalize(c);c=k.vec3cross(b,c);k.vec3normalizeInPlace(c);d=k.vec3cross(c,b);k.vec3normalizeInPlace(d);k.vec3negateInPlace(b);return[c[0],d[0],b[0],0,c[1],d[1],b[1],0,c[2],d[2],b[2],0,-k.vec3dot(a,c),-k.vec3dot(a,
d),-k.vec3dot(a,b),1]},mat4multiply:function(a,b){for(var c=[],d=0;16>d;d+=4)for(var e=0;4>e;e++)c[d+e]=b[d]*a[e]+b[d+1]*a[e+4]+b[d+2]*a[e+8]+b[d+3]*a[e+12];return c},mat4oblique:function(a,b){var c=(0<=a&&360>a?a:a%360+(0>a?360:0))*k.PiDividedBy180,d=(0<=b&&360>b?b:b%360+(0>b?360:0))*k.PiDividedBy180,e=Math.cos(c),f=Math.cos(d),c=e/(0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-e*e):-Math.sqrt(1-e*e):Math.sin(c));return[1,0,0,0,0,1,0,0,-f*c,-(0<=d&&6.283185307179586>d?3.141592653589793>=
d?Math.sqrt(1-f*f):-Math.sqrt(1-f*f):Math.sin(d))*c,1,0,0,0,0,1]},mat4ortho:function(a,b,c,d,e,f){var g=1/(b-a),h=1/(d-c),m=1/(f-e);return[2*g,0,0,0,0,2*h,0,0,0,0,-2*m,0,-(a+b)*g,-(d+c)*h,-(e+f)*m,1]},mat4ortho2d:function(a,b,c,d){return k.mat4ortho(a,b,c,d,-1,1)},mat4ortho2dAspect:function(a,b,c,d,e){return k.mat4orthoAspect(a,b,c,d,-1,1,e)},mat4orthoAspect:function(a,b,c,d,e,f,g){g/=Math.abs((b-a)/(d-c));var h=Math.abs(b-a),m=Math.abs(d-c);1>g?(g=m/g,d>c?(c-=.5*(g-m),d+=.5*(g-m)):(d-=.5*(g-m),c+=
.5*(g-m))):(g*=h,b>a?(a-=.5*(g-h),b+=.5*(g-h)):(b-=.5*(g-h),a+=.5*(g-h)));return k.mat4ortho(a,b,c,d,e,f)},mat4perspective:function(a,b,c,d){a=1/Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*k.PiDividedBy360);var e;e=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,e*(c+d),-1,0,0,e*c*d*2,0]},mat4perspectiveHorizontal:function(a,b,c,d){return k.mat4perspective(k.Num360DividedByPi*Math.atan2(Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*k.PiDividedBy360),b),b,c,d)},mat4projectVec3:function(a,b,c,d){var e;"undefined"!==
typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);d=1/(e*a[3]+c*a[7]+b*a[11]+a[15]);return[(e*a[0]+c*a[4]+b*a[8]+a[12])*d,(e*a[1]+c*a[5]+b*a[9]+a[13])*d,(e*a[2]+c*a[6]+b*a[10]+a[14])*d]},mat4rotate:function(a,b,c,d,e){var f,g;"undefined"!==typeof d&&"undefined"!==typeof e?(f=c,g=d,c=e,e=b):"undefined"===typeof c?(f=b[0],g=b[1],c=b[2],e=b[3]):(f=c[0],g=c[1],c=c[2],e=b);e=(0<=e&&360>e?e:e%360+(0>e?360:0))*k.PiDividedBy180;b=Math.cos(e);var h=3.141592653589793>=e?Math.sqrt(1-b*b):-Math.sqrt(1-
b*b);if(1===f&&0===g&&0===c)return[a[0],a[1],a[2],a[3],b*a[4]+a[8]*h,b*a[5]+a[9]*h,b*a[6]+a[10]*h,b*a[7]+a[11]*h,b*a[8]-h*a[4],b*a[9]-h*a[5],b*a[10]-h*a[6],b*a[11]-h*a[7],a[12],a[13],a[14],a[15]];if(0===f&&1===g&&0===c)return[b*a[0]-h*a[8],b*a[1]-h*a[9],b*a[2]-h*a[10],b*a[3]-h*a[11],a[4],a[5],a[6],a[7],b*a[8]+a[0]*h,b*a[9]+a[1]*h,b*a[10]+a[2]*h,b*a[11]+a[3]*h,a[12],a[13],a[14],a[15]];if(0===f&&0===g&&1===c)return[b*a[0]+a[4]*h,b*a[1]+a[5]*h,b*a[2]+a[6]*h,b*a[3]+a[7]*h,b*a[4]-h*a[0],b*a[5]-h*a[1],
b*a[6]-h*a[2],b*a[7]-h*a[3],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]];if(0===f&&0===g&&0===c)return k.mat4copy(a);e=1/Math.sqrt(f*f+g*g+c*c);f*=e;g*=e;c*=e;var m=g*g;d=1-b;var t=f*g,l=g*c;e=f*h;g*=h;var r=c*h,h=d*l,n=d*t,q=d*f*c;f=b+d*f*f;t=n+r;l=q-g;m=b+d*m;r=n-r;n=h+e;c=b+d*c*c;b=q+g;e=h-e;return[a[0]*f+a[4]*t+a[8]*l,a[1]*f+a[5]*t+a[9]*l,a[10]*l+a[2]*f+a[6]*t,a[11]*l+a[3]*f+a[7]*t,a[0]*r+a[4]*m+a[8]*n,a[1]*r+a[5]*m+a[9]*n,a[10]*n+a[2]*r+a[6]*m,a[11]*n+a[3]*r+a[7]*m,a[0]*b+a[4]*e+a[8]*c,a[1]*
b+a[5]*e+a[9]*c,a[10]*c+a[2]*b+a[6]*e,a[11]*c+a[3]*b+a[7]*e,a[12],a[13],a[14],a[15]]},mat4rotated:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d,d=a):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2],d=a[3]):(e=b[0],c=b[1],b=b[2],d=a);d=(0<=d&&360>d?d:d%360+(0>d?360:0))*k.PiDividedBy180;if(90===d||-270===d)return d=1/Math.sqrt(e*e+c*c+b*b),e*=d,c*=d,b*=d,[e*e,e*c+b,e*b-c,0,c*e-b,c*c,c*b+e,0,b*e+c,b*c-e,b*b,0,0,0,0,1];if(-90===d||270===d)return d=1/Math.sqrt(e*e+c*c+b*b),
e*=d,c*=d,b*=d,[e*e,e*c-b,e*b+c,0,c*e+b,c*c,c*b-e,0,b*e-c,b*c+e,b*b,0,0,0,0,1];if(180===d||-180===d)return d=1/Math.sqrt(e*e+c*c+b*b),e*=d,c*=d,b*=d,[e*e*2-1,e*c*2,e*b*2,0,c*e*2,c*c*2-1,c*b*2,0,b*e*2,b*c*2,b*b*2-1,0,0,0,0,1];a=Math.cos(d);var f=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);if(1===e&&0===c&&0===b)return[1,0,0,0,0,a,f,0,0,-f,a,0,0,0,0,1];if(0===e&&1===c&&0===b)return[a,0,-f,0,0,1,0,0,f,0,a,0,0,0,0,1];if(0===e&&0===c&&1===b)return[a,f,
0,0,-f,a,0,0,0,0,1,0,0,0,0,1];if(0===e&&0===c&&0===b)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];d=1/Math.sqrt(e*e+c*c+b*b);e*=d;c*=d;b*=d;d=e*e;var g=c*c,h=b*b,m=e*b,t=c*b,l=e*f,r=c*f,f=b*f,n=1-a;e=n*e*c;c=n*m;b=n*t;return[a+n*d,e+f,c-r,0,e-f,a+n*g,b+l,0,c+r,b-l,a+n*h,0,0,0,0,1]},mat4scale:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0]*e,a[1]*e,a[2]*e,a[3]*e,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],
a[15]]},mat4scaleInPlace:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);a[0]*=e;a[1]*=e;a[2]*=e;a[3]*=e;a[4]*=c;a[5]*=c;a[6]*=c;a[7]*=c;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a},mat4scaled:function(a,b,c){return"undefined"!==typeof b&&"undefined"!==typeof c?[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]:[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},mat4toFrustumPlanes:function(a){var b=[[],[],[],[],[],[]];b[0]=k.planeNormalizeInPlace([a[3]+a[0],a[7]+a[4],
a[11]+a[8],a[15]+a[12]]);b[1]=k.planeNormalizeInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);b[2]=k.planeNormalizeInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);b[3]=k.planeNormalizeInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]);b[4]=k.planeNormalizeInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);b[5]=k.planeNormalizeInPlace([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);return b},mat4toMat3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},mat4transform:function(a,
b,c,d,e){var f;"undefined"!==typeof c&&"undefined"!==typeof d&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],d=b[2],b=b[3]);return[f*a[0]+c*a[4]+d*a[8]+b*a[12],f*a[1]+c*a[5]+d*a[9]+b*a[13],f*a[2]+c*a[6]+d*a[10]+b*a[14],f*a[3]+c*a[7]+d*a[11]+b*a[15]]},mat4transformVec3:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[4]+b*a[8]+a[12],e*a[1]+c*a[5]+b*a[9]+a[13],e*a[2]+c*a[6]+b*a[10]+a[14]]},mat4translate:function(a,b,c,d){var e;
"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*e+a[4]*c+a[8]*b+a[12],a[1]*e+a[5]*c+a[9]*b+a[13],a[2]*e+a[6]*c+a[10]*b+a[14],a[3]*e+a[7]*c+a[11]*b+a[15]]},mat4translated:function(a,b,c){var d;"undefined"!==typeof b&&"undefined"!==typeof c?(d=a,a=c):(d=a[0],b=a[1],a=a[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,d,b,a,1]},mat4transpose:function(a){return k.mat4transposeInPlace(k.mat4copy(a))},mat4transposeInPlace:function(a){var b=
a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return a},planeFromNormalAndPoint:function(a,b){return[a[0],a[1],a[2],-(a[0]*b[0]+a[1]*b[1]+a[2]*b[2])]},planeNormalize:function(a){return k.planeNormalizeInPlace(k.vec4copy(a))},planeNormalizeInPlace:function(a){var b=a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},quatConjugate:function(a){return[-a[0],
-a[1],-a[2],a[3]]},quatFromAxisAngle:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2]):(e=b[0],c=b[1],b=b[2]);d=(0<=a&&360>a?a:a%360+(0>a?360:0))*k.PiDividedBy360;a=Math.cos(d);d=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);e=k.vec3normalizeInPlace([e,c,b]);e=[e[0],e[1],e[2],a];e[0]*=d;e[1]*=d;e[2]*=d;return e},quatFromMat4:function(a){var b=[],c=a[1],d=a[2],e=a[4],f=a[6],
g=a[8],h=a[9],m=a[0]+a[5]+a[10];0<=m?(a=.5*Math.sqrt(m+1),m=.25/a,b[0]=(f-h)*m,b[1]=(g-d)*m,b[2]=(c-e)*m,b[3]=a):a[0]>a[5]&&a[0]>a[10]?(a=.5*Math.sqrt(1+a[0]-a[5]-a[10]),m=.25/a,b[0]=a,b[1]=(e+c)*m,b[2]=(d+g)*m,b[3]=(f-h)*m):a[5]>a[10]?(a=.5*Math.sqrt(1+a[5]-a[0]-a[10]),m=.25/a,b[0]=(e+c)*m,b[1]=a,b[2]=(h+f)*m,b[3]=(g-d)*m):(a=.5*Math.sqrt(1+a[10]-a[0]-a[5]),m=.25/a,b[0]=(g+d)*m,b[1]=(h+f)*m,b[2]=a,b[3]=(c-e)*m);return b},quatFromTaitBryan:function(a,b,c,d){var e,f;if("undefined"===typeof d||null===
d)d=k.GlobalRollPitchYaw;if(0>d||6<=d)throw Error("invalid mode");a.constructor===Array?(c=(0<=a[2]&&360>a[2]?a[2]:a[2]%360+(0>a[2]?360:0))*k.PiDividedBy360,e=(0<=a[0]&&360>a[0]?a[0]:a[0]%360+(0>a[0]?360:0))*k.PiDividedBy360,f=(0<=a[1]&&360>a[1]?a[1]:a[1]%360+(0>a[1]?360:0))*k.PiDividedBy360):(c=(0<=c&&360>c?c:c%360+(0>c?360:0))*k.PiDividedBy360,e=(0<=a&&360>a?a:a%360+(0>a?360:0))*k.PiDividedBy360,f=(0<=b&&360>b?b:b%360+(0>b?360:0))*k.PiDividedBy360);a=Math.cos(e);e=0<=e&&6.283185307179586>e?3.141592653589793>=
e?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(e);b=Math.cos(f);f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(f);var g=Math.cos(c);c=0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-g*g):-Math.sqrt(1-g*g):Math.sin(c);var h;d===k.GlobalPitchYawRoll||d===k.GlobalPitchRollYaw?(h=[c*f,g*f,c*b,g*b],d===k.GlobalPitchYawRoll&&(h[0]=-h[0]),d=[h[3]*e+h[0]*a,h[1]*a+h[2]*e,h[2]*a-h[1]*e,h[3]*a-h[0]*e]):d===k.GlobalYawPitchRoll||d===k.GlobalYawRollPitch?
(h=[g*e,c*e,c*a,g*a],d===k.GlobalYawRollPitch&&(h[1]=-h[1]),d=[h[0]*b-h[2]*f,h[3]*f+h[1]*b,h[2]*b+h[0]*f,h[3]*b-h[1]*f]):(h=[b*e,f*a,f*e,b*a],d===k.GlobalRollPitchYaw&&(h[2]=-h[2]),d=[h[0]*g+h[1]*c,h[1]*g-h[0]*c,h[3]*c+h[2]*g,h[3]*g-h[2]*c]);return d},quatFromVectors:function(a,b){var c=k.vec3cross(a,b);if(1E-9>k.vec3dot(c,c)){if(0<k.vec3dot(a,b))return[0,0,0,1];c=k.vec3perp(a);c[3]=0}else{var d=k.vec3length(a)*k.vec3length(b);0===d&&(d=1);c[3]=d+k.vec3dot(a,b)}return k.quatNormalizeInPlace(c)},quatIdentity:function(){return[0,
0,0,1]},quatInvert:function(a){var b=1/k.quatDot(a,a);return k.vec4scaleInPlace(k.quatConjugate(a),b)},quatIsIdentity:function(a){return 0===a[0]&&0===a[1]&&0===a[2]&&1===a[3]},quatMultiply:function(a,b){return[a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]+a[1]*b[3]+a[2]*b[0]-a[0]*b[2],a[3]*b[2]+a[2]*b[3]+a[0]*b[1]-a[1]*b[0],a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]]},quatNlerp:function(a,b,c){var d=1-c,e=a[0]*d,f=a[1]*d,g=a[2]*d,d=a[3]*d,h=b[0]*c,m=b[1]*c,t=b[2]*c;c*=b[3];return 0>a[0]*b[0]+a[1]*
b[1]+a[2]*b[2]+a[3]*b[3]?k.quatNormalizeInPlace([e-h,f-m,g-t,d-c]):k.quatNormalizeInPlace([e+h,f+m,g+t,d+c])},quatRotate:function(a,b,c,d,e){return k.quatMultiply(a,k.quatFromAxisAngle(b,c,d,e))},quatSlerp:function(a,b,c){var d=k.quatDot(a,b),e=b;0>d&&(e=[-b[0],-b[1],-b[2],-b[3]],d=k.quatDot(a,e));if(-1<d)if(1>d){if(d=Math.acos(d),0===d)return k.quatNlerp(a,b,c)}else return k.quatNlerp(a,b,c);else d=Math.PI;var f=1/Math.sin(d);b=Math.sin((1-c)*d)*f;c=Math.sin(c*d)*f;return[a[0]*b+e[0]*c,a[1]*b+e[1]*
c,a[2]*b+e[2]*c,a[3]*b+e[3]*c]},quatToAxisAngle:function(a){var b=a[3],c=1-b*b;return 0<c?(c=1/Math.sqrt(c),[a[0]*c,a[1]*c,a[2]*c,Math.acos(Math.min(1,Math.max(0,b)))*k.Num360DividedByPi]):[0,1,0,0]},quatToMat4:function(a){var b,c,d,e,f,g,h,m,t;b=2*a[0];c=2*a[1];d=2*a[2];e=b*a[0];f=b*a[1];g=b*a[2];h=c*a[1];m=d*a[1];t=d*a[2];b*=a[3];c*=a[3];a=d*a[3];return[1-(h+t),f+a,g-c,0,f-a,1-(e+t),m+b,0,g+c,m-b,1-(e+h),0,0,0,0,1]},quatToTaitBryan:function(a,b){var c=a[3],d,e,f,g=1;if("undefined"===typeof b||null===
b)b=k.GlobalRollPitchYaw;if(0>b||6<=b)throw Error("invalid mode");b===k.GlobalRollPitchYaw?(d=a[1],e=a[0],f=a[2],g=-1):b===k.GlobalPitchYawRoll?(d=a[2],e=a[1],f=a[0],g=-1):b===k.GlobalPitchRollYaw?(d=a[1],e=a[2],f=a[0]):b===k.GlobalYawPitchRoll?(d=a[2],e=a[0],f=a[1]):b===k.GlobalYawRollPitch?(d=a[0],e=a[2],f=a[1],g=-1):(d=a[0],e=a[1],f=a[2]);var h=e*e,m=Math.atan2(2*(c*d-g*e*f),1-2*(d*d+h)),t=2*(c*e+g*d*f);1<t&&(t=1);-1>t&&(t=-1);t=Math.asin(t);e=Math.atan2(2*(c*f-g*d*e),1-2*(h+f*f));m*=k.Num180DividedByPi;
t*=k.Num180DividedByPi;e*=k.Num180DividedByPi;if(1E-6>Math.abs(t-90)||1E-6>Math.abs(t+90))e=0,m=Math.atan2(d,c)*k.Num180DividedByPi,isNaN(m)&&(m=0);c=[];b===k.GlobalRollPitchYaw?(c[0]=t,c[1]=m,c[2]=e):b===k.GlobalPitchYawRoll?(c[0]=e,c[1]=t,c[2]=m):b===k.GlobalPitchRollYaw?(c[0]=e,c[1]=m,c[2]=t):b===k.GlobalYawPitchRoll?(c[0]=t,c[1]=e,c[2]=m):b===k.GlobalYawRollPitch?(c[0]=m,c[1]=e,c[2]=t):(c[0]=m,c[1]=t,c[2]=e);return c},quatTransform:function(a,b){var c=a[1]*b[2]-a[2]*b[1]+b[0]*a[3],d=a[2]*b[0]-
a[0]*b[2]+b[1]*a[3],e=a[0]*b[1]-a[1]*b[0]+b[2]*a[3],f=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];return 3===b.length?[c*a[3]-(d*a[2]-e*a[1])+a[0]*f,d*a[3]-(e*a[0]-c*a[2])+a[1]*f,e*a[3]-(c*a[1]-d*a[0])+a[2]*f]:[c*a[3]-(d*a[2]-e*a[1])+a[0]*f,d*a[3]-(e*a[0]-c*a[2])+a[1]*f,e*a[3]-(c*a[1]-d*a[0])+a[2]*f,1]},vec2abs:function(a){return[Math.abs(a[0]),Math.abs(a[1])]},vec2absInPlace:function(a){a[0]=Math.abs(a[0]);a[1]=Math.abs(a[1]);return a},vec2add:function(a,b){return[a[0]+b[0],a[1]+b[1]]},vec2addInPlace:function(a,
b){var c=b[1];a[0]+=b[0];a[1]+=c;return a},vec2assign:function(a,b){a[0]=b[0];a[1]=b[1];return a},vec2clamp:function(a,b,c){return k.vec2clampInPlace(k.vec2copy(a),b,c)},vec2clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;return a},vec2copy:function(a){return[a[0],a[1]]},vec2dist:function(a,b){return k.vec2length(k.vec2sub(a,b))},vec2dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},vec2length:function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+
a*a)},vec2lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c]},vec2mul:function(a,b){return[a[0]*b[0],a[1]*b[1]]},vec2mulInPlace:function(a,b){var c=b[1];a[0]*=b[0];a[1]*=c;return a},vec2negate:function(a){return[-a[0],-a[1]]},vec2negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];return a},vec2normalize:function(a){return k.vec2normalizeInPlace([a[0],a[1]])},vec2normalizeInPlace:function(a){var b=a[0],c=a[1],b=Math.sqrt(b*b+c*c);0!==b&&(b=1/b,a[0]*=b,a[1]*=b);return a},vec2perp:function(a){return[-a[1],
a[0]]},vec2proj:function(a,b){var c=k.vec2dot(b,b);return 0===c?[0,0]:k.vec2scale(b,k.vec2dot(a,b)/c)},vec2reflect:function(a,b){return k.vec2sub(a,k.vec2scale(b,2*k.vec2dot(b,a)))},vec2scale:function(a,b){return k.vec2scaleInPlace([a[0],a[1]],b)},vec2scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;return a},vec2sub:function(a,b){return[a[0]-b[0],a[1]-b[1]]},vec2subInPlace:function(a,b){var c=b[1];a[0]-=b[0];a[1]-=c;return a},vec3abs:function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])]},vec3absInPlace:function(a){a[0]=
Math.abs(a[0]);a[1]=Math.abs(a[1]);a[2]=Math.abs(a[2]);return a},vec3add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},vec3addInPlace:function(a,b){var c=b[1],d=b[2];a[0]+=b[0];a[1]+=c;a[2]+=d;return a},vec3assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},vec3clamp:function(a,b,c){return k.vec3clampInPlace(k.vec3copy(a),b,c)},vec3clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1])),e=Math.min(c,Math.max(b,a[2]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;a[2]=e;return a},
vec3copy:function(a){return[a[0],a[1],a[2]]},vec3cross:function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},vec3dist:function(a,b){return k.vec3length(k.vec3sub(a,b))},vec3dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3fromWindowPoint:function(a,b,c,d){var e=.5*c[2],f=.5*c[3],g=0,h=0,m=2*a[2]-1;0!==e&&0!==f&&(g=(a[0]-c[0]-e)/e,h=(a[1]-c[1]-f)/f);h=d?h:-h;a=k.mat4invert(b);return k.mat4projectVec3(a,[g,h,m])},vec3length:function(a){var b=a[0],c=a[1];a=a[2];
return Math.sqrt(b*b+c*c+a*a)},vec3lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c]},vec3mul:function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]},vec3mulInPlace:function(a,b){var c=b[1],d=b[2];a[0]*=b[0];a[1]*=c;a[2]*=d;return a},vec3negate:function(a){return[-a[0],-a[1],-a[2]]},vec3negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},vec3normalize:function(a){return k.vec3normalizeInPlace([a[0],a[1],a[2]])},vec3normalizeInPlace:function(a){var b=
a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b);return a},vec3perp:function(a){var b=Math.abs(a[0]),c=Math.abs(a[1]),d=Math.max(b,c,Math.abs(a[2])),e=[0,0,0];d===b?(e[0]=a[1],e[1]=-a[0],e[2]=0):d===c?(e[0]=0,e[1]=a[2],e[2]=-a[1]):(e[0]=-a[2],e[1]=0,e[2]=a[0]);return e},vec3proj:function(a,b){var c=k.vec3dot(b,b);return 0===c?[0,0,0]:k.vec3scale(b,k.vec3dot(a,b)/c)},vec3reflect:function(a,b){return k.vec3sub(a,k.vec3scale(b,2*k.vec3dot(b,a)))},vec3scale:function(a,
b){return k.vec3scaleInPlace([a[0],a[1],a[2]],b)},vec3scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},vec3sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},vec3subInPlace:function(a,b){var c=b[1],d=b[2];a[0]-=b[0];a[1]-=c;a[2]-=d;return a},vec3toWindowPoint:function(a,b,c,d){if(0>c[2]||0>c[3])throw Error();a=k.mat4projectVec3(b,a);b=.5*c[2];var e=.5*c[3];return[a[0]*b+b+c[0],(d?a[1]:-a[1])*e+e+c[1],.5*(a[2]+1)]},vec3triple:function(a,b,c){return k.vec3dot(a,k.vec3cross(b,c))},
vec4abs:function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2]),Math.abs(a[3])]},vec4absInPlace:function(a){a[0]=Math.abs(a[0]);a[1]=Math.abs(a[1]);a[2]=Math.abs(a[2]);a[3]=Math.abs(a[3]);return a},vec4add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},vec4addInPlace:function(a,b){var c=b[1],d=b[2],e=b[3];a[0]+=b[0];a[1]+=c;a[2]+=d;a[3]+=e;return a},vec4assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},vec4clamp:function(a,b,c){return k.vec4clampInPlace(k.vec4copy(a),
b,c)},vec4clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1])),e=Math.min(c,Math.max(b,a[2])),f=Math.min(c,Math.max(b,a[3]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;a[2]=e;a[3]=f;return a},vec4copy:function(a){return[a[0],a[1],a[2],a[3]]},vec4dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},vec4length:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},vec4lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c,a[3]+
(b[3]-a[3])*c]},vec4negate:function(a){return[-a[0],-a[1],-a[2],-a[3]]},vec4negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},vec4normalize:function(a){return k.vec4normalizeInPlace([a[0],a[1],a[2],a[3]])},vec4normalizeInPlace:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],b=Math.sqrt(b*b+c*c+d*d+e*e);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},vec4proj:function(a,b){var c=k.vec4dot(b,b);return 0===c?[0,0,0]:k.vec4scale(b,k.vec4dot(a,b)/c)},vec4scale:function(a,
b){return[a[0]*b,a[1]*b,a[2]*b,a[3]*b]},vec4scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},vec4sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},vec4subInPlace:function(a,b){var c=b[1],d=b[2],e=b[3];a[0]-=b[0];a[1]-=c;a[2]-=d;a[3]-=e;return a},interpCubicBezier:function(a,b,c,d,e){if(0>=e)return 0;if(1<=e)return 1;for(var f=e,g=0;10>g;g++){var h=f*(3*a*(f*(f-2)+1)-3*c*f*(f-1)+f*f)-e;if(1E-9>Math.abs(h))break;f-=h/(3*(((3*f-4)*f+1)*a+(-3*f+2)*f*c+f*f))}return f*
(3*b*(f*(f-2)+1)-3*d*f*(f-1)+f*f)}};k.quatDot=k.vec4dot;k.quatNormalizeInPlace=k.vec4normalizeInPlace;k.quatNormalize=k.vec4normalize;k.quatLength=k.vec4length;k.quatScaleInPlace=k.vec4scaleInPlace;k.quatScale=k.vec4scale;k.quatCopy=k.vec4copy;k.PiTimes2=6.283185307179586;k.HalfPi=1.5707963267948966;k.PiDividedBy180=.017453292519943295;k.ToRadians=k.PiDividedBy180;k.PiDividedBy360=.008726646259971648;k.Num360DividedByPi=114.59155902616465;k.Num180DividedByPi=57.29577951308232;k.ToDegrees=k.Num180DividedByPi;
k.GlobalPitchYawRoll=0;k.GlobalPitchRollYaw=1;k.GlobalYawPitchRoll=2;k.GlobalYawRollPitch=3;k.GlobalRollPitchYaw=4;k.GlobalRollYawPitch=5;k.LocalPitchYawRoll=k.GlobalRollYawPitch;k.LocalPitchRollYaw=k.GlobalYawRollPitch;k.LocalYawPitchRoll=k.GlobalRollPitchYaw;k.LocalYawRollPitch=k.GlobalPitchRollYaw;k.LocalRollPitchYaw=k.GlobalYawPitchRoll;k.LocalRollYawPitch=k.GlobalPitchYawRoll;k.PitchYawRoll=0;k.PitchRollYaw=1;k.YawPitchRoll=2;k.YawRollPitch=3;k.RollPitchYaw=4;k.RollYawPitch=5;k.quatInverse=k.quatInvert;
k.vec3norm=k.vec3normalize;k.vec4norm=k.vec4normalize;k.quatNorm=k.quatNormalize;k.vec3normInPlace=k.vec3normalizeInPlace;k.vec4normInPlace=k.vec4normalizeInPlace;k.quatNormInPlace=k.quatNormalizeInPlace;k.planeNormInPlace=k.planeNormalizeInPlace;k.planeNorm=k.planeNormalize;var F={vecZeros:function(a){for(var b=[],c=0;c<a;c++)b[c]=0;return b},vecSub:function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]-b[d];return c},vecSubInPlace:function(a,b){for(var c=0;c<a.length;c++)a[c]-=b[c];return a},vecScale:function(a,
b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]*b;return c},vecSubScaleInPlace:function(a,b,c){for(var d=0;d<a.length;d++)a[d]=(a[d]-b[d])*c;return a},vecNormalizeInPlace:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];b=Math.sqrt(b);if(0!==b)for(b=1/b,c=0;c<a.length;c++)a[c]*=b;return a},vecLength:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return Math.sqrt(b)}};w.prototype.endPoints=function(){return"undefined"!==typeof this.curveParam&&null!==this.curveParam?this.curveParam.endPoints():
"undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.endPoints&&null!==this.curve.endPoints?this.curve.endPoints():[0,1]};w.prototype._getCoord=function(a){return"undefined"!==typeof this.curveParam&&null!==this.curveParam?this.curveParam.getCoordinate(a):a};w._EPSILON=1E-5;w.prototype.evaluate=function(a){return"undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.evaluate&&null!==this.curve.evaluate?
this.curve.evaluate(this._getCoord(a)):[0,0,0]};w.prototype.velocity=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.velocity&&null!==this.curve.velocity)return this.curve.velocity(this._getCoord(a));var b=w._EPSILON,c=this.evaluate(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.evaluate(a+b));return F.vecSubScaleInPlace(c,this.evaluate(a),1/b)};w.prototype.accel=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&
this.curve!==this&&"undefined"!==typeof this.curve.accel&&null!==this.curve.accel)return this.curve.accel(this._getCoord(a));var b=w._EPSILON,c=this.velocity(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.velocity(a+b));return F.vecSubScaleInPlace(c,this.velocity(a),1/b)};w.prototype.jerk=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.jerk&&null!==this.curve.jerk)return this.curve.jerk(this._getCoord(a));var b=w._EPSILON,c=this.accel(a+
b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.accel(a+b));return F.vecSubScaleInPlace(c,this.accel(a),1/b)};w.prototype.normal=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.normal&&null!==this.curve.normal)return this.curve.normal(this._getCoord(a));var b=w._EPSILON,c=this.tangent(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(c=this.tangent(a+-b));c=F.vecSubInPlace(c,this.tangent(a));return F.vecNormalizeInPlace(c)};w.prototype.tangent=
function(a){return F.vecNormalizeInPlace(this.velocity(a))};w.prototype.getLength=function(){var a=this.endPoints();return this.arcLength(a[1])};var aa=[.9969339225295955,.00825771143316837,0,.9815606342467192,.02303608403898155,.04717533638651112,.9505377959431213,.03891523046929952,0,.9041172563704749,.05369701760775668,.10693932599531891,.8435581241611533,.06725090705083998,0,.7699026741943047,.07992027533360173,.16007832854334625,.6840598954700559,.09154946829504924,0,.5873179542866175,.10164973227906016,
.20316742672306579,.4813394504781571,.11002260497764407,0,.3678314989981802,.11671205350175679,.23349253653835478,.24850574832046932,.12162630352394839,0,.1252334085114689,.12458416453615606,.24914704581340283,0,.12555689390547423,0];w.prototype.arcLength=function(a){if("undefined"!==typeof this.curveParam&&null!==this.curveParam&&this.curveParam instanceof w._ArcLengthParam)return a;if("undefined"!==typeof this.curve&&null!==this.curve&&this.curve!==this&&"undefined"!==typeof this.curve.arcLength&&
null!==this.curve.arcLength)return this.curve.arcLength(this._getCoord(a));var b=this.endPoints();if(a===b[0])return 0;var c=this;return Z(function(a){return F.vecLength(c.velocity(a))},Math.min(a,b[0]),Math.max(a,b[0]),a>=b[0]?1:-1,0)};w.prototype.getPoints=function(a){if(0===a)return[];if(0>a)throw Error();for(var b=this.endPoints(),c=[this.evaluate(b[0])],d=1;d<a;d++)c.push(this.evaluate(b[0]+d/(a-1)*(b[1]-b[0])));return c};w._ChangeEnds=function(a,b){this.u1=a;this.u2=b;this.getCoordinate=function(a){return a};
this.endPoints=function(){return[this.u1,this.u2]}};w._FitRange=function(a,b,c){this.newEp1=b;this.newEp2=c;this.invNewEpDelta=1/(c-b);a=a.endPoints();this.origEp1=a[0];this.origEp2=a[1];this.getCoordinate=function(a){return this.origEp1+(this.origEp2-this.origEp1)*(a-this.newEp1)*this.invNewEpDelta};this.endPoints=function(){return[b,c]}};w._ArcLengthParam=function(a){this.curve=a;this.ep=this.curve.endPoints();this.segments=[];a=this.ep[0];for(var b=0,c=this.curve.getLength(),c=Math.min(Math.max(10,
Math.ceil(18*c)),50),d=1;d<=c;d++){var e=this.ep[0]+d/c*(this.ep[1]-this.ep[0]),f=this.curve.arcLength(e);this.segments.push([b,f,a,e]);a=e;b=f}this.length=0===this.segments.length?0:this.segments[this.segments.length-1][1];this._vecLength=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return Math.sqrt(b)};this._solveArcLength=function(a,b,c,d){for(var e=0;10>e;e++){var f=this.curve.arcLength(b)-a;if(1E-10>Math.abs(f)&&b>=c&&b<d)break;var g=this._vecLength(this.curve.velocity(b));if(0===
g)break;var g=f/g,h=b-g;if(0===g)break;c!==Number.NEGATIVE_INFINITY&&d!==Number.POSITIVE_INFINITY?0>f?(c=Math.max(c,b),b=h,h>=d&&(b=c+.5*(d-c))):0<f&&(d=Math.min(d,b),b=h,h<=c&&(b=c+.5*(d-c))):b=h}return b}};w._ArcLengthParam.prototype.getCoordinate=function(a){var b,c;if(a>this.length)return b=this.curve.endPoints(),c=b[0]+a/this.length*(b[1]-b[0]),this._solveArcLength(a,c,b[0],Number.POSITIVE_INFINITY);if(0>a)return b=this.curve.endPoints(),c=b[0]+a/this.length*(b[1]-b[0]),this._solveArcLength(a,
c,Number.NEGATIVE_INFINITY,0);if(a===this.length)return b=this.curve.endPoints(),b[1];if(0===a)return b=this.curve.endPoints(),b[0];c=0;for(var d=this.segments.length,e=0;c<d;){e+=1;if(20<e)throw Error();var f=c+((d-c)/2|0);b=this.segments[f];if(a===b[0])return b[2];if(a===b[1])return b[3];if(a>b[0]&&a<b[1])return c=b[2]+(a-b[0])/(b[1]-b[0])*(b[3]-b[2]),1E-10<=b[1]-b[0]?this._solveArcLength(a,c,b[2],b[3]):c;a<b[0]?d=f:c=f+1}throw Error("Internal error");};w._ArcLengthParam.prototype.endPoints=function(){return[0,
this.length]};w.prototype.changeEnds=function(a,b){return new w(this,new w._ChangeEnds(a,b))};w.prototype.fitRange=function(a,b){return new w(this,new w._FitRange(this,a,b))};w.prototype.toArcLengthParam=function(){return new w(this,new w._ArcLengthParam(this))};var M=function(a){this.surface="undefined"===typeof a?null:a};M._EPSILON=1E-5;M.prototype.tangent=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.tangent&&null!==this.surface.tangent)return this.surface.tangent(a,
b);var c=M._EPSILON,d=this.evaluate(a+c,b);0===d[0]&&0===d[1]&&0===d[2]&&(c=-c,d=this.evaluate(a+c,b));return F.vecSubScaleInPlace(d,this.evaluate(a,b),1/c)};M.prototype.bitangent=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.bitangent&&null!==this.surface.bitangent)return this.surface.bitangent(a,b);var c=M._EPSILON,d=this.evaluate(a,b+c);0===d[0]&&0===d[1]&&0===d[2]&&(c=-c,d=this.evaluate(a,b+c));return F.vecSubScaleInPlace(d,this.evaluate(a,
b),1/c)};M.prototype.normal=function(a,b){return F.vecNormalizeInPlace(this.gradient(a,b))};M.prototype.gradient=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.gradient&&null!==this.surface.gradient)return this.surface.gradient(a,b);var c=this.tangent(a,b),d=this.bitangent(a,b);if(0===F.vecLength(d))return c;if(0!==F.vecLength(c)){if(3!==c.length||3!==d.length){var e=c.length,f=F.vecZeros(e),c=[c[0]||0,c[1]||0,c[2]||0],d=[d[0]||0,d[1]||0,
d[2]||0],c=H3DU.Math.vec3cross(c,d);f[0]=c[0];f[1]=c[1];f[2]=c[2];return f.slice(0,e)}return H3DU.Math.vec3cross(c,d)}return d};M.prototype.evaluate=function(a,b){return"undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.evaluate&&null!==this.surface.evaluate?this.surface.evaluate(a,b):[0,0,0]};M.prototype.endPoints=function(){return"undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.endPoints&&null!==this.surface.endPoints?
this.surface.endPoints():[0,1,0,1]};var G=function(a,b,c,d){if("undefined"===typeof d||null===d)d=b;if("undefined"===typeof c||null===c)c=0;if(0>c||0>=b||0>=d)throw Error();this.buffer=a;this.offset=c;this.countPerValue=b;this.stride=d};G.prototype.count=function(){var a=this.buffer.length-this.offset;return Math.floor(a/this.stride)+(a%this.stride>=this.countPerValue?1:0)};G.prototype.get=function(a){return this.buffer[this.offset+a*this.stride]};G.prototype.set=function(a,b){this.buffer[this.offset+
a*this.stride]=b;return this};G.prototype.getVec=function(a,b){for(var c=this.offset+a*this.stride,d=this.buffer,e=0;e<this.countPerValue;e++)b[e]=d[c+e];return b};G.prototype.setVec=function(a,b){for(var c=this.offset+a*this.stride,d=this.buffer,e=Math.min(b.length,this.countPerValue),f=0;f<e;f++)d[c+f]=b[f];return this};G.prototype.copy=function(){for(var a=this.count(),b=G.makeBlank(a,this.countPerValue),c=[],d=0;d<a;d++)this.getVec(d,c),b.setVec(d,c);return b};G.makeBlank=function(a,b){return new G(new Float32Array(new ArrayBuffer(a*
b*4)),b)};G.makeIndices=function(a){var b;b=65536>a?new Uint16Array(new ArrayBuffer(2*a)):new Uint32Array(new ArrayBuffer(4*a));for(var c=0;c<a;c++)b[c]=c;return b};G.merge=function(a,b,c,d){var e;e=Math.max("undefined"===typeof a||null===a?0:a.countPerValue,"undefined"===typeof c||null===c?0:c.countPerValue);var f=G.makeBlank(b.length+d.length,e),g=F.vecZeros(e);if("undefined"!==typeof a&&null!==a)for(e=0;e<b.length;e++)a&&a.getVec(b[e],g),f.setVec(e,g);if("undefined"!==typeof c&&null!==c)for(e=
0;e<d.length;e++)c&&c.getVec(d[e],g),f.setVec(b.length+e,g);return f};var v=function(){this.format=H3DU.Mesh.TRIANGLES;this.attributes=[];this._bounds=null;this.indices=new Uint8Array([])};v.prototype.getIndices=function(){return this.indices};v.prototype.setIndices=function(a){if(a instanceof Array){for(var b=0,c=a.length-1;0<=c&&!(b=Math.max(b,a[c]),65536<=b);c--);this.indices=65536<=b?new Uint32Array(a):new Uint16Array(a)}else this.indices=a.slice(0,a.length);return this};v.prototype.setPrimitiveType=
function(a){this.format=a;return this};v.prototype.setAttribute=function(a,b,c,d,e){return this.setAttributeEx(a,0,b,c,d,e)};v.prototype.setAttributeEx=function(a,b,c,d,e,f){var g;if(c instanceof G){if(c.buffer instanceof G)throw Error();return this.setAttributeEx(a,b,c.buffer,c.countPerValue,c.offset,c.stride)}if("undefined"===typeof d||null===d)throw Error();g=c instanceof Array?new Float32Array(c):c;f="undefined"===typeof f||null===f?d:f;e="undefined"===typeof e||null===e?0:e;if(0>=d||0>=f||0>
e)throw Error();b=v._resolveSemantic(a,b);if("undefined"===typeof b||null===b)return console.warn("Unsupported attribute semantic: "+a),this;a=b[0];b=b[1];var h=this.getAttribute(a,b);h?(h[2].buffer=c,h[2].offset=e,h[2].countPerValue=d,h[2].stride=f):this.attributes.push([a,b,new G(g,d,e,f)]);this._bounds=null;return this};v.prototype._getAttributes=function(){return this.attributes};v.prototype.getAttribute=function(a,b){for(var c="undefined"===typeof b||null===b?0:b,d=0;d<this.attributes.length;d++)if(this.attributes[d][0]===
a&&this.attributes[d][1]===c)return this.attributes[d][2];return null};v.prototype.vertexIndices=function(a,b){var c=3,d=this.primitiveType();d===H3DU.Mesh.LINES&&(c=2);d===H3DU.Mesh.POINTS&&(c=1);d=a*c;b[0]=this.indices[d];2<=c&&(b[1]=this.indices[d+1]);3<=c&&(b[2]=this.indices[d+2]);return b};v.prototype.primitiveCount=function(){return this.format===H3DU.Mesh.LINES?Math.floor(this.indices.length/2):this.format===H3DU.Mesh.POINTS?this.indices.length:Math.floor(this.indices.length/3)};v.prototype.getPositions=
function(){var a=this.getAttribute(H3DU.Semantic.POSITION,0);if(!a)return[];for(var b=[],c=[],d=this.primitiveCount(),e=0;e<d;e++){this.vertexIndices(e,c);for(var f=[],g=0;g<c.length;g++)f.push(a.getVec(c[g],[0,0,0]));b.push(f)}return b};v.prototype.normalizeNormals=function(){for(var a=0;a<this.attributes.length;a++){var b=this.attributes[a];if(b[0]===H3DU.Semantic.NORMAL)for(var c=[],d=b[2].count(),e=0;e<d;e++)b[2].getVec(e,c),F.vecNormalizeInPlace(c),b[2].setVec(e,c)}return this};v.prototype.reverseNormals=
function(){for(var a=0;a<this.attributes.length;a++){var b=this.attributes[a];if(b[0]===H3DU.Semantic.NORMAL)for(var c=[],d=b[2].count(),e=0;e<d;e++){b[2].getVec(e,c);for(var f=0;f<c.length;f++)c[f]=-c[f];b[2].setVec(e,c)}}return this};v.prototype.setColor3=function(a){return 3===arguments.length?this.setColor([arguments[0],arguments[1],arguments[2]]):this.setColor(a)};v.prototype.setColor=function(a){a=H3DU.toGLColor(a);for(var b=!1,c=0;c<this.attributes.length;c++){var d=this.attributes[c],e=d[2].count();
if(d[0]===H3DU.Semantic.COLOR)for(var b=!0,f=0;f<e;f++)d[2].setVec(f,a)}return b?this:(this._ensureAttribute(H3DU.Semantic.COLOR,0,3),this.setColor(a))};v.prototype.reverseWinding=function(){if(this.primitiveType()===H3DU.Mesh.TRIANGLES)for(var a=0;a+2<this.indices.length;a+=3){var b=this.indices[a+1];this.indices[a+1]=this.indices[a+2];this.indices[a+2]=b}return this};v._recalcNormals=function(a,b,c,d,e){var f=e?-1:1;e={};var g=[],h,m=b.count(),t=Math.min(a.count(),m),l=[0,0,0],k=[0,0,0],n=[0,0,
0],q=[0,0,0];for(h=0;h<t;h++)if(b.setVec(h,l),!d){var u=a.getVec(h,[]);e[u]?e[u].push(h):e[u]=[h]}for(h=0;h<c.length;h+=3)l=a.getVec(c[h],l),k=a.getVec(c[h+1],k),n=a.getVec(c[h+2],n),t=H3DU.Math.vec3sub(l,n),u=H3DU.Math.vec3sub(k,n),t=H3DU.Math.vec3cross(t,u),H3DU.Math.vec3normalizeInPlace(t),H3DU.Math.vec3scaleInPlace(t,f),b.getVec(c[h],l),b.getVec(c[h+1],k),b.getVec(c[h+2],n),H3DU.Math.vec3addInPlace(l,t),H3DU.Math.vec3addInPlace(k,t),H3DU.Math.vec3addInPlace(n,t),b.setVec(c[h],l),b.setVec(c[h+
1],k),b.setVec(c[h+2],n);if(!d)for(var C in e)if(Object.prototype.hasOwnProperty.call(e,C)&&(d=e[C])&&d.constructor===Array&&2<=d.length){b.getVec(d[0],q);f=[q[0],q[1],q[2]];g[0]=q[0];g[1]=q[1];g[2]=q[2];c=3;for(h=1;h<d.length;h++){l=!1;a.getVec(d[h],q);k=q[0];n=q[1];t=q[2];for(u=0;u<c;u+=3)if(k===g[u]&&n===g[u+1]&&t===g[u+2]){l=!0;break}l||(g[c++]=k,g[c++]=n,g[c++]=t,H3DU.Math.vec3addInPlace(f,q))}for(h=0;h<d.length;h++)b.setVec(d[h],f)}for(h=0;h<m;h++)b.getVec(h,q),H3DU.Math.vec3normalize(q),b.setVec(h,
q)};v._recalcTangentsInternal=function(a,b,c,d,e,f){for(var g=[0,0,0],h=[0,0,0],m=[0,0,0],t=0;t<f.length;t+=3){var g=a.getVec(f[t],g),h=a.getVec(f[t+1],h),m=a.getVec(f[t+2],m),l;l=h[0]-g[0];var k=h[1]-g[1],n=h[2]-g[2],q=m[0]-g[0],u=m[1]-g[1],C=m[2]-g[2],g=c.getVec(f[t],g),h=c.getVec(f[t+1],h),m=c.getVec(f[t+2],m),p=h[0]-g[0],v=h[1]-g[1],w=m[0]-g[0],x=m[1]-g[1],D=p*x-v*w;0===D?l=[0,0,0,0,0,0]:(D=1/D,v=-v,w=-w,l=[(x*l+v*q)*D,(x*k+v*u)*D,(x*n+v*C)*D,(w*l+p*q)*D,(w*k+p*u)*D,(w*n+p*C)*D]);for(k=0;3>k;k++)n=
l,g=b.getVec(f[t+k],g),q=g[0],u=g[1],C=g[2],p=n[0]*q+n[1]*u+n[2]*C,p=H3DU.Math.vec3normalizeInPlace([n[0]-p*q,n[1]-p*u,n[2]-p*C]),x=n[3]*q+n[4]*u+n[5]*C,D=n[3]*p[0]+n[4]*p[1]+n[5]*p[2],n=H3DU.Math.vec3normalizeInPlace([n[3]-x*q-D*p[0],n[4]-x*u-D*p[1],n[5]-x*C-D*p[2]]),d.setVec(f[t+k],p),e.setVec(f[t+k],n)}};v.prototype._makeRedundant=function(){for(var a=[],b=0;b<this.attributes.length;b++){var c=this.attributes[b];a.push([c[0],c[1],G.merge(c[2],this.indices,null,[])])}this.attributes=a;this.setIndices(G.makeIndices(this.indices.length))};
v.prototype._ensureAttribute=function(a,b,c){var d=this.getAttribute(a,b),e=0===this.attributes.length?0:this.attributes[0][2].count(),f="undefined"!==typeof d&&null!==d?d.countPerValue:0;if(d&&f>=c)return d;var g=G.makeBlank(e,c);if(0<f)for(c=F.vecZeros(c),f=0;f<e;f++)d.getVec(f,c),g.setVec(f,c);this.attributes.push([a,b,g]);return g};v.prototype._countPerValue=function(a){a=this.getAttribute(a);return"undefined"!==typeof a&&null!==a?a.countPerValue:0};v.prototype.recalcNormals=function(a,b){if(this.primitiveType()===
H3DU.Mesh.TRIANGLES){if(3>this._countPerValue(H3DU.Semantic.POSITION))return this;this._makeRedundant();var c=this.getAttribute(H3DU.Semantic.POSITION),d=this._ensureAttribute(H3DU.Semantic.NORMAL,0,3);v._recalcNormals(c,d,this.indices,a,b)}return this};v.prototype._recalcTangents=function(){if(this.primitiveType()===H3DU.Mesh.TRIANGLES){if(3>this._countPerValue(H3DU.Semantic.POSITION)||3>this._countPerValue(H3DU.Semantic.NORMAL)||2>this._countPerValue(H3DU.Semantic.TEXCOORD))return this;this._makeRedundant();
var a=this.getAttribute(H3DU.Semantic.POSITION),b=this.getAttribute(H3DU.Semantic.NORMAL),c=this.getAttribute(H3DU.Semantic.TEXCOORD),d=this._ensureAttribute(H3DU.Semantic.TANGENT,0,3),e=this._ensureAttribute(H3DU.Semantic.BITANGENT,0,3);v._recalcTangentsInternal(a,b,c,d,e,this.indices)}return this};v.prototype.merge=function(a){var b=[],c;if(!a)throw Error();if(a instanceof H3DU.Mesh)return this.merge(a.toMeshBuffer());if(0===a.indices.length)return this;if(0===this.indices.length){for(var d=!0,
e=0;e<this.attributes.length;e++)c=this.attributes[e][2],d=d&&("undefined"===typeof c||null===c||0===c.count());if(d){for(e=0;e<a.attributes.length;e++)c=a.attributes[e],b.push([c[0],c[1],c[2].copy()]);this._bounds=null;this.format=a.format;this.attributes=b;this.setIndices(a.indices.slice(0,a.indices.length));return this}}if(this.format!==a.format)throw Error();for(e=0;e<this.attributes.length;e++){var f=null;c=this.attributes[e];for(var d=c[0],g=c[1],h=0;h<a.attributes.length;h++){var m=a.attributes[h];
if(m[0]===d&&m[1]===g){f=m[2];break}}c=G.merge(c[2],this.indices,f,a.indices);if(!c)throw Error();b.push([d,g,c])}for(e=0;e<a.attributes.length;e++){f=null;m=a.attributes[e];for(h=0;h<this.attributes.length;h++)if(c=this.attributes[h],m[0]===c[0]&&m[1]===c[1]){f=c;break}if("undefined"===typeof f||null===f){c=G.merge(null,this.indices,m[2],a.indices);if(!c)throw Error();b.push([m[0],m[1],c])}}a=G.makeIndices(this.indices.length+a.indices.length);this._bounds=null;this.attributes=b;this.setIndices(a);
return this};v.prototype.transform=function(a){var b=this.getAttribute(H3DU.Semantic.POSITION);if(!b)return this;var c=this.getAttribute(H3DU.Semantic.NORMAL),d=!(1===a[0]&&0===a[1]&&0===a[2]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[8]&&0===a[9]&&1===a[10]),e=null;"undefined"!==typeof c&&null!==c&&d&&(e=H3DU.Math.mat4inverseTranspose3(a));var f=b.count();c&&(f=Math.min(f,c.count()));for(var g=[0,0,0],h=[0,0,0],m=0;m<f;m++){b.getVec(m,g);var t=H3DU.Math.mat4projectVec3(a,g[0],g[1],g[2]);b.setVec(m,t);
c&&d&&"undefined"!==typeof e&&null!==e&&(c.getVec(m,h),t=H3DU.Math.mat3transform(e,h[0],h[1],h[2]),H3DU.Math.vec3normalizeInPlace(t),c.setVec(m,t))}this._bounds=null;return this};v._addLine=function(a,b,c,d){if(c<d){var e=c;c=d;d=e}(e=b[c])?0>e.indexOf(d)&&(e.push(d),a.push(c,d)):(b[c]=[d],a.push(c,d))};v.prototype.toWireFrame=function(){return(new v).merge(this).wireFrame()};v.prototype.wireFrame=function(){if(this.primitiveType()!==H3DU.Mesh.TRIANGLES)return this;for(var a=[],b={},c=0;c<this.indices.length;c+=
3){var d=this.indices[c],e=this.indices[c+1],f=this.indices[c+2];v._addLine(a,b,d,e);v._addLine(a,b,e,f);v._addLine(a,b,f,d)}return this.setIndices(a).setPrimitiveType(H3DU.Mesh.LINES)};v.prototype.getBounds=function(){if(!this._bounds){var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this.getAttribute(H3DU.Semantic.POSITION,0);if(!c)return b;for(var d=[],e=[0,0,0],f=this.primitiveCount(),g=0;g<f;g++){this.vertexIndices(g,d);for(var h=0;h<d.length;h++){var m=c.getVec(d[h],e);a?(a=!1,b[0]=
b[3]=m[0],b[1]=b[4]=m[1],b[2]=b[5]=m[2]):(b[0]=Math.min(b[0],m[0]),b[3]=Math.max(b[3],m[0]),b[1]=Math.min(b[1],m[1]),b[4]=Math.max(b[4],m[1]),b[2]=Math.min(b[2],m[2]),b[5]=Math.max(b[5],m[2]))}b.push([])}this._bounds=b.slice(0,6);return b}return this._bounds.slice(0,6)};v.prototype.primitiveType=function(){return this.format};v.prototype.vertexCount=function(){return this.indices.length};v._resolveSemantic=function(a,b){if("number"===typeof a)return[a,b|0];var c=v._wellKnownAttributes[a];if("undefined"===
typeof c||null===c){var d=a.indexOf("_");if(0>d)return null;c=v._wellKnownAttributes[a.substr(0,d)];if("undefined"===typeof c||null===c)return null;d=a.substr(d+1);return 5>=d.length&&/^\d$/.test(d)?[c,parseInt(d,10)]:null}return[c,0]};v._wellKnownAttributes={POSITION:0,TEXCOORD:2,TEXCOORD_0:2,NORMAL:1,COLOR:3,JOINT:4,WEIGHT:5,JOINTS:4,WEIGHTS:5,TANGENT:6,BITANGENT:7};var B={POSITION:0,NORMAL:1,TEXCOORD:2,COLOR:3,JOINT:4,WEIGHT:5,TANGENT:6,BITANGENT:7,CUSTOM:8,MODEL:101,VIEW:102,PROJECTION:103,MODELVIEW:104,
MODELVIEWPROJECTION:105,MODELVIEWINVERSETRANSPOSE:106,VIEWINVERSE:107,JOINTMATRIX:108},l=function(a,b,c){this._initialize(a,b,c);this._elementsDefined=0;this.currentMode=-1;this.normal=[0,0,0];this.color=[0,0,0];this.tangent=[0,0,0];this.bitangent=[0,0,0];this.texCoord=[0,0]};l._modeToPrimitiveType=function(a){return a===l.LINES||a===l.LINE_STRIP?l.LINES:a===l.POINTS?l.POINTS:l.TRIANGLES};l._isCompatibleMode=function(a,b){return l._modeToPrimitiveType(a)===l._modeToPrimitiveType(b)};l.prototype.mode=
function(a){if(0>a)throw Error("invalid mode");if(-1===this.currentMode){var b=0,c=l._modeToPrimitiveType(a);c===l.LINES?b|=l.LINES_BIT:c===l.POINTS&&(b|=l.POINTS_BIT);this._initialize([],[],b);this.currentMode=a}else if(l._isCompatibleMode(this.currentMode,a))this.newPrimitive(),this.currentMode=a;else throw Error("Storing a different primitive mode in this mesh is no longer supported");return this};l.prototype.normal3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?
(this.normal[0]=a,this.normal[1]=b,this.normal[2]=c):(this.normal[0]=a[0],this.normal[1]=a[1],this.normal[2]=a[2]);this._elementsDefined|=l.NORMALS_BIT;return this};l.prototype.color3=function(a,b,c){"string"===typeof a?(a=H3DU.toGLColor(a),this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]):"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.color[0]=a,this.color[1]=b,this.color[2]=c):(this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]);this._elementsDefined|=l.COLORS_BIT;
return this};l.prototype.texCoord2=function(a,b){"number"===typeof a&&"number"===typeof b?(this.texCoord[0]=a,this.texCoord[1]=b):(this.texCoord[0]=a[0],this.texCoord[1]=a[1]);this._elementsDefined|=l.TEXCOORDS_BIT;return this};l.prototype.vertex3=function(a,b,c){"undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?this._vertex3(a,b,c):"number"!==typeof a?this._vertex3(a[0],a[1],a[2]):this._vertex3(a,a,a);return this};l.prototype.vertex2=function(a,
b){return"undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b?this.vertex3(a,b,0):"number"!==typeof a?this.vertex3(a[0],a[1],0):this.vertex3(a,a,0)};l.prototype.setVertex=function(a,b,c,d){if(0>a)return this;"undefined"===typeof c&&"undefined"===typeof d&&(c=b[1],d=b[2],b=b[0]);var e=this.vertexCount();a<e&&(a*=this.getStride(),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=d);return this};l.prototype.setVertexNormal=function(a,b,c,d){if(0>a)return this;"undefined"===typeof c&&
"undefined"===typeof d&&(c=b[1],d=b[2],b=b[0]);var e=this.vertexCount();a<e&&(this._rebuildVertices(l.NORMALS_BIT),a*=this.getStride(),a+=l._normalOffset(this.attributeBits),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=d);return this};l.prototype.getVertex=function(a){if(0>a)return null;var b=this.vertexCount();return a<b?(this._rebuildVertices(l.NORMALS_BIT),a*=this.getStride(),this.vertices.slice(a,a+3)):null};l.prototype.getVertexNormal=function(a){var b=this.vertexCount();return a<
b?(this._rebuildVertices(l.NORMALS_BIT),a*=this.getStride(),a+=l._normalOffset(this.attributeBits),this.vertices.slice(a,a+3)):null};l.prototype.vertexCount=function(){return this.vertices.length/this.getStride()};l._initVertices=function(a,b){if(0===(b&(l.TANGENTS_BIT|l.BITANGENTS_BIT)))return a;var c=l._getStride(b),d=c;0!==(b&l.TANGENTS_BIT)&&(d+=3);0!==(b&l.BITANGENTS_BIT)&&(d+=3);for(var e=[],f=0;f<a.length;f+=d)for(var g=0;g<c;g++)e.push(a[f+g]);return e};l._initTangents=function(a,b){if(0===
(b&(l.TANGENTS_BIT|l.BITANGENTS_BIT)))return[];var c=l._getStride(b),d=c;0!==(b&l.TANGENTS_BIT)&&(d+=3);0!==(b&l.BITANGENTS_BIT)&&(d+=3);for(var e=[],f=0;f<a.length;f+=d){var g=0,h=0,m=0,t=0,k=0,r=0,n=f+c;0!==(b&l.TANGENTS_BIT)&&(g=a[n],h=a[n+1],m=a[n+2],n+=3);0!==(b&l.BITANGENTS_BIT)&&(t=a[n],k=a[n+1],r=a[n+2]);e.push(g,h,m,t,k,r)}return e};l.prototype._initialize=function(a,b,c){this.attributeBits="undefined"===typeof c||null===c?0:c;a=a||[];this.vertices=l._initVertices(a,this.attributeBits);this.indices=
b||[];this.tangents=l._initTangents(a,this.attributeBits);this.startIndex=0;this.primitiveData=[0,0,0,0];this.primitiveIndex=0;this.primitiveOdd=!1;b=c&l.PRIMITIVES_BITS;if(0!==b&&b!==l.LINES_BIT&&b!==l.POINTS_BIT)throw Error("invalid format");this.getStride=function(){return l._getStride(this.attributeBits)};this.newPrimitive=function(){this.primitiveIndex=0;this.primitiveOdd=!1;return this};this.primitiveType=function(){var a=l.TRIANGLES;0!==(this.attributeBits&l.LINES_BIT)&&(a=l.LINES);0!==(this.attributeBits&
l.POINTS_BIT)&&(a=l.POINTS);return a};this._rebuildVertices=function(a){var b=this.attributeBits;a=b|a&l.ATTRIBUTES_BITS;if(a!==b){for(var c=this.getStride(),d,h,m,t=[],k=[],r=0;r<this.vertices.length;r+=c){var n=r+3;t.push(this.vertices[r],this.vertices[r+1],this.vertices[r+2]);0!==(a&l.NORMALS_BIT)&&(0!==(b&l.NORMALS_BIT)?(d=this.vertices[n],h=this.vertices[n+1],m=this.vertices[n+2],n+=3,t.push(d,h,m)):t.push(0,0,0));0!==(a&l.COLORS_BIT)&&(0===(b&l.COLORS_BIT)?t.push(0,0,0):(d=this.vertices[n],
h=this.vertices[n+1],m=this.vertices[n+2],n+=3,t.push(d,h,m)));0!==(a&l.TEXCOORDS_BIT)&&(0===(b&l.TEXCOORDS_BIT)?t.push(0,0):(d=this.vertices[n],h=this.vertices[n+1],n+=2,t.push(d,h)));0!==(a&(l.TANGENTS_BIT|l.BITANGENTS_BIT))&&(0===(b&(l.TANGENTS_BIT|l.BITANGENTS_BIT))?k.push(0,0,0,0,0,0):(d=this.tangents[n],h=this.tangents[n+1],m=this.tangents[n+2],k.push(d,h,m),d=this.tangents[n+3],h=this.tangents[n+4],m=this.tangents[n+5],k.push(d,h,m)))}this.vertices=t;this.tangents=k;this.attributeBits=a}};
this._setTriangle=function(a,b,c,g,h){this.indices.push(c,g,h)};this._vertex3=function(a,b,c){var d=this.currentMode;if(-1===d)throw Error("mode() not called");this._rebuildVertices(this._elementsDefined);var e=this.vertices.length;this.vertices.push(a,b,c);0!==(this.attributeBits&l.NORMALS_BIT)&&this.vertices.push(this.normal[0],this.normal[1],this.normal[2]);0!==(this.attributeBits&l.COLORS_BIT)&&this.vertices.push(this.color[0],this.color[1],this.color[2]);0!==(this.attributeBits&l.TEXCOORDS_BIT)&&
this.vertices.push(this.texCoord[0],this.texCoord[1]);0!==(this.attributeBits&(l.TANGENTS_BIT|l.BITANGENTS_BIT))&&(this.tangents.push(this.tangent[0],this.tangent[1],this.tangent[2]),this.tangents.push(this.bitangent[0],this.bitangent[1],this.bitangent[2]));a=this.getStride();b=e/a;if(Math.floor(b)!==b)throw Error();this.primitiveData[this.primitiveIndex]=b;this.primitiveIndex++;d===l.QUAD_STRIP&&4<=this.primitiveIndex?(this._setTriangle(e,a,this.primitiveData[0],this.primitiveData[1],this.primitiveData[2]),
this._setTriangle(e,a,this.primitiveData[2],this.primitiveData[1],this.primitiveData[3]),this.primitiveData[0]=this.primitiveData[2],this.primitiveData[1]=this.primitiveData[3],this.primitiveIndex-=2):d===l.QUADS&&4<=this.primitiveIndex?(this._setTriangle(e,a,this.primitiveData[0],this.primitiveData[1],this.primitiveData[2]),this._setTriangle(e,a,this.primitiveData[0],this.primitiveData[2],this.primitiveData[3]),this.primitiveIndex-=4):d===l.TRIANGLES&&3<=this.primitiveIndex?(this._setTriangle(e,
a,this.primitiveData[0],this.primitiveData[1],this.primitiveData[2]),this.primitiveIndex-=3):d===l.LINES&&2<=this.primitiveIndex?(this.indices.push(this.primitiveData[0],this.primitiveData[1]),this.primitiveIndex-=2):d===l.TRIANGLE_FAN&&3<=this.primitiveIndex?(this._setTriangle(e,a,this.primitiveData[0],this.primitiveData[1],this.primitiveData[2]),this.primitiveData[1]=this.primitiveData[2],--this.primitiveIndex):d===l.LINE_STRIP&&2<=this.primitiveIndex?(this.indices.push(this.primitiveData[0],this.primitiveData[1]),
this.primitiveData[0]=this.primitiveData[1],this.primitiveIndex--):d===l.POINTS?(this.indices.push(this.primitiveData[0]),this.primitiveIndex--):d===l.TRIANGLE_STRIP&&3<=this.primitiveIndex&&(this.primitiveOdd?this._setTriangle(e,a,this.primitiveData[1],this.primitiveData[0],this.primitiveData[2]):this._setTriangle(e,a,this.primitiveData[0],this.primitiveData[1],this.primitiveData[2]),this.primitiveData[0]=this.primitiveData[1],this.primitiveData[1]=this.primitiveData[2],this.primitiveIndex--);this.primitiveOdd=
!this.primitiveOdd;return this}};l.prototype.primitiveCount=function(){return 0!==(this.attributeBits&l.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.attributeBits&l.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};l.prototype.toMeshBuffer=function(){var a=new v;a.setIndices(this.indices);a.setPrimitiveType(this.primitiveType());var b=l._getStride(this.attributeBits),c=new Float32Array(this.vertices);a.setAttribute(B.POSITION,c,3,0,b);var d=l._normalOffset(this.attributeBits);
0<=d&&a.setAttribute(B.NORMAL,c,3,d,b);d=l._colorOffset(this.attributeBits);0<=d&&a.setAttribute(B.COLOR,c,3,d,b);d=l._texCoordOffset(this.attributeBits);0<=d&&a.setAttribute(B.TEXCOORD,c,2,d,b);b=new Float32Array(this.tangents);0!==(this.attributeBits&l.TANGENTS_BIT)&&a.setAttribute(B.TANGENT,b,3,0,3);0!==(this.attributeBits&l.BITANGENTS_BIT)&&a.setAttribute(B.BITANGENT,b,3,3,3);return a};l._getStride=function(a){return[3,6,6,9,5,8,8,11][a&(l.NORMALS_BIT|l.COLORS_BIT|l.TEXCOORDS_BIT)]};l._normalOffset=
function(a){return[-1,3,-1,3,-1,3,-1,3][a&(l.NORMALS_BIT|l.COLORS_BIT|l.TEXCOORDS_BIT)]};l._colorOffset=function(a){return[-1,-1,3,6,-1,-1,3,6][a&(l.NORMALS_BIT|l.COLORS_BIT|l.TEXCOORDS_BIT)]};l._texCoordOffset=function(a){return[-1,-1,-1,-1,3,6,6,9][a&(l.NORMALS_BIT|l.COLORS_BIT|l.TEXCOORDS_BIT)]};l.ATTRIBUTES_BITS=255;l.PRIMITIVES_BITS=768;l.NORMALS_BIT=1;l.COLORS_BIT=2;l.TEXCOORDS_BIT=4;l.TANGENTS_BIT=8;l.BITANGENTS_BIT=16;l.LINES_BIT=256;l.POINTS_BIT=512;l.TRIANGLES=4;l.QUAD_STRIP=8;l.QUADS=7;
l.LINES=1;l.TRIANGLE_FAN=6;l.TRIANGLE_STRIP=5;l.LINE_STRIP=3;l.POINTS=0;l.prototype.enumPrimitives=function(a){var b=this.primitiveType(),c=l._normalOffset(this.attributeBits),d=l._colorOffset(this.attributeBits),e=l._texCoordOffset(this.attributeBits),f=this.getStride(),g=this.vertices,h=3;b===l.LINES&&(h=2);b===l.POINTS&&(h=1);for(b=0;b<this.indices.length;b+=h){for(var m=[],t=0;t<h;t++){var k=this.indices[b+t]*f,r={};r.position=[g[k],g[k+1],g[k+2]];0<=c&&(r.normal=[g[k+c],g[k+c+1],g[k+c+2]]);0<=
d&&(r.color=[g[k+d],g[k+d+1],g[k+d+2]]);0<=e&&(r.uv=[g[k+e],g[k+e+1]]);m.push(r)}a(m)}return this};l.prototype._carryOver=function(a){this.vertices=a.vertices;this.attributeBits=a.attributeBits;this.indices=a.indices;this.tangents=a.tangents;this.newPrimitive();return this};l.prototype.toWireFrame=function(){return 0!==(this.attributeBits&l.PRIMITIVES_BITS)?this:l._fromMeshBuffer(this.toMeshBuffer().wireFrame(),null)};l._getValue=function(a,b,c){return a?(c[0]=0,c[1]=0,c[2]=0,a.getVec(b,c),!0):!1};
l._fromMeshBufferOne=function(a,b){var c=a.getAttribute(B.POSITION),d=a.getAttribute(B.NORMAL),e=a.getAttribute(B.COLOR),f=a.getAttribute(B.TEXCOORD),g=[],h=b.color.slice(0,3),m=b.normal.slice(0,3),t=b.texCoord.slice(0,2);l._getValue(d,0,g)&&b.normal3(g);l._getValue(e,0,g)&&b.color3(g);l._getValue(f,0,g)&&b.texCoord2(g);l._getValue(c,0,g)&&b.vertex3(g);b.color3(h).normal3(m).texCoord2(t)};l._fromMeshBuffer=function(a,b){for(var c=a.getAttribute(B.POSITION),d=a.getAttribute(B.NORMAL),e=a.getAttribute(B.COLOR),
f=a.getAttribute(B.TEXCOORD),g=a.getAttribute(B.TANGENT),h=a.getAttribute(B.BITANGENT),m=a.getIndices(),t=[],k=("undefined"===typeof b||null===b?new l:b).mode(a.primitiveType()),r=0;r<m.length;r++){var n=m[r];l._getValue(d,n,t)&&k.normal3(t);l._getValue(e,n,t)&&k.color3(t);l._getValue(f,n,t)&&k.texCoord2(t);l._getValue(g,n,t)&&k.tangent3(t);l._getValue(h,n,t)&&k.bitangent3(t);l._getValue(c,n,t)&&k.vertex3(t)}k.newPrimitive();return k};l.prototype.transform=function(a){return this._carryOver(l._fromMeshBuffer(this.toMeshBuffer().transform(a),
null))};l.prototype.getBoundingBox=function(){return this.toMeshBuffer().getBounds()};l.prototype.reverseNormals=function(){return 0>l._normalOffset(this.attributeBits)?this:this._carryOver(l._fromMeshBuffer(this.toMeshBuffer().reverseNormals(),null))};l.prototype.reverseWinding=function(){if(0!==(this.attributeBits&l.PRIMITIVES_BITS))return this;for(var a=0;a<this.indices.length;a+=3){var b=this.indices[a+2];this.indices[a+2]=this.indices[a+1];this.indices[a+1]=b}return this};l.prototype.recalcNormals=
function(a,b){return this.primitiveType()===l.TRIANGLES?this._carryOver(l._fromMeshBuffer(this.toMeshBuffer().recalcNormals(a,b),null)):this};l.prototype.merge=function(a){if(a instanceof H3DU.MeshBuffer)return this.merge(l._fromMeshBuffer(a,null));if(!(a instanceof H3DU.Mesh))throw Error();if(!l._isCompatibleMode(this.currentMode,a.currentMode))throw Error("Meshes have incompatible types");return this._carryOver(l._fromMeshBuffer(this.toMeshBuffer().merge(a.toMeshBuffer()),null))};l.prototype.setColor3=
function(a,b,c){return 0>l._colorOffset(this.attributeBits)?this:"string"===typeof a?this._carryOver(l._fromMeshBuffer(this.toMeshBuffer().setColor(a),null)):this._carryOver(l._fromMeshBuffer(this.toMeshBuffer().setColor([a,b,c]),null))};l.prototype.normalizeNormals=function(){return 0>l._normalOffset(this.attributeBits)?this:this._carryOver(l._fromMeshBuffer(this.toMeshBuffer().normalizeNormals(),null))};l.prototype.tangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?
(this.tangent[0]=a,this.tangent[1]=b,this.tangent[2]=c):(this.tangent[0]=a[0],this.tangent[1]=a[1],this.tangent[2]=a[2]);this._elementsDefined|=l.TANGENTS_BIT;return this};l.prototype.bitangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.bitangent[0]=a,this.bitangent[1]=b,this.bitangent[2]=c):(this.bitangent[0]=a[0],this.bitangent[1]=a[1],this.bitangent[2]=a[2]);this._elementsDefined|=l.BITANGENTS_BIT;return this};l.prototype.recalcTangents=function(){return this.primitiveType()!==
l.TRIANGLES?this:this._carryOver(l._fromMeshBuffer(this.toMeshBuffer()._recalcTangents(),null))};var z=function(){this.attributes=[];this.vertexCount=0;this.indices=[];this.mode=l.TRIANGLES},Q=function(){this.attributes=[];this.vertexCount=0;this.indices=[];this.mode=l.TRIANGLES};z._toMeshBuffer=function(a,b,c){for(var d=0,e=b.length-1;0<=e&&!(d=Math.max(d,b[e]),65536<=d);e--);var f=new v,e=65536>d?new Uint16Array(b):new Uint32Array(b);f.setPrimitiveType(c);f.setIndices(e);for(e=0;e<a.length;e++)c=
a[e],f.setAttributeEx(c[0],c[1],c[3],c[2]);return f};z._blank=function(a){for(var b=[],c=0;c<a;c++)b.push(0);return b};z._resize=function(a,b){if(a[2]!==b){for(var c=a[3].length/a[2],d=Math.min(a[2],b),e=z._blank(c*b),f=0,g=0,h=0;h<c;h++){for(var m=0;m<d;m++)e[g+m]=a[3][f+m];f+=a[2];g+=b}a[2]=b;a[3]=e}};z._addValue=function(a,b){for(var c=Math.min(b.length,a[2]),d=0;d<c;d++)a[3].push(b[d]);for(d=c;d<a[2];d++)a[3].push(0)};z._defaultEndPointsCurve=function(a){for(var b=0;b<a.length;b++){var c=a[b];
if(c[0]===B.POSITION&&0===c[1]){a=c[4];if("undefined"!==typeof a.endPoints&&null!==a.endPoints)return c[4].endPoints();break}}return[0,1]};z._defaultEndPointsSurface=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(c[0]===B.POSITION&&0===c[1]){a=c[4];if("undefined"!==typeof a&&null!==a&&"undefined"!==typeof a.endPoints&&null!==a.endPoints)return c[4].endPoints();break}}return[0,1,0,1]};z._setAttribute=function(a,b,c,d,e,f){var g="undefined"===typeof f||null===f?3:f,h="undefined"!==typeof c&&
null!==c;if(0>=f)throw Error("Invalid attribute size");d=v._resolveSemantic(d,"undefined"===typeof e||null===e?0:e);if("undefined"===typeof d||null===d)throw Error();for(e=0;e<a.length;e++)if(f=a[e],f[0]===d[0]&&f[1]===d[1]){h?(f[4]=c,z._resize(f,g)):a.splice(e,1);return}h&&(b=[d[0],d[1],g,z._blank(g*b),c],a.push(b))};z._NormalSurface=function(a){this.surface=new M(a);this.endPoints=function(){return this.surface.endPoints()};this.evaluate=function(a,c){return this.surface.normal(a,c)}};z.prototype.clearVertices=
function(){this.vertexCount=0;this.indices=[];for(var a=0;a<this.attributes.length;a++)this.attributes[a][3]=[];return this};z.prototype.toMeshBuffer=function(){return z._toMeshBuffer(this.attributes,this.indices,this.mode)};z.prototype.position=function(a,b){return this.attribute(a,B.POSITION,0,b)};z.prototype.attribute=function(a,b,c,d){z._setAttribute(this.attributes,this.vertexCount,a,b,c,d);return this};z.curveToBuffer=function(a,b,c,d,e){return(new z).position(a,3).evalCurve(b,c,d,e).toMeshBuffer()};
Q.prototype.clearVertices=function(){this.vertexCount=0;this.indices=[];for(var a=0;a<this.attributes.length;a++)this.attributes[a][3]=[];return this};Q.prototype.toMeshBuffer=function(){return z._toMeshBuffer(this.attributes,this.indices,this.mode)};Q.prototype.position=function(a,b){return this.attribute(a,B.POSITION,0,b)};Q.prototype.texCoord=function(a,b){return this.attribute(a,B.TEXCOORD,0,"undefined"===typeof b||null===b?2:b)};Q.prototype.positionNormal=function(a,b){var c="undefined"!==typeof a&&
null!==a?new z._NormalSurface(a):null;return this.attribute(a,B.POSITION,0,b).attribute(c,B.NORMAL,0,b)};Q._TexCoord=function(a){a=(new M(a)).endPoints();this.u1=a[0];this.v1=a[2];this.uinv=a[0]===a[1]?0:1/(a[1]-a[0]);this.vinv=a[2]===a[3]?0:1/(a[3]-a[2]);this.evaluate=function(a,c){return[(a-this.u1)*this.uinv,(c-this.v1)*this.vinv]}};Q.prototype.positionTexCoord=function(a,b){var c="undefined"!==typeof a&&null!==a?new Q._TexCoord(a):null;return this.attribute(a,B.POSITION,0,b).attribute(c,B.TEXCOORD,
0,2)};Q.prototype.positionNormalTexCoord=function(a,b){return this.positionNormal(a,b).positionTexCoord(a,b)};Q.prototype.attribute=function(a,b,c,d){z._setAttribute(this.attributes,this.vertexCount,a,b,c,d);return this};Q.surfaceToBuffer=function(a,b,c,d,e,f,g,h){return(new Q).positionNormalTexCoord(a,3).evalSurface(b,c,d,e,f,d,h).toMeshBuffer()};z.prototype.evalCurve=function(a,b,c,d){b="undefined"===typeof b||null===b?24:Math.ceil(b);if(0===b)return this;if(0>b)throw Error();if("undefined"===typeof a||
null===a)a=l.LINES;if("undefined"===typeof c||null===c||"undefined"===typeof d||null===d)d=z._defaultEndPointsCurve(this.attributes),c=d[0],d=d[1];var e=(d-c)/b,f=this.vertexCount;if(a===l.LINES||"undefined"===typeof a||null===a){for(d=0;d<b;d++)this.indices.push(f+d,f+d+1);this.vertexCount+=b+1}else if(a===l.POINTS){for(d=0;d<b;d++)this.indices.push(f+d);this.vertexCount+=b+1}else return this;this.mode=a;for(d=0;d<=b;d++)for(a=c+d*e,f=0;f<this.attributes.length;f++){var g=this.attributes[f],h="undefined"!==
typeof g[4]&&null!==g[4]?g[4].evaluate(a):[];z._addValue(g,h)}return this};Q.prototype.evalSurface=function(a,b,c,d,e,f,g){b="undefined"===typeof b||null===b?24:Math.ceil(b);c="undefined"===typeof c||null===c?24:Math.ceil(c);if(0===b||0===c)return this;if(0>=b)throw Error();if(0>=c)throw Error();if("undefined"===typeof a||null===a)a=l.TRIANGLES;if("undefined"===typeof d||null===d||"undefined"===typeof e||null===e||"undefined"===typeof f||null===f||"undefined"===typeof g||null===g)g=z._defaultEndPointsSurface(this.attributes),
d=g[0],e=g[1],f=g[2],g=g[3];if(a!==l.TRIANGLES&&a!==l.LINES&&a!==l.POINTS)return this;var h,m,k,p=(e-d)/b,r=(g-f)/c;g=this.vertexCount;this.vertexCount+=(c+1)*(b+1);for(e=0;e<=c;e++)for(k=0;k<=b;k++){h=k*p+d;m=e*r+f;for(var n=0;n<this.attributes.length;n++){var q=this.attributes[n],u="undefined"!==typeof q[4]&&null!==q[4]?q[4].evaluate(h,m):[];z._addValue(q,u)}}this.mode=a;if(a===l.TRIANGLES)for(a=b+1,e=0;e<b;e++)for(k=0;k<c;k++)d=k*a+e+g,f=d+a,p=d+1,h=f+1,this.indices.push(d,f,p),this.indices.push(p,
f,h);else if(a===l.POINTS)for(b=this.vertexCount,e=g;e<b;e++)this.indices.push(e);else if(a===l.LINES)for(a=b+1,e=0;e<=b;e++)for(k=0;k<=c;k++)f=k*a+e+g,k<c&&(p=f+a,this.indices.push(f,p)),e<b&&(p=f+1,this.indices.push(p,f));return this};var N=function(a){this.curves=[];this.curvesEp=[];this.runningCurveStart=[];for(var b=0;b<a.length;b++)this.curves[b]=a[b]instanceof w?a[b]:new w(a[b]),this.curvesEp[b]=this.curves[b].endPoints(),this.runningCurveStart[b]=0===b?0:Number.NaN};N.prototype=Object.create(w.prototype);
N.prototype.constructor=N;N.prototype.endPoints=function(){return[0,this.curves.length]};N.prototype.getCurves=function(){return this.curves};N.prototype._getRunningCurveStart=function(a){if(0===a)return 0;if(isNaN(this.runningCurveStart[a]))for(var b=1;b<=a;b++)isNaN(this.runningCurveStart[b])&&(this.runningCurveStart[b]=this.runningCurveStart[b-1]+this.curves[b-1].arcLength(this.curvesEp[b-1][1]));return this.runningCurveStart[a]};N.prototype._getCurveAndPoint=function(a){var b;0>a?a=b=0:a>=this.curves.length?
(b=this.curves.length-1,a=1):(b=Math.floor(a),a-=b);var c=this.curvesEp[b];return[b,c[0]+(c[1]-c[0])*a]};N.prototype.arcLength=function(a){if(0>=a)return 0;a=this._getCurveAndPoint(a);return this._getRunningCurveStart(a[0])+this.curves[a[0]].arcLength(a[1])};N.prototype.evaluate=function(a){a=this._getCurveAndPoint(a);return this.curves[a[0]].evaluate(a[1])};N.prototype.velocity=function(a){a=this._getCurveAndPoint(a);return this.curves[a[0]].velocity(a[1])};p.prototype=Object.create(w.prototype);
p.prototype.constructor=p;p.WEIGHTED_BIT=1;p.DIVIDE_BIT=2;p.HOMOGENEOUS_BIT=4;p.WEIGHTED_DIVIDE_BITS=3;p._checkKnots=function(a,b){for(var c=1;c<a.length;c++)if(a[c]<a[c-1])throw Error();for(c=1;c<a.length-2-b;c++)if(a[c+b]<=a[c])throw Error();if(a[0]===a[a.length-1]||a[0]>=a[b+1])throw Error();if(a[a.length-2-b]>=a[a.length-1])throw Error();if(b+1>=a.length)throw Error();};p._nfunc=function(a,b,c,d){if(0===b)return d[a]<=c&&c<d[a+1]?1:0;if(d[a]>c||d[a]===d[a+b]&&d[a+b+1]===d[a+1]||d[a+b+1]<c)return 0;
var e=d[a]===d[a+b]?0:p._nfunc(a,b-1,c,d),f=d[a+b+1]===d[a+1]?0:p._nfunc(a+1,b-1,c,d);if(0===e+f)return 0;var g=0;if(0!==e)var h=d[a+b]-d[a],g=g+(c-d[a])*e*(0===h?1:1/h);0!==f&&(h=d[a+b+1]-d[a+1],g+=(d[a+b+1]-c)*f*(0===h?1:1/h));return g};p._getFactors=function(a,b,c,d,e){for(var f=1,g=1,h=0;h<d;h++)e[h]=0;for(h=1;h<a.length;h++)if(a[h]===a[0])f+=1;else break;for(h=a.length-2;0<=h;h--)if(a[h]===a[a.length-1])g+=1;else break;if(b>=a[a.length-1-c]&&a[a.length-1-c]===a[a.length-1])e[d-1]=1;else if(f!==
c+1||g!==c+1)for(h=0;h<d;h++)e[h]=p._nfunc(h,c,b,a);else if(b<=a[c])e[0]=1;else if(b>=a[a.length-1-c])e[d-1]=1;else{d=-1;for(h=0;h<=a.length;h++)if(a[h]<=b&&b<a[h+1]){d=h;break}if(!(0>d))for(var f=a[d+1]-b,g=a[d],m=b-g,k=e[d]=1;k<=c;k++){e[d-k]=e[d-k+1]*f/(a[d+1]-a[d-k+1]);for(h=d-k+1;h<d;h++){var l=a[h];e[h]*=(b-l)/(a[h+k]-l);e[h]+=e[h+1]*(a[h+k+1]-b)/(a[h+k+1]-a[h+1])}e[d]*=m/(a[d+k]-g)}}};p.prototype.evaluate=function(a){var b=[];if(this.fastBezier){var c=this.controlPoints;switch(c.length){case 1:b=
c[0].slice(0,c[0].length);break;case 2:for(var d=c[0].length,b=[],e=c[0],c=c[1],f=0;f<d;f++){var g=e[f];b[f]=g+(c[f]-g)*a}break;case 3:d=c[0].length;b=[];e=c[0];f=c[1];c=c[2];for(g=0;g<d;g++)b[g]=((a-2)*a+1)*e[g]+(-2*a+2)*a*f[g]+a*a*c[g];break;case 4:for(var d=c[0].length,b=[],e=c[0],f=c[1],g=c[2],c=c[3],h=0;h<d;h++)b[h]=(((3-a)*a-3)*a+1)*e[h]+((3*a-6)*a+3)*a*f[h]+(-3*a+3)*a*a*g[h]+a*a*a*c[h]}}else if(e=this.controlPoints.length,c=this.knots.length-e-1,d=this.controlPoints[0].length,b=null,a<=this.knots[c]?
this.knots[c]===this.knots[0]?b=this.controlPoints[0].slice(0,d):a=this.knots[c]:a>=this.knots[this.knots.length-1-c]&&(this.knots[this.knots.length-1-c]===this.knots[this.knots.length-1]?b=this.controlPoints[e-1].slice(0,d):a=this.knots[this.knots.length-1-c]),"undefined"===typeof b||null===b){h=0;b=-1;for(e=0;e<this.knots.length;e++)if(f=this.knots[e],(g=a===f)&&h++,f<this.knots[e+1])if(g){b=e;break}else if(f<a&&a<this.knots[e+1]){b=e;break}if(0>b)throw Error();if(h>c)throw Error();if(h===c)b=this.controlPoints[b-
c].slice(0,d);else{f=c-h;g=[];for(e=b-c;e<=b-h;e++)g.push(this.controlPoints[e]);for(h=1;h<=f;h++)for(var m=g[h-1],e=h;e<g.length;e++){for(var k=b-c+e,l=this.knots[k],k=(a-l)/(this.knots[k+c-h+1]-l),l=g[e],r=[],n=0;n<d;n++)r[n]=m[n]*(1-k)+l[n]*k;g[e]=r;m=l}b=g[g.length-1].slice(0,d)}}0!==(this.bits&p.DIVIDE_BIT)&&(b=p._fromHomogen(b));return b};p._splitKnots=function(a,b,c){for(var d=-1,e=-1,f=[],g=[],h=0;h<a.length;h++)if(a[h]>c){e=h;break}else a[h]<c&&(d=h);if(0>d||0>e)throw Error();for(h=0;h<=
d;h++)f.push(a[h]);for(h=0;h<b+1;h++)f.push(c),g.push(c);for(h=e;h<a.length;h++)g.push(a[h]);return[f,g]};p.prototype.split=function(a){var b=this.controlPoints.length,c=this.knots.length-b-1,d=this.controlPoints[0].length,e;if(a<=this.knots[c])return[null,this];if(a>=this.knots[this.knots.length-1-c])return[this,null];var f=0,g=-1;for(e=0;e<this.knots.length;e++){var h=this.knots[e],m=a===h;m&&f++;if(h<this.knots[e+1])if(m){g=e;break}else if(h<a&&a<this.knots[e+1]){g=e;break}}if(0>g)throw Error();
if(f>c)throw Error();var h=p._splitKnots(this.knots,c,a),k,m=[];if(f===c)k=this.controlPoints.slice(0,g-c+1),m=this.controlPoints.slice(g-c,this.controlPoints.length);else{var l=c-f,r=[];for(e=g-c;e<=g-f;e++)r.push(this.controlPoints[e]);k=[];for(e=0;e<=g-c;e++)k.push(this.controlPoints[e]);for(var n=[],q=1;q<=l;q++){var u=r[q-1];for(e=q;e<r.length;e++){for(var C=g-c+e,v=this.knots[C],C=(a-v)/(this.knots[C+c-q+1]-v),v=r[e],w=[],T=0;T<d;T++)w[T]=u[T]*(1-C)+v[T]*C;r[e]=w;u=v;e===q?k.push(w):e+1===r.length&&
n.push(w)}}m.push(k[k.length-1]);for(e=n.length-1;0<=e;e--)m.push(n[e]);for(e=g-f;e<b;e++)m.push(this.controlPoints[e])}a=new p(k,h[0],this.bits);b=new p(m,h[1],this.bits);return[a,b]};p.prototype.endPoints=function(){var a=this.knots.length-this.controlPoints.length-1;return[this.knots[a],this.knots[this.knots.length-1-a]]};p.prototype.getControlPoints=function(){return this.controlPoints};p.prototype.getKnots=function(){return this.knots};p.prototype.velocity=function(a){var b=[];if(this.fastBezier){var c=
this.controlPoints;switch(c.length){case 1:b=F.vecZeros(c[0].length);break;case 2:b=F.vecSub(c[1],c[0]);break;case 3:for(var b=c[0].length,d=[],e=c[0],f=c[1],c=c[2],g=0;g<b;g++)d[g]=(2*a-2)*e[g]+(-4*a+2)*f[g]+2*a*c[g];b=d;break;case 4:for(var b=c[0].length,d=[],e=c[0],f=c[1],g=c[2],c=c[3],h=0;h<b;h++)d[h]=((-3*a+6)*a-3)*e[h]+((9*a-12)*a+3)*f[h]+(-9*a+6)*a*g[h]+3*a*a*c[h];b=d}}else{c=this.controlPoints.length;e=this.knots.length-c-1;d=this.controlPoints[0].length;p._getFactors(this.knots,a,e-1,c,this.buffer);
f=[];for(g=0;g<c;g++)f[g]=0;for(a=0;a<c-1;a++)g=e*this.buffer[a+1]/(this.knots[a+e+1]-this.knots[a+1]),f[a+1]+=g,f[a]-=g;for(g=0;g<d;g++){for(a=e=0;a<c;a++)e+=f[a]*this.controlPoints[a][g];b[g]=e}}0!==(this.bits&p.DIVIDE_BIT)&&(b=p._fromHomogen(b));return b};p._convertToHomogen=function(a){for(var b=[],c=a[0].length,d=0;d<a.length;d++){for(var e=[],f=a[d][c-1],g=0;g<c-1;g++)e[g]=a[d][g]*f;e[c-1]=f;b.push(e)}return b};p._fromHomogen=function(a){for(var b=a.length,c=1/a[b-1],d=0;d<b-1;d++)a[d]*=c;return a=
a.slice(0,b-1)};H.prototype=Object.create(M.prototype);H.prototype.constructor=H;p.clamped=function(a,b,c){return new p(a,p.clampedKnots(a.length,b),c)};p.fromBezierCurve=function(a,b){return p.clamped(a,a.length-1,b)};p.uniform=function(a,b,c){return new p(a,p.uniformKnots(a.length,b),c)};H.clamped=function(a,b,c,d){return new H(a,p.clampedKnots(a[0].length,b),p.clampedKnots(a.length,c),d)};H.uniform=function(a,b,c,d){return new H(a,p.uniformKnots(a[0].length,b),p.uniformKnots(a.length,c),d)};p.uniformKnots=
function(a,b){"object"===typeof a&&(a=a.length);var c="undefined"===typeof b||null===b?3:b;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var c=c+1,d=[],e=1/(a+c-1),f=0;f<a+c;f++)d.push(f*e);return d};p.clampedKnots=function(a,b){"object"===typeof a&&(a=a.length);var c="undefined"===typeof b||null===b?3:b;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var c=c+1,d=a-c,e=[],f=0;f<c;f++)e.push(0);for(f=0;f<d;f++)e.push(1*(f+1)/(d+1));for(f=0;f<c;f++)e.push(1);
return e};H.prototype.evaluate=function(a,b){var c=this.controlPoints[0][0].length,d=this.bufferU,e=this.bufferV,f,g,h,k;p._getFactors(this.knotsU,a,this.degreeU,this.ucplen,this.bufferU);p._getFactors(this.knotsV,b,this.degreeV,this.vcplen,this.bufferV);var l=[];for(h=0;h<c;h++){for(f=k=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)k+=this.controlPoints[g][f][h]*d[f]*e[g];l[h]=k}0!==(this.bits&p.DIVIDE_BIT)&&(l=p._fromHomogen(l));return l};H.prototype.getControlPoints=function(){return this.controlPoints};
H.prototype.getKnots=function(){return this.knots};H.prototype.tangent=function(a,b){var c=this.controlPoints[0][0].length,d=this.bufferV,e,f,g,h;p._getFactors(this.knotsU,a,this.degreeU-1,this.ucplen,this.bufferU);p._getFactors(this.knotsV,b,this.degreeV,this.vcplen,this.bufferV);var k=[],l=[];for(g=0;g<this.ucplen;g++)l[g]=0;for(e=0;e<this.ucplen-1;e++)f=this.degreeU*this.bufferU[e+1]/(this.knotsU[e+this.degreeU+1]-this.knotsU[e+1]),l[e+1]+=f,l[e]-=f;for(g=0;g<c;g++){for(e=h=0;e<this.ucplen;e++)for(f=
0;f<this.vcplen;f++)h+=this.controlPoints[f][e][g]*l[e]*d[f];k[g]=h}0!==(this.bits&p.DIVIDE_BIT)&&(k=p._fromHomogen(k));return k};H.prototype.bitangent=function(a,b){var c=this.controlPoints[0][0].length,d=this.bufferU,e,f,g,h;p._getFactors(this.knotsU,a,this.degreeU,this.ucplen,this.bufferU);p._getFactors(this.knotsV,b,this.degreeV-1,this.vcplen,this.bufferV);var k=[],l=[];for(g=0;g<this.vcplen;g++)l[g]=0;for(e=0;e<this.vcplen-1;e++)f=this.degreeV*this.bufferV[e+1]/(this.knotsV[e+this.degreeV+1]-
this.knotsV[e+1]),l[e+1]+=f,l[e]-=f;for(g=0;g<c;g++){for(e=h=0;e<this.ucplen;e++)for(f=0;f<this.vcplen;f++)h+=this.controlPoints[f][e][g]*d[e]*l[f];k[g]=h}0!==(this.bits&p.DIVIDE_BIT)&&(k=p._fromHomogen(k));return k};H._convertToHomogen=function(a){for(var b=[],c=0;c<a.length;c++)b.push(p._convertToHomogen(a[c]));return b};H.fromBezierSurface=function(a,b){return H.clamped(a,a[0].length-1,a.length-1,b)};U.prototype=Object.create(w.prototype);U.prototype.constructor=U;U.prototype.endPoints=function(){return this.curve.endPoints()};
U.prototype.evaluate=function(a){return this.curve.evaluate(a)};V.prototype=Object.create(M.prototype);V.prototype.constructor=V;V.prototype.evaluate=function(a,b){return this.surface.evaluate(a,b)};V.prototype.endPoints=function(){return this.surface.endPoints()};var A=function(a){if("undefined"===typeof a||null===a)throw Error("mesh is null");a instanceof H3DU.Mesh?this.meshBuffer=a.toMeshBuffer():a instanceof H3DU.BufferedMesh?(H3DU.Shape._meshBufferWarning||(console.warn("Using an H3DU.BufferedMesh in H3DU.Shape objects is deprecated."),
H3DU.Shape._meshBufferWarning=!0),this.meshBuffer=a._toMeshBuffer()):this.meshBuffer=a;if(!(this.meshBuffer instanceof H3DU.MeshBuffer))throw Error("Unsupported data type for mesh parameter (must be Mesh or MeshBuffer)");this.transform=new H3DU.Transform;this.material=new H3DU.PbrMaterial;this.parent=null;this.visible=!0};A.prototype.getMeshBuffer=function(){return this.meshBuffer};A._meshBufferWarning=!1;A.prototype.vertexCount=function(){return this.meshBuffer?this.meshBuffer.vertexCount():0};A.prototype.primitiveCount=
function(){return this.meshBuffer?this.meshBuffer.primitiveCount():0};A.prototype.setVisible=function(a){this.visible=!!a;return this};A.prototype.getVisible=function(){return this.visible};A.prototype.setColor=function(a,b,c,d){a=H3DU.toGLColor(a,b,c,d);this._ensureMaterial().setParams({ambient:a,diffuse:a});return this};A.prototype.setTexture=function(a){this._ensureMaterial().setParams({texture:a});return this};A.prototype.setShader=function(a){this._ensureMaterial().setParams({shader:a});return this};
A.prototype._ensureMaterial=function(){if("undefined"===typeof this.material||null===this.material)this.material=new H3DU.PbrMaterial;return this.material};A.prototype.setTextureAndColor=function(a,b,c,d,e){b=H3DU.toGLColor(b,c,d,e);this._ensureMaterial().setParams({texture:a,ambient:b,diffuse:b});return this};A.prototype.setMaterial=function(a){if("undefined"===typeof a||null===a)throw Error();if(a instanceof H3DU.Texture)throw Error("Material parameter can't directly be a Texture");this.material=
a;return this};A.prototype.copy=function(){var a=new H3DU.Shape(this.meshBuffer);a.visible=this.visible;a.parent=null;a.material=this.material.copy();a.transform=this.getTransform().copy();return a};A.prototype.getTransform=function(){return this.transform};A.prototype.getMaterial=function(){return this.material};A.prototype.getBounds=function(){if(!this.meshBuffer){var a=Number.POSITIVE_INFINITY;return[a,a,a,-a,-a,-a]}var b=this.meshBuffer.getBounds();if(H3DU.Math.boxIsEmpty(b))return b;var c=this.getMatrix();
if(H3DU.Math.mat4isIdentity(c))return b.slice(0,6);if(0===c[1]&&0===c[2]&&0===c[3]&&0===c[4]&&0===c[6]&&0===c[7]&&0===c[8]&&0===c[9]&&0===c[11]&&1===c[15]){var a=[],d=c[0],e=c[12];a[0]=d*b[0]+e;var f=c[5],g=c[13];a[1]=f*b[1]+g;var h=c[10],c=c[14];a[2]=h*b[2]+c;b=[d*b[3]+e,f*b[4]+g,h*b[5]+c];return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2]),Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2])]}a=[H3DU.Math.mat4projectVec3(c,b[0],b[1],b[2]),H3DU.Math.mat4projectVec3(c,b[0],b[1],
b[5]),H3DU.Math.mat4projectVec3(c,b[0],b[4],b[2]),H3DU.Math.mat4projectVec3(c,b[0],b[4],b[5]),H3DU.Math.mat4projectVec3(c,b[3],b[1],b[2]),H3DU.Math.mat4projectVec3(c,b[3],b[1],b[5]),H3DU.Math.mat4projectVec3(c,b[3],b[4],b[2]),H3DU.Math.mat4projectVec3(c,b[3],b[4],b[5])];b=a[0];d=[b[0],b[1],b[2],b[0],b[1],b[2]];for(e=1;8>e;e++)b=a[e],d[0]=Math.min(d[0],b[0]),d[1]=Math.min(d[1],b[1]),d[2]=Math.min(d[2],b[2]),d[3]=Math.max(d[3],b[0]),d[4]=Math.max(d[4],b[1]),d[5]=Math.max(d[5],b[2]);return d};A.prototype.isCulled=
function(a){return this.meshBuffer&&this.visible?!H3DU.Math.frustumHasBox(a,this.getBounds()):!0};A.prototype.setTransform=function(a){this.transform=a.copy();return this};A.prototype.setScale=function(a,b,c){this.getTransform().setScale(a,b,c);return this};A.prototype.setPosition=function(a,b,c){this.getTransform().setPosition(a,b,c);return this};A.prototype.setQuaternion=function(a){this.getTransform().setQuaternion(a);return this};A.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();
if("undefined"===typeof this.parent||null===this.parent)a=a.getMatrix();else var c=this.parent.getMatrix(),a=b?c:H3DU.Math.mat4isIdentity(c)?a.getMatrix():H3DU.Math.mat4multiply(c,a.getMatrix());return a};var J=function(){this._init()};J.prototype._init=function(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new H3DU.Transform};J.prototype.shapeCount=function(){return this.shapes.length};J.prototype.getShape=function(a){return"undefined"===typeof this.shapes[a]?null:this.shapes[a]};
J.prototype.setShape=function(a,b){this.shapes[a]=b;return this};J.prototype.copy=function(){var a=new H3DU.ShapeGroup;a.visible=this.visible;a.transform=this.transform.copy();for(var b=0;b<this.shapes.length;b++)a.addShape(this.shapes[b].copy());return a};J.prototype.addShape=function(a){if(!a)throw Error();a.parent=this;this.shapes.push(a);return this};J.prototype.setVisible=function(a){this.visible=!!a;return this};J.prototype.getVisible=function(){return this.visible};J.prototype.getTransform=
function(){return this.transform};J.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if("undefined"!==typeof this.parent&&null!==this.parent)var c=this.parent.getMatrix(),a=b?H3DU.Math.mat4multiply(c,a.getMatrix()):H3DU.Math.mat4isIdentity(c)?a.getMatrix():c;else a=a.getMatrix();return a};J.prototype.setTransform=function(a){this.transform=a.copy();return this};J.prototype.setMaterial=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterial(a);return this};
J.prototype.setTexture=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setTexture(a);return this};J.prototype.setShader=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setShader(a);return this};J.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};J.prototype.getBounds=function(){for(var a=Number.POSITIVE_INFINITY,a=[a,a,a,-a,-a,-a],b=!0,c=0;c<this.shapes.length;c++){var d=this.shapes[c].getBounds();
H3DU.Math.boxIsEmpty(d)||(b?(a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=d[3],a[4]=d[4],a[5]=d[5],b=!1):(a[0]=Math.min(d[0],a[0]),a[1]=Math.min(d[1],a[1]),a[2]=Math.min(d[2],a[2]),a[3]=Math.max(d[3],a[3]),a[4]=Math.max(d[4],a[4]),a[5]=Math.max(d[5],a[5])))}return a};J.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};J.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};J.prototype.setPosition=
function(a,b,c){this.transform.setPosition(a,b,c);return this};J.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};J.prototype.setScale=function(a,b,c){this.transform.setScale(a,b,c);return this};var I=function(){this.scale=[1,1,1];this.position=[0,0,0];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=H3DU.Math.mat4identity()};I.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],
this.matrix[10]]:this.scale.slice(0,3)};I.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};I.prototype.getQuaternion=function(){return this.complexMatrix?H3DU.Math.quatNormalizeInPlace(H3DU.Math.quatFromMat4(this.matrix)):this.rotation.slice(0,4)};I.prototype.reset=function(){this.matrix=H3DU.Math.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=
!1;this._isIdentity=!0;return this};I.prototype.setMatrix=function(a){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=H3DU.Math.quatFromMat4(this.matrix);this.rotation=H3DU.Math.quatNormalizeInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===
a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15];return this};I.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&H3DU.Math.quatIsIdentity(this.rotation);return this._isIdentity};I.prototype.resetTransform=function(){return this.reset()};I.prototype.setScale=function(a,b,c){if(this.complexMatrix)return this;this.scale="undefined"===
typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};I.prototype.setPosition=function(a,b,c){if(this.complexMatrix)return this;this.position="undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,
a,a];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};I.prototype.movePosition=function(a,b,c){if(this.complexMatrix)return this;"undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?(this.position[0]+=a,this.position[1]+=b,this.position[2]+=c):"number"!==typeof a?(this.position[0]+=a[0],this.position[1]+=a[1],this.position[2]+=a[2]):(this.position[0]+=a,this.position[1]+=
a,this.position[2]+=a);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};I.prototype.setQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=a.slice(0,4);H3DU.Math.quatNormalizeInPlace(this.rotation);this._matrixDirty=!0;return this};I.prototype.setRotation=function(a,b,c,d){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};I.prototype.setOrientation=function(a,b,c,d){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,
b,c,d))};I.prototype.multQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=H3DU.Math.quatNormalizeInPlace(H3DU.Math.quatMultiply(this.rotation,a));this._matrixDirty=!0;return this};I.prototype.multRotation=function(a,b,c,d){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};I.prototype.multOrientation=function(a,b,c,d){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};I.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,
H3DU.Math.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=H3DU.Math.mat4multiply(this.matrix,H3DU.Math.quatToMat4(this.rotation));H3DU.Math.mat4scaleInPlace(this.matrix,
this.scale);var a=this.matrix;this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]}else if(this._isIdentity)return H3DU.Math.mat4identity();return this.matrix.slice(0,16)};I.prototype.copy=function(){var a=new H3DU.Transform;a.scale=this.scale.slice(0,this.scale.length);a.position=this.position.slice(0,this.scale.length);a.complexMatrix=this.complexMatrix;a._matrixDirty=
this._matrixDirty;a.matrix=this.matrix.slice(0,this.matrix.length);return a};y.Math=k;y.Curve=w;y.Surface=M;y.CurveBuilder=z;y.SurfaceBuilder=Q;y.PiecewiseCurve=N;y.BezierCurve=U;y.BezierSurface=V;y.BSplineCurve=p;y.BSplineSurface=H;y.Shape=A;y.ShapeGroup=J;y.Transform=I;y.Mesh=l;y.Meshes={createBox:function(a,b,c,d){a*=.5;b*=.5;c*=.5;a=[-a,-b,c,-1,0,0,1,0,-a,b,c,-1,0,0,1,1,-a,b,-c,-1,0,0,0,1,-a,-b,-c,-1,0,0,0,0,a,-b,-c,1,0,0,1,0,a,b,-c,1,0,0,1,1,a,b,c,1,0,0,0,1,a,-b,c,1,0,0,0,0,a,-b,-c,0,-1,0,1,
0,a,-b,c,0,-1,0,1,1,-a,-b,c,0,-1,0,0,1,-a,-b,-c,0,-1,0,0,0,a,b,c,0,1,0,1,0,a,b,-c,0,1,0,1,1,-a,b,-c,0,1,0,0,1,-a,b,c,0,1,0,0,0,-a,-b,-c,0,0,-1,1,0,-a,b,-c,0,0,-1,1,1,a,b,-c,0,0,-1,0,1,a,-b,-c,0,0,-1,0,0,a,-b,c,0,0,1,1,0,a,b,c,0,0,1,1,1,-a,b,c,0,0,1,0,1,-a,-b,c,0,0,1,0,0];if(d)for(d=0;d<a.length;d+=8)a[d+3]=-a[d+3],a[d+4]=-a[d+4],a[d+5]=-a[d+5];d=new Float32Array(a);return(new H3DU.MeshBuffer).setIndices([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]).setAttribute(H3DU.Semantic.POSITION,
d,3,0,8).setAttribute(H3DU.Semantic.NORMAL,d,3,3,8).setAttribute(H3DU.Semantic.TEXCOORD,d,2,6,8)},createCylinder:function(a,b,c,d,e,f,g){var h=new H3DU.Mesh;if("undefined"===typeof d||null===d)d=32;if("undefined"===typeof e||null===e)e=1;if(2>=d)throw Error("too few slices");if(1>e)throw Error("too few stacks");if(0>c)throw Error("negative height");if(0>=a&&0>=b||0===c)return h;for(var k=g?-1:1,l=[],p=[],r=H3DU.Math.PiTimes2/d,n=Math.cos(r),q=3.141592653589793>=r?Math.sqrt(1-n*n):-Math.sqrt(1-n*n),
u=1,C=0,r=0;r<d;r++){var v=1*r/d;l.push(u,C);p.push(v);v=n*u+q*C;C=n*C-q*u;u=v}l.push(l[0],l[1]);p.push(1);d*=2;if(0<c)for(n=0,q=a,a===b?(C=0,u=k):(r=a-b,u=c,C=Math.sqrt(u*u+r*r),0!==C&&(C=1/C,r*=C,u*=C),u*=k,C=r*k),k=1/e,r=0;r<e;r++){var v=n,w=r+1===e?1:(r+1)*k,T=c*v,x=c*w,D=q,z=a+(b-a)*w,n=w,q=z;h.mode(H3DU.Mesh.TRIANGLE_STRIP);h.texCoord2(1,v);h.normal3(l[0]*u,l[1]*u,C);h.vertex3(l[0]*D,l[1]*D,T);h.texCoord2(1,w);h.normal3(l[0]*u,l[1]*u,C);h.vertex3(l[0]*z,l[1]*z,x);for(var E=2,y=1;E<=d;E+=2,y++){var B=
p[y],A,G;A=l[E];G=l[E+1];h.texCoord2(1-B,v);h.normal3(A*u,G*u,C);h.vertex3(A*D,G*D,T);h.texCoord2(1-B,w);h.normal3(A*u,G*u,C);h.vertex3(A*z,G*z,x)}}h=h.toMeshBuffer();return f?h.recalcNormals(f,g):h},createLathe:function(a,b,c,d){var e=new H3DU.Mesh;if(4>a.length)throw Error("too few points");if("undefined"===typeof b||null===b)b=32;if(2>=b)throw Error("too few slices");if(0!==a.length%1)throw Error("points array length is not an even number");var f;for(f=0;f<a.length;f+=2)if(0>a[f<<1])throw Error("point's x is less than 0");
var g=[],h=[];f=H3DU.Math.PiTimes2/b;var k=Math.cos(f),l=3.141592653589793>=f?Math.sqrt(1-k*k):-Math.sqrt(1-k*k),p=1,r=0;for(f=0;f<b;f++){var n=1*f/b;g.push(p,r);h.push(n);n=k*p+l*r;r=k*r-l*p;p=n}g.push(g[0],g[1]);h.push(1);b*=2;var q=0,k=a.length/2-1,l=1/k;for(f=0;f<k;f++){var p=q,r=f+1===k?1:(f+1)*l,q=f<<1,u=a[q+1],C=a[q+3],n=Math.min(u,C),u=Math.max(u,C),C=a[q],v=a[q+2],q=r;e.mode(H3DU.Mesh.TRIANGLE_STRIP);e.texCoord2(1,p);e.vertex3(g[0]*C,g[1]*C,n);e.texCoord2(1,r);e.vertex3(g[0]*C,g[1]*v,u);
for(var w=2,z=1;w<=b;w+=2,z++){var x=h[z],D,y;D=g[w];y=g[w+1];e.texCoord2(1-x,p);e.vertex3(D*C,y*C,n);e.texCoord2(1-x,r);e.vertex3(D*v,y*v,u)}}e=e.toMeshBuffer();return e.recalcNormals(c,d)},createClosedCylinder:function(a,b,c,d,e,f,g){e=H3DU.Meshes.createCylinder(a,b,c,d,e,f,g);a=H3DU.Meshes.createDisk(0,a,d,2,!g).reverseWinding();b=H3DU.Meshes.createDisk(0,b,d,2,g);b.transform(H3DU.Math.mat4translated(0,0,c));return e.merge(a).merge(b)},createDisk:function(a,b,c,d,e){return H3DU.Meshes.createPartialDisk(a,
b,c,d,0,360,e)},createPartialDisk:function(a,b,c,d,e,f,g){var h=new H3DU.Mesh;if("undefined"===typeof c||null===c)c=32;if("undefined"===typeof d||null===d)d=1;if("undefined"===typeof e||null===e)e=0;if("undefined"===typeof f||null===f)f=360;if(2>=c)throw Error("too few slices");if(1>d)throw Error("too few loops");if(a>b)throw Error("inner greater than outer");0>a&&(a=0);0>b&&(b=0);if(0===b||0===f)return h;var k=360===f&&0===e,l=0>f?-1:1;0>f&&(f=-f);f%=360;0===f&&(f=360);var p=[],r=[],n=H3DU.Math.PiTimes2;
f=360===f?n:f*H3DU.Math.PiDividedBy180;e*=H3DU.Math.PiDividedBy180;0>l&&(f=-f);var q=f/c,l=Math.cos(q),q=0<=q&&6.283185307179586>q?3.141592653589793>=q?Math.sqrt(1-l*l):-Math.sqrt(1-l*l):Math.sin(q),u=Math.cos(e),v=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-u*u):-Math.sqrt(1-u*u):Math.sin(e),w=u,z=v;for(e=0;e<=c;e++){e===c&&f===n?p.push(z,w):p.push(v,u);r.push(1*e/c);var y=l*v+q*u,u=l*u-q*v,v=y}k&&(p[0]=0,p[1]=1,p[p.length-1]=1,p[p.length-2]=0,r[0]=0,r[r.length-1]=1);c*=2;k=b-a;r=
a;g?h.normal3(0,0,-1):h.normal3(0,0,1);for(e=0;e<d;e++)if(g=r,n=a+(e+1)/d*k,f=g/b,l=n/b,r=n,q=0===e&&0===a,h.mode(q?H3DU.Mesh.TRIANGLE_FAN:H3DU.Mesh.TRIANGLE_STRIP),q)for(u=c/2,q=c,w=u;0<=q;q-=2,w--)u=p[q],v=p[q+1],q===c&&(h.texCoord2(.5*(1+u*f),.5*(1+v*f)),h.vertex3(u*g,v*g,0)),h.texCoord2(.5*(1+u*l),.5*(1+v*l)),h.vertex3(u*n,v*n,0);else for(w=q=0;q<=c;q+=2,w++)u=p[q],v=p[q+1],h.texCoord2(.5*(1+u*l),.5*(1+v*l)),h.vertex3(u*n,v*n,0),h.texCoord2(.5*(1+u*f),.5*(1+v*f)),h.vertex3(u*g,v*g,0);return h=
h.toMeshBuffer()},createTorus:function(a,b,c,d,e,f){var g=new H3DU.Mesh;if("undefined"===typeof d||null===d)d=16;if("undefined"===typeof c||null===c)c=16;if(3>d)throw Error("crosswise is less than 3");if(3>c)throw Error("lengthwise is less than 3");if(0>a||0>b)throw Error("inner or outer is less than 0");if(0===b||0===a)return g;var h=[],k=[],l,p,r,n=H3DU.Math.PiTimes2/d;r=Math.cos(n);var q=0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-r*r):-Math.sqrt(1-r*r):Math.sin(n);p=0;l=1;for(n=
0;n<d;n++){h.push(p,l);var u=r*p+q*l;l=r*l-q*p;p=u}h.push(h[0]);h.push(h[1]);n=H3DU.Math.PiTimes2/c;r=Math.cos(n);q=0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-r*r):-Math.sqrt(1-r*r):Math.sin(n);p=0;l=1;for(n=0;n<c;n++)k.push(p,l),u=r*p+q*l,l=r*l-q*p,p=u;k.push(k[0]);k.push(k[1]);for(q=0;q<c;q++){u=q/c;l=(q+1)/c;p=k[2*q];var v=k[2*q+1],w=k[2*q+2],z=k[2*q+3];g.mode(H3DU.Mesh.TRIANGLE_STRIP);for(n=0;n<=d;n++){r=n/d;var y=h[2*n],x=h[2*n+1],D=x*(b+z*a),B=y*(b+z*a),E=w*a,A=z*x,G=z*y,J=w;
g.normal3(A,G,J);g.texCoord2(r,l);g.vertex3(D,B,E);D=x*(b+v*a);B=y*(b+v*a);E=p*a;A=v*x;G=v*y;J=p;g.normal3(A,G,J);g.texCoord2(r,u);g.vertex3(D,B,E)}}g=g.toMeshBuffer();return e?g.recalcNormals(e,f):g},createPlane:function(a,b,c,d,e){var f=new H3DU.Mesh;if("undefined"===typeof a||null===a)a=1;if("undefined"===typeof b||null===b)b=1;if("undefined"===typeof c||null===c)c=1;if("undefined"===typeof d||null===d)d=1;if(0>a||0>b)throw Error("width or height is less than 0");if(0>=d||0>=c)throw Error("widthDiv or heightDiv is 0 or less");
if(0===a||0===b)return f;var g=.5*-a,h=.5*-b;e?f.normal3(0,0,-1):f.normal3(0,0,1);for(e=0;e<d;e++){f.mode(H3DU.Mesh.TRIANGLE_STRIP);var k=e/d,l=(e+1)/d,p=h+b*k,r=h+b*l;f.texCoord2(0,l);f.vertex3(g,r,0);f.texCoord2(0,k);f.vertex3(g,p,0);for(var n=0;n<c;n++){var q=(n+1)/c,u=g+a*q;f.texCoord2(q,l);f.vertex3(u,r,0);f.texCoord2(q,k);f.vertex3(u,p,0)}}return f=f.toMeshBuffer()},createSphere:function(a,b,c,d,e){return H3DU.Meshes._createCapsule(a,0,b,c,1,d,e)},createCapsule:function(a,b,c,d,e,f,g){if("undefined"===
typeof d||null===d)d=8;if(1>d)throw Error("too few stacks");return H3DU.Meshes._createCapsule(a,b,c,2*d,e,f,g)},_createCapsule:function(a,b,c,d,e,f,g){function h(a,b,c,d,e,f){a.normal3(c*b,d*b,e*b);a.vertex3(c,d,e+f)}var k=new H3DU.Mesh;if("undefined"===typeof c||null===c)c=16;if("undefined"===typeof d||null===d)d=16;if("undefined"===typeof e||null===e)e=1;if("undefined"===typeof a||null===a)a=1;if("undefined"===typeof b||null===b)b=1;if(2>d)throw Error("too few stacks");if(2>=c)throw Error("too few slices");
if(1>e&&0<b)throw Error("too few middle stacks");if(0>b)throw Error("negative length");if(0>a)throw Error("negative radius");if(0===a)return k;var l,p,r=.5*b,n=d/2,q=g?-1:1,u=[],v=[],w=[],z=[],y,x=H3DU.Math.PiTimes2/c,D=Math.cos(x),B=0<=x&&6.283185307179586>x?3.141592653589793>=x?Math.sqrt(1-D*D):-Math.sqrt(1-D*D):Math.sin(x);p=1;for(x=l=0;x<c;x++){var E=1*x/c;u.push(p,l);z.push(E);var A=D*p+B*l;l=D*l-B*p;p=A}u.push(u[0],u[1]);z.push(1);var E=2*a,E=E/(E+b),G=[],x=Math.PI/d,D=Math.cos(x);p=B=0<=x&&
6.283185307179586>x?3.141592653589793>=x?Math.sqrt(1-D*D):-Math.sqrt(1-D*D):Math.sin(x);l=D;for(x=0;x<d;x++)A=1*(x+1)/d,v.push(p),G.push(-l),w.push(A),A=D*p+B*l,l=D*l-B*p,p=A;c*=2;var D=-1,J=p=0,B=u[0];l=u[1];for(x=0;x<d;x++){var H=G[x],F=w[x];y=a*D;var A=a*H,I=x<n?-r:r,L=p,K=a*v[x],O=J,P=F;0<b&&(O=x<n?J*E:1-(1-J)*E,P=x<n?F*E:1-(1-F)*E);D=H;J=F;p=K;x===d-1||0===x?k.mode(H3DU.Mesh.TRIANGLES):(k.mode(H3DU.Mesh.TRIANGLE_STRIP),k.texCoord2(1,O),h(k,q,B*L,l*L,y,I),k.texCoord2(1,P),h(k,q,B*K,l*K,A,I));
for(var M=0,Q=B,S=l,R,N,F=2,U=1;F<=c;F+=2,U++)H=z[U],x===d-1?(R=M+.5*(H-M),k.texCoord2(1-M,O),h(k,q,Q*L,S*L,y,I),k.texCoord2(1-R,P),h(k,q,B*K,l*K,A,I),R=u[F],N=u[F+1],k.texCoord2(1-H,O),h(k,q,R*L,N*L,y,I),Q=R,S=N,M=H):0===x?(R=M+.5*(H-M),k.texCoord2(1-R,O),h(k,q,B*L,l*L,y,I),k.texCoord2(1-M,P),h(k,q,Q*K,S*K,A,I),R=u[F],N=u[F+1],k.texCoord2(1-H,P),h(k,q,R*K,N*K,A,I),Q=R,S=N,M=H):(R=u[F],N=u[F+1],k.texCoord2(1-H,O),h(k,q,R*L,N*L,y,I),k.texCoord2(1-H,P),h(k,q,R*K,N*K,A,I));if(x+1===n&&0<b)for(I=.5*E,
L=2*r,M=1-I,Q=1-E,S=0;S<e;S++){y=-r+(0===S?0:L*S/e);var V=S===e-1?r:-r+L*(S+1)/e,O=I+(0===S?0:Q*S/e),P=S===e-1?M:I+Q*(S+1)/e;k.mode(H3DU.Mesh.TRIANGLE_STRIP);k.texCoord2(1,O);h(k,q,B*K,l*K,A,y);k.texCoord2(1,P);h(k,q,B*K,l*K,A,V);F=2;for(U=1;F<=c;F+=2,U++)H=z[U],R=u[F],N=u[F+1],k.texCoord2(1-H,O),h(k,q,R*K,N*K,A,y),k.texCoord2(1-H,P),h(k,q,R*K,N*K,A,V)}}k=k.toMeshBuffer();return f?k.recalcNormals(f,g):k.normalizeNormals()},createPointedStar:function(a,b,c,d){var e=new H3DU.Mesh;if(2>a||0>b||0>c||
0>=b&&0>=c)return e;e.mode(H3DU.Mesh.TRIANGLE_FAN);var f=0,g=0,h=1/Math.max(b,c);e.normal3(0,0,d?-1:1).texCoord2(.5,.5).vertex2(0,0);var k=H3DU.Math.PiTimes2/(2*a);d=Math.cos(k);for(var k=3.141592653589793>=k?Math.sqrt(1-d*d):-Math.sqrt(1-d*d),l=0,p=1,r=0;r<2*a;r++){var n=0===(r&1)?b:c,q=-l*n,n=p*n,u=.5*(1+q*h),v=.5*(1+n*h);0===r&&(f=q,g=n);e.texCoord2(u,v).vertex2(q,n);q=d*p-k*l;l=d*l+k*p;p=q}e.texCoord2(.5*(1+f*h),.5*(1+g*h)).vertex2(f,g);return e.toMeshBuffer()}};y.BufferAccessor=G;y.MeshBuffer=
v;y.Semantic=B;y.getPromiseResults=ca;y.getPromiseResultsAll=function(a,b,c){return ca(a,b,c).then(function(a){return 0<a.failures.length?Promise.reject(a):Promise.resolve(a.successes)})};y.loadFileFromUrl=function(a,b){var c=b||"text";return new Promise(function(b,e){var d=new XMLHttpRequest;d.onreadystatechange=function(d){d=d.target;4===d.readyState&&(200<=d.status&&300>d.status?(d="xml"===c?d.responseXML:"json"===c?"response"in d?d.response:JSON.parse(d.responseText):"arraybuffer"===c?d.response:
d.responseText+"",b({url:a,data:d})):e({url:a}))};d.onerror=function(b){e({url:a,error:b})};d.open("get",a,!0);d.responseType=c;d.send()})};y.getTimePosition=function(a,b,c){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)a.lastTime=b;return 1*(b-a.time)%c/c};y.newFrames=function(a,b){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)return a.lastTime=
b,0;var c=b-a.lastTime;a.lastTime=b;return 60*c/1E3};y.toGLColor=function(a,b,c,d){return"undefined"===typeof a||null===a?[0,0,0,0]:"string"===typeof a?(a=da.colorToRgba(a)||[0,0,0,0],b=1/255,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,ba(a)):"number"===typeof a&&"number"===typeof b&&"number"===typeof c?[a,b,c,"number"!==typeof d?1:d]:a.constructor===Array?ba([a[0]||0,a[1]||0,a[2]||0,"number"!==typeof a[3]?1:a[3]]):ba(a||[0,0,0,0])};Object.defineProperty(y,"__esModule",{value:!0})});var BezierCurve=H3DU.BezierCurve,BezierSurface=H3DU.BezierSurface,BSplineCurve=H3DU.BSplineCurve,BSplineSurface=H3DU.BSplineSurface,GLUtil=H3DU,GLMath=H3DU.Math,BufferedMesh=H3DU.BufferedMesh,FrameBuffer=H3DU.FrameBuffer,CurveEval=H3DU.CurveEval,SurfaceEval=H3DU.SurfaceEval,Lights=H3DU.Lights,LightSource=H3DU.LightSource,Material=H3DU.Material,Mesh=H3DU.Mesh,Meshes=H3DU.Meshes,Scene3D=H3DU.Scene3D,ShaderProgram=H3DU.ShaderProgram,Shape=H3DU.Shape,ShapeGroup=H3DU.ShapeGroup,Texture=H3DU.Texture,TextureLoader=
H3DU.TextureLoader,Transform=H3DU.Transform;
