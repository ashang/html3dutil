(function(a,b){"function"===typeof define&&define.amd?define(["exports"],b):"object"===typeof exports?b(exports):b(a)})(this,function(a){if(!a.Promise){var b=function(a){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];a&&this._invokeResolver(a)};b.resolve=function(a){return new this(function(b){b(a)})};b.reject=function(a){return new this(function(b,c){c(a)})};b.all=b.when=function(a){return new this(function(b,c){var d=0,e=[];a.forEach(function(a,
f){d++;a.then(function(a){e[f]=a;d--;d||b(e)},function(a){d=1/0;c(a)})})})};b.race=function(a){return new this(function(b,c){a.forEach(function(a){a.then(b,c)})})};b.prototype.then=function(a,d){this._cb.fulfilled.push(a);this._cb.rejected.push(d);var c=new b;this._thenPromises.push(c);0<this._state&&this._schedule();return c};b.prototype.fulfill=function(a){if(0!==this._state)return this;this._state=1;this._value=a;this._thenPromises.length&&this._schedule();return this};b.prototype.reject=function(a){if(0!==
this._state)return this;this._state=2;this._value=a;this._thenPromises.length&&this._schedule();return this};b.prototype.resolve=function(a){if(a===this)this.reject(new TypeError("Promise resolved by its own instance"));else if(a instanceof this.constructor)a.chain(this);else{var b;if("undefined"===typeof a||null===a||"object"!==typeof a&&"function"!==typeof a)this.fulfill(a);else{try{b=a.then}catch(g){this.reject(g);return}if("function"===typeof b){var c=!1,f=function(a){c||(c=!0,this.resolve(a))},
h=function(a){c||(c=!0,this.reject(a))};try{b.call(a,f.bind(this),h.bind(this))}catch(g){c||this.reject(g)}}else this.fulfill(a)}}};b.prototype.chain=function(a){return this.then(function(b){a.resolve(b)},function(b){a.reject(b)})};b.prototype["catch"]=function(a){return this.then(null,a)};b.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};b.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var a=this._cb.fulfilled.shift(),
b=this._cb.rejected.shift();this._executeCallback(1===this._state?a:b)}};b.prototype._executeCallback=function(a){var b=this._thenPromises.shift();if("function"!==typeof a)1===this._state?b.fulfill(this._value):b.reject(this._value);else try{var c=a(this._value);b.resolve(c);return c}catch(f){b.reject(f)}};b.prototype._invokeResolver=function(a){try{a(this.resolve.bind(this),this.reject.bind(this))}catch(d){this.reject(d)}};a.Promise=b}});/*
 CC0-1.0
*/
if("undefined"===typeof window.requestAnimationFrame||null===window.requestAnimationFrame)if(window.requestAnimationFrame=("undefined"===typeof window.mozRequestAnimationFrame?null:window.mozRequestAnimationFrame)||("undefined"===typeof window.webkitRequestAnimationFrame?null:window.webkitRequestAnimationFrame)||("undefined"===typeof window.msRequestAnimationFrame?null:window.msRequestAnimationFrame),"undefined"===typeof window.requestAnimationFrame||null===window.requestAnimationFrame)window.requestAnimationFrame=
function(a){window.setTimeout(function(){a(window.performance.now())},17)};if("undefined"===typeof window.performance||null===window.performance)window.performance={};if("undefined"===typeof window.performance.now||null===window.performance.now)window.performance.now=function(){return 1E3*(new Date).getTime()-window.performance._startTime},window.performance._startTime=1E3*(new Date).getTime();
if("undefined"===typeof Object.keys||null===Object.keys)Object.keys=function(a){var b=[],c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[b.length]=c);return b};
var H3DU={renderLoop:function(a){a(window.performance.now());var b=function(c){window.requestAnimationFrame(b);a(c)};window.requestAnimationFrame(b)},createCanvasElement:function(a,b,c){var d=document.createElement("canvas");a&&a.appendChild(d);if("undefined"===typeof b||null===b)d.width=Math.ceil(d.clientWidth)+"";else{if(0>b)throw Error("width negative");d.width=Math.ceil(b)+""}if("undefined"===typeof c||null===c)d.height=Math.ceil(d.clientHeight)+"";else{if(0>c)throw Error("height negative");d.height=
Math.ceil(c)+""}return d},get3DOr2DContext:function(a){if(!a||!a.getContext)return null;var b=null,c={preserveDrawingBuffer:!0,alpha:!1};c.antialias=window.devicePixelRatio&&1<window.devicePixelRatio?!1:!0;try{b=a.getContext("webgl2",c)}catch(d){b=null}if(!b)try{b=a.getContext("webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("experimental-webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("moz-webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("webkit-3d",c)}catch(d){b=null}if(!b)try{b=a.getContext("2d",
c)}catch(d){b=null}H3DU.is3DContext(b)&&(b.getExtension("OES_element_index_uint"),b.getExtension("OES_standard_derivatives"));return b},get3DContext:function(a,b){var c=H3DU.get3DOr2DContext(a),d=null;c||"undefined"===typeof window.WebGLShader||null===window.WebGLShader?"undefined"===typeof window.WebGLShader||null===window.WebGLShader||H3DU.is3DContext(c)?c&&H3DU.is3DContext(c)||(d="This page requires a WebGL-supporting browser."):d="This page requires WebGL, but it failed to start. Your computer might not support WebGL.":
d="Failed to initialize graphics support required by this page.";return d?((b||window.alert)(d),null):c},is3DContext:function(a){return a&&"undefined"!==typeof WebGLRenderingContext&&null!==WebGLRenderingContext&&a instanceof WebGLRenderingContext||a&&"undefined"!==typeof WebGL2RenderingContext&&null!==WebGL2RenderingContext&&a instanceof WebGL2RenderingContext?!0:a&&"compileShader"in a},getPromiseResultsAll:function(a,b,c){return H3DU.getPromiseResults(a,b,c).then(function(a){return 0<a.failures.length?
Promise.reject(a):Promise.resolve(a.successes)})},getPromiseResults:function(a,b,c){function d(a,b,c){return function(d){a&&a(d);b.successes[c]=d;return!0}}function e(a,b,c){return function(d){a&&a(d);b.failures[c]=d;return!0}}if(!a||0===a.length)return Promise.resolve({successes:[],failures:[],results:[]});for(var f={successes:[],failures:[],results:[]},h=[],g=0;g<a.length;g++){var k=g;h.push(a[g].then(d(b,f,k),e(c,f,k)))}return Promise.all(h).then(function(a){for(var b=0;b<f.successes.length;b++)"undefined"===
typeof f.successes[b]&&(f.successes.splice(b,1),--b);for(b=0;b<f.failures.length;b++)"undefined"===typeof f.failures[b]&&(f.failures.splice(b,1),--b);f.results=a;return Promise.resolve(f)})},loadFileFromUrl:function(a,b){var c=b||"text";return new Promise(function(b,e){var d=new XMLHttpRequest;d.onreadystatechange=function(d){d=d.target;4===d.readyState&&(200<=d.status&&300>d.status?(d="xml"===c?d.responseXML:"json"===c?"response"in d?d.response:JSON.parse(d.responseText):"arraybuffer"===c?d.response:
d.responseText+"",b({url:a,data:d})):e({url:a}))};d.onerror=function(b){e({url:a,error:b})};d.open("get",a,!0);d.responseType=c;d.send()})},getTimePosition:function(a,b,c){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)a.lastTime=b;return 1*(b-a.time)%c/c},newFrames:function(a,b){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)return a.lastTime=
b,0;var c=b-a.lastTime;a.lastTime=b;return 60*c/1E3}};
(function(a){var b=function(){throw Error();};(function(a){a.skipWhite=function(a,b,c){for(;b<c;){var d=a.charCodeAt(b);if(32===d||13===d||12===d||9===d||10===d)++b;else break}return b};a.parseComma=function(a,c,d){var e=c;c=b.skipWhite(a,c,d);return c<d&&44===a.charCodeAt(c)?b.skipWhite(a,c+1,d):e};a.parseEndparen=function(a,c,d){var e=c;c=b.skipWhite(a,c,d);return c<d&&41===a.charCodeAt(c)?c+1:e};a.hsl=function(a,c,d,g){var e,f;e=c;if((f=b.parseHue(a,c,d,g,0))===c)return e;c=f;if((f=b.sepPct(a,
c,d,g,1))===c)return e;c=f;if((f=b.sepPct(a,c,d,g,2))===c)return e;c=f;f=b.parseEndparen(a,c,d);if(f===c)return e;c=f;a=b.hlsToRgb(g[0],g[2],g[1]);g[0]=a[0];g[1]=a[1];g[2]=a[2];g[3]=255;return c};a.pct=function(a,c,d,g,k){var e=b.parseNumber(a,c,d);if(e!==c){if(e>=d||37!==a.charAt(e))return c;g[k]=255*b.stringToPercent(a,c,e)/100;return e+1}return e};a.parseByte=function(a,c,d,g,k){d=b.parseInteger(a,c,d,!0);d!==c&&(g[k]=b.stringToByte(a,c,d));return d};a.parseHue=function(a,c,d,g,k){var e=c;c=b.skipWhite(a,
c,d);d=b.parseNumber(a,c,d);return d!==c?(g[k]=b.stringToHue(a,c,d),d):e};a.sepByte=function(a,c,d,g,k){var e=b.parseComma(a,c,d);return e!==c?b.parseByte(a,e,d,g,k):e};a.sepPct=function(a,c,d,g,k){var e=b.parseComma(a,c,d);return e!==c?b.pct(a,e,d,g,k):e};a.sepAlpha=function(a,c,d,g,k){var e=b.parseComma(a,c,d);e!==c&&(c=e,e=b.parseNumber(a,c,d),e!==c&&(g[k]=b.stringToAlpha(a,c,e)));return e};a.hsla=function(a,c,d,g){var e,f;e=c;if((f=b.parseHue(a,c,d,g,0))===c)return e;c=f;if((f=b.sepPct(a,c,d,
g,1))===c)return e;c=f;if((f=b.sepPct(a,c,d,g,2))===c)return e;c=f;if((f=b.sepAlpha(a,c,d,g,3))===c)return e;c=f;f=b.hlsToRgb(g[0],g[2],g[1]);g[0]=f[0];g[1]=f[1];g[2]=f[2];f=b.parseEndparen(a,c,d);return f===c?e:f};a.rgba=function(a,c,d,g){var e,f;e=c;var h=c=b.skipWhite(a,c,d),n=!0;(f=b.pct(a,c,d,g,0))===c?n=!1:c=f;n&&(f=b.sepPct(a,c,d,g,1))===c?n=!1:c=f;n&&(f=b.sepPct(a,c,d,g,2))===c?n=!1:c=f;n&&(f=b.sepAlpha(a,c,d,g,3))===c?n=!1:c=f;n||(c=h,n=!0,(f=b.parseByte(a,c,d,g,0))===c?n=!1:c=f,n&&(f=b.sepByte(a,
c,d,g,1))===c?n=!1:c=f,n&&(f=b.sepByte(a,c,d,g,2))===c?n=!1:c=f,n&&(f=b.sepAlpha(a,c,d,g,3))===c?n=!1:c=f);if(!n)return e;f=b.parseEndparen(a,c,d);return f===c?e:f};a.rgb=function(a,c,d,g){var e,f;e=c;var h=c=b.skipWhite(a,c,d),n=!0;(f=b.pct(a,c,d,g,0))===c?n=!1:c=f;n&&(f=b.sepPct(a,c,d,g,1))===c?n=!1:c=f;n&&(f=b.sepPct(a,c,d,g,2))===c?n=!1:c=f;n||(c=h,n=!0,(f=b.parseByte(a,c,d,g,0))===c?n=!1:c=f,n&&(f=b.sepByte(a,c,d,g,1))===c?n=!1:c=f,n&&(f=b.sepByte(a,c,d,g,2))===c?n=!1:c=f);if(!n)return e;g[3]=
255;f=b.parseEndparen(a,c,d);return f===c?e:f};a.stringToNumber=function(a,b,c){a=a.substring(b,b+(c-b));return parseFloat(a)};a.stringToPercent=function(a,c,d){a=b.stringToNumber(a,c,d);return Number.isNaN(a)?-1:0>a?0:100<a?100:a};a.stringToAlpha=function(a,c,d){a=b.stringToNumber(a,c,d);return 0>a?0:1<a?255:255*a};a.stringToHue=function(a,c,d){a=b.stringToNumber(a,c,d);return Number.isNaN(a)||a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY?0:(a%360+360)%360};a.stringToByte=function(a,
c,d){a=b.stringToNumber(a,c,d);return 0>a?0:255<a?255:a};a.parseInteger=function(a,b,c,d){var e=!1,f=b;for(d&&b<c&&(43===a.charCodeAt(b)||45===a.charCodeAt(b))&&++b;b<c&&48<=a.charCodeAt(b)&&57>=a.charCodeAt(b);)++b,e=!0;return e?b:f};a.parseNumber=function(a,c,d){var e=c,f,h=0;if((f=b.parseInteger(a,c,d,!0))!==e)return c=f,c<d&&46===a.charCodeAt(c)?(++c,(f=b.parseInteger(a,c,d,!1))!==c?c<d&&(69===a.charCodeAt(c)||101===a.charCodeAt(c))&&(h=b.parseInteger(a,c+1,d,!0))!==c+1?h:f:c-1):c;c<d&&(43===
a.charCodeAt(c)||45===a.charCodeAt(c))&&++c;return c<d&&46===a.charCodeAt(c)&&(++c,(f=b.parseInteger(a,c,d,!1))!==c)?c<d&&(69===a.charCodeAt(c)||101===a.charCodeAt(c))&&(h=b.parseInteger(a,c+1,d,!0))!==c+1?h:f:e};a.hlsToRgb=a.HlsToRgb=function(a,b,c){b=0>b?0:255<b?255:b;c=0>c?0:255<c?255:c;if(0===c)return[b,b,b];c=127.5>=b?b*(255+c)/255:b+c-b*c/255;var d=2*b-c,e;if(0>a||360<=a)a=(a%360+360)%360;var f=a+120;360<=f&&(f-=360);b=60>f?d+(c-d)*f/60:180>f?c:240>f?d+(c-d)*(240-f)/60:d;f=a;e=60>f?d+(c-d)*
f/60:180>f?c:240>f?d+(c-d)*(240-f)/60:d;f=a-120;0>f&&(f+=360);a=60>f?d+(c-d)*f/60:180>f?c:240>f?d+(c-d)*(240-f)/60:d;return[0>b?0:255<b?255:b,0>e?0:255<e?255:e,0>a?0:255<a?255:a]};a.dehexchar=function(a){return 48<=a&&57>=a?a-48:65<=a&&70>=a?a+10-65:97<=a&&102>=a?a+10-97:-1};a.rgbHex=function(a,c,d){if("undefined"===typeof a||null===a||0===a.length)return!1;var e=a.length,f=[0,0,0,0,0,0,0,0],h=0,l=0;if("#"===a.charAt(0))--e,++h;else if(d)return!1;if(3!==e&&4!==e&&6!==e&&8!==e)return!1;for(d=h;d<a.length;++d){h=
b.dehexchar(a.charCodeAt(d));if(0>h)return!1;f[l++]=h}c[3]=4===e?f[3]|f[3]<<4:8===e?f[7]|f[6]<<4:255;3===e||4===e?(c[0]=f[0]|f[0]<<4,c[1]=f[1]|f[1]<<4,c[2]=f[2]|f[2]<<4):6<=e&&(c[0]=f[1]|f[0]<<4,c[1]=f[3]|f[2]<<4,c[2]=f[5]|f[4]<<4);return!0};a.colorToRgba=a.colorToRgba=function(a){if("undefined"===typeof a||null===a||0===a.length)return null;a=a.replace(/^[\r\n\t \u000c]+|[\r\n\t \u000c]+$/g,"");a=a.toLowerCase();if("transparent"===a)return[0,0,0,0];if("undefined"===typeof a||null===a||0===a.length)return null;
var c=[0,0,0,0];if("#"===a.charAt(0)&&b.rgbHex(a,c,!0))return c;if(4<a.length&&"rgb("===a.substring(0,4))return b.rgb(a,4,a.length,c)===a.length?c:null;if(5<a.length&&"rgba("===a.substring(0,5))return b.rgba(a,5,a.length,c)===a.length?c:null;if(4<a.length&&"hsl("===a.substring(0,4))return b.hsl(a,4,a.length,c)===a.length?c:null;if(5<a.length&&"hsla("===a.substring(0,5))return b.hsla(a,5,a.length,c)===a.length?c:null;var d=b.colorToRgbaSetUpNamedColors();return"undefined"!==typeof d[a]&&null!==d[a]?
(b.rgbHex(d[a],c,!1),c):null};a.namedColorMap=a.namedColorMap=null;a.nc="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
a.colorToRgbaSetUpNamedColors=function(){if("undefined"===typeof b.namedColorMap||null===b.namedColorMap){for(var a={},c=0;c<b.nc.length;c+=2)a[b.nc[c]]=b.nc[c+1];for(var d="grey gray darkgrey darkgray darkslategrey darkslategray dimgrey dimgray lightgrey lightgray lightslategrey lightslategray slategrey slategray".split(" "),c=0;c<d.length;c+=2)a[d[c]]=a[d[c+1]];b.namedColorMap=a}return b.namedColorMap}})(b,b.prototype);var c=function(a){a[0]=0>a[0]?0:Math.min(a[0],1);a[1]=0>a[1]?0:Math.min(a[1],
1);a[2]=0>a[2]?0:Math.min(a[2],1);a[3]=0>a[3]?0:Math.min(a[3],1);return a};a.toGLColor=function(a,e,f,h){return"undefined"===typeof a||null===a?[0,0,0,0]:"string"===typeof a?(a=b.colorToRgba(a)||[0,0,0,0],e=1/255,a[0]*=e,a[1]*=e,a[2]*=e,a[3]*=e,c(a)):"number"===typeof a&&"number"===typeof e&&"number"===typeof f?[a,e,f,"number"!==typeof h?1:h]:a.constructor===Array?c([a[0]||0,a[1]||0,a[2]||0,"number"!==typeof a[3]?1:a[3]]):c(a||[0,0,0,0])}})(H3DU);
H3DU._isIdentityExceptTranslate=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&1===a[15]};H3DU._toContext=function(a){return a&&a.getContext?a.getContext():a};H3DU._isPowerOfTwo=function(a){if(Math.floor(a)!==a||0>=a)return!1;for(;1<a&&0===(a&1);)a>>=1;return 1===a};H3DU.Curve=function(a){this.curve=a};H3DU.Curve.prototype.endPoints=function(){return"undefined"!==typeof this.curve&&null!==this.curve&&"undefined"!==typeof this.curve.endPoints&&null!==this.curve.endPoints?this.curve.endPoints():[0,1]};H3DU.Curve._EPSILON=1E-5;H3DU.Curve.prototype.evaluate=function(a){return"undefined"!==typeof this.curve&&null!==this.curve&&"undefined"!==typeof this.curve.evaluate&&null!==this.curve.evaluate?this.curve.evaluate(a):[0,0,0]};
H3DU.Curve.prototype.velocity=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&"undefined"!==typeof this.curve.velocity&&null!==this.curve.velocity)return this.curve.velocity(a);var b=H3DU.Curve._EPSILON,c=this.evaluate(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.evaluate(a+b));return H3DU._MathInternal.vecSubScaleInPlace(c,this.evaluate(a),1/b)};
H3DU.Curve.prototype.accel=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&"undefined"!==typeof this.curve.accel&&null!==this.curve.accel)return this.curve.accel(a);var b=H3DU.Curve._EPSILON,c=this.velocity(a+b);0===c[0]&&0===c[1]&&0===c[2]&&(b=-b,c=this.velocity(a+b));return H3DU._MathInternal.vecSubScaleInPlace(c,this.velocity(a),1/b)};
H3DU.Curve.prototype.normal=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&"undefined"!==typeof this.curve.normal&&null!==this.curve.normal)return this.curve.normal(a);var b=H3DU.Curve._EPSILON,c=H3DU._MathInternal.vecNormalizeInPlace(this.velocity(a+b));0===c[0]&&0===c[1]&&0===c[2]&&(c=H3DU._MathInternal.vecNormalizeInPlace(this.velocity(a+-b)));a=H3DU._MathInternal.vecNormalizeInPlace(this.velocity(a));H3DU._MathInternal.vecSubInPlace(c,a);return H3DU._MathInternal.vecNormalizeInPlace(c)};
H3DU.Curve._legendreGauss24=[.12793819534675216,.06405689286260563,.1258374563468283,.1911188674736163,.12167047292780339,.3150426796961634,.1155056680537256,.4337935076260451,.10744427011596563,.5454214713888396,.09761865210411388,.6480936519369755,.08619016153195327,.7401241915785544,.0733464814110803,.820001985973903,.05929858491543678,.8864155270044011,.04427743881741981,.9382745520027328,.028531388628933663,.9747285559713095,.0123412297999872,.9951872199970213];
H3DU.Curve.prototype.arcLength=function(a){if("undefined"!==typeof this.curve&&null!==this.curve&&"undefined"!==typeof this.curve.arcLength&&null!==this.curve.arcLength)return this.curve.arcLength(a);var b=this.endPoints();if(a===b[0])return 0;var c=Math.min(a,b[0]),d=Math.max(a,b[0]);a=a>=b[0]?1:-1;for(var b=.5*(d-c),c=.5*(d+c),d=0,e=H3DU.Curve._legendreGauss24,f=0;f<e.length;f+=2)var h=e[f],g=e[f+1],k=this.velocity(b*g+c),d=d+h*H3DU._MathInternal.vecLength(k),k=this.velocity(-b*g+c),d=d+h*H3DU._MathInternal.vecLength(k);
return d*b*a};H3DU.Surface=function(a){this.surface="undefined"===typeof a?null:a};H3DU.Surface._EPSILON=1E-5;H3DU.Surface.prototype.tangent=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.tangent&&null!==this.surface.tangent)return this.surface.tangent(a,b);var c=H3DU.Curve._EPSILON,d=this.evaluate(a+c,b);0===d[0]&&0===d[1]&&0===d[2]&&(c=-c,d=this.evaluate(a+c,b));return H3DU._MathInternal.vecSubScaleInPlace(d,this.evaluate(a,b),1/c)};
H3DU.Surface.prototype.bitangent=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.bitangent&&null!==this.surface.bitangent)return this.surface.bitangent(a,b);var c=H3DU.Curve._EPSILON,d=this.evaluate(a,b+c);0===d[0]&&0===d[1]&&0===d[2]&&(c=-c,d=this.evaluate(a,b+c));return H3DU._MathInternal.vecSubScaleInPlace(d,this.evaluate(a,b),1/c)};
H3DU.Surface.prototype.normal=function(a,b){return H3DU._MathInternal.vecNormalizeInPlace(this.gradient(a,b))};
H3DU.Surface.prototype.gradient=function(a,b){if("undefined"!==typeof this.surface&&null!==this.surface&&"undefined"!==typeof this.surface.gradient&&null!==this.surface.gradient)return this.surface.gradient(a,b);var c=this.tangent(a,b),d=this.bitangent(a,b);if(0===H3DU._MathInternal.vecLength(d))return c;if(0!==H3DU._MathInternal.vecLength(c)){if(3!==c.length||3!==d.length){var e=c.length,f=H3DU._MathInternal.vecZeros(e),c=[c[0]||0,c[1]||0,c[2]||0],d=[d[0]||0,d[1]||0,d[2]||0],c=H3DU.Math.vec3cross(c,
d);f[0]=c[0];f[1]=c[1];f[2]=c[2];return f.slice(0,e)}return H3DU.Math.vec3cross(c,d)}return d};H3DU.Surface.prototype.evaluate=function(a,b){return"undefined"!==typeof this.evaluate&&null!==this.evaluate&&"undefined"!==typeof this.surface.evaluate&&null!==this.surface.evaluate?this.surface.evaluate(a,b):[0,0,0]};
H3DU.Surface.prototype.endPoints=function(){return"undefined"!==typeof this.evaluate&&null!==this.evaluate&&"undefined"!==typeof this.surface.endPoints&&null!==this.surface.endPoints?this.surface.endPoints():[0,1,0,1]};H3DU.ShaderProgram=function(a,b,c){this._init(a,new H3DU.ShaderInfo(b,c))};H3DU.ShaderProgram._fromShaderInfo=function(a,b){var c=new H3DU.ShaderProgram(null);c._init(a,b);return c};
H3DU.ShaderProgram.prototype._init=function(a,b){if(a){a=a.getContext?a.getContext():a;this.CURRENT_PROGRAM=35725;this.FLOAT=5126;this.shaderInfo=b;this.context=a;this.prog=H3DU.ShaderProgram._compileShaders(a,b.vertexShader,b.fragmentShader);this.uniformValues={};this.actives={};this.attributes=[];this.uniformTypes={};this.savedUniforms={};this.attributeNames=[];this.attributeSemantics={};for(var c=Object.keys(b.attributeSemantics),d=0;d<c.length;d++)this.attributeSemantics[c[d]]=b.attributeSemantics[c[d]].slice(0,
2);this.uniformSemantics={};c=Object.keys(b.uniformSemantics);for(d=0;d<c.length;d++)this.uniformSemantics[c[d]]=b.uniformSemantics[c[d]];H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms);if("undefined"!==typeof this.prog&&null!==this.prog){for(var e,c={},f=a.getProgramParameter(this.prog,a.ACTIVE_ATTRIBUTES),d=0;d<f;++d)if(e=a.getActiveAttrib(this.prog,d),"undefined"!==typeof e&&null!==e){e=e.name;var h=a.getAttribLocation(this.prog,e);0<=h&&
(this.attributes.push(h),c[e]=h,this.attributeNames.push([e,h]))}f=a.getProgramParameter(this.prog,a.ACTIVE_UNIFORMS);for(d=0;d<f;++d)h=this.context.getActiveUniform(this.prog,d),"undefined"!==typeof h&&null!==h&&(e=h.name,c[e]=this.context.getUniformLocation(this.prog,e),this.uniformTypes[e]=h.type);this.actives=c}}};
H3DU.ShaderProgram.prototype._addNamesWithSemantic=function(a,b,c){for(var d in this.attributeSemantics)if(Object.prototype.hasOwnProperty.call(this.attributeSemantics,d)){var e=this.attributeSemantics[d];e[0]===b&&e[1]===c&&a.push(d)}};H3DU.ShaderProgram.prototype._disableOthers=function(a){for(var b={},c=0;c<a.length;c++)b[a[c]]=!0;for(c=0;c<this.attributeNames.length;c++)a=this.attributeNames[c],b[a[0]]||this.context.disableVertexAttribArray(a[1])};
H3DU.ShaderProgram.prototype.dispose=function(){this.program&&this.context.deleteProgram(this.program);this.program=this.context=null;this.actives={};this.attributes={};this.uniformTypes={};this.attributeSemantics={}};H3DU.ShaderProgram.prototype.setSemantic=function(a,b,c){b=this.attributeSemantics[a];c=H3DU.MeshBuffer._resolveSemantic(a,c);b?(b[0]=c[0],b[1]=c[1]):this.attributeSemantics[a]=c;return null};H3DU.ShaderProgram.prototype.getContext=function(){return this.context};
H3DU.ShaderProgram.prototype._setUniformInternal=function(a,b){var c=this.get(b);if("undefined"!==typeof c&&null!==c){var d=a[b];d instanceof H3DU.TextureInfo||("number"===typeof d?this.uniformTypes[b]===this.FLOAT?this.context.uniform1f(c,d):this.context.uniform1i(c,d):3===d.length?this.context.uniform3fv(c,d):2===d.length?this.context.uniform2fv(c,d):4===d.length?this.context.uniform4fv(c,d):16===d.length?this.context.uniformMatrix4fv(c,!1,d):9===d.length&&this.context.uniformMatrix3fv(c,!1,d))}};
H3DU.ShaderProgram.prototype.get=function(a){a=this.actives[a];return"undefined"===typeof a||null===a?null:a};H3DU.ShaderProgram.prototype.getUniform=function(a){var b="string"===typeof a?this.get(a):a;if(null===b||"number"===typeof b)return null;a=this.uniformValues[a];return"undefined"===typeof a||null===a?this.context.getUniform(this.program,b):a instanceof Array?a.slice(0,a.length):a};
H3DU.ShaderProgram.prototype._setSavedUniforms=function(){var a,b,c=Object.keys(this.savedUniforms);b=c.length;for(var d=0;d<b;d++)a=c[d],this._setUniformInternal(this.savedUniforms,a);return b};H3DU.ShaderProgram.prototype.use=function(){this.context.useProgram(this.prog);0<this._setSavedUniforms()&&(this.savedUniforms={});return this};H3DU.ShaderProgram.prototype._update=function(){H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms);return this};
H3DU.ShaderProgram.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,this.savedUniforms);this.context.getParameter(this.CURRENT_PROGRAM)===this.prog&&0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
H3DU.ShaderProgram._compileShaders=function(a,b,c){function d(a,b,c){var d=a.createShader(b);a.shaderSource(d,c);a.compileShader(d);if(!a.getShaderParameter(d,a.COMPILE_STATUS)){c||(c="");c=c.split("\n");for(var e=0;e<c.length;e++)c[e]="/* "+(e+1)+" */   "+c[e];console.log(c.join("\n"));console.log((b===a.VERTEX_SHADER?"vertex: ":"fragment: ")+a.getShaderInfoLog(d));return null}return d}b=b&&0!==b.length?d(a,a.VERTEX_SHADER,b):null;c=c&&0!==c.length?d(a,a.FRAGMENT_SHADER,c):null;var e=null;"undefined"!==
typeof b&&null!==b&&"undefined"!==typeof c&&null!==c&&(e=a.createProgram(),a.attachShader(e,b),a.attachShader(e,c),a.linkProgram(e),a.getProgramParameter(e,a.LINK_STATUS)||(console.log("link: "+a.getProgramInfoLog(e)),a.deleteProgram(e),e=null),a.detachShader(e,b),a.detachShader(e,c));"undefined"!==typeof b&&null!==b&&a.deleteShader(b);"undefined"!==typeof c&&null!==c&&a.deleteShader(c);return e};H3DU.ShaderProgram.makeEffectFragment=function(a){return H3DU.ShaderInfo.makeEffectFragment(a)};
H3DU.ShaderProgram.makeCopyEffect=function(){return H3DU.ShaderInfo.makeCopyEffect()};H3DU.ShaderProgram.makeEffect=function(a,b){return H3DU.ShaderInfo.makeEffect(b)};H3DU.ShaderProgram.getInvertEffect=function(){return H3DU.ShaderInfo.makeInvertEffect()};H3DU.ShaderProgram.getEdgeDetectEffect=function(){return H3DU.ShaderInfo.makeEdgeDetectEffect()};H3DU.ShaderProgram.getDefaultVertex=function(){return H3DU.ShaderInfo.getDefaultVertex()};H3DU.ShaderProgram.getDefaultFragment=function(){return H3DU.ShaderInfo.getDefaultFragment()};H3DU.TextureInfo=function(a){this.uri="";this.topDown=!1;this.internalFormat=this.format=6408;this.target=3553;this.type=5121;this.magFilter=9729;this.minFilter=9987;this.wrapT=this.wrapS=10497;this.setParams(a)};
H3DU.TextureInfo.prototype.copyFrom=function(a){"undefined"!==typeof a&&null!==a&&(this.uri="undefined"===typeof a.uri||null===a.uri?"":a.uri,this.format="undefined"===typeof a.format||null===a.format?6408:a.format,this.internalFormat="undefined"===typeof a.internalFormat||null===a.internalFormat?6408:a.internalFormat,this.target="undefined"===typeof a.target||null===a.target?3553:a.target,this.type="undefined"===typeof a.type||null===a.type?5121:a.type,this.magFilter="undefined"===typeof a.magFilter||
null===a.magFilter?9729:a.magFilter,this.minFilter="undefined"===typeof a.minFilter||null===a.minFilter?9986:a.minFilter,this.wrapS="undefined"===typeof a.wrapS||null===a.wrapS?10497:a.wrapS,this.wrapT="undefined"===typeof a.wrapT||null===a.wrapT?10497:a.wrapT,this.topDown="undefined"===typeof a.topDown||null===a.topDown?10497:a.topDown);return this};
H3DU.TextureInfo.prototype.setParams=function(a){"undefined"!==typeof a&&null!==a&&("undefined"!==typeof a.uri&&null!==a.uri&&(this.uri=a.uri),"undefined"!==typeof a.format&&null!==a.format&&(this.format=a.format),"undefined"!==typeof a.internalFormat&&null!==a.internalFormat&&(this.internalFormat=a.internalFormat),"undefined"!==typeof a.target&&null!==a.target&&(this.target=a.target),"undefined"!==typeof a.type&&null!==a.type&&(this.type=a.type),"undefined"!==typeof a.magFilter&&null!==a.magFilter&&
(this.magFilter=a.magFilter),"undefined"!==typeof a.minFilter&&null!==a.minFilter&&(this.minFilter=a.minFilter),"undefined"!==typeof a.wrapS&&null!==a.wrapS&&(this.wrapS=a.wrapS),"undefined"!==typeof a.wrapT&&null!==a.wrapT&&(this.wrapT=a.wrapT),"undefined"!==typeof a.topDown&&null!==a.topDown&&(this.topDown=a.topDown));return this};H3DU.TextureInfo._texInfoOrString=function(a){return"string"===typeof a?new H3DU.TextureInfo({uri:a}):a};H3DU.Transform=function(){this.scale=[1,1,1];this.position=[0,0,0];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=H3DU.Math.mat4identity()};H3DU.Transform.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],this.matrix[10]]:this.scale.slice(0,3)};H3DU.Transform.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};
H3DU.Transform.prototype.getQuaternion=function(){return this.complexMatrix?H3DU.Math.quatNormalizeInPlace(H3DU.Math.quatFromMat4(this.matrix)):this.rotation.slice(0,4)};H3DU.Transform.prototype.reset=function(){this.matrix=H3DU.Math.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;return this};
H3DU.Transform.prototype.setMatrix=function(a){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=H3DU.Math.quatFromMat4(this.matrix);this.rotation=H3DU.Math.quatNormalizeInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===
a[13]&&0===a[14]&&1===a[15];return this};H3DU.Transform.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&H3DU.Math.quatIsIdentity(this.rotation);return this._isIdentity};H3DU.Transform.prototype.resetTransform=function(){return this.reset()};
H3DU.Transform.prototype.setScale=function(a,b,c){if(this.complexMatrix)return this;this.scale="undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.setPosition=function(a,b,c){if(this.complexMatrix)return this;this.position="undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.movePosition=function(a,b,c){if(this.complexMatrix)return this;"undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?(this.position[0]+=a,this.position[1]+=b,this.position[2]+=c):"number"!==typeof a?(this.position[0]+=a[0],this.position[1]+=a[1],this.position[2]+=a[2]):(this.position[0]+=a,this.position[1]+=a,this.position[2]+=a);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];
this._matrixDirty=!0;return this};H3DU.Transform.prototype.setQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=a.slice(0,4);H3DU.Math.quatNormalizeInPlace(this.rotation);this._matrixDirty=!0;return this};H3DU.Transform.prototype.setRotation=function(a,b,c,d){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};H3DU.Transform.prototype.setOrientation=function(a,b,c,d){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};
H3DU.Transform.prototype.multQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=H3DU.Math.quatNormalizeInPlace(H3DU.Math.quatMultiply(this.rotation,a));this._matrixDirty=!0;return this};H3DU.Transform.prototype.multRotation=function(a,b,c,d){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};H3DU.Transform.prototype.multOrientation=function(a,b,c,d){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,d))};
H3DU.Transform.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,H3DU.Math.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=
H3DU.Math.mat4multiply(this.matrix,H3DU.Math.quatToMat4(this.rotation));H3DU.Math.mat4scaleInPlace(this.matrix,this.scale);var a=this.matrix;this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]}else if(this._isIdentity)return H3DU.Math.mat4identity();return this.matrix.slice(0,16)};
H3DU.Transform.prototype.copy=function(){var a=new H3DU.Transform;a.scale=this.scale.slice(0,this.scale.length);a.position=this.position.slice(0,this.scale.length);a.complexMatrix=this.complexMatrix;a._matrixDirty=this._matrixDirty;a.matrix=this.matrix.slice(0,this.matrix.length);return a};H3DU.Meshes={};
H3DU.Meshes.createBox=function(a,b,c,d){a*=.5;b*=.5;c*=.5;a=[-a,-b,c,-1,0,0,1,0,-a,b,c,-1,0,0,1,1,-a,b,-c,-1,0,0,0,1,-a,-b,-c,-1,0,0,0,0,a,-b,-c,1,0,0,1,0,a,b,-c,1,0,0,1,1,a,b,c,1,0,0,0,1,a,-b,c,1,0,0,0,0,a,-b,-c,0,-1,0,1,0,a,-b,c,0,-1,0,1,1,-a,-b,c,0,-1,0,0,1,-a,-b,-c,0,-1,0,0,0,a,b,c,0,1,0,1,0,a,b,-c,0,1,0,1,1,-a,b,-c,0,1,0,0,1,-a,b,c,0,1,0,0,0,-a,-b,-c,0,0,-1,1,0,-a,b,-c,0,0,-1,1,1,a,b,-c,0,0,-1,0,1,a,-b,-c,0,0,-1,0,0,a,-b,c,0,0,1,1,0,a,b,c,0,0,1,1,1,-a,b,c,0,0,1,0,1,-a,-b,c,0,0,1,0,0];if(d)for(d=
0;d<a.length;d+=8)a[d+3]=-a[d+3],a[d+4]=-a[d+4],a[d+5]=-a[d+5];return new H3DU.Mesh(a,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.TEXCOORDS_BIT)};
H3DU.Meshes.createCylinder=function(a,b,c,d,e,f,h){var g=new H3DU.Mesh;if("undefined"===typeof d||null===d)d=32;if("undefined"===typeof e||null===e)e=1;if(2>=d)throw Error("too few slices");if(1>e)throw Error("too few stacks");if(0>c)throw Error("negative height");if(0>=a&&0>=b||0===c)return g;for(var k=h?-1:1,m=[],l=[],n=H3DU.Math.PiTimes2/d,p=Math.cos(n),q=3.141592653589793>=n?Math.sqrt(1-p*p):-Math.sqrt(1-p*p),r=1,t=0,n=0;n<d;n++){var x=1*n/d;m.push(r,t);l.push(x);x=p*r+q*t;t=p*t-q*r;r=x}m.push(m[0],
m[1]);l.push(1);d*=2;if(0<c)for(p=0,q=a,a===b?(t=0,r=k):(n=a-b,r=c,t=Math.sqrt(r*r+n*n),0!==t&&(t=1/t,n*=t,r*=t),r*=k,t=n*k),k=1/e,n=0;n<e;n++){var x=p,w=n+1===e?1:(n+1)*k,y=c*x,u=c*w,z=q,B=a+(b-a)*w,p=w,q=B;g.mode(H3DU.Mesh.TRIANGLE_STRIP);g.texCoord2(1,x);g.normal3(m[0]*r,m[1]*r,t);g.vertex3(m[0]*z,m[1]*z,y);g.texCoord2(1,w);g.normal3(m[0]*r,m[1]*r,t);g.vertex3(m[0]*B,m[1]*B,u);for(var v=2,N=1;v<=d;v+=2,N++){var F=l[N],J,C;J=m[v];C=m[v+1];g.texCoord2(1-F,x);g.normal3(J*r,C*r,t);g.vertex3(J*z,C*
z,y);g.texCoord2(1-F,w);g.normal3(J*r,C*r,t);g.vertex3(J*B,C*B,u)}}return f?g.recalcNormals(f,h):g};
H3DU.Meshes.createLathe=function(a,b,c,d){var e=new H3DU.Mesh;if(4>a.length)throw Error("too few points");if("undefined"===typeof b||null===b)b=32;if(2>=b)throw Error("too few slices");if(0!==a.length%1)throw Error("points array length is not an even number");var f;for(f=0;f<a.length;f+=2)if(0>a[f<<1])throw Error("point's x is less than 0");var h=[],g=[];f=H3DU.Math.PiTimes2/b;var k=Math.cos(f),m=3.141592653589793>=f?Math.sqrt(1-k*k):-Math.sqrt(1-k*k),l=1,n=0;for(f=0;f<b;f++){var p=1*f/b;h.push(l,
n);g.push(p);p=k*l+m*n;n=k*n-m*l;l=p}h.push(h[0],h[1]);g.push(1);b*=2;var q=0,k=a.length/2-1,m=1/k;for(f=0;f<k;f++){var l=q,n=f+1===k?1:(f+1)*m,q=f<<1,r=a[q+1],t=a[q+3],p=Math.min(r,t),r=Math.max(r,t),t=a[q],x=a[q+2],q=n;e.mode(H3DU.Mesh.TRIANGLE_STRIP);e.texCoord2(1,l);e.vertex3(h[0]*t,h[1]*t,p);e.texCoord2(1,n);e.vertex3(h[0]*t,h[1]*x,r);for(var w=2,y=1;w<=b;w+=2,y++){var u=g[y],z,B;z=h[w];B=h[w+1];e.texCoord2(1-u,l);e.vertex3(z*t,B*t,p);e.texCoord2(1-u,n);e.vertex3(z*x,B*x,r)}}return e.recalcNormals(c,
d)};H3DU.Meshes.createClosedCylinder=function(a,b,c,d,e,f,h){e=H3DU.Meshes.createCylinder(a,b,c,d,e,f,h);a=H3DU.Meshes.createDisk(0,a,d,2,!h).reverseWinding();b=H3DU.Meshes.createDisk(0,b,d,2,h);b.transform(H3DU.Math.mat4translated(0,0,c));return e.merge(a).merge(b)};H3DU.Meshes.createDisk=function(a,b,c,d,e){return H3DU.Meshes.createPartialDisk(a,b,c,d,0,360,e)};
H3DU.Meshes.createPartialDisk=function(a,b,c,d,e,f,h){var g=new H3DU.Mesh;if("undefined"===typeof c||null===c)c=32;if("undefined"===typeof d||null===d)d=1;if("undefined"===typeof e||null===e)e=0;if("undefined"===typeof f||null===f)f=360;if(2>=c)throw Error("too few slices");if(1>d)throw Error("too few loops");if(a>b)throw Error("inner greater than outer");0>a&&(a=0);0>b&&(b=0);if(0===b||0===f)return g;var k=360===f&&0===e,m=0>f?-1:1;0>f&&(f=-f);f%=360;0===f&&(f=360);var l=[],n=[],p=H3DU.Math.PiTimes2;
f=360===f?p:f*H3DU.Math.PiDividedBy180;e*=H3DU.Math.PiDividedBy180;0>m&&(f=-f);var q=f/c,m=Math.cos(q),q=0<=q&&6.283185307179586>q?3.141592653589793>=q?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(q),r=Math.cos(e),t=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-r*r):-Math.sqrt(1-r*r):Math.sin(e),x=r,w=t;for(e=0;e<=c;e++){e===c&&f===p?l.push(w,x):l.push(t,r);n.push(1*e/c);var y=m*t+q*r,r=m*r-q*t,t=y}k&&(l[0]=0,l[1]=1,l[l.length-1]=1,l[l.length-2]=0,n[0]=0,n[n.length-1]=1);c*=2;k=b-a;n=
a;h?g.normal3(0,0,-1):g.normal3(0,0,1);for(e=0;e<d;e++)if(h=n,p=a+(e+1)/d*k,f=h/b,m=p/b,n=p,q=0===e&&0===a,g.mode(q?H3DU.Mesh.TRIANGLE_FAN:H3DU.Mesh.TRIANGLE_STRIP),q)for(r=c/2,q=c,x=r;0<=q;q-=2,x--)r=l[q],t=l[q+1],q===c&&(g.texCoord2(.5*(1+r*f),.5*(1+t*f)),g.vertex3(r*h,t*h,0)),g.texCoord2(.5*(1+r*m),.5*(1+t*m)),g.vertex3(r*p,t*p,0);else for(x=q=0;q<=c;q+=2,x++)r=l[q],t=l[q+1],g.texCoord2(.5*(1+r*m),.5*(1+t*m)),g.vertex3(r*p,t*p,0),g.texCoord2(.5*(1+r*f),.5*(1+t*f)),g.vertex3(r*h,t*h,0);return g};
H3DU.Meshes.createTorus=function(a,b,c,d,e,f){var h=new H3DU.Mesh;if("undefined"===typeof d||null===d)d=16;if("undefined"===typeof c||null===c)c=16;if(3>d)throw Error("crosswise is less than 3");if(3>c)throw Error("lengthwise is less than 3");if(0>a||0>b)throw Error("inner or outer is less than 0");if(0===b||0===a)return h;var g=[],k=[],m,l,n,p=H3DU.Math.PiTimes2/d;n=Math.cos(p);var q=0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(p);l=0;m=1;for(p=0;p<d;p++){g.push(l,
m);var r=n*l+q*m;m=n*m-q*l;l=r}g.push(g[0]);g.push(g[1]);p=H3DU.Math.PiTimes2/c;n=Math.cos(p);q=0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(p);l=0;m=1;for(p=0;p<c;p++)k.push(l,m),r=n*l+q*m,m=n*m-q*l,l=r;k.push(k[0]);k.push(k[1]);for(q=0;q<c;q++){r=q/c;m=(q+1)/c;l=k[2*q];var t=k[2*q+1],x=k[2*q+2],w=k[2*q+3];h.mode(H3DU.Mesh.TRIANGLE_STRIP);for(p=0;p<=d;p++){n=p/d;var y=g[2*p],u=g[2*p+1],z=u*(b+w*a),B=y*(b+w*a),v=x*a,N=w*u,F=w*y,J=x;h.normal3(N,F,J);h.texCoord2(n,
m);h.vertex3(z,B,v);z=u*(b+t*a);B=y*(b+t*a);v=l*a;N=t*u;F=t*y;J=l;h.normal3(N,F,J);h.texCoord2(n,r);h.vertex3(z,B,v)}}return e?h.recalcNormals(e,f):h};
H3DU.Meshes.createPlane=function(a,b,c,d,e){var f=new H3DU.Mesh;if("undefined"===typeof a||null===a)a=1;if("undefined"===typeof b||null===b)b=1;if("undefined"===typeof c||null===c)c=1;if("undefined"===typeof d||null===d)d=1;if(0>a||0>b)throw Error("width or height is less than 0");if(0>=d||0>=c)throw Error("widthDiv or heightDiv is 0 or less");if(0===a||0===b)return f;var h=.5*-a,g=.5*-b;e?f.normal3(0,0,-1):f.normal3(0,0,1);for(e=0;e<d;e++){f.mode(H3DU.Mesh.TRIANGLE_STRIP);var k=e/d,m=(e+1)/d,l=g+
b*k,n=g+b*m;f.texCoord2(0,m);f.vertex3(h,n,0);f.texCoord2(0,k);f.vertex3(h,l,0);for(var p=0;p<c;p++){var q=(p+1)/c,r=h+a*q;f.texCoord2(q,m);f.vertex3(r,n,0);f.texCoord2(q,k);f.vertex3(r,l,0)}}return f};H3DU.Meshes.createSphere=function(a,b,c,d,e){return H3DU.Meshes._createCapsule(a,0,b,c,1,d,e)};H3DU.Meshes.createCapsule=function(a,b,c,d,e,f,h){if("undefined"===typeof d||null===d)d=8;if(1>d)throw Error("too few stacks");return H3DU.Meshes._createCapsule(a,b,c,2*d,e,f,h)};
H3DU.Meshes._createCapsule=function(a,b,c,d,e,f,h){function g(a,b,c,d,e,f){a.normal3(c*b,d*b,e*b);a.vertex3(c,d,e+f)}var k=new H3DU.Mesh;if("undefined"===typeof c||null===c)c=16;if("undefined"===typeof d||null===d)d=16;if("undefined"===typeof e||null===e)e=1;if("undefined"===typeof a||null===a)a=1;if("undefined"===typeof b||null===b)b=1;if(2>d)throw Error("too few stacks");if(2>=c)throw Error("too few slices");if(1>e&&0<b)throw Error("too few middle stacks");if(0>b)throw Error("negative length");
if(0>a)throw Error("negative radius");if(0===a)return k;var m,l,n=.5*b,p=d/2,q=h?-1:1,r=[],t=[],x=[],w=[],y,u=H3DU.Math.PiTimes2/c,z=Math.cos(u),B=0<=u&&6.283185307179586>u?3.141592653589793>=u?Math.sqrt(1-z*z):-Math.sqrt(1-z*z):Math.sin(u);l=1;for(u=m=0;u<c;u++){var v=1*u/c;r.push(l,m);w.push(v);v=z*m-B*l;l=z*l+B*m;m=v}r.push(r[0],r[1]);w.push(1);var v=2*a,v=v/(v+b),N=[],u=Math.PI/d,z=Math.cos(u);l=B=0<=u&&6.283185307179586>u?3.141592653589793>=u?Math.sqrt(1-z*z):-Math.sqrt(1-z*z):Math.sin(u);m=
z;for(u=0;u<d;u++){w=1*(u+1)/d;t.push(l);N.push(-m);x.push(w);var F=z*l+B*m,w=z*m-B*l;l=F;m=w}c*=2;var z=-1,J=m=0;l=r[0];B=r[1];for(u=0;u<d;u++){var C=N[u],G=x[u];y=a*z;var F=a*C,K=u<p?-n:n,L=m,A=a*t[u],D=J,E=G;0<b&&(D=u<p?J*v:1-(1-J)*v,E=u<p?G*v:1-(1-G)*v);z=C;J=G;m=A;u===d-1||0===u?k.mode(H3DU.Mesh.TRIANGLES):(k.mode(H3DU.Mesh.TRIANGLE_STRIP),k.texCoord2(1,D),g(k,q,l*L,B*L,y,K),k.texCoord2(1,E),g(k,q,l*A,B*A,F,K));for(var M=0,P=l,I=B,H,O,G=2,T=1;G<=c;G+=2,T++)C=w[T],u===d-1?(H=M+.5*(C-M),k.texCoord2(1-
M,D),g(k,q,P*L,I*L,y,K),k.texCoord2(1-H,E),g(k,q,l*A,B*A,F,K),H=r[G],O=r[G+1],k.texCoord2(1-C,D),g(k,q,H*L,O*L,y,K),P=H,I=O,M=C):0===u?(H=M+.5*(C-M),k.texCoord2(1-H,D),g(k,q,l*L,B*L,y,K),k.texCoord2(1-M,E),g(k,q,P*A,I*A,F,K),H=r[G],O=r[G+1],k.texCoord2(1-C,E),g(k,q,H*A,O*A,F,K),P=H,I=O,M=C):(H=r[G],O=r[G+1],k.texCoord2(1-C,D),g(k,q,H*L,O*L,y,K),k.texCoord2(1-C,E),g(k,q,H*A,O*A,F,K));if(u+1===p&&0<b)for(K=.5*v,L=2*n,M=1-K,P=1-v,I=0;I<e;I++){y=-n+(0===I?0:L*I/e);var U=I===e-1?n:-n+L*(I+1)/e,D=K+(0===
I?0:P*I/e),E=I===e-1?M:K+P*(I+1)/e;k.mode(H3DU.Mesh.TRIANGLE_STRIP);k.texCoord2(1,D);g(k,q,l*A,B*A,F,y);k.texCoord2(1,E);g(k,q,l*A,B*A,F,U);G=2;for(T=1;G<=c;G+=2,T++)C=w[T],H=r[G],O=r[G+1],k.texCoord2(1-C,D),g(k,q,H*A,O*A,F,y),k.texCoord2(1-C,E),g(k,q,H*A,O*A,F,U)}}return f?k.recalcNormals(f,h):k.normalizeNormals()};
H3DU.Meshes.createPointedStar=function(a,b,c,d){var e=new H3DU.Mesh;if(2>a||0>b||0>c||0>=b&&0>=c)return e;e.mode(H3DU.Mesh.TRIANGLE_FAN);var f=0,h=0,g=1/Math.max(b,c);e.normal3(0,0,d?-1:1).texCoord2(.5,.5).vertex2(0,0);var k=H3DU.Math.PiTimes2/(2*a);d=Math.cos(k);for(var k=3.141592653589793>=k?Math.sqrt(1-d*d):-Math.sqrt(1-d*d),m=0,l=1,n=0;n<2*a;n++){var p=0===(n&1)?b:c,q=-m*p,p=l*p,r=.5*(1+q*g),t=.5*(1+p*g);0===n&&(f=q,h=p);e.texCoord2(r,t).vertex2(q,p);q=d*l-k*m;m=d*m+k*l;l=q}e.texCoord2(.5*(1+
f*g),.5*(1+h*g)).vertex2(f,h);return e};H3DU.Scene3D=function(a){var b=a;"function"===typeof a.getContext&&(b=HTMLCanvasElement&&b.constructor===HTMLCanvasElement?H3DU.get3DContext(a):H3DU._toContext(b));this.context=b;this.textureCache={};this._textureLoader=new H3DU.TextureLoader;this._meshLoader=new H3DU.BufferedMesh._MeshLoader;this._renderedOutsideScene=!1;this.shapes=[];this._errors=!1;this._frontFace=H3DU.Scene3D.CCW;this._cullFace=H3DU.Scene3D.NONE;this.clearColor=[0,0,0,1];this.fboFilter=null;this._subScene=new H3DU.Batch3D;this._subScene.getLights().setBasic();
this._programs=new H3DU.Scene3D.ProgramCache;this.useDevicePixelRatio=!1;this._is3d=H3DU.is3DContext(this.context);this._pixelRatio=1;this.autoResize=!0;this.width=Math.ceil(1*this.context.canvas.clientWidth);this.height=Math.ceil(1*this.context.canvas.clientHeight);this.context.canvas.width=this.width;this.context.canvas.height=this.height;this._is3d&&(this.context.viewport(0,0,this.width,this.height),this.context.enable(this.context.BLEND),this.context.blendFunc(this.context.SRC_ALPHA,this.context.ONE_MINUS_SRC_ALPHA),
this.context.enable(this.context.DEPTH_TEST),this.context.depthFunc(this.context.LEQUAL),this.context.disable(this.context.CULL_FACE),this.context.clearDepth(1),this._setClearColor(),this._setFace())};H3DU.Scene3D.prototype.getCanvas=function(){return this.context?this.context.canvas:null};H3DU.Scene3D.LIGHTING_ENABLED=1;H3DU.Scene3D.SPECULAR_MAP_ENABLED=2;H3DU.Scene3D.NORMAL_MAP_ENABLED=4;H3DU.Scene3D.SPECULAR_ENABLED=8;H3DU.Scene3D.TEXTURE_ENABLED=16;H3DU.Scene3D.COLORATTR_ENABLED=32;
H3DU.Scene3D.ROUGHNESS_ENABLED=64;H3DU.Scene3D.ROUGHNESS_MAP_ENABLED=128;H3DU.Scene3D.METALNESS_ENABLED=256;H3DU.Scene3D.METALNESS_MAP_ENABLED=512;H3DU.Scene3D.PHYSICAL_BASED_ENABLED=1024;H3DU.Scene3D.INVERT_ROUGHNESS_ENABLED=2048;H3DU.Scene3D.ENV_MAP_ENABLED=4096;H3DU.Scene3D.ENV_EQUIRECT_ENABLED=8192;H3DU.Scene3D.EMISSION_MAP_ENABLED=16384;
H3DU.Scene3D._flagsForShape=function(a){var b=0,c=a.material;"undefined"!==typeof c&&null!==c&&c instanceof H3DU.Material&&(b|=H3DU.Scene3D.LIGHTING_ENABLED,b|=0!==c.specular[0]||0!==c.specular[1]||0!==c.specular[2]?H3DU.Scene3D.SPECULAR_ENABLED:0,b|=c.specularMap?H3DU.Scene3D.SPECULAR_MAP_ENABLED:0,b|=c.normalMap?H3DU.Scene3D.NORMAL_MAP_ENABLED:0,b|=c.texture?H3DU.Scene3D.TEXTURE_ENABLED:0,b|=c.emissionMap?H3DU.Scene3D.EMISSION_MAP_ENABLED:0);"undefined"!==typeof c&&null!==c&&c instanceof H3DU.PbrMaterial&&
(b|=H3DU.Scene3D.LIGHTING_ENABLED|H3DU.Scene3D.PHYSICAL_BASED_ENABLED,c.workflow===H3DU.PbrMaterial.Metallic?(b|="number"===typeof c.metalness?H3DU.Scene3D.METALNESS_ENABLED:0,b|=c.metalnessMap?H3DU.Scene3D.METALNESS_MAP_ENABLED:0):(b|=c.specular?H3DU.Scene3D.SPECULAR_ENABLED:0,b|=c.specularMap?H3DU.Scene3D.SPECULAR_MAP_ENABLED:0),b|=c.normalMap?H3DU.Scene3D.NORMAL_MAP_ENABLED:0,b|=c.emissionMap?H3DU.Scene3D.EMISSION_MAP_ENABLED:0,b|=c.albedoMap?H3DU.Scene3D.TEXTURE_ENABLED:0,b|=!0===c.invertRoughness?
H3DU.Scene3D.INVERT_ROUGHNESS_ENABLED:0,b|="number"===typeof c.roughness?H3DU.Scene3D.ROUGHNESS_ENABLED:0,b|=c.roughnessMap?H3DU.Scene3D.ROUGHNESS_MAP_ENABLED:0,"undefined"!==typeof c.environmentMap&&null!==c.environmentMap&&(b=c.environmentMap instanceof H3DU.CubeMap?b|H3DU.Scene3D.ENV_MAP_ENABLED:b|H3DU.Scene3D.ENV_EQUIRECT_ENABLED));(a=a.getMeshBuffer())&&a._getAttribute(H3DU.Semantic.COLOR)&&(b|=H3DU.Scene3D.COLORATTR_ENABLED);return b};
H3DU.Scene3D.ProgramCache=function(){this._programs=[];this._customPrograms=[]};H3DU.Scene3D.ProgramCache.prototype.dispose=function(){var a,b;for(a=0;a<this._customPrograms.length;a++)b=this._customPrograms[a],b[2].dispose();for(a=0;a<this._programs.length;a++)(b=this._programs[a])&&b.dispose();this._customPrograms=[];this._programs=[]};
H3DU.Scene3D.ProgramCache.prototype.getCustomProgram=function(a,b){if(!b)throw Error();if(!H3DU.is3DContext(b))return null;if(a instanceof H3DU.ShaderProgram)return a;for(var c=0;c<this._customPrograms.length;c++){var d=this._customPrograms[c];if(d[0]===a&&d[1]===b)return d[2]._update(),d[2]}c=H3DU.ShaderProgram._fromShaderInfo(b,a);this._customPrograms.push([a,b,c]);return c};
H3DU.Scene3D.ProgramCache.prototype.getProgram=function(a,b){if(!b)throw Error();if(!H3DU.is3DContext(b))return null;var c=this._programs[a];if(c)for(var d=0;d<c.length;d++){if(c[d][0]===b)return c[d][1]}else this._programs[a]=[];c="";0!==(a&H3DU.Scene3D.LIGHTING_ENABLED)&&(c+="#define SHADING\n");0!==(a&H3DU.Scene3D.SPECULAR_ENABLED)&&(c+="#define SPECULAR\n");0!==(a&H3DU.Scene3D.PHYSICAL_BASED_ENABLED)&&(c+="#define PHYSICAL_BASED\n");0!==(a&H3DU.Scene3D.METALNESS_ENABLED)&&(c+="#define METALNESS\n");
0!==(a&H3DU.Scene3D.METALNESS_MAP_ENABLED)&&(c+="#define METALNESS_MAP\n");0!==(a&H3DU.Scene3D.ROUGHNESS_ENABLED)&&(c+="#define ROUGHNESS\n");0!==(a&H3DU.Scene3D.ROUGHNESS_MAP_ENABLED)&&(c+="#define ROUGHNESS_MAP\n");0!==(a&H3DU.Scene3D.NORMAL_MAP_ENABLED)&&(c+="#define NORMAL_MAP\n");0!==(a&H3DU.Scene3D.TEXTURE_ENABLED)&&(c+="#define TEXTURE\n");0!==(a&H3DU.Scene3D.COLORATTR_ENABLED)&&(c+="#define COLORATTR\n");0!==(a&H3DU.Scene3D.INVERT_ROUGHNESS_ENABLED)&&(c+="#define INVERT_ROUGHNESS\n");0!==
(a&H3DU.Scene3D.ENV_MAP_ENABLED)&&(c+="#define ENV_MAP\n");0!==(a&H3DU.Scene3D.ENV_EQUIRECT_ENABLED)&&(c+="#define ENV_EQUIRECT\n");0!==(a&H3DU.Scene3D.EMISSION_MAP_ENABLED)&&(c+="#define EMISSION_MAP\n");0!==(a&H3DU.Scene3D.SPECULAR_MAP_ENABLED)&&(c+="#define SPECULAR_MAP\n#define SPECULAR\n");c=new H3DU.ShaderProgram(b,c+H3DU.ShaderProgram.getDefaultVertex(),c+H3DU.ShaderProgram.getDefaultFragment());this._programs[a].push([b,c]);return c};H3DU.Scene3D.prototype.getContext=function(){return this.context};
H3DU.Scene3D.NONE=0;H3DU.Scene3D.BACK=1;H3DU.Scene3D.FRONT=2;H3DU.Scene3D.FRONT_AND_BACK=3;H3DU.Scene3D.CCW=0;H3DU.Scene3D.CW=1;H3DU.Scene3D.prototype.cullFace=function(a){this._cullFace=a===H3DU.Scene3D.BACK||a===H3DU.Scene3D.FRONT||a===H3DU.Scene3D.FRONT_AND_BACK?a:0;return this};
H3DU.Scene3D.prototype._setFace=function(){if(this._is3d)return this._cullFace===H3DU.Scene3D.BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.BACK)):this._cullFace===H3DU.Scene3D.FRONT?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT)):this._cullFace===H3DU.Scene3D.FRONT_AND_BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT_AND_BACK)):this.context.disable(this.context.CULL_FACE),this._frontFace===
H3DU.Scene3D.CW?this.context.frontFace(this.context.CW):this.context.frontFace(this.context.CCW),this};H3DU.Scene3D.prototype.frontFace=function(a){this._frontFace=a===H3DU.Scene3D.CW?a:0;return this};H3DU.Scene3D.prototype.setAutoResize=function(a){this.autoResize=!!a;return this};H3DU.Scene3D.prototype.getAutoResize=function(){return!!this.autoResize};
H3DU.Scene3D.prototype.setUseDevicePixelRatio=function(a){var b=!!this.useDevicePixelRatio;this._pixelRatio=(this.useDevicePixelRatio=!!a)&&window.devicePixelRatio?window.devicePixelRatio:1;b!==this.useDevicePixelRatio&&this.setDimensions(this.width,this.height);return this};H3DU.Scene3D.prototype.getClearColor=function(){return this.clearColor.slice(0,4)};H3DU.Scene3D.prototype.useProgram=function(){console.warn("The 'useProgram' method is obsolete.  Instead of this method, use the 'setShader' program of individual shapes to set the shader programs they use.")};
H3DU.Scene3D.prototype.setDimensions=function(a,b){if(0>a||0>b)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(b);this.context.canvas.width=this.width*this._pixelRatio;this.context.canvas.height=this.height*this._pixelRatio;this._is3d&&this.context.viewport(0,0,this.width*this._pixelRatio,this.height*this._pixelRatio);"undefined"!==typeof this.fbo&&this.fbo&&(this.fbo.dispose(),this.fbo=this.createBuffer())};H3DU.Scene3D.prototype.getWidth=function(){return this.width};
H3DU.Scene3D.prototype.getHeight=function(){return this.height};H3DU.Scene3D.prototype.getAspect=function(){var a=this.getHeight();return 0>=a?1:this.getWidth()/a};H3DU.Scene3D.prototype.getClientWidth=function(){return this.context.canvas.clientWidth};H3DU.Scene3D.prototype.getClientHeight=function(){return this.context.canvas.clientHeight};H3DU.Scene3D.prototype.getClientAspect=function(){var a=this.getClientHeight();return 0>=a?1:this.getClientWidth()/a};
H3DU.Scene3D.prototype.createBuffer=function(){return new H3DU.FrameBuffer(this.context,this.getWidth(),this.getHeight())};H3DU.Scene3D.prototype.getProjectionMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene._projectionMatrix.slice(0,16)};
H3DU.Scene3D.prototype.getViewMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._viewMatrix.slice(0,16)};H3DU.Scene3D.prototype.setPerspective=function(a,b,c,d){return this.setProjectionMatrix(H3DU.Math.mat4perspective(a,b,c,d))};
H3DU.Scene3D.prototype.setOrthoAspect=function(a,b,c,d,e,f,h){if("undefined"===typeof h||null===h)h=this.getClientAspect();0===h&&(h=1);return this.setProjectionMatrix(H3DU.Math.mat4orthoAspect(a,b,c,d,e,f,h))};H3DU.Scene3D.prototype.setOrtho2DAspect=function(a,b,c,d,e){return this.setOrthoAspect(a,b,c,d,-1,1,e)};H3DU.Scene3D.prototype.setFrustum=function(a,b,c,d,e,f){return this.setProjectionMatrix(H3DU.Math.mat4frustum(a,b,d,c,e,f))};
H3DU.Scene3D.prototype.setOrtho=function(a,b,c,d,e,f){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,b,c,d,e,f))};H3DU.Scene3D.prototype.setOrtho2D=function(a,b,c,d){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,b,c,d,-1,1))};H3DU.Scene3D.prototype._setClearColor=function(){this._is3d&&this.context.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);return this};
H3DU.Scene3D.prototype.dispose=function(){this.context=null;this._programs&&this._programs.dispose();this._textureLoader&&this._textureLoader.dispose();this._meshLoader&&this._meshLoader.dispose();this._meshLoader=this._textureLoader=this._programs=null};H3DU.Scene3D.prototype.setClearColor=function(a,b,c,d){this.clearColor=H3DU.toGLColor(a,b,c,d);return this._setClearColor()};H3DU.Scene3D.prototype.loadTexture=function(a){return this._textureLoader.loadTexture(a)};
H3DU.Scene3D.prototype.loadAndMapTexture=function(a){if(a.constructor===H3DU.Texture)return this._textureLoader.loadAndMapTexture(a.name,this.context);if("string"===typeof a)return this._textureLoader.loadAndMapTexture(a,this.context)};H3DU.Scene3D.prototype.loadAndMapTextures=function(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(this.loadAndMapTexture(a[e]));return H3DU.getPromiseResults(d,b,c)};
H3DU.Scene3D.prototype.clear=function(){this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT|this.context.STENCIL_BUFFER_BIT);return this};H3DU.Scene3D.prototype.clearDepth=function(){this._is3d&&this.context.clear(this.context.DEPTH_BUFFER_BIT);return this};H3DU.Scene3D.prototype.vertexCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.vertexCount()};
H3DU.Scene3D.prototype.primitiveCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.primitiveCount()};H3DU.Scene3D.prototype.setProjectionMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setProjectionMatrix(a);return this};
H3DU.Scene3D.prototype.setViewMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setViewMatrix(a);return this};H3DU.Scene3D.prototype.setLookAt=function(a,b,c){return this.setViewMatrix(H3DU.Math.mat4lookat(a,b,c))};
H3DU.Scene3D.prototype.addShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.addShape(a);this.shapes.push(a);return this};H3DU.Scene3D.prototype.makeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return new H3DU.Shape(a)};
H3DU.Scene3D.prototype.removeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.removeShape(a);for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};
H3DU.Scene3D.prototype.getLights=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.getLights()};H3DU.Scene3D.prototype.setDirectionalLight=function(a,b,c,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setDirectionalLight(a,b,c,d);return this};
H3DU.Scene3D.prototype.setLightParams=function(a,b){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setParams(a,b);return this};H3DU.Scene3D.prototype.setAmbient=function(a,b,c,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setAmbient(a,b,c,d);return this};
H3DU.Scene3D.prototype.setPointLight=function(a,b,c,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setPointLight(a,b,c,d);return this};H3DU.Scene3D.prototype._clearForPass=function(a){var b=0;a.clearColor&&(b|=this.context.COLOR_BUFFER_BIT);a.clearDepth&&(b|=this.context.DEPTH_BUFFER_BIT);a.clearStencil&&(b|=this.context.STENCIL_BUFFER_BIT);this._is3d&&0!==b&&this.context.clear(b)};
H3DU.Scene3D.prototype.render=function(a){if(a instanceof H3DU.Batch3D)return this.render([new H3DU.RenderPass3D(a)]);if(this.autoResize){var b=this.context.canvas;b.height===Math.ceil(b.clientHeight)*this._pixelRatio&&b.width===Math.ceil(b.clientWidth)*this._pixelRatio||this.setDimensions(b.clientWidth,b.clientHeight)}this._setFace();var b=this.getClientWidth(),c=this.getClientHeight();if("undefined"===typeof a||null===a){this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT);
a=this._subScene.shapes;var d=[],d=d.concat(this.shapes);this._subScene.shapes=d;this._subScene.resize(b,c);this._subScene.render(this);this._subScene.shapes=a}else{this._renderedOutsideScene=!0;for(var d=this.getWidth(),e=this.getHeight(),f=0;f<a.length;f++){var h=a[f],g=!1,k=b,m=c;h.frameBuffer&&(h.useFrameBufferSize&&(g=!0,k=h.frameBuffer.getWidth(),m=h.frameBuffer.getHeight(),this.setDimensions(k,m)),this._textureLoader.bindFrameBuffer(h.frameBuffer,this.context,0));this._clearForPass(h);a[f].batch.resize(k,
m);a[f].batch.render(this,h);h.frameBuffer&&(g&&this.setDimensions(d,e),this._textureLoader.unbindFrameBuffer(h.frameBuffer,this.context))}}return this};
H3DU.Scene3D.prototype.useFilter=function(a){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");console.warn("The useFilter method is deprecated. Use the {@link H3DU.Batch3D.forFilter} method to create a batch for rendering filter effects from a frame buffer.");a instanceof H3DU.ShaderProgram?this._subScene._useShader(a.shaderInfo):this._subScene._useShader(a);return this};H3DU.Lights=function(){this.lights=[];this.sceneAmbient=[.2,.2,.2]};H3DU.Lights.prototype.setBasic=function(){this.lights=[(new H3DU.LightSource).setParams({ambient:[0,0,0,1],position:[0,0,1,0],diffuse:[1,1,1,1],specular:[1,1,1],radius:0})];this.sceneAmbient=[.2,.2,.2];return this};H3DU.Lights.MAX_LIGHTS=3;H3DU.Lights._createNewLight=function(a){var b=new H3DU.LightSource;0!==a&&(b.diffuse=[0,0,0,0],b.specular=[0,0,0]);return b};H3DU.Lights.prototype.getCount=function(){return this.lights.length};
H3DU.Lights.prototype.getLight=function(a){var b=this.lights.length;this.lights[a]||(this.lights[a]=H3DU.Lights._createNewLight(a));if(2<=this.lights.length-b)for(;b<this.lights.length;b++)this.lights[b]||(this.lights[b]=H3DU.Lights._createNewLight(b));return this.lights[a]};H3DU.Lights.prototype.setParams=function(a,b){this.getLight(a).setParams(b);return this};
H3DU.Lights.prototype.setDirectionalLight=function(a,b,c,d){b=this.setParams(a,{position:[b[0],b[1],b[2],0]});"undefined"!==typeof c&&null!==c&&(b=b.setParams(a,{diffuse:c}));"undefined"!==typeof d&&null!==d&&(b=b.setParams(a,{specular:d}));return b};H3DU.Lights.prototype.setPointLight=function(a,b,c,d){b=this.setParams(a,{position:[b[0],b[1],b[2],1]});"undefined"!==typeof c&&null!==c&&(b=b.setParams(a,{diffuse:c}));"undefined"!==typeof d&&null!==d&&(b=b.setParams(a,{specular:d}));return b};
H3DU.Lights.prototype.setAmbient=function(a,b,c,d){this.sceneAmbient=H3DU.toGLColor(a,b,c,d);return this};H3DU.Batch3D=function(){this._projectionMatrix=H3DU.Math.mat4identity();this._viewMatrix=H3DU.Math.mat4identity();this.lights=new H3DU.Lights;this._frustum=this._globalShader=this._projectionUpdater=null;this.shapes=[]};
H3DU.Batch3D._PerspectiveView=function(a,b,c,d){this.fov=b;this.near=c;this.far=d;this.batch=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c===this.lastAspect||isNaN(c)||(this.lastAspect=c,this.batch.setProjectionMatrix(H3DU.Math.mat4perspective(this.fov,c,this.near,this.far)))};this.update(1,1)};
H3DU.Batch3D._OrthoView=function(a,b,c,d,e,f,h){this.a=b;this.b=c;this.c=d;this.d=e;this.e=f;this.f=h;this.batch=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c===this.lastAspect||isNaN(c)||(this.lastAspect=c,this.batch.setProjectionMatrix(H3DU.Math.mat4orthoAspect(this.a,this.b,this.c,this.d,this.e,this.f,c)))};this.update(1,1)};
H3DU.Batch3D._setupMatrices=function(a,b,c,d){var e={},f=null,h;for(h in a.uniformSemantics)if(Object.prototype.hasOwnProperty.call(a.uniformSemantics,h)){var g=a.uniformSemantics[h];switch(g){case H3DU.Semantic.MODEL:e[h]=d;break;case H3DU.Semantic.VIEW:e[h]=c;break;case H3DU.Semantic.PROJECTION:e[h]=b;break;case H3DU.Semantic.MODELVIEW:case H3DU.Semantic.MODELVIEWPROJECTION:case H3DU.Semantic.MODELVIEWINVERSETRANSPOSE:f||(H3DU._isIdentityExceptTranslate(c)?(f=d.slice(0,16),f[12]+=c[12],f[13]+=c[13],
f[14]+=c[14]):f=H3DU.Math.mat4multiply(c,d));g===H3DU.Semantic.MODELVIEW?e[h]=f:g===H3DU.Semantic.MODELVIEWPROJECTION?e[h]=H3DU.Math.mat4multiply(b,f):g===H3DU.Semantic.MODELVIEWINVERSETRANSPOSE&&(e[h]=H3DU.Math.mat4inverseTranspose3(f));break;case H3DU.Semantic.VIEWINVERSE:e[h]=H3DU.Math.mat4invert(c)}}a.setUniforms(e)};
H3DU.Batch3D._isSameMatrix=function(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]&&a[6]===b[6]&&a[7]===b[7]&&a[8]===b[8]&&a[9]===b[9]&&a[10]===b[10]&&a[11]===b[11]&&a[12]===b[12]&&a[13]===b[13]&&a[14]===b[14]&&a[15]===b[15]};H3DU.Batch3D.prototype.setProjectionMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._projectionMatrix,a)||(this._projectionMatrix=a.slice(0,16),this._frustum=null);return this};
H3DU.Batch3D.prototype.perspectiveAspect=function(a,b,c){this._projectionUpdater=new H3DU.Batch3D._PerspectiveView(this,a,b,c);return this};H3DU.Batch3D.prototype.setLookAt=function(a,b,c){return this.setViewMatrix(H3DU.Math.mat4lookat(a,b,c))};H3DU.Batch3D.prototype.orthoAspect=function(a,b,c,d,e,f){this._projectionUpdater=new H3DU.Batch3D._OrthoView(this,a,b,c,d,e,f);return this};H3DU.Batch3D.prototype.ortho2DAspect=function(a,b,c,d){return this.orthoAspect(a,b,c,d,-1,1)};
H3DU.Batch3D.prototype._useShader=function(a){this._globalShader=a;return this};H3DU.Batch3D.prototype.setViewMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._viewMatrix,a)||(this._viewMatrix=a.slice(0,16),this._frustum=null);return this};H3DU.Batch3D.prototype.getProjectionMatrix=function(){return this._projectionMatrix.slice(0,16)};H3DU.Batch3D.prototype.getProjectionViewMatrix=function(){return H3DU.Math.mat4multiply(this.getProjectionMatrix(),this.getViewMatrix())};
H3DU.Batch3D.prototype.getViewMatrix=function(){return this._viewMatrix.slice(0,16)};H3DU.Batch3D.prototype._getFrustum=function(){if("undefined"===typeof this._frustum||null===this._frustum){var a=H3DU.Math.mat4multiply(this._projectionMatrix,this._viewMatrix);this._frustum=H3DU.Math.mat4toFrustumPlanes(a)}return this._frustum};H3DU.Batch3D.prototype.getLights=function(){return this.lights};H3DU.Batch3D.prototype.addShape=function(a){if(!a)throw Error();a.parent=null;this.shapes.push(a);return this};
H3DU.Batch3D.prototype.shapeCount=function(){return this.shapes.length};H3DU.Batch3D.prototype.getShape=function(a){return"undefined"===typeof this.shapes[a]?null:this.shapes[a]};H3DU.Batch3D.prototype.setShape=function(a,b){this.shapes[a]=b;return this};H3DU.Batch3D.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};
H3DU.Batch3D.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};H3DU.Batch3D.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};
H3DU.Batch3D.prototype._renderShape=function(a,b){if(a.constructor===H3DU.ShapeGroup){if(a.visible)for(var c=0;c<a.shapes.length;c++)this._renderShape(a.shapes[c],b)}else if(!a.isCulled(this._getFrustum())){var c=null,d;"undefined"!==typeof b.shader&&null!==b.shader?c=b.scene._programs.getCustomProgram(b.shader,b.context):"undefined"!==typeof this._globalShader&&null!==this._globalShader?c=b.scene._programs.getCustomProgram(this._globalShader,b.context):(a.material instanceof H3DU.Material||a.material instanceof
H3DU.PbrMaterial)&&null!==a.material.shader&&(c=b.scene._programs.getCustomProgram(a.material.shader,b.context));d=H3DU.Scene3D._flagsForShape(a);if("undefined"===typeof c||null===c)c=b.scene._programs.getProgram(d,b.context);"undefined"!==typeof c&&null!==c&&(b.prog!==c&&(c.use(),(new H3DU._LightsBinder(this.lights)).bind(c,this._viewMatrix),b.prog=c),H3DU.Batch3D._setupMatrices(c,this._projectionMatrix,this._viewMatrix,a.getMatrix()),H3DU.Batch3D._getMaterialBinder(a.material).bind(c,b.context,
b.scene._textureLoader),b.scene._meshLoader.draw(a.meshBuffer,c))}};H3DU.Batch3D.prototype.resize=function(a,b){this._projectionUpdater&&this._projectionUpdater.update(a,b)};H3DU.Batch3D.prototype.render=function(a,b){var c={};c.scene=a;c.context=a.getContext();c.shader=b?b.shader:null;for(var d=0;d<this.shapes.length;d++)this._renderShape(this.shapes[d],c);return this};
H3DU.Batch3D.forFilter=function(a,b,c){if("undefined"===typeof c||null===c)c=H3DU.ShaderProgram.makeCopyEffect(a);a=new H3DU.Batch3D;var d=new H3DU.Mesh([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0],[0,1,2,2,1,3],H3DU.Mesh.TEXCOORDS_BIT),d=new H3DU.Shape(d);d.setTexture(b);d.setShader(c);a.addShape(d);return a};H3DU.Batch3D._getMaterialBinder=function(a){return a&&a instanceof H3DU.Material||a&&a instanceof H3DU.PbrMaterial?new H3DU._MaterialBinder(a):{}};H3DU.Material=function(a,b,c,d,e){this.shininess=32;this.ambient=[.2,.2,.2];this.diffuse=[.8,.8,.8,1];this.specular=[.2,.2,.2];this.emission=[0,0,0];this.shader=this.emissionMap=this.normalMap=this.specularMap=this.texture=null;!a||a.constructor!==Array&&"string"!==typeof a?"undefined"!==typeof a&&null!==a&&this.setParams(a):this.setParams({ambient:a,diffuse:b,specular:c,shininess:d,emission:e})};
H3DU.Material.prototype.copy=function(){return(new H3DU.Material).setParams({ambient:this.ambient,diffuse:this.diffuse,specular:this.specular,shininess:this.shininess,emission:this.emission,texture:this.texture,specularMap:this.specularMap,normalMap:this.normalMap,shader:this.shader})};H3DU.Material.fromBasic=function(a){return new H3DU.Material({shininess:1,specular:[0,0,0],diffuse:[0,0,0],ambient:[0,0,0],texture:null,specularMap:null,normalMap:null,emission:a,emissionMap:null})};
H3DU.Material.fromBasicTexture=function(a){return new H3DU.Material({shininess:1,specular:[0,0,0],diffuse:[0,0,0],ambient:[0,0,0],texture:null,specularMap:null,normalMap:null,emission:[0,0,0],emissionMap:a})};
H3DU.Material.prototype.setParams=function(a){"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),3<this.ambient.length&&(this.ambient=this.ambient.slice(0,3)));"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse),4<this.diffuse.length&&(this.diffuse=this.diffuse.slice(0,4)));"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular),3<this.specular.length&&(this.specular=this.specular.slice(0,
3)));"undefined"!==typeof a.emission&&null!==a.emission&&(this.emission=H3DU.toGLColor(a.emission),3<this.emission.length&&(this.emission=this.emission.slice(0,3)));"undefined"!==typeof a.shininess&&null!==a.shininess&&(this.shininess=Math.min(Math.max(0,a.shininess),128));"undefined"!==typeof a.texture&&(this.texture=H3DU.TextureInfo._texInfoOrString(a.texture));"undefined"!==typeof a.specularMap&&(this.specularMap=H3DU.TextureInfo._texInfoOrString(a.specularMap));"undefined"!==typeof a.normalMap&&
(this.normalMap=H3DU.TextureInfo._texInfoOrString(a.normalMap));"undefined"!==typeof a.emissionMap&&(this.emissionMap=H3DU.TextureInfo._texInfoOrString(a.emissionMap));"undefined"!==typeof a.shader&&null!==a.shader&&(this.shader=a.shader);return this};H3DU.Material.fromColor=function(a,b,c,d){a=H3DU.toGLColor(a,b,c,d);return new H3DU.Material(a,a)};H3DU.Material.fromTexture=function(a){return new H3DU.Material({texture:a})};H3DU.FrameBufferInfo=function(a,b){if(0>a||0>b)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(b)};H3DU.FrameBufferInfo.prototype.resize=function(a,b){if(0>a||0>b)throw Error("width or height negative");a=Math.ceil(a);b=Math.ceil(b);this.width=a;this.height=b;return this};H3DU.FrameBufferInfo.prototype.getWidth=function(){return this.width};H3DU.FrameBufferInfo.prototype.getHeight=function(){return this.height};H3DU._MaterialBinder=function(a){this.mshade=a};H3DU._MaterialBinder._textureSizeZeroZero=[0,0];
H3DU._MaterialBinder.prototype.bind=function(a,b,c){if(!this.mshade)return this;var d=this.mshade,e="undefined"!==typeof d.albedo&&null!==d.albedo?d.albedo:d.diffuse,e={textureSize:H3DU._MaterialBinder._textureSizeZeroZero,md:4===e.length?e:[e[0],e[1],e[2],4>e.length?1:e[3]]};d.basic||("undefined"!==typeof d.shininess&&null!==d.shininess&&(e.mshin=d.shininess),"undefined"!==typeof d.metalness&&null!==d.metalness&&(e.metalness=d.metalness),"undefined"!==typeof d.roughness&&null!==d.roughness&&(e.roughness=
d.roughness),"undefined"!==typeof d.ambient&&null!==d.ambient&&(e.ma=3===d.ambient.length?d.ambient:[d.ambient[0],d.ambient[1],d.ambient[2]]),e.ms=3===d.specular.length?d.specular:[d.specular[0],d.specular[1],d.specular[2]],e.me=3===d.emission.length?d.emission:[d.emission[0],d.emission[1],d.emission[2]]);a.setUniforms(e);var e=0,f=[];f.push(["undefined"===typeof d.albedoMap?null:d.albedoMap,"texture","textureSize"]);f.push(["undefined"===typeof d.texture?null:d.texture,"texture","textureSize"]);
f.push(["undefined"===typeof d.specularMap?null:d.specularMap,"specularMap"]);f.push(["undefined"===typeof d.normalMap?null:d.normalMap,"normalMap"]);f.push(["undefined"===typeof d.metalnessMap?null:d.metalnessMap,"metalnessMap"]);f.push(["undefined"===typeof d.roughnessMap?null:d.roughnessMap,"roughnessMap"]);f.push(["undefined"===typeof d.environmentMap?null:d.environmentMap,"envMap"]);f.push(["undefined"===typeof d.emissionMap?null:d.emissionMap,"emissionMap"]);for(var h=0;h<f.length;h++)if("undefined"!==
typeof f[h][0]&&null!==f[h][0]){var g="undefined"===typeof f[h][2]?null:f[h][2],k=f[h][0],m=k instanceof H3DU.Texture?k._toInfo():k;H3DU._MaterialBinder.bindTexture(k,m,b,a,e++,c,f[h][1],g)}if("undefined"!==typeof d.shader&&null!==d.shader)for(var l in d.shader.uniformValues||{})Object.prototype.hasOwnProperty.call(d.shader.uniformValues,l)&&(f=d.shader.uniformValues[l],"undefined"!==typeof f&&null!==f&&f instanceof H3DU.TextureInfo&&H3DU._MaterialBinder.bindTexture(f,f,b,a,e++,c,l,null));return this};
H3DU._LoadedTexture=function(a,b,c){this._init(a,b,c)};
H3DU._LoadedTexture.textureFilters=function(a,b,c,d){a.texParameteri(d,a.TEXTURE_MAG_FILTER,c.magFilter);if("undefined"!==typeof WebGL2RenderingContext&&null!==WebGL2RenderingContext&&a instanceof WebGL2RenderingContext||H3DU._isPowerOfTwo(b.getWidth())&&H3DU._isPowerOfTwo(b.getHeight()))a.generateMipmap(d);else{b=c.minFilter;if(b===a.NEAREST_MIPMAP_NEAREST||b===a.NEAREST_MIPMAP_LINEAR)b=a.NEAREST;if(b===a.LINEAR_MIPMAP_NEAREST||b===a.LINEAR_MIPMAP_LINEAR)b=a.LINEAR;a.texParameteri(d,a.TEXTURE_MIN_FILTER,
b);a.texParameteri(d,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(d,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)}};
H3DU._LoadedTexture.prototype._init=function(a,b,c){if(!a.image)throw Error();this.context=c=H3DU._toContext(c);this.loadedTexture=c.createTexture();c.activeTexture(c.TEXTURE0);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,b.topDown?0:1);var d=b.target;c.bindTexture(d,this.loadedTexture);"src"in a.image?c.texImage2D(d,0,b.internalFormat,b.format,c.UNSIGNED_BYTE,a.image):c.texImage2D(d,0,b.internalFormat,a.getWidth(),a.getHeight(),0,b.format,c.UNSIGNED_BYTE,a.image);H3DU._LoadedTexture.textureFilters(c,a,b,
d)};
H3DU._LoadedCubeMap=function(a,b){this.context=b=H3DU._toContext(b);this.loadedTexture=b.createTexture();b.activeTexture(b.TEXTURE0);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,0);var c=b.TEXTURE_CUBE_MAP;b.bindTexture(c,this.loadedTexture);for(var d=0;6>d;d++)"src"in a.textures[d].image?b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a.textures[d].image):b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,b.RGBA,a.getWidth(),a.getHeight(),0,b.RGBA,b.UNSIGNED_BYTE,a.image);H3DU._LoadedTexture.textureFilters(b,a,
new H3DU.TextureInfo,c)};H3DU._LoadedTexture.prototype.dispose=function(){this.loadedTexture&&this.context&&this.context.deleteTexture(this.loadedTexture);this.loadedTexture=this.context=null};H3DU._LoadedCubeMap.prototype.dispose=function(){this.loadedTexture&&this.context&&this.context.deleteTexture(this.loadedTexture);this.loadedTexture=this.context=null};
H3DU._MaterialBinder.bindTexture=function(a,b,c,d,e,f,h,g){if("undefined"===typeof b||null===b)throw Error();if("undefined"===typeof a||null===a)c&&(c.activeTexture(c.TEXTURE0+e),c.bindTexture(c.TEXTURE_2D,null),c.bindTexture(c.TEXTURE_CUBE_MAP,null));else{var k=a instanceof H3DU.FrameBufferInfo;if(!(k||a instanceof H3DU.Texture||a instanceof H3DU.CubeMap||a instanceof H3DU.TextureInfo))throw Error("unsupported texture type");var m=null;if(k)a=f.mapFrameBuffer(a,c);else{if(a instanceof H3DU.TextureInfo){var l=
f.getTexture(a.uri);if("undefined"===typeof l||null===l){var n=this,p=d;f.loadAndMapTexture(a,c).then(function(){n.bind(p,c,f)})}else a=l}if(0===a.loadStatus){n=this;p=d;a.loadImage().then(function(){n.bind(p,c,f)});return}2<=a.loadStatus&&(m=f._mapTextureWithInfo(a,b,c))}if("undefined"!==typeof m&&null!==m||k)if(l={},l[h]=e,"undefined"!==typeof g&&null!==g&&(l[g]=[a.getWidth(),a.getHeight()]),d.setUniforms(l),c.activeTexture(c.TEXTURE0+e),k)c.bindTexture(c.TEXTURE_2D,a.colorTexture),a.colorTexture&&
(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE));else if(d=a instanceof H3DU.CubeMap?c.TEXTURE_CUBE_MAP:b.target,c.bindTexture(d,m.loadedTexture),f._setMaxAnisotropy(c,d),c.texParameteri(d,c.TEXTURE_MAG_FILTER,b.magFilter),"undefined"!==typeof WebGL2RenderingContext&&null!==WebGL2RenderingContext&&c instanceof
WebGL2RenderingContext||H3DU._isPowerOfTwo(a.getWidth())&&H3DU._isPowerOfTwo(a.getHeight()))c.texParameteri(d,c.TEXTURE_MIN_FILTER,b.minFilter),c.texParameteri(d,c.TEXTURE_WRAP_S,b.wrapS),c.texParameteri(d,c.TEXTURE_WRAP_T,b.wrapT);else{a=b.minFilter;if(a===c.NEAREST_MIPMAP_NEAREST||a===c.NEAREST_MIPMAP_LINEAR)a=c.NEAREST;if(a===c.LINEAR_MIPMAP_NEAREST||a===c.LINEAR_MIPMAP_LINEAR)a=c.LINEAR;c.texParameteri(d,c.TEXTURE_MIN_FILTER,a);c.texParameteri(d,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(d,
c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE)}}};H3DU._LightsBinder=function(a){this.lights=a};H3DU._LightsBinder.emptyW1=[0,0,0,1];H3DU._LightsBinder.emptyW0=[0,0,0,0];H3DU._LightsBinder.emptyAtten=[1,0,0,0];
H3DU._LightsBinder.prototype.bind=function(a,b){var c,d=this.lights;if(!d||!a)return this;var e={};e.sceneAmbient=3===d.sceneAmbient.length?d.sceneAmbient:d.sceneAmbient.slice(0,3);for(var f=0;f<d.lights.length;f++){var h=d.lights[f];c="lights["+f+"]";e[c+".diffuse"]=4===h.diffuse.length?h.diffuse:[h.diffuse[0],h.diffuse[1],h.diffuse[2],1];e[c+".specular"]=4===h.specular.length?h.specular:[h.specular[0],h.specular[1],h.specular[2],1];var g=H3DU.Math.mat4transform(b,d.lights[f].position);e[c+".position"]=
g;e[c+".radius"]=[Math.max(0,h.radius*h.radius*h.radius*h.radius),0,0,0]}for(f=d.lights.length;f<H3DU.Lights.MAX_LIGHTS;f++)c="lights["+f+"]",e[c+".diffuse"]=H3DU._LightsBinder.emptyW1,e[c+".specular"]=H3DU._LightsBinder.emptyW1,e[c+".position"]=H3DU._LightsBinder.emptyW0,e[c+".radius"]=H3DU._LightsBinder.emptyW0;a.setUniforms(e);return this};H3DU.Shape=function(a){if("undefined"===typeof a||null===a)throw Error("mesh is null");a instanceof H3DU.Mesh?this.meshBuffer=new H3DU.MeshBuffer(a):a instanceof H3DU.BufferedMesh?(H3DU.Shape._meshBufferWarning||(console.warn("Using an H3DU.BufferedMesh in H3DU.Shape objects is deprecated."),H3DU.Shape._meshBufferWarning=!0),this.meshBuffer=a._toMeshBuffer()):this.meshBuffer=a;if(!(this.meshBuffer instanceof H3DU.MeshBuffer))throw Error("Unsupported data type for mesh parameter (must be Mesh or MeshBuffer)");
this.transform=new H3DU.Transform;this.material=new H3DU.PbrMaterial;this.parent=null;this.visible=!0};H3DU.Shape.prototype.getMeshBuffer=function(){return this.meshBuffer};H3DU.Shape._meshBufferWarning=!1;H3DU.Shape.prototype.vertexCount=function(){return this.meshBuffer?this.meshBuffer.vertexCount():0};H3DU.Shape.prototype.primitiveCount=function(){return this.meshBuffer?this.meshBuffer.primitiveCount():0};H3DU.Shape.prototype.setVisible=function(a){this.visible=!!a;return this};
H3DU.Shape.prototype.getVisible=function(){return this.visible};H3DU.Shape.prototype.setColor=function(a,b,c,d){a=H3DU.toGLColor(a,b,c,d);this._ensureMaterial().setParams({ambient:a,diffuse:a});return this};H3DU.Shape.prototype.setTexture=function(a){this._ensureMaterial().setParams({texture:a});return this};H3DU.Shape.prototype.setShader=function(a){this._ensureMaterial().setParams({shader:a});return this};
H3DU.Shape.prototype._ensureMaterial=function(){if("undefined"===typeof this.material||null===this.material)this.material=new H3DU.PbrMaterial;return this.material};H3DU.Shape.prototype.setTextureAndColor=function(a,b,c,d,e){b=H3DU.toGLColor(b,c,d,e);this._ensureMaterial().setParams({texture:a,ambient:b,diffuse:b});return this};
H3DU.Shape.prototype.setMaterial=function(a){if("undefined"===typeof a||null===a)throw Error();if(a instanceof H3DU.Texture)throw Error("Material parameter can't directly be a Texture");this.material=a;return this};H3DU.Shape.prototype.copy=function(){var a=new H3DU.Shape(this.meshBuffer);a.visible=this.visible;a.parent=null;a.material=this.material.copy();a.transform=this.getTransform().copy();return a};H3DU.Shape.prototype.getTransform=function(){return this.transform};
H3DU.Shape.prototype.getMaterial=function(){return this.material};
H3DU.Shape.prototype.getBounds=function(){if(!this.meshBuffer){var a=Number.POSITIVE_INFINITY;return[a,a,a,-a,-a,-a]}var b=this.meshBuffer.getBounds();if(H3DU.Math.boxIsEmpty(b))return b;var c=this.getMatrix();if(H3DU.Math.mat4isIdentity(c))return b.slice(0,6);if(0===c[1]&&0===c[2]&&0===c[3]&&0===c[4]&&0===c[6]&&0===c[7]&&0===c[8]&&0===c[9]&&0===c[11]&&1===c[15]){var a=[],d=c[0],e=c[12];a[0]=d*b[0]+e;var f=c[5],h=c[13];a[1]=f*b[1]+h;var g=c[10],c=c[14];a[2]=g*b[2]+c;b=[d*b[3]+e,f*b[4]+h,g*b[5]+c];
return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2]),Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2])]}a=[H3DU.Math.mat4projectVec3(c,b[0],b[1],b[2]),H3DU.Math.mat4projectVec3(c,b[0],b[1],b[5]),H3DU.Math.mat4projectVec3(c,b[0],b[4],b[2]),H3DU.Math.mat4projectVec3(c,b[0],b[4],b[5]),H3DU.Math.mat4projectVec3(c,b[3],b[1],b[2]),H3DU.Math.mat4projectVec3(c,b[3],b[1],b[5]),H3DU.Math.mat4projectVec3(c,b[3],b[4],b[2]),H3DU.Math.mat4projectVec3(c,b[3],b[4],b[5])];b=a[0];d=[b[0],b[1],
b[2],b[0],b[1],b[2]];for(e=1;8>e;e++)b=a[e],d[0]=Math.min(d[0],b[0]),d[1]=Math.min(d[1],b[1]),d[2]=Math.min(d[2],b[2]),d[3]=Math.max(d[3],b[0]),d[4]=Math.max(d[4],b[1]),d[5]=Math.max(d[5],b[2]);return d};H3DU.Shape.prototype.isCulled=function(a){return this.meshBuffer&&this.visible?!H3DU.Math.frustumHasBox(a,this.getBounds()):!0};H3DU.Shape.prototype.setTransform=function(a){this.transform=a.copy();return this};H3DU.Shape.prototype.setScale=function(a,b,c){this.getTransform().setScale(a,b,c);return this};
H3DU.Shape.prototype.setPosition=function(a,b,c){this.getTransform().setPosition(a,b,c);return this};H3DU.Shape.prototype.setQuaternion=function(a){this.getTransform().setQuaternion(a);return this};H3DU.Shape.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if("undefined"===typeof this.parent||null===this.parent)a=a.getMatrix();else var c=this.parent.getMatrix(),a=b?c:H3DU.Math.mat4isIdentity(c)?a.getMatrix():H3DU.Math.mat4multiply(c,a.getMatrix());return a};H3DU.FrameBufferLoader=function(){this._frameBuffers=[]};H3DU.FrameBufferLoader.prototype.mapFrameBuffer=function(a,b){for(var c,d=0;d<this._frameBuffers.length;d++)if(c=this._frameBuffers[d],c[0]===a&&c[1]===b){if(a.width!==c[3]||a.height!==c[4])c[2].dispose(),c[2]=new H3DU.FrameBuffer(c[1],a.width,a.height),c[3]=a.width,c[4]=a.height;return c[2]}c=new H3DU.FrameBuffer(b,a.width,a.height);this._frameBuffers.push([a,b,c,a.width,a.height]);return c};
H3DU.FrameBufferLoader.prototype.dispose=function(){for(var a=0;a<this._frameBuffers.length;a++)this._frameBuffers[a][2].dispose();this._frameBuffers=[]};
H3DU.FrameBufferLoader.prototype.bind=function(a,b,c){return"undefined"!==typeof a&&null!==a?(a=this.mapFrameBuffer(a,b),b.activeTexture(b.TEXTURE0+c),b.bindFramebuffer(b.FRAMEBUFFER,a.buffer),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,a.colorTexture,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a.depthbuffer),a):null};
H3DU.FrameBufferLoader.prototype.unbind=function(a,b){"undefined"!==typeof a&&null!==a&&(b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,null,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,null),b.bindFramebuffer(b.FRAMEBUFFER,null))};H3DU.FrameBuffer=function(a,b,c){if(0>b||0>c)throw Error("width or height negative");this.context=a=a.getContext?a.getContext():a;this.textureUnit=3;this._init(a,b,c)};
H3DU.FrameBuffer.prototype._init=function(a,b,c){this.buffer=a.createFramebuffer();this.colorTexture=a.createTexture();this.width=Math.ceil(b);this.height=Math.ceil(c);this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindTexture(this.context.TEXTURE_2D,this.colorTexture);this.context.pixelStorei(this.context.UNPACK_FLIP_Y_WEBGL,1);this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.width,this.height,0,this.context.RGBA,this.context.UNSIGNED_BYTE,
null);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE);this.depthbuffer=this.context.createRenderbuffer();b=this.context.getParameter(a.FRAMEBUFFER_BINDING);
this.context.bindFramebuffer(a.FRAMEBUFFER,this.buffer);this.context.bindRenderbuffer(a.RENDERBUFFER,this.depthbuffer);this.context.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height);this.context.bindFramebuffer(a.FRAMEBUFFER,b)};H3DU.FrameBuffer.prototype.resize=function(a,b){a=Math.ceil(a);b=Math.ceil(b);if(a!==this.width||b!==this.height)this.dispose(),this._init(this.context,a,b);return this};H3DU.FrameBuffer.prototype.getWidth=function(){return this.width};
H3DU.FrameBuffer.prototype.getHeight=function(){return this.height};H3DU.FrameBuffer.prototype.getContext=function(){return this.context};H3DU.FrameBuffer.prototype.bind=function(){console.log("FrameBuffer bind method has no effect.");return this};H3DU.FrameBuffer.prototype.unbind=function(){console.log("FrameBuffer unbind method has no effect.")};
H3DU.FrameBuffer.prototype.dispose=function(){"undefined"!==typeof this.buffer&&null!==this.buffer&&(this.context.getParameter(this.context.FRAMEBUFFER_BINDING)===this.buffer&&this.unbind(),this.context.deleteFramebuffer(this.buffer));"undefined"!==typeof this.depthbuffer&&null!==this.depthbuffer&&this.context.deleteRenderbuffer(this.depthbuffer);"undefined"!==typeof this.colorTexture&&null!==this.colorTexture&&this.context.deleteTexture(this.colorTexture);this.colorTexture=this.depthbuffer=this.buffer=
null};(function(a){H3DU.BezierCurve=function(a,c,d){("undefined"!==typeof c&&null!==c||"undefined"!==typeof d&&null!==d)&&console.warn("Unused parameters u1 and/or u2 given");this.curve=H3DU.BSplineCurve.clamped(a,a.length-1,0)};H3DU.BezierCurve.prototype=Object.create(H3DU.Curve.prototype);H3DU.BezierCurve.prototype.constructor=H3DU.BezierCurve;H3DU.BezierCurve.prototype.endPoints=function(){return this.surface.endPoints()};H3DU.BezierCurve.prototype.evaluate=function(a){return this.curve.evaluate(a)};
H3DU.BezierSurface=function(a){this.surface=H3DU.BSplineSurface.clamped(a,a[0].length-1,a.length-1,0)};H3DU.BezierSurface.prototype=Object.create(H3DU.Surface.prototype);H3DU.BezierSurface.prototype.constructor=H3DU.BezierSurface;H3DU.BezierSurface.prototype.evaluate=function(a,c){return this.surface.evaluate(a,c)};H3DU.BezierSurface.prototype.endPoints=function(){return this.surface.endPoints()};H3DU.BSplineCurve=function(a,c,d){if(0>=a.length)throw Error();if(!c)throw Error();this.bits=d||0;this.controlPoints=
a;0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)&&0===(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT)&&(this.controlPoints=H3DU.BSplineCurve._convertToHomogen(this.controlPoints));d=c.length-this.controlPoints.length;if(1>d||d>this.controlPoints.length)throw Error();H3DU.BSplineCurve._checkKnots(c,d-1);var b=this.controlPoints[0].length,f=1;0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)&&(f=2);if(b<f)throw Error();this.fastBezier=!1;if(d===a.length&&4>=d){this.fastBezier=!0;for(b=0;b<d;b++)if(0!==c[0]){this.fastBezier=
!1;break}for(b=d;this.fastBezier&&b<c.length;b++)if(1!==c[0]){this.fastBezier=!1;break}}this.knots=c;this.buffer=[];this.controlPoints=a};H3DU.BSplineCurve.prototype=Object.create(H3DU.Curve.prototype);H3DU.BSplineCurve.prototype.constructor=H3DU.BSplineCurve;H3DU.BSplineCurve.WEIGHTED_BIT=1;H3DU.BSplineCurve.DIVIDE_BIT=2;H3DU.BSplineCurve.HOMOGENEOUS_BIT=4;H3DU.BSplineCurve.WEIGHTED_DIVIDE_BITS=3;H3DU.BSplineCurve._checkKnots=function(a,c){for(var b=1;b<a.length;b++)if(a[b]<a[b-1])throw Error();
for(b=1;b<a.length-2-c;b++)if(a[b+c]<=a[b])throw Error();if(a[0]===a[a.length-1]||a[0]>=a[c+1])throw Error();if(a[a.length-2-c]>=a[a.length-1])throw Error();if(c+1>=a.length)throw Error();};H3DU.BSplineCurve._nfunc=function(a,c,d,e){if(0===c)return e[a]<=d&&d<e[a+1]?1:0;if(e[a]>d||e[a]===e[a+c]&&e[a+c+1]===e[a+1]||e[a+c+1]<d)return 0;var b=e[a]===e[a+c]?0:H3DU.BSplineCurve._nfunc(a,c-1,d,e),h=e[a+c+1]===e[a+1]?0:H3DU.BSplineCurve._nfunc(a+1,c-1,d,e);if(0===b+h)return 0;var g=0;if(0!==b)var k=e[a+
c]-e[a],g=g+(d-e[a])*b*(0===k?1:1/k);0!==h&&(k=e[a+c+1]-e[a+1],g+=(e[a+c+1]-d)*h*(0===k?1:1/k));return g};H3DU.BSplineCurve._getFactors=function(a,c,d,e,f){for(var b=1,g=1,k=0;k<e;k++)f[k]=0;for(k=1;k<a.length;k++)if(a[k]===a[0])b+=1;else break;for(k=a.length-2;0<=k;k--)if(a[k]===a[a.length-1])g+=1;else break;if(c>=a[a.length-1-d]&&a[a.length-1-d]===a[a.length-1])f[e-1]=1;else if(b!==d+1||g!==d+1)for(k=0;k<e;k++)f[k]=H3DU.BSplineCurve._nfunc(k,d,c,a);else if(c<=a[d])f[0]=1;else if(c>=a[a.length-1-
d])f[e-1]=1;else{e=-1;for(k=0;k<=a.length;k++)if(a[k]<=c&&c<a[k+1]){e=k;break}if(!(0>e))for(var b=a[e+1]-c,g=a[e],m=c-g,l=f[e]=1;l<=d;l++){f[e-l]=f[e-l+1]*b/(a[e+1]-a[e-l+1]);for(k=e-l+1;k<e;k++){var n=a[k];f[k]*=(c-n)/(a[k+l]-n);f[k]+=f[k+1]*(a[k+l+1]-c)/(a[k+l+1]-a[k+1])}f[e]*=m/(a[e+l]-g)}}};H3DU.BSplineCurve.prototype.evaluate=function(a){var b=[];if(this.fastBezier){var d=this.controlPoints;switch(d.length){case 1:b=d[0].slice(0,d[0].length);break;case 2:for(var e=d[0].length,b=[],f=d[0],d=d[1],
h=0;h<e;h++){var g=f[h];b[h]=g+(d[h]-g)*a}break;case 3:e=d[0].length;b=[];f=d[0];h=d[1];d=d[2];for(g=0;g<e;g++)b[g]=((a-2)*a+1)*f[g]+(-2*a+2)*a*h[g]+a*a*d[g];break;case 4:for(var e=d[0].length,b=[],f=d[0],h=d[1],g=d[2],d=d[3],k=0;k<e;k++)b[k]=(((3-a)*a-3)*a+1)*f[k]+((3*a-6)*a+3)*a*h[k]+(-3*a+3)*a*a*g[k]+a*a*a*d[k]}}else if(f=this.controlPoints.length,d=this.knots.length-f-1,e=this.controlPoints[0].length,b=null,a<=this.knots[d]?this.knots[d]===this.knots[0]?b=this.controlPoints[0].slice(0,e):a=this.knots[d]:
a>=this.knots[this.knots.length-1-d]&&(this.knots[this.knots.length-1-d]===this.knots[this.knots.length-1]?b=this.controlPoints[f-1].slice(0,e):a=this.knots[this.knots.length-1-d]),"undefined"===typeof b||null===b){k=0;b=-1;for(f=0;f<this.knots.length;f++)if(h=this.knots[f],(g=a===h)&&k++,h<this.knots[f+1])if(g){b=f;break}else if(h<a&&a<this.knots[f+1]){b=f;break}if(0>b)throw Error();if(k>d)throw Error();if(k===d)b=this.controlPoints[b-d].slice(0,e);else{h=d-k;g=[];for(f=b-d;f<=b-k;f++)g.push(this.controlPoints[f]);
for(k=1;k<=h;k++)for(var m=g[k-1],f=k;f<g.length;f++){for(var l=b-d+f,n=this.knots[l],l=(a-n)/(this.knots[l+d-k+1]-n),n=g[f],p=[],q=0;q<e;q++)p[q]=m[q]*(1-l)+n[q]*l;g[f]=p;m=n}b=g[g.length-1].slice(0,e)}}0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)&&(b=H3DU.BSplineCurve._fromHomogen(b));return b};H3DU.BSplineCurve._splitKnots=function(a,c,d){for(var b=-1,f=-1,h=[],g=[],k=0;k<a.length;k++)if(a[k]>d){f=k;break}else a[k]<d&&(b=k);if(0>b||0>f)throw Error();for(k=0;k<=b;k++)h.push(a[k]);for(k=0;k<c+1;k++)h.push(d),
g.push(d);for(k=f;k<a.length;k++)g.push(a[k]);return[h,g]};H3DU.BSplineCurve.prototype.split=function(a){var b=this.controlPoints.length,d=this.knots.length-b-1,e=this.controlPoints[0].length,f;if(a<=this.knots[d])return[null,this];if(a>=this.knots[this.knots.length-1-d])return[this,null];var h=0,g=-1;for(f=0;f<this.knots.length;f++){var k=this.knots[f],m=a===k;m&&h++;if(k<this.knots[f+1])if(m){g=f;break}else if(k<a&&a<this.knots[f+1]){g=f;break}}if(0>g)throw Error();if(h>d)throw Error();var k=H3DU.BSplineCurve._splitKnots(this.knots,
d,a),l,m=[];if(h===d)l=this.controlPoints.slice(0,g-d+1),m=this.controlPoints.slice(g-d,this.controlPoints.length);else{var n=d-h,p=[];for(f=g-d;f<=g-h;f++)p.push(this.controlPoints[f]);l=[];for(f=0;f<=g-d;f++)l.push(this.controlPoints[f]);for(var q=[],r=1;r<=n;r++){var t=p[r-1];for(f=r;f<p.length;f++){for(var x=g-d+f,w=this.knots[x],x=(a-w)/(this.knots[x+d-r+1]-w),w=p[f],y=[],u=0;u<e;u++)y[u]=t[u]*(1-x)+w[u]*x;p[f]=y;t=w;f===r?l.push(y):f+1===p.length&&q.push(y)}}m.push(l[l.length-1]);for(f=q.length-
1;0<=f;f--)m.push(q[f]);for(f=g-h;f<b;f++)m.push(this.controlPoints[f])}a=new H3DU.BSplineCurve(l,k[0],this.bits);b=new H3DU.BSplineCurve(m,k[1],this.bits);return[a,b]};H3DU.BSplineCurve.prototype.endPoints=function(){var a=this.knots.length-this.controlPoints.length-1;return[this.knots[a],this.knots[this.knots.length-1-a]]};H3DU.BSplineCurve.prototype.getPoints=function(){return this.controlPoints};H3DU.BSplineCurve.prototype.velocity=function(a){var b=[];if(this.fastBezier){var d=this.controlPoints;
switch(d.length){case 1:b=H3DU._MathInternal.vecZeros(d[0].length);break;case 2:b=H3DU._MathInternal.vecSub(d[1],d[0]);break;case 3:for(var b=d[0].length,e=[],f=d[0],h=d[1],d=d[2],g=0;g<b;g++)e[g]=(2*a-2)*f[g]+(-4*a+2)*h[g]+2*a*d[g];b=e;break;case 4:for(var b=d[0].length,e=[],f=d[0],h=d[1],g=d[2],d=d[3],k=0;k<b;k++)e[k]=((-3*a+6)*a-3)*f[k]+((9*a-12)*a+3)*h[k]+(-9*a+6)*a*g[k]+3*a*a*d[k];b=e}}else{d=this.controlPoints.length;f=this.knots.length-d-1;e=this.controlPoints[0].length;H3DU.BSplineCurve._getFactors(this.knots,
a,f-1,d,this.buffer);h=[];for(g=0;g<d;g++)h[g]=0;for(a=0;a<d-1;a++)g=f*this.buffer[a+1]/(this.knots[a+f+1]-this.knots[a+1]),h[a+1]+=g,h[a]-=g;for(g=0;g<e;g++){for(a=f=0;a<d;a++)f+=h[a]*this.controlPoints[a][g];b[g]=f}}0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)&&(b=H3DU.BSplineCurve._fromHomogen(b));return b};H3DU.BSplineCurve._convertToHomogen=function(a){for(var b=[],d=a[0].length,e=0;e<a.length;e++){for(var f=[],h=a[e][d-1],g=0;g<d-1;g++)f[g]=a[e][g]*h;f[d-1]=h;b.push(f)}return b};H3DU.BSplineCurve._fromHomogen=
function(a){for(var b=a.length,d=1/a[b-1],e=0;e<b-1;e++)a[e]/=d;return a=a.slice(0,b-1)};H3DU.BSplineSurface=function(a,c,d,e){this.bits=e||0;0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)&&0===(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT)&&(a=H3DU.BSplineSurface._convertToHomogen(a));e=a.length;if(0>=e)throw Error();var b=a[0].length;if(0>=b)throw Error();var h=a[0][0].length,g=1;0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)&&(g=2);if(h<g)throw Error();if(!c||!d)throw Error();this.degreeU=c.length-
b-1;this.degreeV=d.length-e-1;this.vcplen=e;this.ucplen=b;if(1>this.degreeU||this.degreeU+1>b)throw Error();if(1>this.degreeV||this.degreeV+1>e)throw Error();H3DU.BSplineCurve._checkKnots(c,this.degreeU);H3DU.BSplineCurve._checkKnots(d,this.degreeV);this.knotsU=c;this.knotsV=d;this.bufferU=[];this.bufferV=[];this.controlPoints=a};H3DU.BSplineSurface.prototype=Object.create(H3DU.Surface.prototype);H3DU.BSplineSurface.prototype.constructor=H3DU.BSplineSurface;H3DU.BSplineCurve.clamped=function(a,c,
d){return new H3DU.BSplineCurve(a,H3DU.BSplineCurve.clampedKnots(a.length,c),d)};H3DU.BSplineCurve.fromBezierCurve=function(a,c){return H3DU.BSplineCurve.clamped(a,a.length-1,c)};H3DU.BSplineCurve.uniform=function(a,c,d){return new H3DU.BSplineCurve(a,H3DU.BSplineCurve.uniformKnots(a.length,c),d)};H3DU.BSplineSurface.clamped=function(a,c,d,e){return new H3DU.BSplineSurface(a,H3DU.BSplineCurve.clampedKnots(a[0].length,c),H3DU.BSplineCurve.clampedKnots(a.length,d),e)};H3DU.BSplineSurface.uniform=function(a,
c,d,e){return new H3DU.BSplineSurface(a,H3DU.BSplineCurve.uniformKnots(a[0].length,c),H3DU.BSplineCurve.uniformKnots(a.length,d),e)};H3DU.BSplineCurve.uniformKnots=function(a,c){"object"===typeof a&&(a=a.length);if("undefined"===typeof c||null===c)c=3;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var b=c+1,e=[],f=1/(a+b-1),h=0;h<a+b;h++)e.push(h*f);return e};H3DU.BSplineCurve.clampedKnots=function(a,c){"object"===typeof a&&(a=a.length);if("undefined"===typeof c||null===
c)c=3;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var b=c+1,e=a-b,f=[],h=0;h<b;h++)f.push(0);for(h=0;h<e;h++)f.push(1*(h+1)/(e+1));for(h=0;h<b;h++)f.push(1);return f};H3DU.BSplineSurface.prototype.evaluate=function(a,c){var b=this.controlPoints[0][0].length,e=this.bufferU,f=this.bufferV,h,g,k,m;H3DU.BSplineCurve._getFactors(this.knotsU,a,this.degreeU,this.ucplen,this.bufferU);H3DU.BSplineCurve._getFactors(this.knotsV,c,this.degreeV,this.vcplen,this.bufferV);var l=[];
for(k=0;k<b;k++){for(h=m=0;h<this.ucplen;h++)for(g=0;g<this.vcplen;g++)m+=this.controlPoints[g][h][k]*e[h]*f[g];l[k]=m}0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)&&(l=H3DU.BSplineCurve._fromHomogen(l));return l};H3DU.BSplineSurface.getPoints=function(){return this.controlPoints};H3DU.BSplineSurface.prototype.tangent=function(a,c){var b=this.controlPoints[0][0].length,e=this.bufferV,f,h,g,k;H3DU.BSplineCurve._getFactors(this.knotsU,a,this.degreeU-1,this.ucplen,this.bufferU);H3DU.BSplineCurve._getFactors(this.knotsV,
c,this.degreeV,this.vcplen,this.bufferV);var m=[],l=[];for(g=0;g<this.ucplen;g++)l[g]=0;for(f=0;f<this.ucplen-1;f++)h=this.degreeU*this.bufferU[f+1]/(this.knotsU[f+this.degreeU+1]-this.knotsU[f+1]),l[f+1]+=h,l[f]-=h;for(g=0;g<b;g++){for(f=k=0;f<this.ucplen;f++)for(h=0;h<this.vcplen;h++)k+=this.controlPoints[h][f][g]*l[f]*e[h];m[g]=k}0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)&&(m=H3DU.BSplineCurve._fromHomogen(m));return m};H3DU.BSplineSurface.prototype.bitangent=function(a,c){var b=this.controlPoints[0][0].length,
e=this.bufferU,f,h,g,k;H3DU.BSplineCurve._getFactors(this.knotsU,a,this.degreeU,this.ucplen,this.bufferU);H3DU.BSplineCurve._getFactors(this.knotsV,c,this.degreeV-1,this.vcplen,this.bufferV);var m=[],l=[];for(g=0;g<this.vcplen;g++)l[g]=0;for(f=0;f<this.vcplen-1;f++)h=this.degreeV*this.bufferV[f+1]/(this.knotsV[f+this.degreeV+1]-this.knotsV[f+1]),l[f+1]+=h,l[f]-=h;for(g=0;g<b;g++){for(f=k=0;f<this.ucplen;f++)for(h=0;h<this.vcplen;h++)k+=this.controlPoints[h][f][g]*e[f]*l[h];m[g]=k}0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)&&
(m=H3DU.BSplineCurve._fromHomogen(m));return m};H3DU.BSplineSurface._convertToHomogen=function(a){for(var b=[],d=0;d<a.length;d++)b.push(H3DU.BSplineCurve._convertToHomogen(a[d]));return b};H3DU.BSplineSurface.fromBezierSurface=function(a,c){return H3DU.BSplineSurface.clamped(a,a[0].length-1,a.length-1,c)};H3DU.CurveEval=function(){this.vertexCurve=this.texCoordCurve=this.normalCurve=this.colorCurve=null;this.vertexCurveHasNormal=!1};H3DU.CurveEval.prototype.vertex=function(a){this.vertexCurve="undefined"!==
typeof a&&null!==a?new H3DU.Curve(a):null;this.vertexCurveHasNormal="undefined"!==typeof a&&null!==a&&"undefined"!==typeof a.normal&&null!==a.normal;return this};H3DU.CurveEval.prototype.normal=function(a){this.normalCurve=a;return this};H3DU.CurveEval.prototype.color=function(a){this.colorCurve=a;return this};H3DU.CurveEval.prototype.texCoord=function(a){this.texCoordCurve=a;return this};H3DU.CurveEval.prototype.evalOne=function(a,c){var b=null,e=null,f=null;if(!this.texCoordCurve&&!this.normalCurve)return this._evalOneSimplified(a,
c);this.colorCurve&&(b=this.colorCurve.evaluate(c));this.texCoordCurve&&(f=this.texCoordCurve.evaluate(c),1===f.length&&f.push(0));this.normalCurve?e=this.normalCurve.evaluate(c):this.vertexCurve&&this.vertexCurveHasNormal&&(e=this.vertexCurve.normal(c));if(this.vertexCurve){var h=b?a.color.slice(0,3):null,g=e?a.normal.slice(0,3):null,k=f?a.texCoord.slice(0,2):null;b&&a.color3(b[0],b[1],b[2]);e&&(2===e.length?a.normal3(e[0],e[1],0):a.normal3(e[0],e[1],e[2]));f&&a.texCoord2(f[0],f[1]);b=this.vertexCurve.evaluate(c);
2===b.length?a.vertex3(b[0],b[1],0):a.vertex3(b[0],b[1],b[2]);h&&a.color3(h[0],h[1],h[2]);g&&a.normal3(g[0],g[1],g[2]);k&&a.texCoord2(k[0],k[1])}return this};H3DU.CurveEval.prototype._evalOneSimplified=function(a,c){var b=null;this.colorCurve&&(b=this.colorCurve.evaluate(c));if(this.vertexCurve){var e=b?a.color.slice(0,3):null;b&&a.color3(b[0],b[1],b[2]);b=this.vertexCurve.evaluate(c);a.vertex3(b[0],b[1],2===b.length?0:b[2]);e&&a.color3(e[0],e[1],e[2])}return this};H3DU.CurveEval.prototype.evalCurve=
function(a,c,d,e,f){"undefined"===typeof d&&(d=24);if(0>=d)throw Error("invalid n");"undefined"===typeof e&&"undefined"===typeof f&&("undefined"!==typeof this.vertexCurve&&null!==this.vertexCurve?(f=this.vertexCurve.endPoints(),e=f[0],f=f[1]):(e=0,f=1));if("undefined"===typeof c||null===c)c=H3DU.Mesh.LINES;if(c===H3DU.Mesh.POINTS)a.mode(H3DU.Mesh.POINTS);else if(c===H3DU.Mesh.LINES)a.mode(H3DU.Mesh.LINE_STRIP);else return this;c=(f-e)/d;for(f=0;f<=d;f++)this.evalOne(a,e+f*c);return this};H3DU.SurfaceEval=
function(){this.normalSurface=this.colorSurface=null;this.generateNormals=!1;this.vertexSurface=this.texCoordSurface=null;this.autoNormal=!1};H3DU.SurfaceEval.prototype.setAutoNormal=function(a){this.autoNormal=!!a;return this};H3DU.SurfaceEval.prototype.vertex=function(a){this.vertexSurface=a;this.generateNormals=this.normalSurface||!!this.autoNormal||"undefined"!==typeof this.vertexSurface&&null!==this.vertexSurface&&"undefined"!==typeof this.vertexSurface.gradient&&null!==this.vertexSurface.gradient;
return this};H3DU.SurfaceEval.prototype.normal=function(a){this.generateNormals=(this.normalSurface=a)||!!this.autoNormal||"undefined"!==typeof this.vertexSurface&&null!==this.vertexSurface&&"undefined"!==typeof this.vertexSurface.gradient&&null!==this.vertexSurface.gradient;return this};H3DU.SurfaceEval.prototype.color=function(a){this.colorSurface=a;return this};H3DU.SurfaceEval.prototype.texCoord=function(a){this.texCoordSurface=a;return this};H3DU._OLD_VALUES_SIZE=8;H3DU._RECORDED_VALUES_SIZE=
11;H3DU.SurfaceEval.prototype.evalOne=function(a,c,d){var b=[];this._saveValues(a,b,0);this._recordAndPlayBack(a,c,d,b,H3DU._OLD_VALUES_SIZE);this._restoreValues(a,b,0);return this};H3DU.SurfaceEval.prototype._recordAndPlayBack=function(a,c,d,e,f){this._record(c,d,e,f);this._playBack(a,e,f)};H3DU.SurfaceEval.prototype._saveValues=function(a,c,d){this.colorSurface&&(c[d+3]=a.color[0],c[d+4]=a.color[1],c[d+5]=a.color[2]);this.generateNormals&&(c[d+0]=a.normal[0],c[d+1]=a.normal[1],c[d+2]=a.normal[2]);
this.texCoordSurface&&(c[d+6]=a.texCoord[0],c[d+7]=a.texCoord[1])};H3DU.SurfaceEval.prototype._restoreValues=function(a,c,d){this.colorSurface&&a.color3(c[d+3],c[d+4],c[d+5]);this.generateNormals&&a.normal3(c[d+0],c[d+1],c[d+2]);this.texCoordSurface&&a.texCoord2(c[d+6],c[d+7])};H3DU.SurfaceEval.prototype._record=function(a,c,d,e){var b;this.colorSurface&&(b=this.colorSurface.evaluate(a,c),d[e+6]=b[0],d[e+7]=b[1],d[e+8]=b[2]);this.texCoordSurface&&(b=this.texCoordSurface.evaluate(a,c),d[e+9]=b[0],
d[e+10]=1>=b.length?0:b[1]);this.autoNormal||"undefined"===typeof this.vertexSurface.gradient||null===this.vertexSurface.gradient?this.normalSurface&&!this.autoNormal&&(b=this.normalSurface.evaluate(a,c),d[e+3]=b[0],d[e+4]=b[1],d[e+5]=b[2]):(b=H3DU.Math.vec3normalize(this.vertexSurface.gradient(a,c)),d[e+3]=b[0],d[e+4]=b[1],d[e+5]=b[2]);this.vertexSurface&&(b=this.vertexSurface.evaluate(a,c),d[e]=b[0],d[e+1]=b[1],d[e+2]=b[2],this.autoNormal&&(b=this.vertexSurface.normal(a,c),d[e+3]=b[0],d[e+4]=b[1],
d[e+5]=b[2]))};H3DU.SurfaceEval.prototype._playBack=function(a,c,d){this.vertexSurface&&(this.colorSurface&&a.color3(c[d+6],c[d+7],c[d+8]),this.generateNormals&&a.normal3(c[d+3],c[d+4],c[d+5]),this.texCoordSurface&&a.texCoord2(c[d+9],c[d+10]),a.vertex3(c[d+0],c[d+1],c[d+2]))};H3DU.SurfaceEval.prototype.evalSurface=function(a,c,d,e,f,h,g,k){"undefined"===typeof d&&(d=24);"undefined"===typeof e&&(e=24);if(0>=d)throw Error("invalid un");if(0>=e)throw Error("invalid vn");if("undefined"===typeof c||null===
c)c=H3DU.Mesh.TRIANGLES;var b=null;"undefined"===typeof g&&"undefined"===typeof k&&(b||(b="undefined"!==typeof this.vertexSurface&&null!==this.vertexSurface?this.vertexSurface.endPoints():[0,1]),g=b[2],k=b[3]);"undefined"===typeof f&&"undefined"===typeof h&&(b||(b="undefined"!==typeof this.vertexSurface&&null!==this.vertexSurface?this.vertexSurface.endPoints():[0,1]),f=b[0],h=b[1]);h=(h-f)/d;k=(k-g)/e;var l,n;if(c===H3DU.Mesh.TRIANGLES){var p=[],q=[];this._saveValues(a,p,0);for(c=0;c<e;c++)for(a.mode(H3DU.Mesh.TRIANGLE_STRIP),
n=b=0;b<=d;b++,n+=H3DU._RECORDED_VALUES_SIZE)l=b*h+f,0===c?this._recordAndPlayBack(a,l,c*k+g,p,H3DU._OLD_VALUES_SIZE):this._playBack(a,q,n),c===e-1?this._recordAndPlayBack(a,l,(c+1)*k+g,p,H3DU._OLD_VALUES_SIZE):this._recordAndPlayBack(a,l,(c+1)*k+g,q,n);this._restoreValues(a,p,0)}else if(c===H3DU.Mesh.POINTS)for(a.mode(H3DU.Mesh.POINTS),c=0;c<=e;c++)for(b=0;b<=d;b++)l=b*h+f,this.evalOne(a,l,c*k+g);else if(c===H3DU.Mesh.LINES){for(c=0;c<=e;c++)for(a.mode(H3DU.Mesh.LINE_STRIP),b=0;b<=d;b++)l=b*h+f,
this.evalOne(a,l,c*k+g);for(c=0;c<=d;c++)for(a.mode(H3DU.Mesh.LINE_STRIP),b=0;b<=e;b++)this.evalOne(a,c*h+f,b*k+g)}return this};a.H3DU.SurfaceEval=H3DU.SurfaceEval;a.H3DU.CurveEval=H3DU.CurveEval;a.H3DU.BezierCurve=H3DU.BezierCurve;a.H3DU.BezierSurface=H3DU.BezierSurface;a.H3DU.BSplineCurve=H3DU.BSplineCurve;a.H3DU.BSplineSurface=H3DU.BSplineSurface})(this);H3DU.Texture=function(a){this.image=null;this.loadStatus=0;this.name=a;this.height=this.width=0;this.clamp=!1};H3DU.Texture.prototype.getWidth=function(){return this.width};H3DU.Texture.prototype.getHeight=function(){return this.height};H3DU.Texture.prototype._toInfo=function(){return new H3DU.TextureInfo({uri:this.name,wrapS:this.clamp?33071:10497,wrapT:this.clamp?33071:10497})};H3DU.Texture.prototype.setClamp=function(a){this.clamp=!!a;return this};
H3DU.Texture.loadTexture=function(a,b){var c,d;if("undefined"===typeof a||null===a)throw Error();if(a instanceof H3DU.Texture)d=a.name,c=a;else{d=a instanceof H3DU.TextureInfo?a.uri:a;if(b&&b[d]&&d&&0<d.length)return Promise.resolve(b[d]);c=new H3DU.Texture(d)}b&&d&&0<d.length&&(b[d]=c);return c.loadImage().then(function(a){return a},function(a){return Promise.reject(a.name)})};
H3DU.Texture.fromUint8Array=function(a,b,c){if(0>b)throw Error("width less than 0");if(0>c)throw Error("height less than 0");if(a.length<b*c*4)throw Error("array too short for texture");var d=new H3DU.Texture("");d.image=a;d.width=Math.ceil(b);d.height=Math.ceil(c);d.loadStatus=2;return d};
H3DU.Texture.loadTga=function(a){return H3DU.loadFileFromUrl(a,"arraybuffer").then(function(a){var b=new DataView(a.data),d=b.getUint8(2);if(2!==d&&3!==d)return Promise.reject(Error("unsupported image type"));var e=b.getUint16(8,!0),f=b.getUint16(10,!0);if(0!==e||0!==f)return Promise.reject(Error("unsupported origins"));e=b.getUint16(12,!0);f=b.getUint16(14,!0);if(0===e||0===f)return Promise.reject(Error("invalid width or height"));var h=b.getUint8(16);if(!(32===h&&2===d||24===h&&2===d||8===h&&3===
d))return Promise.reject(Error("unsupported pixelsize"));var g=e*f;if(g>a.data.length)return Promise.reject(Error("size too big"));var k=new Uint8Array(4*g),m=18;if(32===h&&2===d)for(h=d=0;d<g;d++,h+=4)k[h+2]=b.getUint8(m),k[h+1]=b.getUint8(m+1),k[h]=b.getUint8(m+2),k[h+3]=b.getUint8(m+3),m+=4;else if(24===h&&2===d)for(h=d=0;d<g;d++,h+=4)k[h+2]=b.getUint8(m),k[h+1]=b.getUint8(m+1),k[h]=b.getUint8(m+2),k[h+3]=255,m+=3;else if(8===h&&3===d)for(h=d=0;d<g;d++,h+=4){var l=b.getUint8(m);k[h]=l;k[h+1]=l;
k[h+2]=l;k[h+3]=255;m++}a.data=null;return{width:e,height:f,image:k}})};
H3DU.Texture.prototype.loadImage=function(){if("undefined"!==typeof this.image&&null!==this.image)return Promise.resolve(this);var a=this,b=this.name;a.loadStatus=1;return/\.tga$/i.test(b)?H3DU.Texture.loadTga(b).then(function(b){a.image=b.image;a.width=b.width;a.height=b.height;a.loadStatus=2;return a},function(c){a.loadStatus=-1;return Promise.reject({name:b,error:c})}):new Promise(function(c,d){var e=new Image;e.onload=function(b){b=b.target;a.image=b;a.width=b.width;a.height=b.height;a.loadStatus=
2;e.onload=null;e.onerror=null;c(a)};e.onerror=function(c){a.loadStatus=-1;e.onload=null;e.onerror=null;d({name:b,error:c})};e.src=b})};H3DU.Texture.prototype.dispose=function(){this.height=this.width=0;this.name="";this.image&&("undefined"!==typeof this.image.onload&&null!==this.image.onload&&(this.image.onload=null),"undefined"!==typeof this.image.onerror&&null!==this.image.onerror&&(this.image.onerror=null));this.image=null;this.clamp=!1;this.loadStatus=0};H3DU.Texture.prototype.getName=function(){return this.name};
H3DU.Texture._texOrString=function(a){return"string"===typeof a?new H3DU.Texture(a):a};H3DU.Texture._texOrInfoOrString=function(a){return"undefined"===typeof a||null===a?null:"string"===typeof a?new H3DU.Texture(a):a instanceof H3DU.TextureInfo?new H3DU.TextureInfo(a.uri):a};H3DU.CubeMap=function(a){this.textures=[];for(var b=this.loadStatus=0;6>b;b++)this.textures.push(H3DU.Texture._texOrInfoOrString(a[b]))};H3DU.CubeMap.prototype.getWidth=function(){return this.textures[0].getWidth()};
H3DU.CubeMap.prototype.getHeight=function(){return this.textures[0].getHeight()};H3DU.CubeMap.prototype.setTexture=function(a,b){if(0>a||6<=a)return this;this.textures[a]=H3DU.Texture._texOrInfoOrString(b);return this};H3DU.CubeMap.prototype.getTexture=function(a){return 0>a||6<=a?this:this.textures[a]};
H3DU.CubeMap.prototype.loadImage=function(){var a;if(2===this.loadStatus){for(a=0;6>a;a++)2!==this.textures[a].loadStatus&&(this.loadStatus=0);if(2===this.loadStatus)return Promise.resolve(this)}var b=[];for(a=0;6>a;a++)b.push(this.textures[a].loadImage());var c=this;c.loadStatus=1;return H3DU.getPromiseResultsAll(b).then(function(){c.loadStatus=2;return Promise.resolve(c)})};H3DU._MathInternal={vecZeros:function(a){for(var b=[],c=0;c<a;c++)b[c]=0;return b},vecSub:function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]-b[d];return c},vecSubInPlace:function(a,b){for(var c=0;c<a.length;c++)a[c]-=b[c];return a},vecScale:function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]*b;return c},vecSubScaleInPlace:function(a,b,c){for(var d=0;d<a.length;d++)a[d]=(a[d]-b[d])*c;return a},vecNormalizeInPlace:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];b=Math.sqrt(b);if(0!==
b)for(c=0;c<a.length;c++)b+=a[c]*a[c];return a},vecLength:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return Math.sqrt(b)}};H3DU.BufferedMesh=function(a,b){b=b.getContext?b.getContext():b;this._bounds=a instanceof H3DU.MeshBuffer?a._bounds:a.getBoundingBox();this._initialize(a,b)};H3DU.BufferedMesh.prototype._getArrayObjectExt=function(a){return"undefined"===typeof this.arrayObjectExt||null===this.arrayObjectExt?(this.arrayObjectExt=a.getExtension("OES_vertex_array_object"),this.arrayObjectExtContext=a,this.arrayObjectExt):this.arrayObjectExtContext===a?this.arrayObjectExt:a.getExtension("OES_vertex_array_object")};
H3DU.BufferedMesh.prototype._createVertexArray=function(a){return"undefined"!==typeof WebGL2RenderingContext&&null!==WebGL2RenderingContext&&a instanceof WebGL2RenderingContext?a.createVertexArray():a instanceof WebGLRenderingContext?(a=this._getArrayObjectExt(a),"undefined"===typeof a||null===a?null:a.createVertexArrayOES()):null};
H3DU.BufferedMesh.prototype._deleteVertexArray=function(a,b){if("undefined"!==typeof WebGL2RenderingContext&&null!==WebGL2RenderingContext&&a instanceof WebGL2RenderingContext)a.deleteVertexArray(b);else if(a instanceof WebGLRenderingContext){var c=this._getArrayObjectExt(a);"undefined"!==typeof c&&null!==c&&c.deleteVertexArrayOES(b)}};
H3DU.BufferedMesh.prototype._bindVertexArray=function(a,b){if("undefined"!==typeof WebGL2RenderingContext&&null!==WebGL2RenderingContext&&a instanceof WebGL2RenderingContext)a.bindVertexArray(b);else if(a instanceof WebGLRenderingContext){var c=this._getArrayObjectExt(a);"undefined"!==typeof c&&null!==c&&c.bindVertexArrayOES(b)}};
H3DU.BufferedMesh.prototype._initialize=function(a,b){if("undefined"===typeof a||null===a)throw Error("mesh is null");var c=a instanceof H3DU.MeshBuffer?a:new H3DU.MeshBuffer(a);this.smb=c;this.vertsMap=new H3DU.BufferedMesh._Map;this.indices=b.createBuffer();if("undefined"===typeof this.indices||null===this.indices)throw Error("can't create face buffer");this.vao=this._createVertexArray(this.context);for(var d=c._getAttributes(),e=0;e<d.length;e++){var f=d[e][2];if(f&&!this.vertsMap.get(f)){var h=
b.createBuffer();if("undefined"===typeof h||null===h)throw Error("can't create buffer");b.bindBuffer(b.ARRAY_BUFFER,h);b.bufferData(b.ARRAY_BUFFER,f,b.STATIC_DRAW);this.vertsMap.put(f,h)}}b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indices);b.bufferData(b.ELEMENT_ARRAY_BUFFER,c.indices,b.STATIC_DRAW);d=b.UNSIGNED_SHORT;4===c.indexBufferSize?d=b.UNSIGNED_INT:1===c.indexBufferSize&&(d=b.UNSIGNED_BYTE);this.type=d;this.context=b;this._lastKnownProgram=null;this._attribLocations=[];this._attribNames=[]};
H3DU.BufferedMesh.prototype._toMeshBuffer=function(){return this.smb};H3DU.BufferedMesh.prototype._getVaoExtension=function(){};H3DU.BufferedMesh.prototype._getBounds=function(){return this._bounds};H3DU.BufferedMesh.prototype.getContext=function(){return this.context};H3DU.BufferedMesh.prototype.getFormat=function(){return this.smb.format};
H3DU.BufferedMesh.prototype.dispose=function(){if("undefined"!==typeof this.vertsMap&&null!==this.vertsMap)for(var a=this.vertsMap.values(),b=0;b<a.length;b++)a[b].dispose();"undefined"!==typeof this.indices&&null!==this.indices&&this.context.deleteBuffer(this.indices);"undefined"!==typeof this.vao&&null!==this.vao&&this._deleteVertexArray(this.context,this.vao);this._lastKnownProgram=this.vao=this.smb=this.indices=this.vertsMap=null;this._attribLocations=[];this._attribNames=[]};
H3DU.BufferedMesh.prototype._getAttribLocations=function(a){if(this._lastKnownProgram!==a){this._lastKnownProgram=a;var b=this.smb._getAttributes();this._attribLocations=[];for(var c=0;c<b.length;c++){var d=[],e=[];a._addNamesWithSemantic(e,b[c][0],b[c][5]);for(var f=0;f<e.length;f++){var h=a.get(e[f]);if("undefined"===typeof h||null===h)h=-1;d.push(h)}this._attribLocations[c]=d;this._attribNames[c]=e}return!0}return!1};
H3DU.BufferedMesh.prototype._prepareDraw=function(a,b){var c=this._getAttribLocations(a,b);this.vao?this._bindVertexArray(b,this.vao):c=!0;if(c){b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indices);for(var c=this.smb._getAttributes(),d=[],e=0;e<this._attribLocations.length;e++)for(var f=0;f<this._attribLocations[e].length;f++){var h=this._attribLocations[e][f];if(0<=h){var g=this.vertsMap.get(c[e][2]);b.bindBuffer(b.ARRAY_BUFFER,g);b.enableVertexAttribArray(h);b.vertexAttribPointer(h,c[e][3],b.FLOAT,
!1,4*c[e][4],4*c[e][1]);d.push(this._attribNames[e][f])}}a._disableOthers(d)}};
H3DU.BufferedMesh.prototype.draw=function(a){var b=a.getContext();if("undefined"===typeof this.vertsMap||null===this.vertsMap)throw Error("mesh buffer disposed");if(b!==this.context)throw Error("can't bind mesh: context mismatch");this._prepareDraw(a,b);a=b.TRIANGLES;0!==(this.smb.format&H3DU.Mesh.LINES_BIT)&&(a=b.LINES);0!==(this.smb.format&H3DU.Mesh.POINTS_BIT)&&(a=b.POINTS);b.drawElements(a,this.smb.indices.length,this.type,0);this._bindVertexArray(b,null)};
H3DU.BufferedMesh.prototype.vertexCount=function(){return this.smb.indices.length};H3DU.BufferedMesh.prototype.primitiveCount=function(){return this.smb.primitiveCount()};H3DU.BufferedMesh._Map=function(){this.map=[]};H3DU.BufferedMesh._Map.prototype.get=function(a){for(var b=0;b<this.map.length;b++)if(this.map[b][0]===a)return this.map[b][1];return null};
H3DU.BufferedMesh._Map.prototype.put=function(a,b){for(var c=0;c<this.map.length;c++)if(this.map[c][0]===a){this.map[c][1]=b;return}this.map.push([a,b])};H3DU.BufferedMesh._Map.prototype.values=function(){for(var a=[],b=0;b<this.map.length;b++)a.push(this.map[b][1]);return a};H3DU.BufferedMesh._MeshLoader=function(){this.meshes=[]};
H3DU.BufferedMesh._MeshLoader.prototype.draw=function(a,b){if(!(a instanceof H3DU.MeshBuffer))throw Error("Expected H3DU.MeshBuffer");for(var c=b.getContext(),d=0;d<this.meshes.length;d++){var e=this.meshes[d];if(e[0]===a&&e[1]===c){e[2].draw(b);return}}d=new H3DU.BufferedMesh(a,b);this.meshes.push([a,c,d]);d.draw(b)};H3DU.BufferedMesh._MeshLoader.prototype.dispose=function(){for(var a=0;a<this.meshes.length;a++)this.meshes[a][2].dispose();this.meshes=[]};H3DU.Math={vec3cross:function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},vec3dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3triple:function(a,b,c){return H3DU.Math.vec3dot(H3DU.Math.vec3cross(b,c))},vec3add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},vec3sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},vec3addInPlace:function(a,b){var c=b[1],d=b[2];a[0]+=b[0];a[1]+=c;a[2]+=d;return a},vec3subInPlace:function(a,b){var c=b[1],d=b[2];a[0]-=
b[0];a[1]-=c;a[2]-=d;return a},vec4add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},vec4sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},vec4addInPlace:function(a,b){var c=b[1],d=b[2],e=b[3];a[0]+=b[0];a[1]+=c;a[2]+=d;a[3]+=e;return a},vec4subInPlace:function(a,b){var c=b[1],d=b[2],e=b[3];a[0]-=b[0];a[1]-=c;a[2]-=d;a[3]-=e;return a},vec3abs:function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])]},vec4abs:function(a){return[Math.abs(a[0]),Math.abs(a[1]),
Math.abs(a[2]),Math.abs(a[3])]},vec3absInPlace:function(a){a[0]=Math.abs(a[0]);a[1]=Math.abs(a[1]);a[2]=Math.abs(a[2]);return a},vec4absInPlace:function(a){a[0]=Math.abs(a[0]);a[1]=Math.abs(a[1]);a[2]=Math.abs(a[2]);a[3]=Math.abs(a[3]);return a},vec3negate:function(a){return[-a[0],-a[1],-a[2]]},vec4negate:function(a){return[-a[0],-a[1],-a[2],-a[3]]},vec3negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},vec4negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},
vec3mul:function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]},vec3mulInPlace:function(a,b){var c=b[1],d=b[2];a[0]*=b[0];a[1]*=c;a[2]*=d;return a},vec3scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},vec3scale:function(a,b){return H3DU.Math.vec3scaleInPlace([a[0],a[1],a[2]],b)},vec3lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c]},vec3perp:function(a){var b=Math.abs(a[0]),c=Math.abs(a[1]),d=Math.max(b,c,Math.abs(a[2])),e=[0,0,0];d===b?(e[0]=a[1],e[1]=
-a[0],e[2]=0):d===c?(e[0]=0,e[1]=a[2],e[2]=-a[1]):(e[0]=-a[2],e[1]=0,e[2]=a[0]);return e},vec3proj:function(a,b){var c=H3DU.Math.vec3dot(b,b);return 0===c?[0,0,0]:H3DU.Math.vec3scale(b,H3DU.Math.vec3dot(a,b)/c)},vec4proj:function(a,b){var c=H3DU.Math.vec4dot(b,b);return 0===c?[0,0,0]:H3DU.Math.vec4scale(b,H3DU.Math.vec4dot(a,b)/c)},vec3reflect:function(a,b){return H3DU.Math.vec3sub(a,H3DU.math.vec3scale(b,2*H3DU.Math.vec3dot(b,a)))},vec3toWindowPoint:function(a,b,c,d){if(0>c[2]||0>c[3])throw Error();
a=H3DU.Math.mat4projectVec3(b,a);b=.5*c[2];var e=.5*c[3];return[a[0]*b+b+c[0],(d?a[1]:-a[1])*e+e+c[1],.5*(a[2]+1)]},vec3fromWindowPoint:function(a,b,c,d){var e=.5*c[2],f=.5*c[3],h=0,g=0,k=2*a[2]-1;0!==e&&0!==f&&(h=(a[0]-c[0]-e)/e,g=(a[1]-c[1]-f)/f);g=d?g:-g;a=H3DU.Math.mat4invert(b);return H3DU.Math.mat4projectVec3(a,[h,g,k])},vec4dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},vec4scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},vec4scale:function(a,b){return[a[0]*
b,a[1]*b,a[2]*b,a[3]*b]},vec4lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c,a[3]+(b[3]-a[3])*c]},vec3normalizeInPlace:function(a){var b=a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b);return a},vec3dist:function(a,b){return H3DU.Math.vec3length(H3DU.Math.vec3sub(a,b))},vec4normalizeInPlace:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],b=Math.sqrt(b*b+c*c+d*d+e*e);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},vec3normalize:function(a){return H3DU.Math.vec3normalizeInPlace([a[0],
a[1],a[2]])},vec4normalize:function(a){return H3DU.Math.vec4normalizeInPlace([a[0],a[1],a[2],a[3]])},vec3length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)},vec3clamp:function(a,b,c){return H3DU.Math.vec3clampInPlace(H3DU.Math.vec3copy(a),b,c)},vec4clamp:function(a,b,c){return H3DU.Math.vec4clampInPlace(H3DU.Math.vec4copy(a),b,c)},vec3clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1])),e=Math.min(c,Math.max(b,a[2]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;a[2]=
e;return a},vec4clampInPlace:function(a,b,c){var d=Math.min(c,Math.max(b,a[1])),e=Math.min(c,Math.max(b,a[2])),f=Math.min(c,Math.max(b,a[3]));a[0]=Math.min(c,Math.max(b,a[0]));a[1]=d;a[2]=e;a[3]=f;return a},vec4length:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},mat3identity:function(){return[1,0,0,0,1,0,0,0,1]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},quatIdentity:function(){return[0,0,0,1]},mat4copy:function(a){return[a[0],a[1],a[2],a[3],
a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]},mat3copy:function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]]},vec3copy:function(a){return[a[0],a[1],a[2]]},vec4copy:function(a){return[a[0],a[1],a[2],a[3]]},vec3assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},vec4assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},mat4isIdentity:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&
0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mat3invert:function(a){var b=[],c=a[4]*a[8]-a[5]*a[7],d=a[5]*a[6]-a[3]*a[8],e=a[3]*a[7]-a[4]*a[6],f=1/(a[0]*c+a[1]*d+a[2]*e);if(0===f)return H3DU.Math.mat3identity();b[0]=c*f;b[1]=(a[2]*a[7]-a[1]*a[8])*f;b[2]=(a[1]*a[5]-a[2]*a[4])*f;b[3]=d*f;b[4]=(a[0]*a[8]-a[2]*a[6])*f;b[5]=(a[2]*a[3]-a[0]*a[5])*f;b[6]=e*f;b[7]=(a[1]*a[6]-a[0]*a[7])*f;b[8]=(a[0]*a[4]-a[1]*a[3])*f;return b},mat4invert:function(a){var b=a[0]*a[10],c=a[0]*a[11],
d=a[0]*a[5],e=a[0]*a[6],f=a[0]*a[7],h=a[0]*a[9],g=a[10]*a[12],k=a[10]*a[13],m=a[10]*a[15],l=a[11]*a[12],n=a[11]*a[13],p=a[11]*a[14],q=a[1]*a[4],r=a[1]*a[6],t=a[1]*a[7],x=a[1]*a[8],w=a[2]*a[4],y=a[2]*a[5],u=a[2]*a[7],z=a[2]*a[8],B=a[2]*a[9],v=a[3]*a[4],N=a[3]*a[5],F=a[3]*a[6],J=a[3]*a[8],C=a[3]*a[9],G=a[4]*a[9],K=a[5]*a[8],L=a[6]*a[8],A=a[6]*a[9],D=a[7]*a[8],E=a[7]*a[9],M=q-d,P=r-y,I=t-N,H=w-e,d=d-q,r=y-r,y=u-F,q=v-f,t=N-t,u=F-u,e=e-w,w=f-v,f=a[9]*a[12]*u+g*I+l*r+a[8]*a[13]*y+k*q+n*e+a[8]*a[14]*t+
a[9]*a[14]*w+p*M+a[8]*a[15]*P+a[9]*a[15]*H+m*d;if(0===f)return H3DU.Math.mat4identity();f=1/f;v=[];v[0]=a[6]*n-a[7]*k+E*a[14]-a[5]*p-A*a[15]+a[5]*m;v[1]=a[3]*k-a[2]*n-C*a[14]+a[1]*p+B*a[15]-a[1]*m;v[2]=a[13]*y+a[14]*t+a[15]*P;v[3]=a[9]*u+a[10]*I+a[11]*r;v[4]=a[7]*g-a[6]*l-D*a[14]+a[4]*p+L*a[15]-a[4]*m;v[5]=a[2]*l-a[3]*g+a[14]*(J-c)+a[15]*(b-z);v[6]=a[12]*u+a[14]*w+a[15]*H;v[7]=a[8]*y+a[10]*q+a[11]*e;v[8]=a[5]*l-E*a[12]+D*a[13]-a[4]*n+a[15]*(G-K);v[9]=C*a[12]-a[1]*l+a[13]*(c-J)+a[15]*(x-h);v[10]=a[12]*
I+a[13]*q+a[15]*d;v[11]=a[8]*t+a[9]*w+a[11]*M;v[12]=A*a[12]-a[5]*g-L*a[13]+a[4]*k+a[14]*(K-G);v[13]=a[1]*g-B*a[12]+a[13]*(z-b)+a[14]*(h-x);v[14]=a[12]*r+a[13]*e+a[14]*M;v[15]=a[8]*P+a[9]*H+a[10]*d;for(a=0;16>a;a++)v[a]*=f;return v},quatConjugate:function(a){return[-a[0],-a[1],-a[2],a[3]]},quatInvert:function(a){var b=1/H3DU.Math.quatDot(a,a);return H3DU.Math.vec4scaleInPlace(H3DU.Math.quatConjugate(a),b)},quatIsIdentity:function(a){return 0===a[0]&&0===a[1]&&0===a[2]&&1===a[3]},quatToMat4:function(a){var b,
c,d,e,f,h,g,k,m;b=2*a[0];c=2*a[1];d=2*a[2];e=b*a[0];f=b*a[1];h=b*a[2];g=c*a[1];k=d*a[1];m=d*a[2];b*=a[3];c*=a[3];a=d*a[3];return[1-(g+m),f+a,h-c,0,f-a,1-(e+m),k+b,0,h+c,k-b,1-(e+g),0,0,0,0,1]},quatToAxisAngle:function(a){var b=a[3],c=1-b*b;return 0<c?(c=1/Math.sqrt(c),[a[0]*c,a[1]*c,a[2]*c,Math.min(1,Math.max(0,Math.acos(b)))*H3DU.Math.Num360DividedByPi]):[0,1,0,0]},quatFromVectors:function(a,b){var c=H3DU.Math.vec3cross(a,b);if(1E-9>H3DU.Math.vec3dot(c,c)){if(0<H3DU.Math.vec3dot(a,b))return[0,0,
0,1];c=H3DU.Math.vec3perp(a);c[3]=0}else{var d=H3DU.Math.vec3length(a)*H3DU.Math.vec3length(b);0===d&&(d=1);c[3]=d+H3DU.Math.vec3dot(a,b)}return H3DU.Math.quatNormalizeInPlace(c)},quatFromAxisAngle:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2]):(e=b[0],c=b[1],b=b[2]);d=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360;a=Math.cos(d);d=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-
a*a):Math.sin(d);e=H3DU.Math.vec3normalizeInPlace([e,c,b]);e=[e[0],e[1],e[2],a];e[0]*=d;e[1]*=d;e[2]*=d;return e},quatFromTaitBryan:function(a,b,c,d){var e,f;if("undefined"===typeof d||null===d)d=H3DU.Math.GlobalRollPitchYaw;if(0>d||6<=d)throw Error("invalid mode");a.constructor===Array?(c=(0<=a[2]&&360>a[2]?a[2]:a[2]%360+(0>a[2]?360:0))*H3DU.Math.PiDividedBy360,e=(0<=a[0]&&360>a[0]?a[0]:a[0]%360+(0>a[0]?360:0))*H3DU.Math.PiDividedBy360,f=(0<=a[1]&&360>a[1]?a[1]:a[1]%360+(0>a[1]?360:0))*H3DU.Math.PiDividedBy360):
(c=(0<=c&&360>c?c:c%360+(0>c?360:0))*H3DU.Math.PiDividedBy360,e=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360,f=(0<=b&&360>b?b:b%360+(0>b?360:0))*H3DU.Math.PiDividedBy360);a=Math.cos(e);e=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(e);b=Math.cos(f);f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(f);var h=Math.cos(c);c=0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-h*h):-Math.sqrt(1-
h*h):Math.sin(c);var g;d===H3DU.Math.GlobalPitchYawRoll||d===H3DU.Math.GlobalPitchRollYaw?(g=[c*f,h*f,c*b,h*b],d===H3DU.Math.GlobalPitchYawRoll&&(g[0]=-g[0]),d=[g[3]*e+g[0]*a,g[1]*a+g[2]*e,g[2]*a-g[1]*e,g[3]*a-g[0]*e]):d===H3DU.Math.GlobalYawPitchRoll||d===H3DU.Math.GlobalYawRollPitch?(g=[h*e,c*e,c*a,h*a],d===H3DU.Math.GlobalYawRollPitch&&(g[1]=-g[1]),d=[g[0]*b-g[2]*f,g[3]*f+g[1]*b,g[2]*b+g[0]*f,g[3]*b-g[1]*f]):(g=[b*e,f*a,f*e,b*a],d===H3DU.Math.GlobalRollPitchYaw&&(g[2]=-g[2]),d=[g[0]*h+g[1]*c,g[1]*
h-g[0]*c,g[3]*c+g[2]*h,g[3]*h-g[2]*c]);return d},quatToTaitBryan:function(a,b){var c=a[3],d,e,f,h=1;if("undefined"===typeof b||null===b)b=H3DU.Math.GlobalRollPitchYaw;if(0>b||6<=b)throw Error("invalid mode");b===H3DU.Math.GlobalRollPitchYaw?(d=a[1],e=a[0],f=a[2],h=-1):b===H3DU.Math.GlobalPitchYawRoll?(d=a[2],e=a[1],f=a[0],h=-1):b===H3DU.Math.GlobalPitchRollYaw?(d=a[1],e=a[2],f=a[0]):b===H3DU.Math.GlobalYawPitchRoll?(d=a[2],e=a[0],f=a[1]):b===H3DU.Math.GlobalYawRollPitch?(d=a[0],e=a[2],f=a[1],h=-1):
(d=a[0],e=a[1],f=a[2]);var g=e*e,k=Math.atan2(2*(c*d-h*e*f),1-2*(d*d+g)),m=2*(c*e+h*d*f);1<m&&(m=1);-1>m&&(m=-1);m=Math.asin(m);e=Math.atan2(2*(c*f-h*d*e),1-2*(g+f*f));k*=H3DU.Math.Num180DividedByPi;m*=H3DU.Math.Num180DividedByPi;e*=H3DU.Math.Num180DividedByPi;if(1E-6>Math.abs(m-90)||1E-6>Math.abs(m+90))e=0,k=Math.atan2(d,c)*H3DU.Math.Num180DividedByPi,isNaN(k)&&(k=0);c=[];b===H3DU.Math.GlobalRollPitchYaw?(c[0]=m,c[1]=k,c[2]=e):b===H3DU.Math.GlobalPitchYawRoll?(c[0]=e,c[1]=m,c[2]=k):b===H3DU.Math.GlobalPitchRollYaw?
(c[0]=e,c[1]=k,c[2]=m):b===H3DU.Math.GlobalYawPitchRoll?(c[0]=m,c[1]=e,c[2]=k):b===H3DU.Math.GlobalYawRollPitch?(c[0]=k,c[1]=e,c[2]=m):(c[0]=k,c[1]=m,c[2]=e);return c},quatNlerp:function(a,b,c){var d=1-c,e=a[0]*d,f=a[1]*d,h=a[2]*d,d=a[3]*d,g=b[0]*c,k=b[1]*c,m=b[2]*c;c*=b[3];return 0>a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]?H3DU.Math.quatNormalizeInPlace([e-g,f-k,h-m,d-c]):H3DU.Math.quatNormalizeInPlace([e+g,f+k,h+m,d+c])},quatSlerp:function(a,b,c){var d=H3DU.Math.quatDot(a,b),e=b;0>d&&(e=[-b[0],-b[1],
-b[2],-b[3]],d=H3DU.Math.quatDot(a,e));if(-1<d)if(1>d){if(d=Math.acos(d),0===d)return H3DU.Math.quatNlerp(a,b,c)}else return H3DU.Math.quatNlerp(a,b,c);else d=Math.PI;var f=1/Math.sin(d);b=Math.sin((1-c)*d)*f;c=Math.sin(c*d)*f;return[a[0]*b+e[0]*c,a[1]*b+e[1]*c,a[2]*b+e[2]*c,a[3]*b+e[3]*c]},quatRotate:function(a,b,c,d,e){return H3DU.Math.quatMultiply(a,H3DU.Math.quatFromAxisAngle(b,c,d,e))},quatTransform:function(a,b){var c=a[1]*b[2]-a[2]*b[1]+b[0]*a[3],d=a[2]*b[0]-a[0]*b[2]+b[1]*a[3],e=a[0]*b[1]-
a[1]*b[0]+b[2]*a[3],f=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];return 3===b.length?[c*a[3]-(d*a[2]-e*a[1])+a[0]*f,d*a[3]-(e*a[0]-c*a[2])+a[1]*f,e*a[3]-(c*a[1]-d*a[0])+a[2]*f]:[c*a[3]-(d*a[2]-e*a[1])+a[0]*f,d*a[3]-(e*a[0]-c*a[2])+a[1]*f,e*a[3]-(c*a[1]-d*a[0])+a[2]*f,1]},quatFromMat4:function(a){var b=[],c=a[1],d=a[2],e=a[4],f=a[6],h=a[8],g=a[9],k=a[0]+a[5]+a[10];0<=k?(a=.5*Math.sqrt(k+1),k=.25/a,b[0]=(f-g)*k,b[1]=(h-d)*k,b[2]=(c-e)*k,b[3]=a):a[0]>a[5]&&a[0]>a[10]?(a=.5*Math.sqrt(1+a[0]-a[5]-a[10]),k=.25/a,b[0]=
a,b[1]=(e+c)*k,b[2]=(d+h)*k,b[3]=(f-g)*k):a[5]>a[10]?(a=.5*Math.sqrt(1+a[5]-a[0]-a[10]),k=.25/a,b[0]=(e+c)*k,b[1]=a,b[2]=(g+f)*k,b[3]=(h-d)*k):(a=.5*Math.sqrt(1+a[10]-a[0]-a[5]),k=.25/a,b[0]=(h+d)*k,b[1]=(g+f)*k,b[2]=a,b[3]=(c-e)*k);return b},mat4toMat3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},mat4transpose:function(a){return H3DU.Math.mat4transposeInPlace(H3DU.Math.mat4copy(a))},mat4transposeInPlace:function(a){var b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];
a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return a},mat3transpose:function(a){return H3DU.Math.mat3transposeInPlace(H3DU.Math.mat3copy(a))},mat3transposeInPlace:function(a){var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return a},mat4inverseTranspose3:function(a){if(0===a[1]&&0===a[2]&&0===a[4]&&0===a[6]&&0===a[8]&&0===a[9])return 1===a[0]&&1===a[5]&&1===a[10]?[1,0,0,0,1,0,0,0,1]:0!==a[0]*a[5]*a[10]?[1/a[0],0,0,0,
1/a[5],0,0,0,1/a[10]]:[1,0,0,0,1,0,0,0,1];a=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];var b=a[0]*a[4]*a[8]+a[3]*a[7]*a[2]+a[6]*a[1]*a[5]-a[6]*a[4]*a[2]-a[3]*a[1]*a[8]-a[0]*a[7]*a[5];if(0===b)return[1,0,0,0,1,0,0,0,1];b=1/b;return[(-a[5]*a[7]+a[4]*a[8])*b,(a[5]*a[6]-a[3]*a[8])*b,(-a[4]*a[6]+a[3]*a[7])*b,(a[2]*a[7]-a[1]*a[8])*b,(-a[2]*a[6]+a[0]*a[8])*b,(a[1]*a[6]-a[0]*a[7])*b,(-a[2]*a[4]+a[1]*a[5])*b,(a[2]*a[3]-a[0]*a[5])*b,(-a[1]*a[3]+a[0]*a[4])*b]},mat4scale:function(a,b,c,d){var e;"undefined"!==
typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0]*e,a[1]*e,a[2]*e,a[3]*e,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],a[15]]},mat4scaled:function(a,b,c){return"undefined"!==typeof b&&"undefined"!==typeof c?[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]:[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},mat4transform:function(a,b,c,d,e){var f;"undefined"!==typeof c&&"undefined"!==typeof d&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],d=b[2],b=b[3]);return[f*
a[0]+c*a[4]+d*a[8]+b*a[12],f*a[1]+c*a[5]+d*a[9]+b*a[13],f*a[2]+c*a[6]+d*a[10]+b*a[14],f*a[3]+c*a[7]+d*a[11]+b*a[15]]},mat4transformVec3:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[4]+b*a[8]+a[12],e*a[1]+c*a[5]+b*a[9]+a[13],e*a[2]+c*a[6]+b*a[10]+a[14]]},mat4projectVec3:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);d=1/(e*a[3]+c*a[7]+b*a[11]+a[15]);return[(e*a[0]+c*
a[4]+b*a[8]+a[12])*d,(e*a[1]+c*a[5]+b*a[9]+a[13])*d,(e*a[2]+c*a[6]+b*a[10]+a[14])*d]},mat3transform:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[3]+b*a[6],e*a[1]+c*a[4]+b*a[7],e*a[2]+c*a[5]+b*a[8]]},mat4translated:function(a,b,c){var d;"undefined"!==typeof b&&"undefined"!==typeof c?(d=a,a=c):(d=a[0],b=a[1],a=a[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,d,b,a,1]},mat4translate:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==
typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*e+a[4]*c+a[8]*b+a[12],a[1]*e+a[5]*c+a[9]*b+a[13],a[2]*e+a[6]*c+a[10]*b+a[14],a[3]*e+a[7]*c+a[11]*b+a[15]]},mat4perspective:function(a,b,c,d){a=1/Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360);var e;e=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,e*(c+d),-1,0,0,e*c*d*2,0]},mat4lookat:function(a,b,c){if("undefined"===typeof c||null===c)c=[0,1,0];if("undefined"===typeof b||
null===b)b=[0,0,0];b=H3DU.Math.vec3sub(b,a);var d=H3DU.Math.vec3length(b);if(1E-6>d)return H3DU.Math.mat4identity();H3DU.Math.vec3scaleInPlace(b,1/d);c=H3DU.Math.vec3normalize(c);c=H3DU.Math.vec3cross(b,c);H3DU.Math.vec3normalizeInPlace(c);d=H3DU.Math.vec3cross(c,b);H3DU.Math.vec3normalizeInPlace(d);H3DU.Math.vec3negateInPlace(b);return[c[0],d[0],b[0],0,c[1],d[1],b[1],0,c[2],d[2],b[2],0,-H3DU.Math.vec3dot(a,c),-H3DU.Math.vec3dot(a,d),-H3DU.Math.vec3dot(a,b),1]},mat4ortho:function(a,b,c,d,e,f){var h=
1/(b-a),g=1/(d-c),k=1/(f-e);return[2*h,0,0,0,0,2*g,0,0,0,0,-2*k,0,-(a+b)*h,-(d+c)*g,-(e+f)*k,1]},mat4perspectiveHorizontal:function(a,b,c,d){return H3DU.Math.mat4perspective(H3DU.Math.Num360DividedByPi*Math.atan2(Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360),b),b,c,d)},mat4ortho2d:function(a,b,c,d){return H3DU.Math.mat4ortho2d(a,b,c,d,-1,1)},mat4ortho2dAspect:function(a,b,c,d,e){return H3DU.Math.mat4orthoAspect(a,b,c,d,-1,1,e)},mat4orthoAspect:function(a,b,c,d,e,f,h){h/=Math.abs((b-
a)/(d-c));var g=Math.abs(b-a),k=Math.abs(d-c);1>h?(h=k/h,d>c?(c-=.5*(h-k),d+=.5*(h-k)):(d-=.5*(h-k),c+=.5*(h-k))):(h*=g,b>a?(a-=.5*(h-g),b+=.5*(h-g)):(b-=.5*(h-g),a+=.5*(h-g)));return H3DU.Math.mat4ortho(a,b,c,d,e,f)},mat4frustum:function(a,b,c,d,e,f){var h=2*e,g=1/(b-a),k=1/(d-c),m=1/(f-e);return[h*g,0,0,0,0,h*k,0,0,(a+b)*g,(d+c)*k,-(f+e)*m,-1,0,0,-(h*f)*m,0]},mat4scaleInPlace:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);a[0]*=e;a[1]*=e;
a[2]*=e;a[3]*=e;a[4]*=c;a[5]*=c;a[6]*=c;a[7]*=c;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a},mat4multiply:function(a,b){for(var c=[],d=0;16>d;d+=4)for(var e=0;4>e;e++)c[d+e]=b[d]*a[e]+b[d+1]*a[e+4]+b[d+2]*a[e+8]+b[d+3]*a[e+12];return c},mat3multiply:function(a,b){var c=[];c[0]=b[0]*a[0]+b[1]*a[3]+b[2]*a[6];c[1]=b[0]*a[1]+b[1]*a[4]+b[2]*a[7];c[2]=b[0]*a[2]+b[1]*a[5]+b[2]*a[8];c[3]=b[3]*a[0]+b[4]*a[3]+b[5]*a[6];c[4]=b[3]*a[1]+b[4]*a[4]+b[5]*a[7];c[5]=b[3]*a[2]+b[4]*a[5]+b[5]*a[8];c[6]=b[6]*a[0]+b[7]*
a[3]+b[8]*a[6];c[7]=b[6]*a[1]+b[7]*a[4]+b[8]*a[7];c[8]=b[6]*a[2]+b[7]*a[5]+b[8]*a[8];return c},quatMultiply:function(a,b){return[a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]+a[1]*b[3]+a[2]*b[0]-a[0]*b[2],a[3]*b[2]+a[2]*b[3]+a[0]*b[1]-a[1]*b[0],a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]]},mat4rotate:function(a,b,c,d,e){var f,h;"undefined"!==typeof d&&"undefined"!==typeof e?(f=c,h=d,c=e,e=b):"undefined"===typeof c?(f=b[0],h=b[1],c=b[2],e=b[3]):(f=c[0],h=c[1],c=c[2],e=b);e=(0<=e&&360>e?e:e%360+(0>
e?360:0))*H3DU.Math.PiDividedBy180;b=Math.cos(e);var g=3.141592653589793>=e?Math.sqrt(1-b*b):-Math.sqrt(1-b*b);if(1===f&&0===h&&0===c)return[a[0],a[1],a[2],a[3],b*a[4]+a[8]*g,b*a[5]+a[9]*g,b*a[6]+a[10]*g,b*a[7]+a[11]*g,b*a[8]-g*a[4],b*a[9]-g*a[5],b*a[10]-g*a[6],b*a[11]-g*a[7],a[12],a[13],a[14],a[15]];if(0===f&&1===h&&0===c)return[b*a[0]-g*a[8],b*a[1]-g*a[9],b*a[2]-g*a[10],b*a[3]-g*a[11],a[4],a[5],a[6],a[7],b*a[8]+a[0]*g,b*a[9]+a[1]*g,b*a[10]+a[2]*g,b*a[11]+a[3]*g,a[12],a[13],a[14],a[15]];if(0===f&&
0===h&&1===c)return[b*a[0]+a[4]*g,b*a[1]+a[5]*g,b*a[2]+a[6]*g,b*a[3]+a[7]*g,b*a[4]-g*a[0],b*a[5]-g*a[1],b*a[6]-g*a[2],b*a[7]-g*a[3],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]];if(0===f&&0===h&&0===c)return H3DU.Math.mat4copy(a);e=1/Math.sqrt(f*f+h*h+c*c);f*=e;h*=e;c*=e;var k=h*h;d=1-b;var m=f*h,l=h*c;e=f*g;h*=g;var n=c*g,g=d*l,p=d*m,q=d*f*c;f=b+d*f*f;m=p+n;l=q-h;k=b+d*k;n=p-n;p=g+e;c=b+d*c*c;b=q+h;e=g-e;return[a[0]*f+a[4]*m+a[8]*l,a[1]*f+a[5]*m+a[9]*l,a[10]*l+a[2]*f+a[6]*m,a[11]*l+a[3]*f+a[7]*
m,a[0]*n+a[4]*k+a[8]*p,a[1]*n+a[5]*k+a[9]*p,a[10]*p+a[2]*n+a[6]*k,a[11]*p+a[3]*n+a[7]*k,a[0]*b+a[4]*e+a[8]*c,a[1]*b+a[5]*e+a[9]*c,a[10]*c+a[2]*b+a[6]*e,a[11]*c+a[3]*b+a[7]*e,a[12],a[13],a[14],a[15]]},mat4rotated:function(a,b,c,d){var e;"undefined"!==typeof c&&"undefined"!==typeof d?(e=b,b=d,d=a):"undefined"===typeof b?(e=a[0],c=a[1],b=a[2],d=a[3]):(e=b[0],c=b[1],b=b[2],d=a);d=(0<=d&&360>d?d:d%360+(0>d?360:0))*H3DU.Math.PiDividedBy180;if(90===d||-270===d)return d=1/Math.sqrt(e*e+c*c+b*b),e*=d,c*=d,
b*=d,[e*e,e*c+b,e*b-c,0,c*e-b,c*c,c*b+e,0,b*e+c,b*c-e,b*b,0,0,0,0,1];if(-90===d||270===d)return d=1/Math.sqrt(e*e+c*c+b*b),e*=d,c*=d,b*=d,[e*e,e*c-b,e*b+c,0,c*e+b,c*c,c*b-e,0,b*e-c,b*c+e,b*b,0,0,0,0,1];if(180===d||-180===d)return d=1/Math.sqrt(e*e+c*c+b*b),e*=d,c*=d,b*=d,[e*e*2-1,e*c*2,e*b*2,0,c*e*2,c*c*2-1,c*b*2,0,b*e*2,b*c*2,b*b*2-1,0,0,0,0,1];a=Math.cos(d);var f=0<=d&&6.283185307179586>d?3.141592653589793>=d?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(d);if(1===e&&0===c&&0===b)return[1,0,0,0,0,
a,f,0,0,-f,a,0,0,0,0,1];if(0===e&&1===c&&0===b)return[a,0,-f,0,0,1,0,0,f,0,a,0,0,0,0,1];if(0===e&&0===c&&1===b)return[a,f,0,0,-f,a,0,0,0,0,1,0,0,0,0,1];if(0===e&&0===c&&0===b)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];d=1/Math.sqrt(e*e+c*c+b*b);e*=d;c*=d;b*=d;d=e*e;var h=c*c,g=b*b,k=e*b,m=c*b,l=e*f,n=c*f,f=b*f,p=1-a;e=p*e*c;c=p*k;b=p*m;return[a+p*d,e+f,c-n,0,e-f,a+p*h,b+l,0,c+n,b-l,a+p*g,0,0,0,0,1]},planeNormalizeInPlace:function(a){var b=a[0],c=a[1],d=a[2],b=Math.sqrt(b*b+c*c+d*d);0!==b&&(b=1/b,a[0]*=
b,a[1]*=b,a[2]*=b,a[3]*=b);return a},planeNormalize:function(a){return H3DU.Math.planeNormalizeInPlace(H3DU.Math.vec4copy(a))},mat4toFrustumPlanes:function(a){var b=[[],[],[],[],[],[]];b[0]=H3DU.Math.planeNormalizeInPlace([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]]);b[1]=H3DU.Math.planeNormalizeInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);b[2]=H3DU.Math.planeNormalizeInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);b[3]=H3DU.Math.planeNormalizeInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],
a[15]+a[13]]);b[4]=H3DU.Math.planeNormalizeInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);b[5]=H3DU.Math.planeNormalizeInPlace([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);return b},frustumHasSphere:function(a,b,c,d,e){if(0>e)throw Error("radius is negative");for(var f=0;6>f;f++){var h=a[f];if(h[3]+h[0]*b+h[1]*c+h[2]*d<-e)return!1}return!0},boxIsEmpty:function(a){return a[0]>a[3]||a[1]>a[4]||a[2]>a[5]},boxDimensions:function(a){return[a[3]-a[0],a[4]-a[1],a[5]-a[2]]},boxCenter:function(a){return[a[0]+
.5*(a[3]-a[0]),a[1]+.5*(a[4]-a[1]),a[2]+.5*(a[5]-a[2])]},frustumHasBox:function(a,b){if(H3DU.Math.boxIsEmpty(b))return!1;for(var c=0;6>c;c++){var d=a[c],e=d[3],f=d[0]*b[0],h=d[2]*b[2],g=d[1]*b[1];if(0>=f+g+h+e&&0>=d[0]*b[3]+d[1]*b[4]+d[2]*b[5]+e&&0>=f+d[1]*b[4]+h+e&&0>=f+d[1]*b[4]+d[2]*b[5]+e&&0>=f+g+d[2]*b[5]+e&&0>=d[0]*b[3]+d[1]*b[4]+h+e&&0>=d[0]*b[3]+g+h+e&&0>=d[0]*b[3]+g+d[2]*b[5]+e)return!1}d=H3DU.Math._frustumPoints(a);for(c=0;3>c;c++){e=b[c];if(d[c]<e&&d[3+c]<e&&d[6+c]<e&&d[9+c]<e&&d[12+c]<
e&&d[15+c]<e&&d[18+c]<e&&d[21+c]<e)return!1;e=b[c+3];if(d[c]>e&&d[3+c]>e&&d[6+c]>e&&d[9+c]>e&&d[12+c]>e&&d[15+c]>e&&d[18+c]>e&&d[21+c]>e)return!1}return!0},_frustumPoints:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],h=a[5],g=[],k=d[1]*f[2],m=d[2]*f[1],l=k-m,n=d[2]*f[0],p=d[0]*f[2],q=n-p,r=d[0]*f[1],t=d[1]*f[0],x=r-t,w=b[2]*d[0],y=b[0]*d[2],u=b[0]*d[1],z=b[1]*d[0],B=f[2]*b[0],v=f[0]*b[2],N=f[0]*b[1],F=f[1]*b[0],J=1/(b[0]*l+b[1]*q+b[2]*x),C=f[1]*b[2],G=f[2]*b[1],K=b[1]*d[2],L=b[2]*d[1],A=-b[3],
D=-d[3],E=-f[3];g[0]=(l*A+(C-G)*D+(K-L)*E)*J;g[1]=(q*A+(B-v)*D+(w-y)*E)*J;g[2]=(x*A+(N-F)*D+(u-z)*E)*J;var M=e[1]*f[2],P=e[2]*f[1],I=M-P,H=e[2]*f[0],O=e[0]*f[2],T=H-O,U=e[0]*f[1],ca=e[1]*f[0],da=U-ca,ea=b[2]*e[0],fa=b[0]*e[2],ga=b[0]*e[1],ha=b[1]*e[0],V=1/(b[0]*I+b[1]*T+b[2]*da),ia=b[1]*e[2],ja=b[2]*e[1],Q=-e[3];g[3]=(I*A+(C-G)*Q+(ia-ja)*E)*V;g[4]=(T*A+(B-v)*Q+(ea-fa)*E)*V;g[5]=(da*A+(N-F)*Q+(ga-ha)*E)*V;var ka=k-m,la=n-p,ma=r-t,na=c[2]*d[0],oa=c[0]*d[2],pa=c[0]*d[1],qa=c[1]*d[0],ra=f[2]*c[0],sa=
f[0]*c[2],ta=f[0]*c[1],ua=f[1]*c[0],W=1/(c[0]*ka+c[1]*la+c[2]*ma),va=f[1]*c[2],wa=f[2]*c[1],xa=c[1]*d[2],ya=c[2]*d[1],R=-c[3];g[6]=(ka*R+(va-wa)*D+(xa-ya)*E)*W;g[7]=(la*R+(ra-sa)*D+(na-oa)*E)*W;g[8]=(ma*R+(ta-ua)*D+(pa-qa)*E)*W;var za=M-P,Aa=H-O,Ba=U-ca,Ca=c[2]*e[0],Da=c[0]*e[2],Ea=c[0]*e[1],Fa=c[1]*e[0],X=1/(c[0]*za+c[1]*Aa+c[2]*Ba),Ga=c[1]*e[2],Ha=c[2]*e[1];g[9]=(za*R+(va-wa)*Q+(Ga-Ha)*E)*X;g[10]=(Aa*R+(ra-sa)*Q+(Ca-Da)*E)*X;g[11]=(Ba*R+(ta-ua)*Q+(Ea-Fa)*E)*X;var Ia=d[1]*h[2],Ja=d[2]*h[1],Ka=Ia-
Ja,La=d[2]*h[0],Ma=d[0]*h[2],Na=La-Ma,Oa=d[0]*h[1],Pa=d[1]*h[0],Qa=Oa-Pa,Ra=h[2]*b[0],Sa=h[0]*b[2],Ta=h[0]*b[1],Ua=h[1]*b[0],Y=1/(b[0]*Ka+b[1]*Na+b[2]*Qa),Va=h[1]*b[2],Wa=h[2]*b[1],S=-h[3];g[12]=(Ka*A+(Va-Wa)*D+(K-L)*S)*Y;g[13]=(Na*A+(Ra-Sa)*D+(w-y)*S)*Y;g[14]=(Qa*A+(Ta-Ua)*D+(u-z)*S)*Y;var Xa=e[1]*h[2],Ya=e[2]*h[1],Za=Xa-Ya,$a=e[2]*h[0],ab=e[0]*h[2],bb=$a-ab,cb=e[0]*h[1],db=e[1]*h[0],eb=cb-db,Z=1/(b[0]*Za+b[1]*bb+b[2]*eb);g[15]=(Za*A+(Va-Wa)*Q+(ia-ja)*S)*Z;g[16]=(bb*A+(Ra-Sa)*Q+(ea-fa)*S)*Z;g[17]=
(eb*A+(Ta-Ua)*Q+(ga-ha)*S)*Z;var fb=Ia-Ja,gb=La-Ma,hb=Oa-Pa,ib=h[2]*c[0],jb=h[0]*c[2],kb=h[0]*c[1],lb=h[1]*c[0],aa=1/(c[0]*fb+c[1]*gb+c[2]*hb),mb=h[1]*c[2],nb=h[2]*c[1];g[18]=(fb*R+(mb-nb)*D+(xa-ya)*S)*aa;g[19]=(gb*R+(ib-jb)*D+(na-oa)*S)*aa;g[20]=(hb*R+(kb-lb)*D+(pa-qa)*S)*aa;var ob=Xa-Ya,pb=$a-ab,qb=cb-db,ba=1/(c[0]*ob+c[1]*pb+c[2]*qb);g[21]=(ob*R+(mb-nb)*Q+(Ga-Ha)*S)*ba;g[22]=(pb*R+(ib-jb)*Q+(Ca-Da)*S)*ba;g[23]=(qb*R+(kb-lb)*Q+(Ea-Fa)*S)*ba;return g},frustumHasPoint:function(a,b,c,d){for(var e=
0;6>e;e++)if(0>=a[e][0]*b+a[e][1]*c+a[e][2]*d+a[e][3])return!1;return!0},colorTosRGB:function(a){return[.00304>=a[0]?12.92*a[0]:1.0556*Math.pow(a[0],.41666666667)-.0556,.00304>=a[1]?12.92*a[1]:1.0556*Math.pow(a[1],.41666666667)-.0556,.00304>=a[2]?12.92*a[2]:1.0556*Math.pow(a[2],.41666666667)-.0556,3>=a.length?1:a[3]]},colorToLinear:function(a){return[.03928>=a[0]?.077399381*a[0]:Math.pow(.947328534*(.0556+a[0]),2.4),.03928>=a[1]?.077399381*a[1]:Math.pow(.947328534*(.0556+a[1]),2.4),.03928>=a[2]?.077399381*
a[2]:Math.pow(.947328534*(.0556+a[2]),2.4),3>=a.length?1:a[3]]}};H3DU.Math.quatDot=H3DU.Math.vec4dot;H3DU.Math.quatNormalizeInPlace=H3DU.Math.vec4normalizeInPlace;H3DU.Math.quatNormalize=H3DU.Math.vec4normalize;H3DU.Math.quatLength=H3DU.Math.vec4length;H3DU.Math.quatScaleInPlace=H3DU.Math.vec4scaleInPlace;H3DU.Math.quatScale=H3DU.Math.vec4scale;H3DU.Math.quatCopy=H3DU.Math.vec4copy;H3DU.Math.PiTimes2=6.283185307179586;H3DU.Math.HalfPi=1.5707963267948966;H3DU.Math.PiDividedBy180=.017453292519943295;
H3DU.Math.ToRadians=H3DU.Math.PiDividedBy180;H3DU.Math.PiDividedBy360=.008726646259971648;H3DU.Math.Num360DividedByPi=114.59155902616465;H3DU.Math.Num180DividedByPi=57.29577951308232;H3DU.Math.ToDegrees=H3DU.Math.Num180DividedByPi;H3DU.Math.GlobalPitchYawRoll=0;H3DU.Math.GlobalPitchRollYaw=1;H3DU.Math.GlobalYawPitchRoll=2;H3DU.Math.GlobalYawRollPitch=3;H3DU.Math.GlobalRollPitchYaw=4;H3DU.Math.GlobalRollYawPitch=5;H3DU.Math.LocalPitchYawRoll=H3DU.Math.GlobalRollYawPitch;
H3DU.Math.LocalPitchRollYaw=H3DU.Math.GlobalYawRollPitch;H3DU.Math.LocalYawPitchRoll=H3DU.Math.GlobalRollPitchYaw;H3DU.Math.LocalYawRollPitch=H3DU.Math.GlobalPitchRollYaw;H3DU.Math.LocalRollPitchYaw=H3DU.Math.GlobalYawPitchRoll;H3DU.Math.LocalRollYawPitch=H3DU.Math.GlobalPitchYawRoll;H3DU.Math.PitchYawRoll=0;H3DU.Math.PitchRollYaw=1;H3DU.Math.YawPitchRoll=2;H3DU.Math.YawRollPitch=3;H3DU.Math.RollPitchYaw=4;H3DU.Math.RollYawPitch=5;H3DU.Math.quatInverse=H3DU.Math.quatInvert;H3DU.Math.vec3norm=H3DU.Math.vec3normalize;
H3DU.Math.vec4norm=H3DU.Math.vec4normalize;H3DU.Math.quatNorm=H3DU.Math.quatNormalize;H3DU.Math.vec3normInPlace=H3DU.Math.vec3normalizeInPlace;H3DU.Math.vec4normInPlace=H3DU.Math.vec4normalizeInPlace;H3DU.Math.quatNormInPlace=H3DU.Math.quatNormalizeInPlace;H3DU.Math.planeNormInPlace=H3DU.Math.planeNormalizeInPlace;H3DU.Math.planeNorm=H3DU.Math.planeNormalize;H3DU.ShaderInfo=function(a,b){if("undefined"===typeof a||null===a)a=H3DU.ShaderInfo.getDefaultVertex();if("undefined"===typeof b||null===b)b=H3DU.ShaderInfo.getDefaultFragment();this.vertexShader=a;this.fragmentShader=b;this.uniformValues={};this.attributeSemantics={};this.attributeSemantics.position=new Uint32Array([H3DU.Semantic.POSITION,0]);this.attributeSemantics.tangent=new Uint32Array([H3DU.Semantic.TANGENT,0]);this.attributeSemantics.bitangent=new Uint32Array([H3DU.Semantic.BITANGENT,0]);this.attributeSemantics.normal=
new Uint32Array([H3DU.Semantic.NORMAL,0]);this.attributeSemantics.uv=new Uint32Array([H3DU.Semantic.TEXCOORD,0]);this.attributeSemantics.colorAttr=new Uint32Array([H3DU.Semantic.COLOR,0]);this.uniformSemantics={};this.uniformSemantics.projection=H3DU.Semantic.PROJECTION;this.uniformSemantics.world=H3DU.Semantic.MODEL;this.uniformSemantics.inverseView=H3DU.Semantic.VIEWINVERSE;this.uniformSemantics.modelViewMatrix=H3DU.Semantic.MODELVIEW;this.uniformSemantics.normalMatrix=H3DU.Semantic.MODELVIEWINVERSETRANSPOSE};
H3DU.ShaderInfo.prototype.setUniformSemantic=function(a,b){this.uniformSemantics[a]=b;return this};H3DU.ShaderInfo.prototype.getVertexShader=function(){return this.vertexShader};H3DU.ShaderInfo.prototype.getFragmentShader=function(){return this.fragmentShader};H3DU.ShaderInfo.prototype.dispose=function(){};
H3DU.ShaderInfo.prototype.setSemantic=function(a,b,c){var d=this.attributeSemantics[a],e=H3DU.MeshBuffer._resolveSemantic(b,c);if(!e)throw Error("Can't resolve "+[a,b,c]);d?(d[0]=e[0],d[1]=e[1]):this.attributeSemantics[a]=e;return this};
H3DU.ShaderInfo.prototype.copy=function(){var a=new H3DU.ShaderInfo(this.vertexShader,this.fragmentShader);a.setUniforms(this.uniformValues);for(var b in this.attributeSemantics)if(Object.prototype.hasOwnProperty.call(this.attributeSemantics,b)){var c=this.attributeSemantics[b];a.attributeSemantics[b]=c.slice(0,2)}for(b in this.uniformSemantics)Object.prototype.hasOwnProperty.call(this.uniformSemantics,b)&&(c=this.uniformSemantics[b],a.uniformSemantics[b]=c);return a};
H3DU.ShaderInfo.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,null);return this};
H3DU.ShaderInfo._setUniformInternal=function(a,b,c,d){a=a[c];var e=b[c];if("number"===typeof a){var f=!1;"undefined"===typeof e||null===e?(b[c]=e=a,f=!0):e!==a&&(e=a,b[c]=a,f=!0);f&&d&&(d[c]=e)}else if(a instanceof H3DU.TextureInfo)"undefined"!==typeof e&&null!==e&&e instanceof H3DU.TextureInfo?e.copyFrom(a):b[c]=(new H3DU.TextureInfo).copyFrom(a);else if(3===a.length)if(!e)b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2])e[0]=a[0],e[1]=a[1],e[2]=
a[2],d&&(d[c]=e.slice(0,e.length))}else if(2===a.length)if(!e)b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1])e[0]=a[0],e[1]=a[1],d&&(d[c]=e.slice(0,e.length))}else if(4===a.length)if(!e)b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3])e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3],d&&(d[c]=e.slice(0,e.length))}else 16===a.length?e?H3DU.ShaderInfo._copyIfDifferent(a,e,16)&&d&&(d[c]=e.slice(0,e.length)):
(b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length))):9===a.length&&(e?H3DU.ShaderInfo._copyIfDifferent(a,e,9)&&d&&(d[c]=e.slice(0,e.length)):(b[c]=a.slice(0,a.length),d&&(d[c]=a.slice(0,a.length))))};H3DU.ShaderInfo._copyIfDifferent=function(a,b,c){for(var d=0;d<c;d++)if(a[d]!==b[d]){b[d]=a[d];for(d+=1;d<c;d++)b[d]=a[d];return!0}return!1};H3DU.ShaderInfo._setUniformsInternal=function(a,b,c){for(var d,e=Object.keys(a),f=0;f<e.length;f++)d=e[f],H3DU.ShaderInfo._setUniformInternal(a,b,d,c)};
H3DU.ShaderInfo.fragmentShaderHeader=function(){return"#ifdef GL_ES\n#ifndef GL_FRAGMENT_PRECISION_HIGH\nprecision mediump float;\n#else\nprecision highp float;\n#endif\n#endif\n"};H3DU.ShaderInfo.makeEffectFragment=function(a){var b=H3DU.ShaderInfo.fragmentShaderHeader();return b+"uniform sampler2D sampler;\nuniform vec2 textureSize;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n"+a+"\n\nvoid main() {\n // normalize coordinates to 0..1\n vec2 uv=gl_FragCoord.xy/textureSize.xy;\n gl_FragColor=textureEffect(sampler,uv,textureSize);\n}"};
H3DU.ShaderInfo.makeCopyEffect=function(){var a=H3DU.ShaderInfo.fragmentShaderHeader(),a=a+"uniform sampler2D sampler;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n\n\nvoid main() {\n gl_FragColor=texture2D(sampler,uvVar);\n}";return new H3DU.ShaderInfo(H3DU.ShaderInfo.getBasicVertex(),a)};H3DU.ShaderInfo.makeEffect=function(a){return new H3DU.ShaderInfo(H3DU.ShaderInfo.getBasicVertex(),H3DU.ShaderInfo.makeEffectFragment(a))};H3DU.ShaderInfo.makeInvertEffect=function(){return H3DU.ShaderInfo.makeEffect("vec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize) {\n vec4 color=texture2D(sampler,uvCoord);\n vec4 ret; ret.xyz=vec3(1.0,1.0,1.0)-color.xyz; ret.w=color.w; return ret;\n}")};
H3DU.ShaderInfo.makeEdgeDetectEffect=function(){return H3DU.ShaderInfo.makeEffect("float luma(vec3 color) {\n return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}\nconst vec4 edge_color=vec4(0.,0,0,1);\nconst vec4 back_color=vec4(1.,1,1,1);\nvec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize) {\nfloat dx = 1.0 / float(textureSize.x);\nfloat dy = 1.0 / float(textureSize.y);\nfloat s00 = luma(texture2D(sampler, uvCoord + vec2(-dx,dy)).rgb);\nfloat s10 = luma(texture2D(sampler, uvCoord + vec2(-dx,0.0)).rgb);\nfloat s20 = luma(texture2D(sampler, uvCoord + vec2(-dx,-dy)).rgb);\nfloat s01 = luma(texture2D(sampler, uvCoord + vec2(0.0,dy)).rgb);\nfloat s21 = luma(texture2D(sampler, uvCoord + vec2(0.0,-dy)).rgb);\nfloat s02 = luma(texture2D(sampler, uvCoord + vec2(dx, dy)).rgb);\nfloat s12 = luma(texture2D(sampler, uvCoord + vec2(dx, 0.0)).rgb);\nfloat s22 = luma(texture2D(sampler, uvCoord + vec2(dx, -dy)).rgb);\nfloat sx = s00 + 2.0 * s10 + s20 - (s02 + 2.0 * s12 + s22);\nfloat sy = s00 + 2.0 * s01 + s02 - (s20 + 2.0 * s21 + s22);\nfloat dist = sx * sx + sy * sy;\nif(dist > 0.4) {\nreturn edge_color;\n} else {\nreturn back_color;\n}}")};
H3DU.ShaderInfo.getBasicVertex=function(){return"attribute vec3 position;\n\nattribute vec2 uv;\n\nvarying vec2 uvVar;\n\n#ifdef COLORATTR\n\nattribute vec3 colorAttr;\n\nvarying vec3 colorAttrVar;\n\n#endif\n\nvoid main() {\n\nvec4 positionVec4;\n\npositionVec4.w=1.0;\n\npositionVec4.xyz=position;\n\ngl_PointSize=1.0;\n\nuvVar=uv;\n\n#ifdef COLORATTR\n\ncolorAttrVar=colorAttr;\n\n#endif\n\ngl_Position=positionVec4;\n\n}\n"};H3DU.ShaderInfo.getDefaultVertex=function(){return"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\n#ifdef COLORATTR\nattribute vec3 colorAttr;\nvarying vec3 colorAttrVar;\n#endif\nattribute vec3 tangent;\nattribute vec3 bitangent;\nuniform mat4 projection;\nuniform mat4 modelViewMatrix;\n#ifdef SHADING\nuniform mat3 normalMatrix; /* internal */\nuniform mat4 world;\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#endif\nvarying vec2 uvVar;\nvoid main() {\nvec4 positionVec4;\npositionVec4.w=1.0;\npositionVec4.xyz=position;\ngl_PointSize=1.0;\ngl_Position=(projection*modelViewMatrix)*positionVec4;\n#ifdef COLORATTR\ncolorAttrVar=colorAttr;\n#endif\nuvVar=uv;\n#ifdef SHADING\ntransformedNormalVar=normalize(normalMatrix*normal);\n#ifdef NORMAL_MAP\ntbnMatrixVar=mat3(normalize(vec3(world*vec4(tangent,0.0))),\n   normalize(bitangent),transformedNormalVar);\n#endif\nviewPositionVar=modelViewMatrix*positionVec4;\n#endif\n}"};
H3DU.ShaderInfo.getDefaultFragment=function(){var a,b=H3DU.ShaderInfo.fragmentShaderHeader()+["#define ONE_DIV_PI 0.318309886\n#define ONE_DIV_TWOPI 0.159154943\n#define PI 3.141592654\n#define TWOPI 6.283185307\n#define saturate(f) clamp(f, 0.0, 1.0)\nvec3 tolinear(vec3 c) {\n c=saturate(c);\n bvec3 lt=lessThanEqual(c,vec3(0.03928));\n return mix(pow((0.0556+c)*0.947328534,vec3(2.4)),0.077399381*c,vec3(lt));\n}\nvec3 fromlinear(vec3 c) {\n c=saturate(c);\n bvec3 lt=lessThanEqual(c,vec3(0.00304));\n return mix(pow(c,vec3(0.41666666667))*1.0556-0.0556,12.92*c,vec3(lt));\n}\nuniform vec4 md;\n#ifdef SHADING\nstruct light {\n vec4 position;\n vec4 diffuse;\n#ifdef SPECULAR\n vec4 specular;\n#endif\n vec4 radius;\n};\nuniform vec3 sceneAmbient;",
"uniform light lights["+H3DU.Lights.MAX_LIGHTS+"];","uniform vec3 ma;\nuniform vec3 me;\n#ifdef METALNESS\nuniform float metalness;\n#endif\n#ifdef METALNESS_MAP\nuniform sampler2D metalnessMap;\n#endif\n#ifdef ROUGHNESS\nuniform float roughness;\n#endif\n#ifdef ROUGHNESS_MAP\nuniform sampler2D roughnessMap;\n#endif\n#ifdef SPECULAR_MAP\nuniform sampler2D specularMap;\n#endif\n#ifdef ENV_MAP\nuniform samplerCube envMap;\n#endif\n#ifdef ENV_EQUIRECT\nuniform sampler2D envMap;\n#endif\n#ifdef EMISSION_MAP\nuniform sampler2D emissionMap;\n#endif\nuniform mat4 inverseView;\n#ifdef NORMAL_MAP\nuniform sampler2D normalMap;\n#endif\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\n#ifdef SPECULAR\nuniform vec3 ms;\nuniform float mshin;\n#endif\n#endif\n#ifdef TEXTURE\nuniform sampler2D sampler;\n#endif\n#ifdef COLORATTR\nvarying vec3 colorAttrVar;\n#endif\nvarying vec2 uvVar;\n#ifdef SHADING\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\nvec4 calcLightPower(light lt, vec4 vertexPosition) {\n vec3 sdir;\n float attenuation;\n if(lt.position.w == 0.0) { /* directional light */\n  sdir=normalize((lt.position).xyz);\n  attenuation=1.0;\n } else { /* point light */\n  vec3 vertexToLight=(lt.position-vertexPosition).xyz;\n  float dsSquared=dot(vertexToLight,vertexToLight);\n  sdir=inversesqrt(dsSquared)*vertexToLight;\n  if(lt.radius.x == 0.0) {\n    attenuation=1.0;\n  } else {\n   float radiusPow4=lt.radius.x;\n   float distPow4=dsSquared*dsSquared;\n   float attenDivisor=max(0.0001,dsSquared);\n   float cut=saturate(1.0-distPow4/radiusPow4);\n   attenuation=(cut*cut)/attenDivisor;\n  }\n }\n return vec4(sdir,attenuation);\n}\n#endif\n#ifdef PHYSICAL_BASED\n#define HABLE_TONEMAP_WHITE 1.37906425\nvec3 tonemapHable(vec3 c) {\n  vec3 c2=c*2.0;\n  return HABLE_TONEMAP_WHITE*\n    (((c2*(0.15*c2+0.05)+0.004)/\n     (c2*(0.15*c2+0.5)+0.06))-0.066666);\n}\nfloat ndf(float dotnh, float alpha) {\n float alphasq=alpha*alpha;\n float d=dotnh*dotnh*(alphasq-1.0)+1.0;\n return alphasq*ONE_DIV_PI/(d*d);\n}\nfloat gsmith(float dotnv, float dotnl, float alpha) {\n float a1=(alpha+1.0);\n float k=a1*a1*0.125;\n float invk=(1.0-k);\n return dotnl/(dotnl*invk+k)*dotnv/(dotnv*invk+k);\n}\nfloat gsmithindirect(float dotnv, float dotnl, float alpha) {\n float k=alpha*alpha*0.5;\n float invk=(1.0-k);\n return dotnl/(dotnl*invk+k)*dotnv/(dotnv*invk+k);\n}\nvec3 fresnelschlick(float dothl, vec3 f0) {\n float id=1.0-dothl;\n float idsq=id*id;\n return f0+(vec3(1.0)-f0)*idsq*idsq*id;\n}\nvec3 reflectancespec(vec3 diffuse, vec3 specular, vec3 lightDir, vec3 viewDir, vec3 n, float rough) {\n vec3 h=normalize(viewDir+lightDir);\n float dotnv=abs(dot(n,viewDir))+0.0001;\n float dotnh=saturate(dot(n,h));\n float dotnl=saturate(dot(n,lightDir));\n float dothl=saturate(dot(h,lightDir));\n vec3 ctnum=ndf(dotnh,rough)*gsmith(dotnv,dotnl,rough)*fresnelschlick(dothl,specular);\n float ctden=min(dotnl*dotnv,0.0001);\n return diffuse*ONE_DIV_PI+ctnum*0.25/ctden;\n}\n#ifndef SPECULAR\nvec3 reflectance(vec3 color, vec3 lightDir, vec3 viewDir, vec3 n, float rough, float metal) {\n vec3 h=normalize(viewDir+lightDir);\n float dothl=saturate(dot(h,lightDir));\n vec3 refl=mix(vec3(0.04),color,metal);\n vec3 fr=fresnelschlick(dothl,refl);\n vec3 refr=mix((vec3(1.0)-fr)*color,vec3(0.0),metal);\n return reflectancespec(refr, refl, lightDir, viewDir, n, rough);\n}\n#endif\n#endif\nvoid main() {\n vec3 normal;\n#ifdef TEXTURE\n   vec4 baseColor=texture2D(sampler,uvVar);\n#else\n#ifdef COLORATTR\n   vec4 baseColor;\n   baseColor.w=1.0;\n   baseColor.xyz=colorAttrVar;\n#else\n   vec4 baseColor=md;\n#endif\n#endif\n#ifdef SHADING\n#ifdef NORMAL_MAP\nnormal = normalize(tbnMatrixVar*(2.0*texture2D(normalMap,uvVar).rgb - vec3(1.0)));\n#else\nnormal = normalize(transformedNormalVar);\n#endif\nvec4 lightPowerVec;\nfloat lightCosine, specular;\nvec3 materialAmbient=tolinear(ma);\nvec3 materialDiffuse=tolinear(baseColor.rgb);\nvec3 materialEmission;\n#ifdef EMISSION_MAP\nmaterialEmission=texture2D(emissionMap,uvVar).rgb;\n#else\n materialEmission=me.rgb;\n#endif\n materialEmission=tolinear(materialEmission);\nfloat materialAlpha=baseColor.a;\nvec4 tview=inverseView*vec4(0.0,0.0,0.0,1.0)-viewPositionVar;\nvec3 viewDirection=normalize(tview.xyz/tview.w);\nvec3 environment=vec3(1.0);\n#ifdef PHYSICAL_BASED\nvec3 lightedColor=vec3(0.05)*materialDiffuse;\n#else\nvec3 lightedColor=sceneAmbient*materialAmbient;\n#endif\n#if defined(SPECULAR) || defined(SPECULAR_MAP)\nvec3 materialSpecular=vec3(0.0);\n#endif\nvec3 spectmp, lightFactor;\nfloat rough = 0.0;\nfloat metal = 0.0;\n#ifdef SPECULAR\nmaterialSpecular=tolinear(ms);\n#endif\n#ifdef SPECULAR_MAP\nmaterialSpecular=tolinear(texture2D(specularMap,uvVar).rgb);\n#endif\n#ifdef PHYSICAL_BASED\n#ifdef ROUGHNESS\nrough=roughness;\n#endif\n#ifndef ROUGHNESS\n#ifdef SPECULAR\nrough=clamp(sqrt(2.0/(2.0+mshin)),0.0,1.0);\n#endif\n#endif\n#ifdef ROUGHNESS_MAP\nrough=texture2D(roughnessMap,uvVar).r;\n#endif\n#ifdef INVERT_ROUGHNESS\nrough=1.0-rough;\n#endif\n#ifdef METALNESS\nmetal=metalness;\n#endif\n#ifdef METALNESS_MAP\nmetal=texture2D(metalnessMap,uvVar).r;\n#endif\n#endif\n"].join("\n")+
"\n";for(a=0;a<H3DU.Lights.MAX_LIGHTS;a++)b+=["lightPowerVec=calcLightPower(lights["+a+"],viewPositionVar);","lightCosine=saturate(dot(normal,lightPowerVec.xyz));\nspectmp = vec3(greaterThan(vec3(lightCosine),vec3(0.0001)));\n#ifdef PHYSICAL_BASED","    lightFactor=spectmp*lightCosine*lightPowerVec.w*tolinear(lights["+a+"].diffuse.xyz);","#ifdef SPECULAR\n    lightedColor+=reflectancespec(materialDiffuse,materialSpecular,normalize(lightPowerVec.xyz),\n         normalize(viewDirection),normal,rough)*lightFactor;\n#else\n    lightedColor+=reflectance(materialDiffuse,normalize(lightPowerVec.xyz),\n         normalize(viewDirection),normal,rough,metal)*lightFactor;\n#endif\n#else",
"    lightedColor+=spectmp*materialDiffuse*lightCosine*lightPowerVec.w*tolinear(lights["+a+"].diffuse.xyz);","#ifdef SPECULAR\n    specular=saturate(dot(normalize(viewDirection+lightPowerVec.xyz),normal));\n    specular=pow(specular,mshin);","    lightedColor+=spectmp*materialSpecular*specular*lightPowerVec.w*tolinear(lights["+a+"].specular.xyz);","#endif\n#endif\n"].join("\n")+"\n";return b+" lightedColor+=materialEmission.rgb;\n lightedColor=fromlinear(lightedColor);\n baseColor=vec4(lightedColor,materialAlpha);\n#endif\n gl_FragColor=baseColor;\n}\n"};H3DU.RenderPass3D=function(a,b){this.batch=a;this.clearStencil=this.clearDepth=this.clearColor=!0;this.shader=this.frameBuffer=null;this.useFrameBufferSize=!1;this.setParams(b)};
H3DU.RenderPass3D.prototype.setParams=function(a){if(a){"undefined"!==typeof a.clearColor&&(this.clearColor=a.clearColor);"undefined"!==typeof a.clearDepth&&(this.clearDepth=a.clearDepth);"undefined"!==typeof a.shader&&(this.shader=a.shader);"undefined"!==typeof a.clearStencil&&(this.clearStencil=a.clearStencil);"undefined"!==typeof a.useFrameBufferSize&&(this.useFrameBufferSize=a.useFrameBufferSize);if("undefined"!==typeof a.frameBuffer){if(a.frameBuffer instanceof H3DU.FrameBuffer)throw Error("FrameBuffer not supported");
this.frameBuffer=a.frameBuffer}return this}};H3DU.ShapeGroup=function(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new H3DU.Transform};H3DU.ShapeGroup.prototype.shapeCount=function(){return this.shapes.length};H3DU.ShapeGroup.prototype.getShape=function(a){return"undefined"===typeof this.shapes[a]?null:this.shapes[a]};H3DU.ShapeGroup.prototype.setShape=function(a,b){this.shapes[a]=b;return this};
H3DU.ShapeGroup.prototype.copy=function(){var a=new H3DU.ShapeGroup;a.visible=this.visible;a.transform=this.transform.copy();for(var b=0;b<this.shapes.length;b++)a.addShape(this.shapes[b].copy());return a};H3DU.ShapeGroup.prototype.addShape=function(a){if(!a)throw Error();a.parent=this;this.shapes.push(a);return this};H3DU.ShapeGroup.prototype.setVisible=function(a){this.visible=!!a;return this};H3DU.ShapeGroup.prototype.getVisible=function(){return this.visible};
H3DU.ShapeGroup.prototype.getTransform=function(){return this.transform};H3DU.ShapeGroup.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if("undefined"!==typeof this.parent&&null!==this.parent)var c=this.parent.getMatrix(),a=b?H3DU.Math.mat4multiply(c,a.getMatrix()):H3DU.Math.mat4isIdentity(c)?a.getMatrix():c;else a=a.getMatrix();return a};H3DU.ShapeGroup.prototype.setTransform=function(a){this.transform=a.copy();return this};
H3DU.ShapeGroup.prototype.setMaterial=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterial(a);return this};H3DU.ShapeGroup.prototype.setTexture=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setTexture(a);return this};H3DU.ShapeGroup.prototype.setShader=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setShader(a);return this};
H3DU.ShapeGroup.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};
H3DU.ShapeGroup.prototype.getBounds=function(){for(var a=Number.POSITIVE_INFINITY,a=[a,a,a,-a,-a,-a],b=!0,c=0;c<this.shapes.length;c++){var d=this.shapes[c].getBounds();H3DU.Math.boxIsEmpty(d)||(b?(a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=d[3],a[4]=d[4],a[5]=d[5],b=!1):(a[0]=Math.min(d[0],a[0]),a[1]=Math.min(d[1],a[1]),a[2]=Math.min(d[2],a[2]),a[3]=Math.max(d[3],a[3]),a[4]=Math.max(d[4],a[4]),a[5]=Math.max(d[5],a[5])))}return a};
H3DU.ShapeGroup.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};H3DU.ShapeGroup.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};H3DU.ShapeGroup.prototype.setPosition=function(a,b,c){this.transform.setPosition(a,b,c);return this};H3DU.ShapeGroup.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};
H3DU.ShapeGroup.prototype.setScale=function(a,b,c){this.transform.setScale(a,b,c);return this};H3DU.Mesh=function(a,b,c){this._initialize(a,b,c);this._elementsDefined=0;this.currentMode=-1;this.normal=[0,0,0];this.color=[0,0,0];this.tangent=[0,0,0];this.bitangent=[0,0,0];this.texCoord=[0,0]};H3DU.Mesh._primitiveType=function(a){return a===H3DU.Mesh.LINES||a===H3DU.Mesh.LINE_STRIP?H3DU.Mesh.LINES:a===H3DU.Mesh.POINTS?H3DU.Mesh.POINTS:H3DU.Mesh.TRIANGLES};H3DU.Mesh._isCompatibleMode=function(a,b){return a===b||H3DU.Mesh._primitiveType(a)===H3DU.Mesh._primitiveType(b)?!0:!1};
H3DU.Mesh._recalcNormalsStart=function(a,b,c,d,e,f){for(c=0;c<a.length;c+=d)if(a[c+e]=0,a[c+e+1]=0,a[c+e+2]=0,!f){var h=[a[c],a[c+1],a[c+2]];b[h]?b[h].push(c+e):b[h]=[c+e]}};
H3DU.Mesh._recalcNormalsFinish=function(a,b,c,d,e,f){c=[];var h;if(!f)for(var g in b)if(Object.prototype.hasOwnProperty.call(b,g)){var k=b[g];if(k&&k.constructor===Array&&2<=k.length){f=k[0];var m=a[f],l=a[f+1],n=a[f+2];c[0]=m;c[1]=l;c[2]=n;h=3;for(f=1;f<k.length;f++){for(var p=!1,q=a[k[f]],r=a[k[f]+1],t=a[k[f]+2],x=0;x<h;x+=3)if(q===c[x]&&r===c[x+1]&&t===c[x+2]){p=!0;break}p||(c[h++]=q,c[h++]=r,c[h++]=t,m+=q,l+=r,n+=t)}for(f=0;f<k.length;f++)a[k[f]]=m,a[k[f]+1]=l,a[k[f]+2]=n}}for(f=0;f<a.length;f+=
d)if(g=a[f+e],c=a[f+e+1],k=a[f+e+2],b=Math.sqrt(g*g+c*c+k*k))b=1/b,a[f+e]=g*b,a[f+e+1]=c*b,a[f+e+2]=k*b};
H3DU.Mesh._recalcNormals=function(a,b,c,d,e,f){f=f?-1:1;var h={},g;H3DU.Mesh._recalcNormalsStart(a,h,b,c,d,e);for(var k=0;k<b.length;k+=3){var m=b[k]*c,l=b[k+1]*c,n=b[k+2]*c;g=[a[m]-a[n],a[m+1]-a[n+1],a[m+2]-a[n+2]];var p=[a[l]-a[n],a[l+1]-a[n+1],a[l+2]-a[n+2]],q=g[1]*p[2]-g[2]*p[1],r=g[2]*p[0]-g[0]*p[2],p=g[0]*p[1]-g[1]*p[0];g=Math.sqrt(q*q+r*r+p*p);0!==g&&(g=1/g,g*=f,q*=g,r*=g,p*=g,a[m+d]+=q,a[m+d+1]+=r,a[m+d+2]+=p,a[l+d]+=q,a[l+d+1]+=r,a[l+d+2]+=p,a[n+d]+=q,a[n+d+1]+=r,a[n+d+2]+=p)}H3DU.Mesh._recalcNormalsFinish(a,
h,b,c,d,e)};H3DU.Mesh.prototype.mode=function(a){if(0>a)throw Error("invalid mode");if(-1===this.currentMode){var b=0,c=H3DU.Mesh._primitiveType(a);c===H3DU.Mesh.LINES?b|=H3DU.Mesh.LINES_BIT:c===H3DU.Mesh.POINTS&&(b|=H3DU.Mesh.POINTS_BIT);this._initialize([],[],b);this.currentMode=a}else if(H3DU.Mesh._isCompatibleMode(this.currentMode,a))this.newPrimitive(),this.currentMode=a;else throw Error("Storing a different primitive mode in this mesh is no longer supported");return this};
H3DU.Mesh.prototype.merge=function(a){if(!H3DU.Mesh._isCompatibleMode(this.currentMode,a.currentMode))throw Error("Meshes have incompatible types");var b=this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS,c=a.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS;b!==c&&(b|=c,b===c?this._rebuildVertices(b):(b=new H3DU.Mesh,b.currentMode=a.currentMode,b._rebuildVertices(c),b.merge(a),a=b));c=this.vertexCount();b=this.indices.length;this.vertices.push.apply(this.vertices,a.vertices);this.indices.push.apply(this.indices,
a.indices);for(a=b;a<this.indices.length;a++)this.indices[a]+=c;this.newPrimitive();return this};H3DU.Mesh.prototype.normal3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.normal[0]=a,this.normal[1]=b,this.normal[2]=c):(this.normal[0]=a[0],this.normal[1]=a[1],this.normal[2]=a[2]);this._elementsDefined|=H3DU.Mesh.NORMALS_BIT;return this};
H3DU.Mesh.prototype.tangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.tangent[0]=a,this.tangent[1]=b,this.tangent[2]=c):(this.tangent[0]=a[0],this.tangent[1]=a[1],this.tangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.TANGENTS_BIT;return this};
H3DU.Mesh.prototype.bitangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.bitangent[0]=a,this.bitangent[1]=b,this.bitangent[2]=c):(this.bitangent[0]=a[0],this.bitangent[1]=a[1],this.bitangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.BITANGENTS_BIT;return this};
H3DU.Mesh.prototype.color3=function(a,b,c){"string"===typeof a?(a=H3DU.toGLColor(a),this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]):"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.color[0]=a,this.color[1]=b,this.color[2]=c):(this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]);this._elementsDefined|=H3DU.Mesh.COLORS_BIT;return this};
H3DU.Mesh.prototype.texCoord2=function(a,b){"number"===typeof a&&"number"===typeof b?(this.texCoord[0]=a,this.texCoord[1]=b):(this.texCoord[0]=a[0],this.texCoord[1]=a[1]);this._elementsDefined|=H3DU.Mesh.TEXCOORDS_BIT;return this};H3DU.Mesh.prototype.vertex3=function(a,b,c){"undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b||"undefined"!==typeof c&&null!==c?this._vertex3(a,b,c,this):"number"!==typeof a?this._vertex3(a[0],a[1],a[2],this):this._vertex3(a,a,a,this);return this};
H3DU.Mesh.prototype.vertex2=function(a,b){return"undefined"===typeof a||null===a||"undefined"!==typeof b&&null!==b?this.vertex3(a,b,0):"number"!==typeof a?this.vertex3(a[0],a[1],0):this.vertex3(a,a,0)};
H3DU.Mesh.prototype.setColor3=function(a,b,c){var d=a;"string"===typeof a&&(a=H3DU.toGLColor(a),d=a[0],b=a[1],c=a[2]);this._rebuildVertices(H3DU.Mesh.COLORS_BIT);a=this.getStride();for(var e=H3DU.Mesh._colorOffset(this.attributeBits);e<this.vertices.length;e+=a)this.vertices[e]=d,this.vertices[e+1]=b,this.vertices[e+2]=c;return this};
H3DU.Mesh.prototype.normalizeNormals=function(){var a,b=this.getStride(),c=this.vertices,d=H3DU.Mesh._normalOffset(this.attributeBits);if(0>d)return this;for(a=0;a<c.length;a+=b){var e=c[a+d],f=c[a+d+1],h=c[a+d+2],e=Math.sqrt(e*e+f*f+h*h);0!==e&&(e=1/e,c[a+d]*=e,c[a+d+1]*=e,c[a+d+2]*=e)}return this};
H3DU.Mesh.prototype.setVertex=function(a,b,c,d){if(0>a)return this;"undefined"===typeof c&&"undefined"===typeof d&&(c=b[1],d=b[2],b=b[0]);var e=this.vertexCount();a<e&&(a*=this.getStride(),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=d);return this};
H3DU.Mesh.prototype.setVertexNormal=function(a,b,c,d){if(0>a)return this;"undefined"===typeof c&&"undefined"===typeof d&&(c=b[1],d=b[2],b=b[0]);var e=this.vertexCount();a<e&&(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),a+=H3DU.Mesh._normalOffset(this.attributeBits),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=d);return this};
H3DU.Mesh.prototype.getVertex=function(a){if(0>a)return null;var b=this.vertexCount();return a<b?(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),this.vertices.slice(a,a+3)):null};H3DU.Mesh.prototype.getVertexNormal=function(a){var b=this.vertexCount();return a<b?(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),a+=H3DU.Mesh._normalOffset(this.attributeBits),this.vertices.slice(a,a+3)):null};
H3DU.Mesh.prototype._initialize=function(a,b,c){this.vertices=a||[];this.indices=b||[];this.startIndex=0;a=c&H3DU.Mesh.PRIMITIVES_BITS;if(0!==a&&a!==H3DU.Mesh.LINES_BIT&&a!==H3DU.Mesh.POINTS_BIT)throw Error("invalid format");this.attributeBits="undefined"===typeof c||null===c?0:c;this.vertexCount=function(){return this.vertices.length/this.getStride()};this.getStride=function(){return H3DU.Mesh._getStride(this.attributeBits)};this.newPrimitive=function(){this.startIndex=this.vertices.length;return this};
this.primitiveType=function(){var a=H3DU.Mesh.TRIANGLES;0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)&&(a=H3DU.Mesh.LINES);0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)&&(a=H3DU.Mesh.POINTS);return a};this._rebuildVertices=function(a){var b=this.attributeBits;a=b|a&H3DU.Mesh.ATTRIBUTES_BITS;if(a!==b){for(var c=this.getStride(),d,g,k,m=[],l=0;l<this.vertices.length;l+=c){var n=l+3;m.push(this.vertices[l],this.vertices[l+1],this.vertices[l+2]);0!==(a&H3DU.Mesh.NORMALS_BIT)&&(0!==(b&H3DU.Mesh.NORMALS_BIT)?
(d=this.vertices[n],g=this.vertices[n+1],k=this.vertices[n+2],n+=3,m.push(d,g,k)):m.push(0,0,0));0!==(a&H3DU.Mesh.COLORS_BIT)&&(0===(b&H3DU.Mesh.COLORS_BIT)?m.push(0,0,0):(d=this.vertices[n],g=this.vertices[n+1],k=this.vertices[n+2],n+=3,m.push(d,g,k)));0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(0===(b&H3DU.Mesh.TEXCOORDS_BIT)?m.push(0,0):(d=this.vertices[n],g=this.vertices[n+1],n+=2,m.push(d,g)));0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(0===(b&H3DU.Mesh.TANGENTS_BIT)?m.push(0,0,0):(d=this.vertices[n],g=this.vertices[n+
1],k=this.vertices[n+2],n+=3,m.push(d,g,k)));0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(0===(b&H3DU.Mesh.BITANGENTS_BIT)?m.push(0,0,0):(d=this.vertices[n],g=this.vertices[n+1],k=this.vertices[n+2],m.push(d,g,k)))}this.vertices=m;this.attributeBits=a}};this._setTriangle=function(a,b,c,h,g){var d=c*b,e=h*b,f=g*b,n=0,p=this.vertices;for(a-=b;0<=a&&16>n;a-=b,n++){for(var q=7,r=0;r<b&&0!==q;r++)0!==(q&1)&&p[d+r]!==p[a+r]&&(q&=-2),0!==(q&2)&&p[e+r]!==p[a+r]&&(q&=-3),0!==(q&4)&&p[f+r]!==p[a+r]&&(q&=-5);if(0!==(q&
1)){c=a/b;d=c*b;break}if(0!==(q&2)){h=a/b;e=h*b;break}if(0!==(q&4)){g=a/b;f=g*b;break}}p[d]===p[e]&&p[d+1]===p[e+1]&&p[d+2]===p[e+2]||p[d]===p[f]&&p[d+1]===p[f+1]&&p[d+2]===p[f+2]||p[e]===p[f]&&p[e+1]===p[f+1]&&p[e+2]===p[f+2]||this.indices.push(c,h,g)};this._vertex3=function(a,b,c){var d=this.currentMode;if(-1===d)throw Error("mode() not called");this._rebuildVertices(this._elementsDefined);var e=this.vertices.length;this.vertices.push(a,b,c);0!==(this.attributeBits&H3DU.Mesh.NORMALS_BIT)&&this.vertices.push(this.normal[0],
this.normal[1],this.normal[2]);0!==(this.attributeBits&H3DU.Mesh.COLORS_BIT)&&this.vertices.push(this.color[0],this.color[1],this.color[2]);0!==(this.attributeBits&H3DU.Mesh.TEXCOORDS_BIT)&&this.vertices.push(this.texCoord[0],this.texCoord[1]);0!==(this.attributeBits&H3DU.Mesh.TANGENTS_BIT)&&this.vertices.push(this.tangent[0],this.tangent[1],this.tangent[2]);0!==(this.attributeBits&H3DU.Mesh.BITANGENTS_BIT)&&this.vertices.push(this.bitangent[0],this.bitangent[1],this.bitangent[2]);a=this.getStride();
d===H3DU.Mesh.QUAD_STRIP&&this.vertices.length-this.startIndex>=4*a&&0===(this.vertices.length-this.startIndex)%(2*a)?(d=this.vertices.length/a-4,this._setTriangle(e,a,d,d+1,d+2),this._setTriangle(e,a,d+2,d+1,d+3)):d===H3DU.Mesh.QUADS&&0===(this.vertices.length-this.startIndex)%(4*a)?(d=this.vertices.length/a-4,this._setTriangle(e,a,d,d+1,d+2),this._setTriangle(e,a,d,d+2,d+3)):d===H3DU.Mesh.TRIANGLES&&0===(this.vertices.length-this.startIndex)%(3*a)?(d=this.vertices.length/a-3,this._setTriangle(e,
a,d,d+1,d+2)):d===H3DU.Mesh.LINES&&0===(this.vertices.length-this.startIndex)%(2*a)?(d=this.vertices.length/a-2,this.indices.push(d,d+1)):d===H3DU.Mesh.TRIANGLE_FAN&&this.vertices.length-this.startIndex>=3*a?(d=this.vertices.length/a-2,b=this.startIndex/a,this._setTriangle(e,a,b,d,d+1)):d===H3DU.Mesh.LINE_STRIP&&this.vertices.length-this.startIndex>=2*a?(d=this.vertices.length/a-2,this.indices.push(d,d+1)):d===H3DU.Mesh.POINTS?(d=this.vertices.length/a-1,this.indices.push(d)):d===H3DU.Mesh.TRIANGLE_STRIP&&
this.vertices.length-this.startIndex>=3*a&&(d=this.vertices.length/a-3,b=this.startIndex/a,0===(d-b&1)?this._setTriangle(e,a,d,d+1,d+2):this._setTriangle(e,a,d+1,d,d+2));return this}};H3DU.Mesh.prototype._makeRedundant=function(){for(var a=[],b=this.getStride(),c=this.indices.length,d=0;d<c;d++){var e=this.indices[d];if(a[e]){for(var f=e*b,h=this.vertices.length/b,g=0;g<b;g++)this.vertices.push(this.vertices[f+g]);this.indices[d]=h}a[e]=!0}return this};
H3DU.Mesh.prototype.primitiveCount=function(){return 0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};H3DU.Mesh._addLine=function(a,b,c,d){if(c<d){var e=c;c=d;d=e}(e=b[c])?0>e.indexOf(d)&&(e.push(d),a.push(c,d)):(b[c]=[d],a.push(c,d))};
H3DU.Mesh.prototype.toWireFrame=function(){if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var a=[],b={},c=0;c<this.indices.length;c+=3){var d=this.indices[c],e=this.indices[c+1],f=this.indices[c+2];H3DU.Mesh._addLine(a,b,d,e);H3DU.Mesh._addLine(a,b,e,f);H3DU.Mesh._addLine(a,b,f,d)}return new H3DU.Mesh(this.vertices,a,this.attributeBits|H3DU.Mesh.LINES_BIT)};
H3DU.Mesh._isIdentityInUpperLeft=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[8]&&0===a[9]&&1===a[10]};
H3DU.Mesh.prototype.transform=function(a){var b=this.getStride(),c=this.vertices,d=!H3DU.Mesh._isIdentityInUpperLeft(a),e=H3DU.Mesh._normalOffset(this.attributeBits),f=null;0<=e&&d&&(f=H3DU.Math.mat4inverseTranspose3(a));for(var h=0;h<c.length;h+=b){var g=H3DU.Math.mat4projectVec3(a,c[h],c[h+1],c[h+2]);c[h]=g[0];c[h+1]=g[1];c[h+2]=g[2];0<=e&&d&&(g=H3DU.Math.mat3transform(f,c[h+e],c[h+e+1],c[h+e+2]),H3DU.Math.vec3normalizeInPlace(g),c[h+e]=g[0],c[h+e+1]=g[1],c[h+e+2]=g[2])}this.newPrimitive();return this};
H3DU.Mesh.prototype.enumPrimitives=function(a){var b=this.primitiveType(),c=H3DU.Mesh._normalOffset(this.attributeBits),d=H3DU.Mesh._colorOffset(this.attributeBits),e=H3DU.Mesh._texCoordOffset(this.attributeBits),f=this.getStride(),h=this.vertices,g=3;b===H3DU.Mesh.LINES&&(g=2);b===H3DU.Mesh.POINTS&&(g=1);for(b=0;b<this.indices.length;b+=g){for(var k=[],m=0;m<g;m++){var l=this.indices[b+m]*f,n={};n.position=[h[l],h[l+1],h[l+2]];0<=c&&(n.normal=[h[l+c],h[l+c+1],h[l+c+2]]);0<=d&&(n.color=[h[l+d],h[l+
d+1],h[l+d+2]]);0<=e&&(n.uv=[h[l+e],h[l+e+1]]);k.push(n)}a(k)}return this};H3DU.Mesh.prototype.getBoundingBox=function(){for(var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this.getStride(),d=this.vertices,e=0;e<this.indices.length;e++){var f=this.indices[e]*c;a?(a=!1,b[0]=b[3]=d[f],b[1]=b[4]=d[f+1],b[2]=b[5]=d[f+2]):(b[0]=Math.min(b[0],d[f]),b[3]=Math.max(b[3],d[f]),b[1]=Math.min(b[1],d[f+1]),b[4]=Math.max(b[4],d[f+1]),b[2]=Math.min(b[2],d[f+2]),b[5]=Math.max(b[5],d[f+2]))}return b};
H3DU.Mesh._findTangentAndBitangent=function(a,b,c,d,e){var f=a[c]-a[b],h=a[c+1]-a[b+1],g=a[c+2]-a[b+2],k=a[d]-a[b],m=a[d+1]-a[b+1],l=a[d+2]-a[b+2],n=a[c+e]-a[b+e],p=a[c+e+1]-a[b+e+1];c=a[d+e]-a[b+e];a=a[d+e+1]-a[b+e+1];b=n*a-p*c;if(0===b)return[0,0,0,0,0,0];b=1/b;p=-p;c=-c;return[(a*f+p*k)*b,(a*h+p*m)*b,(a*g+p*l)*b,(c*f+n*k)*b,(c*h+n*m)*b,(c*g+n*l)*b]};
H3DU.Mesh._recalcTangentsInternal=function(a,b,c,d,e,f){for(var h=[0,0,0],g=0;g<b.length;g+=3){h[0]=b[g]*c;h[1]=b[g+1]*c;h[2]=b[g+2]*c;for(var k=H3DU.Mesh._findTangentAndBitangent(a,h[0],h[1],h[2],d),m=0;3>m;m++){var l=k,n=h[m],p=a[n+e],q=a[n+e+1],r=a[n+e+2],t=l[0]*p+l[1]*q+l[2]*r,t=H3DU.Math.vec3normalizeInPlace([l[0]-t*p,l[1]-t*q,l[2]-t*r]),x=l[3]*p+l[4]*q+l[5]*r,w=l[3]*t[0]+l[4]*t[1]+l[5]*t[2],l=H3DU.Math.vec3normalizeInPlace([l[3]-x*p-w*t[0],l[4]-x*q-w*t[1],l[5]-x*r-w*t[2]]);a[n+f]=t[0];a[n+f+
1]=t[1];a[n+f+2]=t[2];a[n+f+3]=l[0];a[n+f+4]=l[1];a[n+f+5]=l[2]}}};
H3DU.Mesh.prototype.recalcTangents=function(){if(this.primitiveType()!==H3DU.Mesh.TRIANGLES)return this;var a=H3DU.Mesh.TANGENTS_BIT|H3DU.Mesh.BITANGENTS_BIT,b=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~a),c=H3DU.Mesh._texCoordOffset(this.attributeBits),d=H3DU.Mesh._normalOffset(this.attributeBits);if(0>c||0>d)return this;this._rebuildVertices(a);b&&this._makeRedundant();this.primitiveType()===H3DU.Mesh.TRIANGLES&&(a=H3DU.Mesh._tangentOffset(this.attributeBits),H3DU.Mesh._recalcTangentsInternal(this.vertices,
this.indices,this.getStride(),c,d,a));return this};H3DU.Mesh.prototype.reverseNormals=function(){var a,b=this.getStride(),c=this.vertices,d=H3DU.Mesh._normalOffset(this.attributeBits);if(0>d)return this;for(a=0;a<c.length;a+=b){var e=c[a+d+1],f=c[a+d+2];c[a+d]=-c[a+d];c[a+d+1]=-e;c[a+d+2]=-f}return this};
H3DU.Mesh.prototype.reverseWinding=function(){if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var a=0;a<this.indices.length;a+=3){var b=this.indices[a+2];this.indices[a+2]=this.indices[a+1];this.indices[a+1]=b}return this};
H3DU.Mesh.prototype.recalcNormals=function(a,b){var c=this.primitiveType();c!==H3DU.Mesh.LINES&&c!==H3DU.Mesh.POINTS&&(c=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~H3DU.Mesh.NORMALS_BIT),this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),(c||a)&&this._makeRedundant(),H3DU.Mesh._recalcNormals(this.vertices,this.indices,this.getStride(),3,a,b));return this};
H3DU.Mesh._getStride=function(a){var b=[3,6,6,9,5,8,8,11][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)];0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(b+=3);return b};H3DU.Mesh._normalOffset=function(a){return[-1,3,-1,3,-1,3,-1,3][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};
H3DU.Mesh._tangentOffset=function(a){var b=3;if(0===(a&H3DU.Mesh.TANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(b+=2);return b};H3DU.Mesh._bitangentOffset=function(a){var b=3;if(0===(a&H3DU.Mesh.BITANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(b+=2);0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(b+=3);return b};
H3DU.Mesh._colorOffset=function(a){return[-1,-1,3,6,-1,-1,3,6][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh._texCoordOffset=function(a){return[-1,-1,-1,-1,3,6,6,9][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh.ATTRIBUTES_BITS=255;H3DU.Mesh.PRIMITIVES_BITS=768;H3DU.Mesh.NORMALS_BIT=1;H3DU.Mesh.COLORS_BIT=2;H3DU.Mesh.TEXCOORDS_BIT=4;H3DU.Mesh.TANGENTS_BIT=8;H3DU.Mesh.BITANGENTS_BIT=16;H3DU.Mesh.LINES_BIT=256;
H3DU.Mesh.POINTS_BIT=512;H3DU.Mesh.TRIANGLES=4;H3DU.Mesh.QUAD_STRIP=8;H3DU.Mesh.QUADS=7;H3DU.Mesh.LINES=1;H3DU.Mesh.TRIANGLE_FAN=6;H3DU.Mesh.TRIANGLE_STRIP=5;H3DU.Mesh.LINE_STRIP=3;H3DU.Mesh.POINTS=0;this.H3DU.Mesh=H3DU.Mesh;H3DU.TextureLoader=function(){this.loadedTextures=[];this.textureImages={};this.maxAnisotropy=[];this.fbLoader=new H3DU.FrameBufferLoader};H3DU.TextureLoader.prototype.getTexture=function(a){var b=this.textureImages[a]||null;return b&&2!==b.loadStatus?this.textureImages[a]=null:this.textureImages[a]||null};H3DU.TextureLoader.prototype.loadTexture=function(a){return H3DU.Texture.loadTexture(a,this.textureImages)};
H3DU.TextureLoader.prototype._setMaxAnisotropy=function(a,b){a=a.getContext?a.getContext():a;for(var c=this.maxAnisotropy,d=0;d<c.length;d++)if(c[d][0]===a)if(0<=c[d][2])a.texParameteri(b,c[d][2],c[d][1]);else return;var e=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic");if(e)return d=e.TEXTURE_MAX_ANISOTROPY_EXT,e=a.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT),c.push([a,e,d]),a.texParameteri(b,
d,e),e;c.push([a,1,-1,null]);return 1};H3DU.TextureLoader.prototype.loadTexturesAll=function(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(this.loadTexture(a[e]));return H3DU.getPromiseResultsAll(d,b,c)};H3DU.TextureLoader.prototype.loadAndMapTexture=function(a,b){b=b.getContext?b.getContext():b;var c=this;return this.loadTexture(a).then(function(d){var e=H3DU.TextureInfo._texInfoOrString(a);c._mapTextureWithInfo(d,e,b);return Promise.resolve(d)})};
H3DU.TextureLoader.prototype.loadAndMapTexturesAll=function(a,b,c,d){b=b.getContext?b.getContext():b;for(var e=[],f=0;f<a.length;f++)e.push(this.loadAndMapTexture(a[f],b));return H3DU.getPromiseResultsAll(e,c,d)};
H3DU.TextureLoader.prototype._mapTextureWithInfo=function(a,b,c){c=c.getContext?c.getContext():c;for(var d=this.loadedTextures,e=0;e<d.length;e++)if(d[e][0]===a&&d[e][1]===c)return d[e][2];b=a instanceof H3DU.CubeMap?new H3DU._LoadedCubeMap(a,c):new H3DU._LoadedTexture(a,b,c);d.push([a,c,b]);return b};H3DU.TextureLoader.prototype.loadCubeMap=function(a,b,c){var d=a;a instanceof H3DU.CubeMap||(d=new H3DU.CubeMap(a));return H3DU.TextureLoader.prototype.loadTexturesAll(d.textures,b,c).then(function(){return Promise.resolve(d)})};
H3DU.TextureLoader.prototype.mapFrameBuffer=function(a,b){b=b.getContext?b.getContext():b;return this.fbLoader.mapFrameBuffer(a,b)};H3DU.TextureLoader.prototype.bindFrameBuffer=function(a,b,c){b=b.getContext?b.getContext():b;return this.fbLoader.bind(a,b,c)};H3DU.TextureLoader.prototype.unbindFrameBuffer=function(a,b){b=b.getContext?b.getContext():b;this.fbLoader.unbind(a,b)};
H3DU.TextureLoader.prototype.dispose=function(){for(var a in this.textureImages)Object.prototype.hasOwnProperty.call(this.textureImages,a)&&this.textureImages[a].dispose();a=this.loadedTextures;for(var b=0;b<a.length;b++)this.loadedTextures[b][2].dispose();"undefined"!==typeof this.fbLoader&&null!==this.fbLoader||this.fbLoader.dispose();this.fbLoader=null;this.textureImages={};this.loadedTextures=[];this.maxAnisotropy=[]};H3DU.PbrMaterial=function(a){this.albedo=[.8,.8,.8,1];this.albedoMap=null;this.metalness=0;this.metalnessMap=null;this.roughness=.35;this.roughnessMap=null;this.specular=[.2,.2,.2];this.specularMap=null;this.workflow=H3DU.PbrMaterial.Metallic;this.normalMap=null;this.emission=[0,0,0];this.shader=this.emissionMap=null;this.invertRoughness=!1;"undefined"!==typeof a&&null!==a&&this.setParams(a)};H3DU.PbrMaterial.Specular=0;H3DU.PbrMaterial.Metallic=1;
H3DU.PbrMaterial.prototype.setParams=function(a){"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.albedo=H3DU.toGLColor(a.diffuse),4<this.albedo.length&&(this.albedo=this.diffuse.slice(0,4)));"undefined"!==typeof a.albedo&&null!==a.albedo&&(this.albedo=H3DU.toGLColor(a.albedo),4<this.albedo.length&&(this.albedo=this.albedo.slice(0,4)));"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular),3<this.specular.length&&(this.specular=this.specular.slice(0,3)));
"undefined"!==typeof a.emission&&null!==a.emission&&(this.emission=H3DU.toGLColor(a.emission),3<this.emission.length&&(this.emission=this.emission.slice(0,3)));"undefined"!==typeof a.texture&&null!==a.texture&&(this.albedoMap=H3DU.TextureInfo._texInfoOrString(a.texture));"undefined"!==typeof a.albedoMap&&(this.albedoMap=H3DU.TextureInfo._texInfoOrString(a.albedoMap));"undefined"!==typeof a.specularMap&&(this.specularMap=H3DU.TextureInfo._texInfoOrString(a.specularMap));"undefined"!==typeof a.normalMap&&
(this.normalMap=H3DU.TextureInfo._texInfoOrString(a.normalMap));"undefined"!==typeof a.metalnessMap&&(this.metalnessMap=H3DU.TextureInfo._texInfoOrString(a.metalnessMap));"undefined"!==typeof a.roughnessMap&&(this.roughnessMap=H3DU.TextureInfo._texInfoOrString(a.roughnessMap));"undefined"!==typeof a.emissionMap&&(this.emissionMap=H3DU.TextureInfo._texInfoOrString(a.emissionMap));"undefined"!==typeof a.metalness&&null!==a.metalness&&(this.metalness=a.metalness);"undefined"!==typeof a.invertRoughness&&
null!==a.invertRoughness&&(this.invertRoughness=a.invertRoughness);"undefined"!==typeof a.roughness&&null!==a.roughness&&(this.roughness=a.roughness);"undefined"!==typeof a.shader&&(this.shader=a.shader);return this};
H3DU.PbrMaterial.prototype.copy=function(){return new H3DU.PbrMaterial({environmentMap:this.environmentMap,metalness:this.metalness,metalnessMap:this.metalnessMap,roughness:this.roughness,roughnessMap:this.roughnessMap,albedo:this.albedo,invertRoughness:this.invertRoughness,specular:this.specular,emission:this.emission,albedoMap:this.albedoMap,specularMap:this.specularMap,normalMap:this.normalMap,shader:this.shader})};H3DU.LightSource=function(a,b,c,d){this.ambient=[0,0,0,1];this.position=[0,0,1,0];this.diffuse=[1,1,1,1];this.specular=[1,1,1];this.radius=0;a&&a.constructor===Array?this.setParams({diffuse:c,position:a,specular:d,ambient:b}):"undefined"!==typeof a&&null!==a&&this.setParams(a)};
H3DU.LightSource.prototype.setParams=function(a){"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),this.ambient=this.ambient.slice(0,4));if("undefined"!==typeof a.position&&null!==a.position){var b=a.position;this.position=[b[0],b[1],b[2],null===b[3]?0:b[3]]}"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular));"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse));"undefined"!==typeof a.radius&&
null!==a.radius&&(this.radius=a.radius);return this};H3DU.Semantic={};H3DU.Semantic.POSITION=0;H3DU.Semantic.NORMAL=1;H3DU.Semantic.TEXCOORD=2;H3DU.Semantic.COLOR=3;H3DU.Semantic.JOINT=4;H3DU.Semantic.WEIGHT=5;H3DU.Semantic.TANGENT=6;H3DU.Semantic.BITANGENT=7;H3DU.Semantic.MODEL=101;H3DU.Semantic.VIEW=102;H3DU.Semantic.PROJECTION=103;H3DU.Semantic.MODELVIEW=104;H3DU.Semantic.MODELVIEWPROJECTION=105;H3DU.Semantic.MODELVIEWINVERSETRANSPOSE=106;H3DU.Semantic.VIEWINVERSE=107;H3DU.MeshBuffer=function(a){var b=new Float32Array(a.vertices);65536<=a.vertices.length||65536<=a.indices.length?(this.indexBufferSize=4,this.indices=new Uint32Array(a.indices)):256>=a.vertices.length&&256>=a.indices.length?(this.indexBufferSize=1,this.indices=new Uint8Array(a.indices)):(this.indexBufferSize=2,this.indices=new Uint16Array(a.indices));this.format=a.attributeBits;a=H3DU.Mesh._getStride(this.format);this.attributes=[];this.attributes.push([H3DU.Semantic.POSITION,0,b,3,a,0]);var c=H3DU.Mesh._normalOffset(this.format);
0<=c&&this.attributes.push([H3DU.Semantic.NORMAL,c,b,3,a,0]);c=H3DU.Mesh._colorOffset(this.format);0<=c&&this.attributes.push([H3DU.Semantic.COLOR,c,b,3,a,0]);c=H3DU.Mesh._texCoordOffset(this.format);0<=c&&this.attributes.push([H3DU.Semantic.TEXCOORD,c,b,2,a,0]);c=H3DU.Mesh._tangentOffset(this.format);0<=c&&this.attributes.push([H3DU.Semantic.TANGENT,c,b,3,a,0]);c=H3DU.Mesh._bitangentOffset(this.format);0<=c&&this.attributes.push([H3DU.Semantic.BITANGENT,c,b,3,a,0])};
H3DU.MeshBuffer.prototype.setIndices=function(a,b){if(1!==b&&2!==b&&4!==b)throw Error();this.indexBufferSize=b;this.indices=a;return this};H3DU.MeshBuffer.prototype.setPrimitiveType=function(a){a===H3DU.Mesh.TRIANGLES?this.format=0:a===H3DU.Mesh.LINES?this.format=H3DU.Mesh.LINES_BIT:a===H3DU.Mesh.POINTS&&(this.format=H3DU.Mesh.POINTS_BIT);return this};
H3DU.MeshBuffer.prototype.setAttribute=function(a,b,c,d,e,f){c.constructor===Array&&(c=new Float32Array(c));var h;h=H3DU.MeshBuffer._resolveSemantic(a,b);if("undefined"===typeof h||null===h)return console.warn("Unsupported attribute semantic: "+a),this;b=h[0];h=h[1];var g=this._getAttribute(b,h);g?(g[1]=d,g[2]=c,g[3]=e,g[4]=f):this.attributes.push([b,d,c,e,f,h]);"position"===a&&(this._bounds=null);return this};
H3DU.MeshBuffer._resolveSemantic=function(a,b){if("number"===typeof a)return[a,b|0];var c=H3DU.MeshBuffer._wellKnownAttributes[a];if("undefined"===typeof c||null===c){var d=a.indexOf(a);if(0>d)return null;c=H3DU.MeshBuffer._wellKnownAttributes[a.substr(0,d)];if("undefined"===typeof c||null===c)return null;d=a.substr(d+1);return 5>=d.length&&/^\d$/.test(d)?new Uint32Array([c,parseInt(d,10)]):null}return new Uint32Array([c,0])};H3DU.MeshBuffer.prototype._getAttributes=function(){return this.attributes};
H3DU.MeshBuffer.prototype._getAttribute=function(a,b){for(var c="undefined"===typeof b||null===b?0:b,d=0;d<this.attributes.length;d++)if(this.attributes[d][0]===a&&this.attributes[d][5]===c)return this.attributes[d];return null};H3DU.MeshBuffer.prototype.primitiveCount=function(){return 0!==(this.format&H3DU.Mesh.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.format&H3DU.Mesh.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};
H3DU.MeshBuffer.prototype.getPositions=function(){var a=3,b=this.primitiveType();b===H3DU.Mesh.LINES&&(a=2);b===H3DU.Mesh.POINTS&&(a=1);var c=this._getAttribute(H3DU.Semantic.POSITION);if(!c||3>c[3])return[];for(var b=this.primitiveCount(),d=c[4],e=c[2],c=c[1],f=[],h=0;h<b;h++){var g=h*a,k=this.indices[g],m=2>a?k:this.indices[g+1],k=k*d+c,l=m*d+c,g=(3>a?m:this.indices[g+2])*d+c,m=[];m.push([e[k],e[k+1],e[k+2]]);2<=a&&m.push([e[l],e[l+1],e[l+2]]);3<=a&&m.push([e[g],e[g+1],e[g+2]]);f.push(m)}return f};
H3DU.MeshBuffer.prototype.getBounds=function(){if(!this._bounds){var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this._getAttribute(H3DU.Semantic.POSITION);if(!c||3>c[3])return b;for(var d=c[4],e=c[2],c=c[1],f=0;f<this.indices.length;f++){var h=this.indices[f]*d+c;a?(a=!1,b[0]=b[3]=e[h],b[1]=b[4]=e[h+1],b[2]=b[5]=e[h+2]):(b[0]=Math.min(b[0],e[h]),b[3]=Math.max(b[3],e[h]),b[1]=Math.min(b[1],e[h+1]),b[4]=Math.max(b[4],e[h+1]),b[2]=Math.min(b[2],e[h+2]),b[5]=Math.max(b[5],e[h+2]))}this._bounds=
b.slice(0,6);return b}return this._bounds.slice(0,6)};H3DU.MeshBuffer.prototype.primitiveType=function(){return 0!==(this.format&H3DU.Mesh.LINES_BIT)?H3DU.Mesh.LINES:0!==(this.format&H3DU.Mesh.POINTS_BIT)?H3DU.Mesh.POINTS:H3DU.Mesh.TRIANGLES};H3DU.MeshBuffer._wellKnownAttributes={POSITION:0,TEXCOORD:2,TEXCOORD_0:2,NORMAL:1,JOINT:4,WEIGHT:5,TANGENT:6,BITANGENT:7};H3DU.MeshBuffer.prototype.getFormat=function(){return this.format};H3DU.MeshBuffer.prototype.vertexCount=function(){return this.indices.length};var BezierCurve=H3DU.BezierCurve,BezierSurface=H3DU.BezierSurface,BSplineCurve=H3DU.BSplineCurve,BSplineSurface=H3DU.BSplineSurface,GLUtil=H3DU,GLMath=H3DU.Math,BufferedMesh=H3DU.BufferedMesh,FrameBuffer=H3DU.FrameBuffer,CurveEval=H3DU.CurveEval,SurfaceEval=H3DU.SurfaceEval,Lights=H3DU.Lights,LightSource=H3DU.LightSource,Material=H3DU.Material,Mesh=H3DU.Mesh,Meshes=H3DU.Meshes,Scene3D=H3DU.Scene3D,ShaderProgram=H3DU.ShaderProgram,Shape=H3DU.Shape,ShapeGroup=H3DU.ShapeGroup,Texture=H3DU.Texture,TextureLoader=
H3DU.TextureLoader,Transform=H3DU.Transform;
