<meta charset=utf-8>
<head>
<script type="text/javascript" src="glmath.js"></script>
<script type="text/javascript" src="glutil.js"></script>
<script type="text/javascript" src="promise.js"></script>
<script type="text/javascript" src="matrixstack.js"></script>
<script>
//<!--

function createContext(){
  var canvasElement=document.getElementById("canvas")
  return GLUtil.get3DContext(canvasElement);
}

function createQuad(x,y,width,height){
 var builder=new Mesh();
 builder.mode(Mesh.QUAD_STRIP);
 var x2=x+width;
 var y2=y+height;
 builder.vertex3(x,y,0);
 builder.vertex3(x,y2,0);
 builder.vertex3(x2,y,0);
 builder.vertex3(x2,y2,0);
 return builder.recalcNormals();
};

var scene3d=null;
var currentFilter=null;

function makeGrayscale(context){
return ShaderProgram.makeEffect(context,[
"vec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){",
" vec4 color=texture2D(sampler,uvCoord);",
" float gray=(color.r+color.g+color.b)/3.0;",
" return vec4(gray,gray,gray,color.a);",
"}"].join("\n"));
}

function link1(){
 if(scene3d){
  if(currentFilter)currentFilter.dispose();
  currentFilter=makeGrayscale(scene3d.getContext());
  scene3d.useFilter(currentFilter);
 }
}

function link2(){
 if(scene3d){
  if(currentFilter)currentFilter.dispose();
  currentFilter=ShaderProgram.getInvertEffect(scene3d.getContext());
  scene3d.useFilter(currentFilter);
 }
}

function link3(){
 if(scene3d){
  if(currentFilter)currentFilter.dispose();
  currentFilter=null;
  scene3d.useFilter(currentFilter);
 }
}

onload=(function(){
  var context=createContext();
  var scene=new Scene3D(context).disableLighting()
  scene3d=scene;
  var color=true;
  var oddrow=false;
  for(var x=-100;x<100;x+=20){
   color=oddrow;
   for(var y=-100;y<100;y+=20){
    var xx=((x/100)+1)/2
    var yy=((y/100)+1)/2
    var mesh=createQuad(-0.1,-0.1,0.2,0.2);
    scene.addShape(new Shape(mesh)
      .setColor(color ? [0,xx,yy] : "white")
      .setPosition(x/100+0.1,y/100+0.1,0));
    color=!color;
   }
   oddrow=!oddrow
  }
  var rot=0;
  GLUtil.renderLoop(function(){
   scene.render();
   for(var i=0;i<scene.shapes.length;i++){
    scene.shapes[i].setRotation([0,rot,0]);
   }
   rot+=5;
 });
})
//-->
</script>
</head>
<body>
<h1>Quads</h1>
<a href="javascript:link1()">Grayscale</a>,
<a href="javascript:link2()">Invert colors</a>,
<a href="javascript:link3()">No filters</a>
<br>
<canvas width="600" height="450" id=canvas></canvas>
</body>
